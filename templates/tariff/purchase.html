<!DOCTYPE html>
<html class="dark" lang="uz">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Nikoh Premium Tariflar</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Epilogue:wght@300;400;500;600;700;800;900&family=Noto+Sans:wght@400;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#17824d",
                        "gold": "#B8860B",
                        "background-light": "#f2f2f2",
                        "background-dark": "#0d0d0d",
                        "glass-dark": "rgba(20, 20, 20, 0.6)",
                    },
                    fontFamily: {
                        "display": ["Epilogue", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.5rem",
                        "lg": "1rem",
                        "xl": "1.5rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <style>
        .glass-card {
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0) 100%);
        }
        .emerald-glow {
            box-shadow: 0 0 40px -10px rgba(23, 130, 77, 0.3);
        }
        .gold-glow {
            box-shadow: 0 0 40px -10px rgba(184, 134, 11, 0.3);
        }
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 300, 'GRAD' 0, 'opsz' 24;
        }
    </style>
    <style>
        body {
            min-height: max(884px, 100dvh);
        }
    </style>
</head>
<body class="bg-background-dark font-display text-white selection:bg-primary/30 antialiased">
    <!-- Main Container -->
    <div class="relative flex min-h-screen w-full flex-col overflow-x-hidden pb-12">
        <!-- Background Ambient Elements -->
        <div class="fixed inset-0 pointer-events-none overflow-hidden">
            <div class="absolute -top-[10%] -left-[20%] w-[70%] h-[50%] rounded-full bg-primary/10 blur-[120px]"></div>
            <div class="absolute top-[40%] -right-[20%] w-[60%] h-[60%] rounded-full bg-gold/5 blur-[120px]"></div>
            <div class="absolute bottom-[-10%] left-[10%] w-[50%] h-[40%] rounded-full bg-primary/10 blur-[120px]"></div>
        </div>
        
        <!-- TopAppBar -->
        <header class="relative flex items-center bg-transparent p-6 justify-between z-10">
            <div class="w-12"></div> <!-- Spacer for centering -->
            <h2 class="text-white text-lg font-semibold leading-tight tracking-wider uppercase flex-1 text-center">Premium Obuna</h2>
            <div class="flex w-12 items-center justify-end">
                <button onclick="closeTariffPage()" class="flex items-center justify-center rounded-full h-10 w-10 bg-white/5 border border-white/10 text-white backdrop-blur-md hover:bg-white/10 transition-colors active:scale-95">
                    <span class="material-symbols-outlined text-[20px]">close</span>
                </button>
            </div>
        </header>
        
        <!-- HeadlineText -->
        <div class="relative z-10 px-6 pt-8 pb-10">
            <h3 class="text-white text-3xl font-bold leading-tight text-center tracking-tight">O'zingizga mos tarifni tanlang</h3>
            <p class="text-white/50 text-center mt-3 font-light text-sm tracking-wide">Premium imkoniyatlar bilan baxtingizni toping</p>
        </div>
        
        <!-- Active Tariff Info -->
        {% if active_tariff %}
        <div class="relative z-10 px-6 mb-6">
            <div class="glass-card rounded-xl p-6 border-primary/30 bg-primary/5">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h4 class="text-primary text-lg font-bold mb-1">Aktiv obuna</h4>
                        <p class="text-white/60 text-sm">{{ active_tariff.tariff_name }} tarif</p>
                    </div>
                    <div class="bg-primary/20 text-primary px-4 py-2 rounded-full text-xs font-bold uppercase">
                        Aktiv
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 mt-4">
                    <div>
                        <p class="text-white/40 text-xs mb-1">Qolgan so'rovlar</p>
                        <p class="text-white text-xl font-bold">{{ active_tariff.requests_count }} / {{ active_tariff.total_requests }}</p>
                    </div>
                    <div>
                        <p class="text-white/40 text-xs mb-1">Qolgan kunlar</p>
                        <p class="text-white text-xl font-bold">{{ active_tariff.days_remaining }} kun</p>
                    </div>
                </div>
                {% if active_tariff.is_top and not active_tariff.is_top_expired %}
                <div class="mt-4 pt-4 border-t border-white/10">
                    <p class="text-gold text-sm font-semibold flex items-center gap-2">
                        <span class="material-symbols-outlined text-[18px]">star</span>
                        TOP rejimida - {{ active_tariff.top_days_remaining }} kun qoldi
                    </p>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        <!-- PricingCards Container -->
        <div class="relative z-10 flex flex-col gap-6 px-6">
            <!-- Silver Plan (Kumush) -->
            <div class="glass-card rounded-xl p-8 flex flex-col gap-6 emerald-glow" data-tariff="KUMUSH">
                <div class="flex flex-col gap-2">
                    <div class="flex items-center justify-between">
                        <h4 class="text-white/60 text-xs font-bold uppercase tracking-[0.2em]">Kumush</h4>
                    </div>
                    <div class="flex items-baseline gap-2 mt-2">
                        <span class="text-white text-4xl font-bold tracking-tighter">50,000</span>
                        <span class="text-white/60 text-sm font-medium">UZS / oy</span>
                    </div>
                </div>
                <div class="h-px w-full bg-gradient-to-r from-transparent via-white/10 to-transparent"></div>
                <ul class="flex flex-col gap-4">
                    <li class="flex items-center gap-3 text-white/80 text-sm">
                        <span class="material-symbols-outlined text-primary text-[20px]">check_circle</span>
                        Cheksiz ko'rishlar
                    </li>
                    <li class="flex items-center gap-3 text-white/80 text-sm">
                        <span class="material-symbols-outlined text-primary text-[20px]">check_circle</span>
                        Asosiy filterlar
                    </li>
                    <li class="flex items-center gap-3 text-white/80 text-sm">
                        <span class="material-symbols-outlined text-primary text-[20px]">check_circle</span>
                        Silver badge
                    </li>
                </ul>
                {% if active_tariff %}
                <button disabled class="w-full h-14 bg-white/5 border border-white/10 rounded-xl text-white/40 font-bold text-sm tracking-wide cursor-not-allowed">
                    Aktiv obuna mavjud
                </button>
                {% else %}
                <button onclick="selectTariff('KUMUSH', 50000)" class="w-full h-14 bg-white/5 border border-white/10 rounded-xl text-white font-bold text-sm tracking-wide hover:bg-white/10 transition-all">
                    Hozir yoqish
                </button>
                {% endif %}
            </div>
            
            <!-- Gold Plan (Oltin) - Highlighted -->
            <div class="glass-card rounded-xl p-8 flex flex-col gap-6 border-gold/30 bg-gold/5 gold-glow relative overflow-hidden" data-tariff="OLTIN">
                <!-- Shine effect -->
                <div class="absolute top-0 -inset-full h-full w-1/2 z-0 block transform -skew-x-12 bg-gradient-to-r from-transparent via-white/5 to-transparent opacity-40"></div>
                <div class="flex flex-col gap-2 relative z-10">
                    <div class="flex items-center justify-between">
                        <h4 class="text-gold text-xs font-bold uppercase tracking-[0.2em]">Oltin</h4>
                        <span class="bg-gold/20 text-gold text-[10px] font-bold px-3 py-1 rounded-full uppercase tracking-wider border border-gold/30">Ommabop</span>
                    </div>
                    <div class="flex items-baseline gap-2 mt-2">
                        <span class="text-gold text-4xl font-bold tracking-tighter">100,000</span>
                        <span class="text-gold/60 text-sm font-medium">UZS / oy</span>
                    </div>
                </div>
                <div class="h-px w-full bg-gradient-to-r from-transparent via-gold/20 to-transparent relative z-10"></div>
                <ul class="flex flex-col gap-4 relative z-10">
                    <li class="flex items-center gap-3 text-white/80 text-sm">
                        <span class="material-symbols-outlined text-gold text-[20px]">star</span>
                        Cheksiz ko'rishlar
                    </li>
                    <li class="flex items-center gap-3 text-white/80 text-sm">
                        <span class="material-symbols-outlined text-gold text-[20px]">star</span>
                        Poiskda yuqorida turish
                    </li>
                    <li class="flex items-center gap-3 text-white/80 text-sm">
                        <span class="material-symbols-outlined text-gold text-[20px]">star</span>
                        Gold badge
                    </li>
                </ul>
                {% if active_tariff %}
                <button disabled class="w-full h-14 bg-white/5 border border-white/10 rounded-xl text-white/40 font-bold text-sm tracking-wide cursor-not-allowed relative z-10">
                    Aktiv obuna mavjud
                </button>
                {% else %}
                <button onclick="selectTariff('OLTIN', 100000)" class="w-full h-14 bg-gold text-black font-extrabold text-sm tracking-widest uppercase rounded-xl shadow-lg shadow-gold/20 relative z-10">
                    Hozir yoqish
                </button>
                {% endif %}
            </div>
            
            <!-- VIP Plan -->
            <div class="glass-card rounded-xl p-8 flex flex-col gap-6 border-white/10 emerald-glow" data-tariff="VIP">
                <div class="flex flex-col gap-2">
                    <div class="flex items-center justify-between">
                        <h4 class="text-primary text-xs font-bold uppercase tracking-[0.2em]">VIP</h4>
                        <span class="bg-primary/20 text-primary text-[10px] font-bold px-3 py-1 rounded-full uppercase tracking-wider">Eksklyuziv</span>
                    </div>
                    <div class="flex items-baseline gap-2 mt-2">
                        <span class="text-white text-4xl font-bold tracking-tighter">250,000</span>
                        <span class="text-white/60 text-sm font-medium">UZS / oy</span>
                    </div>
                </div>
                <div class="h-px w-full bg-gradient-to-r from-transparent via-white/10 to-transparent"></div>
                <ul class="flex flex-col gap-4">
                    <li class="flex items-center gap-3 text-white/80 text-sm">
                        <span class="material-symbols-outlined text-primary text-[20px]">diamond</span>
                        Cheksiz ko'rishlar
                    </li>
                    <li class="flex items-center gap-3 text-white/80 text-sm">
                        <span class="material-symbols-outlined text-primary text-[20px]">diamond</span>
                        Poiskda yuqorida turish
                    </li>
                    <li class="flex items-center gap-3 text-white/80 text-sm">
                        <span class="material-symbols-outlined text-primary text-[20px]">diamond</span>
                        VIP badge (Special)
                    </li>
                    <li class="flex items-center gap-3 text-white/80 text-sm">
                        <span class="material-symbols-outlined text-primary text-[20px]">diamond</span>
                        Shaxsiy menejer 24/7
                    </li>
                </ul>
                {% if active_tariff %}
                <button disabled class="w-full h-14 bg-white/5 border border-white/10 rounded-xl text-white/40 font-bold text-sm tracking-wide cursor-not-allowed">
                    Aktiv obuna mavjud
                </button>
                {% else %}
                <button onclick="selectTariff('VIP', 250000)" class="w-full h-14 bg-primary text-white font-extrabold text-sm tracking-widest uppercase rounded-xl shadow-lg shadow-primary/30">
                    Hozir yoqish
                </button>
                {% endif %}
            </div>
        </div>
        
        <!-- SectionHeader & BodyText -->
        <footer class="relative z-10 mt-12 px-8 pb-10 flex flex-col items-center gap-4">
            <div class="flex items-center gap-2 text-primary">
                <span class="material-symbols-outlined text-sm">verified_user</span>
                <h4 class="text-xs font-semibold uppercase tracking-widest opacity-80">Barcha tariflar xavfsiz</h4>
            </div>
            <p class="text-white/40 text-xs text-center leading-relaxed max-w-[280px]">
                Obunani istalgan vaqtda shaxsiy kabinet orqali bekor qilishingiz mumkin. To'lovlar xavfsiz kanallar orqali amalga oshiriladi.
            </p>
            <div class="mt-4 flex gap-6 text-[10px] uppercase tracking-widest font-medium text-white/30">
                <a href="#">Shartlar</a>
                <a href="#">Maxfiylik</a>
                <a href="#">Yordam</a>
            </div>
        </footer>
    </div>
    
    <!-- Payment Modal -->
    <div id="payment-modal" class="hidden fixed inset-0 z-50 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="glass-card rounded-2xl p-6 max-w-md w-full max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-white">To'lov ma'lumotlari</h3>
                <button onclick="closePaymentModal()" class="text-white/60 hover:text-white">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            
            <div class="space-y-4">
                <div class="bg-white/5 rounded-xl p-4 border border-white/10">
                    <p class="text-white/60 text-xs uppercase tracking-wider mb-2">Tanlangan tarif</p>
                    <p id="selected-tariff-name" class="text-white text-lg font-bold"></p>
                    <p id="selected-tariff-price" class="text-primary text-2xl font-bold mt-2"></p>
                </div>
                
                <div class="bg-white/5 rounded-xl p-4 border border-white/10">
                    <p class="text-white/60 text-xs uppercase tracking-wider mb-2">To'lov karta raqami</p>
                    <div class="flex items-center gap-3">
                        <span class="text-white text-lg font-mono" id="card-number">{{ card_number }}</span>
                        <button onclick="copyCardNumber()" class="text-primary hover:text-primary/80">
                            <span class="material-symbols-outlined text-[20px]">content_copy</span>
                        </button>
                    </div>
                    <p class="text-white/40 text-xs mt-2" id="card-name">{{ card_name }}</p>
                </div>
                
                <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-xl p-4">
                    <p class="text-yellow-400 text-sm font-semibold mb-2">⚠️ Muhim</p>
                    <p class="text-white/80 text-xs leading-relaxed">
                        To'lov chekini Telegram botga yuboring. Admin tekshirgach sizga obuna beriladi.
                    </p>
                </div>
                
                <div class="space-y-3">
                    <label class="block">
                        <p class="text-white/60 text-xs uppercase tracking-wider mb-2">To'lov cheki rasmi *</p>
                        <div class="relative">
                            <input type="file" id="receipt-image" accept="image/*" class="hidden" onchange="handleImageSelect(event)">
                            <label for="receipt-image" class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-white/20 rounded-xl cursor-pointer bg-white/5 hover:bg-white/10 transition-all">
                                <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                    <span class="material-symbols-outlined text-white/40 text-[40px] mb-2">image</span>
                                    <p class="mb-2 text-sm text-white/60">
                                        <span class="font-semibold text-primary">Rasm yuklash</span> yoki bu yerga bosing
                                    </p>
                                    <p class="text-xs text-white/40">PNG, JPG yoki JPEG (MAX. 5MB)</p>
                                </div>
                            </label>
                            <div id="image-preview" class="hidden mt-3 relative">
                                <img id="preview-img" src="" alt="Preview" class="w-full h-48 object-cover rounded-xl border border-white/10">
                                <button onclick="removeImage()" class="absolute top-2 right-2 bg-red-500/80 text-white rounded-full p-2 hover:bg-red-500 transition-all">
                                    <span class="material-symbols-outlined text-[18px]">close</span>
                                </button>
                            </div>
                        </div>
                    </label>
                    
                    <label class="block">
                        <p class="text-white/60 text-xs uppercase tracking-wider mb-2">Qo'shimcha xabar (ixtiyoriy)</p>
                        <textarea id="payment-message" class="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-white text-sm focus:outline-none focus:border-primary/50" rows="3" placeholder="To'lov haqida qo'shimcha ma'lumot..."></textarea>
                    </label>
                </div>
                
                <div class="flex gap-3">
                    <button onclick="closePaymentModal()" class="flex-1 h-12 bg-white/5 border border-white/10 rounded-xl text-white font-semibold text-sm hover:bg-white/10 transition-all">
                        Bekor qilish
                    </button>
                    <button onclick="submitPayment()" id="submit-payment-btn" class="flex-1 h-12 bg-primary text-white font-bold text-sm rounded-xl hover:bg-primary/90 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                        Yuborish
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // User telegram_id ni saqlash (Jinja2 dan)
        const userTelegramId = {{ user.telegram_id if user and user.telegram_id else 'null' }};
        
        let selectedTariff = null;
        let selectedPrice = null;
        let selectedImage = null;
        
        // Tariflar sahifasini yopish va SPA ga qaytish
        function closeTariffPage() {
            // Telegram Mini App ichida bo'lsa
            if (window.Telegram && window.Telegram.WebApp) {
                // Agar orqaga qaytish mumkin bo'lsa
                if (window.Telegram.WebApp.BackButton) {
                    window.Telegram.WebApp.BackButton.hide();
                }
            }
            
            // SPA sahifasiga qaytish - user_id ni topish
            let user_id = null;
            
            // 1. URL parametridan
            user_id = new URLSearchParams(window.location.search).get('user_id');
            
            // 2. Telegram WebApp dan
            if (!user_id && window.Telegram && window.Telegram.WebApp) {
                if (window.Telegram.WebApp.initDataUnsafe && 
                    window.Telegram.WebApp.initDataUnsafe.user && 
                    window.Telegram.WebApp.initDataUnsafe.user.id) {
                    user_id = window.Telegram.WebApp.initDataUnsafe.user.id;
                }
            }
            
            // 3. Sahifada saqlangan telegram_id dan
            if (!user_id && userTelegramId) {
                user_id = userTelegramId;
            }
            
            // SPA sahifasiga qaytish
            if (user_id) {
                window.location.href = `/?user_id=${user_id}`;
            } else {
                // Agar user_id topilmasa, xatolik ko'rsatish
                alert('Xatolik: Foydalanuvchi ma\'lumotlari topilmadi. Iltimos, Telegram bot orqali kiring.');
            }
        }
        
        function selectTariff(tariffName, price) {
            selectedTariff = tariffName;
            selectedPrice = price;
            
            document.getElementById('selected-tariff-name').textContent = tariffName;
            document.getElementById('selected-tariff-price').textContent = price.toLocaleString('uz-UZ') + ' UZS';
            
            document.getElementById('payment-modal').classList.remove('hidden');
        }
        
        function closePaymentModal() {
            document.getElementById('payment-modal').classList.add('hidden');
            selectedTariff = null;
            selectedPrice = null;
            selectedImage = null;
            document.getElementById('receipt-image').value = '';
            document.getElementById('image-preview').classList.add('hidden');
            document.getElementById('submit-payment-btn').disabled = false;
        }
        
        function copyCardNumber() {
            const cardNumber = document.getElementById('card-number').textContent;
            navigator.clipboard.writeText(cardNumber.replace(/\s/g, '')).then(() => {
                alert('Karta raqami nusxalandi!');
            });
        }
        
        function handleImageSelect(event) {
            const file = event.target.files[0];
            if (file) {
                // Fayl hajmini tekshirish (5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('Rasm hajmi 5MB dan katta bo\'lishi mumkin emas!');
                    event.target.value = '';
                    return;
                }
                
                // Rasm formatini tekshirish
                if (!file.type.startsWith('image/')) {
                    alert('Faqat rasm fayllari qabul qilinadi!');
                    event.target.value = '';
                    return;
                }
                
                selectedImage = file;
                
                // Preview ko'rsatish
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('preview-img').src = e.target.result;
                    document.getElementById('image-preview').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }
        
        function removeImage() {
            selectedImage = null;
            document.getElementById('receipt-image').value = '';
            document.getElementById('image-preview').classList.add('hidden');
        }
        
        function submitPayment() {
            if (!selectedImage) {
                alert('Iltimos, to\'lov cheki rasmini yuklang!');
                return;
            }
            
            const message = document.getElementById('payment-message').value;
            const submitBtn = document.getElementById('submit-payment-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Yuborilmoqda...';
            
            // FormData yaratish
            const formData = new FormData();
            formData.append('tariff_name', selectedTariff);
            formData.append('amount', selectedPrice);
            formData.append('message', message);
            formData.append('receipt_image', selectedImage);
            
            // To'lov so'rovini yaratish va rasmni yuborish
            fetch('/tariff/api/create-payment-request', {
                method: 'POST',
                credentials: 'same-origin',
                body: formData
            }).then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('✅ To\'lov so\'rovi yuborildi! Admin tekshirgach sizga xabar beriladi.');
                    closePaymentModal();
                } else {
                    alert(data.error || 'Xatolik yuz berdi');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Yuborish';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Xatolik yuz berdi');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Yuborish';
            });
        }
    </script>
</body>
</html>
