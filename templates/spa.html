<!DOCTYPE html>
<html class="dark" lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NIKOH - Halol tanishuv</title>
    <!-- Preconnect: CDN va API uchun ulanishni tezlashtirish -->
    <link rel="preconnect" href="https://cdn.tailwindcss.com" crossorigin>
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
    
    <!-- Tailwind Config -->
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#40ff00",
                        "background-dark": "#0a0a0b",
                    },
                    fontFamily: {
                        "display": ["Manrope", "sans-serif"]
                    },
                    borderRadius: {
                        "2xl": "24px",
                    },
                },
            },
        }
    </script>
    
    <!-- Custom Styles -->
    <style type="text/tailwindcss">
        @layer base {
            html, body {
                -webkit-text-size-adjust: 100%;
                touch-action: manipulation;
                overscroll-behavior: none;
            }
            body {
                @apply select-none;
            }
            input, textarea {
                -webkit-user-select: text;
                user-select: text;
            }
        }
        @layer components {
            .glass-card {
                background: rgba(255, 255, 255, 0.03);
                backdrop-filter: blur(24px);
                -webkit-backdrop-filter: blur(24px);
                border: 1px solid rgba(255, 255, 255, 0.1);
                box-shadow: inset 0 1px 1px rgba(255, 255, 255, 0.05);
            }
            .glass-row {
                background: rgba(255, 255, 255, 0.02);
                backdrop-filter: blur(12px);
                -webkit-backdrop-filter: blur(12px);
                border: 1px solid rgba(255, 255, 255, 0.05);
            }
            .glass-strip {
                background: rgba(0, 0, 0, 0.85);
                backdrop-filter: blur(12px);
                -webkit-backdrop-filter: blur(12px);
                border-top: 1px solid rgba(255, 255, 255, 0.08);
            }
            .neon-glow {
                box-shadow: 0 0 12px rgba(64, 255, 0, 0.2);
            }
            .search-glass {
                background: rgba(255, 255, 255, 0.04);
                border: 1px solid rgba(255, 255, 255, 0.08);
            }
            .glass-input {
                @apply bg-[#1a1a1c] border border-white/[0.08] focus:border-primary/50 outline-none;
            }
            .card-bg {
                @apply bg-[#141416];
            }
            .ios-scroll-hide::-webkit-scrollbar {
                display: none;
            }
            .ios-scroll-hide {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
            .profile-gradient {
                background: linear-gradient(to top, rgba(10, 10, 11, 1) 0%, rgba(10, 10, 11, 0.95) 15%, rgba(10, 10, 11, 0.4) 50%, transparent 100%);
            }
            .tag-premium {
                background: rgba(20, 20, 22, 0.92);
                backdrop-filter: blur(12px);
                border: 1px solid rgba(255, 255, 255, 0.25);
            }
            .tag-premium-dark {
                background: rgba(0, 0, 0, 0.75);
                backdrop-filter: blur(16px);
                -webkit-backdrop-filter: blur(16px);
                border: 1px solid rgba(255, 255, 255, 0.12);
            }
            .tag-premium-darker {
                background: rgba(0, 0, 0, 0.65);
                backdrop-filter: blur(12px);
                -webkit-backdrop-filter: blur(12px);
                border: 1px solid rgba(255, 255, 255, 0.12);
            }
            .status-pending {
                background: rgba(64, 255, 0, 0.08);
                border: 1px solid rgba(64, 255, 0, 0.3);
                color: #40ff00;
                text-shadow: 0 0 10px rgba(64, 255, 0, 0.3);
            }
            .status-rejected {
                background: rgba(255, 64, 64, 0.08);
                border: 1px solid rgba(255, 64, 64, 0.3);
                color: #ff4040;
                text-shadow: 0 0 10px rgba(255, 64, 64, 0.3);
            }
            .active-neon-btn {
                background: rgba(64, 255, 0, 0.1);
                border-color: rgba(64, 255, 0, 0.4);
                box-shadow: 0 0 15px rgba(64, 255, 0, 0.15);
            }
            .badge-neon {
                background: #40ff00;
                box-shadow: 0 0 8px rgba(64, 255, 0, 0.6);
            }
            .action-glass {
                background: rgba(10, 10, 11, 0.6);
                backdrop-filter: blur(16px);
                -webkit-backdrop-filter: blur(16px);
                border: 1px solid rgba(255, 255, 255, 0.15);
            }
            .timer-badge {
                background: rgba(64, 255, 0, 0.1);
                border: 1px solid rgba(64, 255, 0, 0.3);
                color: #40ff00;
            }
            .glass-effect {
                backdrop-filter: blur(12px);
                -webkit-backdrop-filter: blur(12px);
                border: 1px solid rgba(255, 255, 255, 0.1);
            }
            .glow-primary {
                box-shadow: 0 0 15px rgba(64, 255, 0, 0.4);
            }
            .glow-text {
                text-shadow: 0 0 8px rgba(64, 255, 0, 0.6);
            }
            .neon-text-glow {
                text-shadow: 0 0 10px rgba(64, 255, 0, 0.5);
            }
            .custom-scrollbar::-webkit-scrollbar {
                width: 0px;
            }
            .skeleton {
                background: linear-gradient(90deg, rgba(255, 255, 255, 0.05) 25%, rgba(255, 255, 255, 0.1) 50%, rgba(255, 255, 255, 0.05) 75%);
                background-size: 200% 100%;
                animation: skeleton-loading 1.5s ease-in-out infinite;
            }
            @keyframes skeleton-loading {
                0% { background-position: 200% 0; }
                100% { background-position: -200% 0; }
            }
            .glass-item {
                background: rgba(255, 255, 255, 0.04);
                backdrop-filter: blur(12px);
                -webkit-backdrop-filter: blur(12px);
                border: 1px solid rgba(255, 255, 255, 0.06);
                transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            }
            .glass-item:active {
                background: rgba(255, 255, 255, 0.08);
                transform: scale(0.985);
            }
            .toggle-pill {
                @apply w-12 h-6 rounded-full relative transition-colors duration-300;
            }
            .toggle-circle {
                @apply absolute top-1 left-1 w-4 h-4 bg-white rounded-full transition-transform duration-300 shadow-sm;
            }
            input:checked + .toggle-pill {
                @apply bg-primary;
            }
            input:checked + .toggle-pill .toggle-circle {
                @apply translate-x-6 bg-black;
            }
            .bottom-sheet {
                @apply fixed bottom-0 left-0 w-full bg-[#111112] rounded-t-[2.5rem] border-t border-white/[0.1] z-50 transform translate-y-full transition-transform duration-300;
            }
            .bottom-sheet.active {
                @apply translate-y-0;
            }
            .handle {
                @apply w-12 h-1.5 bg-white/20 rounded-full mx-auto my-4;
            }
            .ios-row {
                @apply flex items-center justify-between py-5 px-6 active:bg-white/[0.05] transition-colors border-b border-white/[0.04];
            }
            .chip {
                @apply px-5 py-2.5 rounded-full text-xs font-bold uppercase tracking-wider transition-all duration-200 border;
            }
            .chip-unselected {
                @apply bg-white/5 border-white/5 text-white/40;
            }
            .chip-selected {
                @apply bg-primary/10 border-primary/30 text-primary;
            }
            .radio-item {
                @apply flex items-center justify-between p-4 rounded-2xl bg-white/[0.03] border border-white/[0.05] active:scale-[0.98] transition-all;
            }
            .radio-item-selected {
                @apply border-primary/30 bg-primary/5;
            }
            .custom-checkbox {
                @apply appearance-none size-6 rounded-lg border-2 border-white/10 bg-white/5 checked:bg-primary checked:border-primary transition-all relative cursor-pointer;
            }
            .custom-checkbox:checked::after {
                content: '\e5ca';
                font-family: 'Material Symbols Outlined';
                @apply absolute inset-0 flex items-center justify-center text-black text-[18px] font-bold;
            }
            .status-card {
                @apply relative flex flex-col items-center justify-center p-4 rounded-2xl border border-white/[0.05] bg-white/[0.02] transition-all duration-200 active:scale-95 overflow-hidden;
            }
            .status-card.selected {
                @apply border-primary/40 bg-primary/5;
            }
            .tag-active {
                @apply bg-primary text-black font-bold border-primary shadow-[0_0_15px_rgba(64,255,0,0.2)];
            }
            .tag-inactive {
                @apply bg-white/[0.05] text-white/60 border-white/[0.05] hover:bg-white/[0.08];
            }
            .vertical-dial {
                @apply relative h-48 w-16 bg-white/[0.02] border border-white/[0.05] rounded-2xl overflow-hidden flex flex-col items-center justify-center;
            }
            .dial-tick {
                @apply w-4 h-[1px] bg-white/10 my-1.5;
            }
            .dial-tick-active {
                @apply w-8 h-[2px] bg-primary/50 my-1.5 neon-glow;
            }
            /* iOS-style Picker Dial - Rasmga 1:1 mos */
            .ios-dial-wrapper {
                @apply flex flex-col items-center;
            }
            .ios-dial-title {
                @apply text-xs font-bold text-white/50 uppercase tracking-[0.15em] mb-2;
            }
            .ios-dial {
                @apply relative overflow-hidden;
                width: 5rem;
                height: 18rem;
                border-radius: 2rem;
                background: rgba(255,255,255,0.02);
                border: 1px solid rgba(255,255,255,0.06);
            }
            .ios-dial-track {
                @apply absolute inset-0;
                overflow: hidden;
                touch-action: pan-y;
            }
            .ios-dial-items {
                @apply absolute w-full;
                left: 0;
                will-change: transform;
                transition: transform 0.08s ease-out;
            }
            .ios-dial-item {
                height: 2.5rem;
                @apply flex items-center justify-center text-lg font-bold select-none;
                color: rgba(255,255,255,0.12);
                transition: color 0.1s, transform 0.1s, opacity 0.1s;
            }
            .ios-dial-item[data-offset="0"] {
                color: #40ff00;
                font-size: 2rem;
                font-weight: 900;
                text-shadow: 0 0 20px rgba(64,255,0,0.4);
            }
            .ios-dial-item[data-offset="1"], .ios-dial-item[data-offset="-1"] {
                color: rgba(255,255,255,0.25);
                font-size: 1.1rem;
            }
            .ios-dial-item[data-offset="2"], .ios-dial-item[data-offset="-2"] {
                color: rgba(255,255,255,0.15);
                font-size: 1rem;
            }
            /* Tick marks - rasmdagidek */
            .ios-dial-ticks {
                @apply absolute inset-0 flex flex-col items-center justify-center pointer-events-none z-10;
                gap: 0.75rem;
            }
            .ios-dial-tick {
                width: 1.5rem;
                height: 2px;
                background: rgba(255,255,255,0.08);
                border-radius: 1px;
            }
            .ios-dial-tick.glow {
                width: 2rem;
                height: 3px;
                background: rgba(64,255,0,0.5);
                box-shadow: 0 0 10px rgba(64,255,0,0.3);
            }
            /* Top/bottom fade */
            .ios-dial-fade-top, .ios-dial-fade-bottom {
                @apply absolute left-0 right-0 pointer-events-none z-20;
                height: 5rem;
            }
            .ios-dial-fade-top {
                top: 0;
                background: linear-gradient(to bottom, #0f0f11 0%, transparent 100%);
            }
            .ios-dial-fade-bottom {
                bottom: 0;
                background: linear-gradient(to top, #0f0f11 0%, transparent 100%);
            }
            .ios-dial-label {
                @apply text-xs font-bold text-white/40 mt-3;
            }
            /* Dual Range Slider */
            .salary-slider-thumb {
                position: absolute;
                top: 50%;
                transform: translate(-50%, -50%);
                width: 1.5rem;
                height: 1.5rem;
                background: white;
                border: 4px solid #0f0f11;
                border-radius: 50%;
                cursor: grab;
                box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                z-index: 10;
                transition: transform 0.1s;
            }
            .salary-slider-thumb:active {
                cursor: grabbing;
                transform: translate(-50%, -50%) scale(1.15);
            }
            .salary-slider-thumb::after {
                content: '';
                position: absolute;
                inset: -8px;
            }
            .chip-active {
                @apply bg-primary text-black font-bold;
            }
            .requests-tab-icon-only {
                width: 2.5rem;
                min-width: 2.5rem;
                padding-left: 0;
                padding-right: 0;
            }
            .chip-inactive {
                @apply bg-white/[0.05] text-white/60 border border-white/[0.05];
            }
            .feed-gender-kuyov { background: rgba(64, 255, 0, 0.15); border: 1px solid rgba(64, 255, 0, 0.5); color: #22c55e; }
            .feed-gender-kelin { background: rgba(236, 72, 153, 0.2); border: 1px solid rgba(236, 72, 153, 0.5); color: #ec4899; }
            .feed-gender-inactive { background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); color: rgba(255,255,255,0.5); }
            .sort-option-active {
                background: rgba(64, 255, 0, 0.12);
                border-color: rgba(64, 255, 0, 0.5);
                box-shadow: 0 0 20px rgba(64, 255, 0, 0.1);
            }
            .gold-gradient {
                background: linear-gradient(135deg, #FFD700 0%, #FFA500 50%, #FF8C00 100%);
            }
            #app-container { position: relative; min-height: 100vh; }
            .page-container {
                position: absolute;
                top: 0; left: 0; right: 0;
                min-height: 100%;
                opacity: 0;
                visibility: hidden;
                transform: scale(0.96);
                pointer-events: none;
                transition: opacity 0.1s ease-out, transform 0.2s ease-out, visibility 0s linear 0.1s;
            }
            .page-container.active {
                opacity: 1;
                visibility: visible;
                transform: scale(1);
                pointer-events: auto;
                transition-delay: 0s;
            }
            .page-container.page-leave {
                opacity: 0;
                transform: scale(0.99);
                transition-duration: 0.1s;
                transition-delay: 0s;
            }
            /* Chat view sahifasida navbar'ni yashirish */
            #page-chat-view.active ~ nav,
            body:has(#page-chat-view.active) nav {
                display: none !important;
            }
            /* Tugma/card bosilish effekti — tez va yoqimli */
            .page-container button,
            .page-container a[href],
            .page-container [role="button"],
            .page-container [onclick] {
                -webkit-tap-highlight-color: transparent;
                transition: transform 0.1s ease-out, opacity 0.1s ease-out;
            }
            .page-container button:active,
            .page-container a:active,
            .page-container [role="button"]:active {
                transform: scale(0.97);
            }
            /* Onboarding styles */
            .onboarding-dot {
                @apply size-2 rounded-full bg-white/20 transition-all duration-300;
            }
            .onboarding-dot.active {
                @apply w-8 bg-primary;
            }
            .onboarding-dot.completed {
                @apply bg-primary/60;
            }
            .onboarding-step {
                @apply absolute inset-0 opacity-0 pointer-events-none transition-all duration-300;
                transform: translateX(30px);
            }
            .onboarding-step.active {
                @apply opacity-100 pointer-events-auto;
                transform: translateX(0);
            }
            .onboarding-step.prev {
                transform: translateX(-30px);
            }
            .onboarding-option-card {
                @apply cursor-pointer block;
            }
            .onboarding-option-card .card-inner {
                @apply glass-card rounded-2xl p-5 flex flex-col items-center justify-center text-center transition-all duration-200 border border-transparent;
            }
            .onboarding-option-card input:checked + .card-inner {
                @apply border-primary bg-primary/10;
            }
            .onboarding-option-card input:checked + .card-inner .material-symbols-outlined {
                @apply text-primary;
            }
            .onboarding-option-card.small .card-inner {
                @apply p-4;
            }
            .onboarding-chip {
                @apply cursor-pointer block;
            }
            .onboarding-chip span {
                @apply glass-card rounded-xl py-3 px-4 text-sm font-semibold text-center block transition-all duration-200 border border-transparent;
            }
            .onboarding-chip input:checked + span {
                @apply border-primary bg-primary/10 text-primary;
            }
            .onboarding-list-option {
                @apply cursor-pointer glass-card rounded-2xl p-4 flex items-center justify-between transition-all duration-200 border border-transparent;
            }
            .onboarding-list-option .option-content {
                @apply flex items-center gap-3 text-white/80;
            }
            .onboarding-list-option .check-icon {
                @apply text-transparent text-xl transition-colors;
            }
            .onboarding-list-option input:checked ~ .option-content {
                @apply text-primary;
            }
            .onboarding-list-option:has(input:checked) {
                @apply border-primary/40 bg-primary/5;
            }
            .onboarding-list-option:has(input:checked) .check-icon {
                @apply text-primary;
            }
            @keyframes shake {
                0%, 100% { transform: translateX(0); }
                20%, 60% { transform: translateX(-5px); }
                40%, 80% { transform: translateX(5px); }
            }
            .shake {
                animation: shake 0.4s ease-in-out;
            }
        }
    </style>
    
    <style>
        html { height: 100%; overflow-x: hidden; }
        body {
            min-height: 100dvh;
            height: 100%;
            overflow-x: hidden;
            overflow-y: auto;
            overscroll-behavior-y: contain;
            -webkit-overflow-scrolling: touch;
        }
        body.feed-modal-open {
            overflow: hidden !important;
            position: fixed !important;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
            width: 100%;
        }
        main {
            padding-bottom: 120px;
        }
        ::-webkit-scrollbar {
            display: none;
        }
        .logo-text {
            letter-spacing: 0.15em;
            font-weight: 800;
        }
        /* Yangi e'lon: to'ldirilgan bo'lim — rangli, to'ldirilmagan — oddiy */
        .add-listing-section-complete {
            border-color: rgba(23, 130, 77, 0.35);
            background: linear-gradient(135deg, rgba(23, 130, 77, 0.08) 0%, rgba(23, 130, 77, 0.02) 100%);
        }
        .add-listing-section-complete .add-listing-section-icon {
            background: rgba(23, 130, 77, 0.15);
            color: rgb(23, 130, 77);
            border-color: rgba(23, 130, 77, 0.3);
        }
        .add-listing-section-complete .text-white\/50 {
            color: rgba(23, 130, 77, 0.85);
        }
    </style>

    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body class="font-display bg-background-dark text-white selection:bg-primary/30">
    <!-- App Container -->
    <div id="app-container" class="min-h-screen">
        <!-- Navigation -->
        <nav class="fixed bottom-6 left-1/2 -translate-x-1/2 w-[92%] max-w-md z-50">
            <div class="glass-card rounded-full p-2 flex items-center justify-between shadow-[0_20px_50px_rgba(0,0,0,0.5)] bg-black/80 border-white/10">
                <a href="#" data-page="feed" class="nav-link flex-1 flex flex-col items-center justify-center py-1 text-primary">
                    <span class="material-symbols-outlined text-[24px]" style="font-variation-settings: 'FILL' 1">home</span>
                    <span class="text-[8px] font-black mt-0.5 uppercase tracking-widest">Asosiy</span>
                </a>
                <a href="#" data-page="chats" class="nav-link flex-1 flex flex-col items-center justify-center py-1 text-white/30 hover:text-white">
                    <span class="material-symbols-outlined text-[24px]">chat_bubble</span>
                    <span class="text-[8px] font-black mt-0.5 uppercase tracking-widest">Xabarlar</span>
                </a>
                <a href="#" data-page="favorites" class="nav-link flex-1 flex flex-col items-center justify-center py-1 text-white/30 hover:text-white">
                    <span class="material-symbols-outlined text-[24px]">favorite</span>
                    <span class="text-[8px] font-black mt-0.5 uppercase tracking-widest">Sevimli</span>
                </a>
                <a href="#" data-page="profile" class="nav-link flex-1 flex flex-col items-center justify-center py-1 text-white/30 hover:text-white">
                    <span class="material-symbols-outlined text-[24px]">person</span>
                    <span class="text-[8px] font-black mt-0.5 uppercase tracking-widest">Profil</span>
                </a>
            </div>
        </nav>

        <!-- Yuklanish oynasi ishlatilmaydi: user cache bilan darhol ishlaydi, orqada yangi ma'lumot yuklanadi -->
        <div id="app-loading-overlay" class="fixed inset-0 z-[100] bg-background-dark hidden flex-col items-center justify-center">
            <div class="flex flex-col items-center gap-4">
                <div class="size-12 border-2 border-primary/40 border-t-primary rounded-full animate-spin"></div>
                <p class="text-white/70 text-sm font-bold">Yuklanmoqda...</p>
            </div>
        </div>

        <!-- ONBOARDING OVERLAY -->
        <div id="onboarding-overlay" class="fixed inset-0 z-50 bg-background-dark flex flex-col max-w-md mx-auto w-full hidden">
            <!-- 1. Ilovani tanishtirish (birinchi ochilganda) -->
            <div id="welcome-screen" class="flex-1 flex flex-col items-center justify-center px-8 py-10 hidden">
                <div class="size-24 mx-auto mb-6 rounded-3xl bg-gradient-to-br from-primary/30 to-primary/10 flex items-center justify-center neon-glow">
                    <span class="material-symbols-outlined text-primary text-5xl" style="font-variation-settings: 'FILL' 1">favorite</span>
                </div>
                <h1 class="text-2xl font-extrabold text-center mb-2">NIKOH</h1>
                <p class="text-primary font-bold text-sm tracking-widest uppercase mb-4">Halol tanishuv</p>
                <p class="text-white/70 text-center text-sm leading-relaxed max-w-xs mb-8">
                    Bizning ilovada e'lonlarni bepul ko'rishingiz, sevimliga saqlashingiz mumkin. So'rov yuborish va o'z e'loningizni joylash uchun to'liq profil to'ldiring va tarif sotib oling.
                </p>
                <button type="button" id="welcome-start-btn" class="w-full bg-primary text-black font-black py-4 rounded-2xl text-sm tracking-[0.22em] uppercase shadow-[0_10px_30px_rgba(64,255,0,0.3)] hover:scale-[1.02] active:scale-[0.98] transition-all">
                    BOSHLASH
                </button>
            </div>

            <!-- 2. Oddiy ro'yxatdan o'tish (telefon, ism, yosh, jins) -->
            <form id="simple-reg-form" class="flex-1 flex flex-col overflow-hidden hidden">
                <header class="px-6 pt-6 pb-4">
                    <button type="button" id="simple-reg-back" class="size-10 glass-card rounded-xl flex items-center justify-center active:scale-95 transition-transform mb-4">
                        <span class="material-symbols-outlined text-white/80 text-xl">arrow_back</span>
                    </button>
                    <h2 class="text-lg font-bold text-center">Ro'yxatdan o'tish</h2>
                    <p class="text-[11px] text-white/50 text-center mt-1">Telefon, ism, yosh va jinsingizni kiriting</p>
                </header>
                <div class="flex-1 overflow-y-auto ios-scroll-hide px-6 pb-6 space-y-5">
                    <div>
                        <label class="block text-[11px] font-black uppercase tracking-[0.2em] text-white/60 mb-2">Telefon raqam</label>
                        <input type="tel" name="phone_number" id="simple-phone" required class="w-full glass-card glass-input rounded-2xl px-4 py-4 text-base" placeholder="+998 90 123 45 67">
                    </div>
                    <div>
                        <label class="block text-[11px] font-black uppercase tracking-[0.2em] text-white/60 mb-2">Ismingiz</label>
                        <input type="text" name="name" id="simple-name" required class="w-full glass-card glass-input rounded-2xl px-4 py-4 text-base" placeholder="Ismingizni kiriting">
                    </div>
                    <div>
                        <label class="block text-[11px] font-black uppercase tracking-[0.2em] text-white/60 mb-2">Tug'ilgan yil (yosh)</label>
                        <select name="birth_year" id="simple-birth_year" required class="w-full glass-card glass-input rounded-2xl px-4 py-4 text-base">
                            <option value="">Yilni tanlang</option>
                            {% for year in range(2006, 1959, -1) %}
                            <option value="{{ year }}">{{ year }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-[11px] font-black uppercase tracking-[0.2em] text-white/60 mb-3">Jinsingiz</label>
                        <div class="grid grid-cols-2 gap-3">
                            <label class="onboarding-option-card">
                                <input type="radio" name="gender" value="Erkak" required class="hidden">
                                <div class="card-inner">
                                    <span class="material-symbols-outlined text-2xl mb-2">male</span>
                                    <span class="font-bold">Erkak</span>
                                </div>
                            </label>
                            <label class="onboarding-option-card">
                                <input type="radio" name="gender" value="Ayol" required class="hidden">
                                <div class="card-inner">
                                    <span class="material-symbols-outlined text-2xl mb-2">female</span>
                                    <span class="font-bold">Ayol</span>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="p-6 bg-gradient-to-t from-background-dark via-background-dark to-transparent">
                    <button type="submit" id="simple-reg-submit" class="w-full bg-primary text-black font-black py-4 rounded-2xl text-sm tracking-[0.22em] uppercase shadow-[0_10px_30px_rgba(64,255,0,0.3)] hover:scale-[1.02] active:scale-[0.98] transition-all">
                        DAVOM ETISH
                    </button>
                </div>
            </form>

            <!-- 3. To'liq profil (5 qadam - so'rov yuborish / e'lon joylash uchun) -->
            <form id="onboarding-form" class="flex-1 flex flex-col overflow-hidden hidden">
                <!-- Header with progress -->
                <header class="px-6 pt-6 pb-4">
                    <div class="flex items-center justify-between mb-4">
                        <button type="button" id="onboarding-back-btn" onclick="onboardingPrevStep()" class="size-10 glass-card rounded-xl flex items-center justify-center active:scale-95 transition-transform opacity-0 pointer-events-none">
                            <span class="material-symbols-outlined text-white/80 text-xl">arrow_back</span>
                        </button>
                        <div class="flex flex-col items-center">
                            <span class="text-[10px] font-black tracking-widest text-primary/60 uppercase">Qadam <span id="onboarding-step-num">1</span>/5</span>
                            <span id="onboarding-step-title" class="text-sm font-bold">Tanishib olaylik</span>
                        </div>
                        <div class="size-10"></div>
                    </div>
                    <!-- Progress dots -->
                    <div class="flex items-center justify-center gap-2">
                        <div class="onboarding-dot active"></div>
                        <div class="onboarding-dot"></div>
                        <div class="onboarding-dot"></div>
                        <div class="onboarding-dot"></div>
                        <div class="onboarding-dot"></div>
                    </div>
                </header>

                <!-- Steps container -->
                <div class="flex-1 overflow-hidden relative">
                    <!-- Step 1: Shaxsiy ma'lumotlar -->
                    <div class="onboarding-step active" data-step="1">
                        <div class="h-full overflow-y-auto ios-scroll-hide px-6 pb-6 space-y-5">
                            <div class="text-center mb-6">
                                <div class="size-20 mx-auto mb-4 rounded-3xl bg-gradient-to-br from-primary/20 to-primary/5 flex items-center justify-center">
                                    <span class="material-symbols-outlined text-primary text-4xl">person</span>
                                </div>
                                <h2 class="text-xl font-extrabold mb-1">Tanishib olaylik</h2>
                                <p class="text-sm text-white/50">O'zingiz haqingizda ma'lumot bering</p>
                            </div>
                            <div>
                                <label class="block text-[11px] font-black uppercase tracking-[0.2em] text-white/60 mb-2">Ismingiz</label>
                                <input name="name" required class="w-full glass-card glass-input rounded-2xl px-4 py-4 text-base" placeholder="Ismingizni kiriting">
                            </div>
                            <div>
                                <label class="block text-[11px] font-black uppercase tracking-[0.2em] text-white/60 mb-3">Jinsingiz</label>
                                <div class="grid grid-cols-2 gap-3">
                                    <label class="onboarding-option-card">
                                        <input type="radio" name="gender" value="Erkak" required class="hidden">
                                        <div class="card-inner">
                                            <span class="material-symbols-outlined text-2xl mb-2">male</span>
                                            <span class="font-bold">Erkak</span>
                                        </div>
                                    </label>
                                    <label class="onboarding-option-card">
                                        <input type="radio" name="gender" value="Ayol" required class="hidden">
                                        <div class="card-inner">
                                            <span class="material-symbols-outlined text-2xl mb-2">female</span>
                                            <span class="font-bold">Ayol</span>
                                        </div>
                                    </label>
                                </div>
                            </div>
                            <div>
                                <label class="block text-[11px] font-black uppercase tracking-[0.2em] text-white/60 mb-2">Tug'ilgan yil</label>
                                <select name="birth_year" required class="w-full glass-card glass-input rounded-2xl px-4 py-4 text-base">
                                    <option value="">Yilni tanlang</option>
                                    {% for year in range(2006, 1959, -1) %}
                                    <option value="{{ year }}">{{ year }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Joylashuv -->
                    <div class="onboarding-step" data-step="2">
                        <div class="h-full overflow-y-auto ios-scroll-hide px-6 pb-6 space-y-5">
                            <div class="text-center mb-6">
                                <div class="size-20 mx-auto mb-4 rounded-3xl bg-gradient-to-br from-primary/20 to-primary/5 flex items-center justify-center">
                                    <span class="material-symbols-outlined text-primary text-4xl">location_on</span>
                                </div>
                                <h2 class="text-xl font-extrabold mb-1">Qayerdansiz?</h2>
                                <p class="text-sm text-white/50">Joylashuvingiz haqida ma'lumot</p>
                            </div>
                            <div>
                                <label class="block text-[11px] font-black uppercase tracking-[0.2em] text-white/60 mb-2">Davlat</label>
                                <select name="country" id="onboarding-country" required class="w-full glass-card glass-input rounded-2xl px-4 py-4 text-base">
                                    <option value="">Davlatni tanlang</option>
                                    <!-- Davlatlar ro'yxati JS orqali LOCATION_COUNTRIES_REGIONS dan to'ldiriladi -->
                                </select>
                            </div>
                            <div>
                                <label class="block text-[11px] font-black uppercase tracking-[0.2em] text-white/60 mb-2">Viloyat / Shahar</label>
                                <select name="region" id="onboarding-region" required class="w-full glass-card glass-input rounded-2xl px-4 py-4 text-base">
                                    <option value="">Viloyatni tanlang</option>
                                    <option value="Toshkent shahar">Toshkent shahar</option>
                                    <option value="Toshkent viloyati">Toshkent viloyati</option>
                                    <option value="Samarqand">Samarqand</option>
                                    <option value="Buxoro">Buxoro</option>
                                    <option value="Andijon">Andijon</option>
                                    <option value="Farg'ona">Farg'ona</option>
                                    <option value="Namangan">Namangan</option>
                                    <option value="Qashqadaryo">Qashqadaryo</option>
                                    <option value="Surxondaryo">Surxondaryo</option>
                                    <option value="Xorazm">Xorazm</option>
                                    <option value="Navoiy">Navoiy</option>
                                    <option value="Jizzax">Jizzax</option>
                                    <option value="Sirdaryo">Sirdaryo</option>
                                    <option value="Qoraqalpog'iston">Qoraqalpog'iston</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-[11px] font-black uppercase tracking-[0.2em] text-white/60 mb-2">Millatingiz</label>
                                <select name="nationality" required class="w-full glass-card glass-input rounded-2xl px-4 py-4 text-base">
                                    <option value="">Millatni tanlang</option>
                                    <option value="O'zbek">O'zbek</option>
                                    <option value="Rus">Rus</option>
                                    <option value="Tojik">Tojik</option>
                                    <option value="Qozoq">Qozoq</option>
                                    <option value="Qoraqalpoq">Qoraqalpoq</option>
                                    <option value="Boshqa">Boshqa</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-[11px] font-black uppercase tracking-[0.2em] text-white/60 mb-3">Oilaviy holatingiz</label>
                                <div id="onboarding-marital-options" class="grid grid-cols-2 gap-3">
                                    <!-- Ayollar: Qiz bola, Beva, Ajrashgan. Erkaklar: Bo'ydoq, Oilali, Ajrashgan (JS to'ldiradi) -->
                                    <label class="onboarding-option-card">
                                        <input type="radio" name="marital_status" value="Bo'ydoq" required class="hidden">
                                        <div class="card-inner">
                                            <span class="material-symbols-outlined text-2xl mb-2">person</span>
                                            <span class="font-bold">Bo'ydoq</span>
                                        </div>
                                    </label>
                                    <label class="onboarding-option-card">
                                        <input type="radio" name="marital_status" value="Ajrashgan" class="hidden">
                                        <div class="card-inner">
                                            <span class="material-symbols-outlined text-2xl mb-2">group</span>
                                            <span class="font-bold">Ajrashgan</span>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Jismoniy va diniy -->
                    <div class="onboarding-step" data-step="3">
                        <div class="h-full overflow-y-auto ios-scroll-hide px-6 pb-6 space-y-5">
                            <div class="text-center mb-6">
                                <div class="size-20 mx-auto mb-4 rounded-3xl bg-gradient-to-br from-primary/20 to-primary/5 flex items-center justify-center">
                                    <span class="material-symbols-outlined text-primary text-4xl">self_improvement</span>
                                </div>
                                <h2 class="text-xl font-extrabold mb-1">Shaxsiy xususiyatlar</h2>
                                <p class="text-sm text-white/50">Jismoniy va diniy ma'lumotlar</p>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-[11px] font-black uppercase tracking-[0.2em] text-white/60 mb-2">Bo'yingiz</label>
                                    <select name="height" required class="w-full glass-card glass-input rounded-2xl px-4 py-4 text-base">
                                        <option value="">sm</option>
                                        {% for height in range(140, 220, 1) %}
                                        <option value="{{ height }}">{{ height }} sm</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-[11px] font-black uppercase tracking-[0.2em] text-white/60 mb-2">Vazningiz</label>
                                    <select name="weight" required class="w-full glass-card glass-input rounded-2xl px-4 py-4 text-base">
                                        <option value="">kg</option>
                                        {% for weight in range(40, 150, 1) %}
                                        <option value="{{ weight }}">{{ weight }} kg</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="block text-[11px] font-black uppercase tracking-[0.2em] text-white/60 mb-3">Namoz o'qiysizmi?</label>
                                <div class="flex gap-2">
                                    <label class="onboarding-chip flex-1">
                                        <input type="radio" name="prays" value="Ha" required class="hidden">
                                        <span>Ha</span>
                                    </label>
                                    <label class="onboarding-chip flex-1">
                                        <input type="radio" name="prays" value="Ba'zan" class="hidden">
                                        <span>Ba'zan</span>
                                    </label>
                                    <label class="onboarding-chip flex-1">
                                        <input type="radio" name="prays" value="Yo'q" class="hidden">
                                        <span>Yo'q</span>
                                    </label>
                                </div>
                            </div>
                            <div>
                                <label class="block text-[11px] font-black uppercase tracking-[0.2em] text-white/60 mb-3">Ro'za tutasizmi?</label>
                                <div class="flex gap-2">
                                    <label class="onboarding-chip flex-1">
                                        <input type="radio" name="fasts" value="Ha" required class="hidden">
                                        <span>Ha</span>
                                    </label>
                                    <label class="onboarding-chip flex-1">
                                        <input type="radio" name="fasts" value="Ba'zan" class="hidden">
                                        <span>Ba'zan</span>
                                    </label>
                                    <label class="onboarding-chip flex-1">
                                        <input type="radio" name="fasts" value="Yo'q" class="hidden">
                                        <span>Yo'q</span>
                                    </label>
                                </div>
                            </div>
                            <div>
                                <label class="block text-[11px] font-black uppercase tracking-[0.2em] text-white/60 mb-3">Diniy darajangiz</label>
                                <div class="flex gap-2">
                                    <label class="onboarding-chip flex-1">
                                        <input type="radio" name="religious_level" value="Jiddiy" required class="hidden">
                                        <span>Jiddiy</span>
                                    </label>
                                    <label class="onboarding-chip flex-1">
                                        <input type="radio" name="religious_level" value="O'rtacha" class="hidden">
                                        <span>O'rtacha</span>
                                    </label>
                                    <label class="onboarding-chip flex-1">
                                        <input type="radio" name="religious_level" value="Yengil" class="hidden">
                                        <span>Yengil</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 4: Ta'lim va kasb -->
                    <div class="onboarding-step" data-step="4">
                        <div class="h-full overflow-y-auto ios-scroll-hide px-6 pb-6 space-y-5">
                            <div class="text-center mb-6">
                                <div class="size-20 mx-auto mb-4 rounded-3xl bg-gradient-to-br from-primary/20 to-primary/5 flex items-center justify-center">
                                    <span class="material-symbols-outlined text-primary text-4xl">school</span>
                                </div>
                                <h2 class="text-xl font-extrabold mb-1">Ta'lim va kasb</h2>
                                <p class="text-sm text-white/50">Bilim va tajribangiz</p>
                            </div>
                            <div>
                                <label class="block text-[11px] font-black uppercase tracking-[0.2em] text-white/60 mb-3">Ta'lim darajangiz</label>
                                <div class="space-y-2">
                                    <label class="onboarding-list-option">
                                        <input type="radio" name="education" value="Oliy" required class="hidden">
                                        <div class="option-content">
                                            <span class="material-symbols-outlined text-xl">workspace_premium</span>
                                            <span>Oliy</span>
                                        </div>
                                        <span class="check-icon material-symbols-outlined">check_circle</span>
                                    </label>
                                    <label class="onboarding-list-option">
                                        <input type="radio" name="education" value="O'rta maxsus" class="hidden">
                                        <div class="option-content">
                                            <span class="material-symbols-outlined text-xl">verified</span>
                                            <span>O'rta maxsus</span>
                                        </div>
                                        <span class="check-icon material-symbols-outlined">check_circle</span>
                                    </label>
                                    <label class="onboarding-list-option">
                                        <input type="radio" name="education" value="O'rta" class="hidden">
                                        <div class="option-content">
                                            <span class="material-symbols-outlined text-xl">menu_book</span>
                                            <span>O'rta</span>
                                        </div>
                                        <span class="check-icon material-symbols-outlined">check_circle</span>
                                    </label>
                                </div>
                            </div>
                            <div>
                                <label class="block text-[11px] font-black uppercase tracking-[0.2em] text-white/60 mb-2">Kasbingiz</label>
                                <input name="profession" required class="w-full glass-card glass-input rounded-2xl px-4 py-4 text-base" placeholder="Masalan: Dasturchi, O'qituvchi...">
                            </div>
                            <div>
                                <label class="block text-[11px] font-black uppercase tracking-[0.2em] text-white/60 mb-2">Maosh (ixtiyoriy)</label>
                                <input name="salary" class="w-full glass-card glass-input rounded-2xl px-4 py-4 text-base" placeholder="Masalan: 500$, 3-5 mln">
                            </div>
                            <div>
                                <label class="block text-[11px] font-black uppercase tracking-[0.2em] text-white/60 mb-3">Hozir ishlaysizmi?</label>
                                <div class="grid grid-cols-2 gap-3">
                                    <label class="onboarding-option-card small">
                                        <input type="radio" name="is_working" value="true" required class="hidden">
                                        <div class="card-inner">
                                            <span class="material-symbols-outlined text-2xl mb-1">work</span>
                                            <span class="font-bold text-sm">Ha</span>
                                        </div>
                                    </label>
                                    <label class="onboarding-option-card small">
                                        <input type="radio" name="is_working" value="false" class="hidden">
                                        <div class="card-inner">
                                            <span class="material-symbols-outlined text-2xl mb-1">home</span>
                                            <span class="font-bold text-sm">Yo'q</span>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 5: Juft talablari va Bio -->
                    <div class="onboarding-step" data-step="5">
                        <div class="h-full overflow-y-auto ios-scroll-hide px-6 pb-6 space-y-5">
                            <div class="text-center mb-6">
                                <div class="size-20 mx-auto mb-4 rounded-3xl bg-gradient-to-br from-primary/20 to-primary/5 flex items-center justify-center">
                                    <span class="material-symbols-outlined text-primary text-4xl">favorite</span>
                                </div>
                                <h2 class="text-xl font-extrabold mb-1">Juftingiz haqida</h2>
                                <p class="text-sm text-white/50">Qanday odam izlayapsiz?</p>
                            </div>
                            <div>
                                <label class="block text-[11px] font-black uppercase tracking-[0.2em] text-white/60 mb-2">Yosh oralig'i</label>
                                <div class="flex gap-3 items-center">
                                    <select name="partner_age_min" required class="flex-1 glass-card glass-input rounded-2xl px-4 py-4 text-base">
                                        <option value="">Min</option>
                                        {% for age in range(18, 70, 1) %}
                                        <option value="{{ age }}">{{ age }}</option>
                                        {% endfor %}
                                    </select>
                                    <span class="text-white/40">—</span>
                                    <select name="partner_age_max" required class="flex-1 glass-card glass-input rounded-2xl px-4 py-4 text-base">
                                        <option value="">Max</option>
                                        {% for age in range(18, 70, 1) %}
                                        <option value="{{ age }}">{{ age }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="block text-[11px] font-black uppercase tracking-[0.2em] text-white/60 mb-2">Hudud</label>
                                <select name="partner_region" required class="w-full glass-card glass-input rounded-2xl px-4 py-4 text-base">
                                    <option value="">Tanlang</option>
                                    <option value="Istalgan">Farqi yo'q</option>
                                    <option value="Toshkent shahar">Toshkent shahar</option>
                                    <option value="Toshkent viloyati">Toshkent viloyati</option>
                                    <option value="Samarqand">Samarqand</option>
                                    <option value="Buxoro">Buxoro</option>
                                    <option value="Andijon">Andijon</option>
                                    <option value="Farg'ona">Farg'ona</option>
                                    <option value="Namangan">Namangan</option>
                                    <option value="Qashqadaryo">Qashqadaryo</option>
                                    <option value="Surxondaryo">Surxondaryo</option>
                                    <option value="Xorazm">Xorazm</option>
                                    <option value="Navoiy">Navoiy</option>
                                    <option value="Jizzax">Jizzax</option>
                                    <option value="Sirdaryo">Sirdaryo</option>
                                    <option value="Qoraqalpog'iston">Qoraqalpog'iston</option>
                                </select>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-[11px] font-black uppercase tracking-[0.2em] text-white/60 mb-2">Diniy daraja</label>
                                    <select name="partner_religious_level" required class="w-full glass-card glass-input rounded-2xl px-4 py-4 text-sm">
                                        <option value="">Tanlang</option>
                                        <option value="Istalgan">Farqi yo'q</option>
                                        <option value="Jiddiy">Jiddiy</option>
                                        <option value="O'rtacha">O'rtacha</option>
                                        <option value="Yengil">Yengil</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-[11px] font-black uppercase tracking-[0.2em] text-white/60 mb-2">Oilaviy holati</label>
                                    <select name="partner_marital_status" required class="w-full glass-card glass-input rounded-2xl px-4 py-4 text-sm">
                                        <option value="">Tanlang</option>
                                        <option value="Bo'ydoq">Bo'ydoq</option>
                                        <option value="Oilali">Oilali</option>
                                        <option value="Ajrashgan">Ajrashgan</option>
                                        <option value="Qiz bola">Qiz bola</option>
                                        <option value="Beva">Beva</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="block text-[11px] font-black uppercase tracking-[0.2em] text-white/60 mb-2">O'zingiz haqingizda</label>
                                <textarea name="bio" required rows="4" class="w-full glass-card glass-input rounded-2xl px-4 py-4 text-base resize-none" placeholder="O'zingiz haqingizda qisqacha yozing. Qiziqishlaringiz, maqsadlaringiz..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bottom buttons -->
                <div class="p-6 bg-gradient-to-t from-background-dark via-background-dark to-transparent">
                    <button type="button" id="onboarding-next-btn" onclick="onboardingNextStep()" class="w-full bg-primary text-black font-black py-4 rounded-2xl text-sm tracking-[0.22em] uppercase shadow-[0_10px_30px_rgba(64,255,0,0.3)] hover:scale-[1.02] active:scale-[0.98] transition-all">
                        DAVOM ETISH
                    </button>
                </div>
            </form>
        </div>

        <!-- FEED PAGE -->
        <div id="page-feed" class="page-container active">
            <header class="sticky top-0 z-50 bg-background-dark/95 backdrop-blur-xl pt-4 pb-4 px-5">
                <div class="max-w-md mx-auto">
                    <div class="flex items-center justify-between mb-5">
                        <div class="flex items-center gap-2">
                            <div class="size-7 bg-primary rounded-lg flex items-center justify-center neon-glow">
                                <span class="material-symbols-outlined text-black text-[18px] font-bold">diamond</span>
                            </div>
                            <h1 class="text-lg logo-text uppercase font-extrabold tracking-wider">Nikoh</h1>
                            <button type="button" id="feed-refresh-btn" class="size-9 rounded-full glass-card flex items-center justify-center text-white/70 hover:text-primary active:scale-95 transition-all" title="Yangilash">
                                <span class="material-symbols-outlined text-[20px]">refresh</span>
                            </button>
                        </div>
                        <div class="flex items-center gap-2">
                            <button type="button" id="feed-kuyov-btn" class="feed-gender-btn h-9 px-3 rounded-full text-[10px] font-black uppercase tracking-wider flex items-center gap-1.5 transition-all active:scale-95" title="Kuyovlar">
                                <span class="material-symbols-outlined text-[18px]">male</span>
                                <span>Kuyov</span>
                            </button>
                            <button type="button" id="feed-kelin-btn" class="feed-gender-btn h-9 px-3 rounded-full text-[10px] font-black uppercase tracking-wider flex items-center gap-1.5 transition-all active:scale-95" title="Kelinlar">
                                <span class="material-symbols-outlined text-[18px]">female</span>
                                <span>Kelin</span>
                            </button>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="relative flex-1">
                            <div class="absolute inset-y-0 left-4 flex items-center pointer-events-none">
                                <span class="material-symbols-outlined text-white/40 text-[18px]">search</span>
                            </div>
                            <input id="feed-search" class="w-full h-11 search-glass rounded-2xl pl-11 pr-4 text-[13px] text-white/60 focus:outline-none focus:border-primary/40 transition-all placeholder:text-white/20 bg-transparent" placeholder="Ism yoki ID qidirish..." type="text"/>
                        </div>
                        <button id="feed-sort-btn" class="size-9 search-glass rounded-xl flex items-center justify-center text-white/50 hover:text-primary hover:border-primary/40 transition-all active:scale-95" title="Saralash">
                            <span class="material-symbols-outlined text-[18px]">sort</span>
                        </button>
                        <button id="feed-filter" class="size-11 search-glass rounded-full flex items-center justify-center text-white/60 hover:text-primary hover:border-primary/40 transition-all active:scale-95">
                            <span class="material-symbols-outlined text-[22px] font-light">tune</span>
                        </button>
                    </div>
                    <div class="flex items-center gap-2 mt-3">
                        <label class="flex items-center gap-2 text-white/60 text-[11px]">
                            <input type="checkbox" id="feed-top-only" class="w-4 h-4 rounded border-white/20 bg-transparent text-primary focus:ring-primary/40">
                            <span>Faqat TOP</span>
                        </label>
                    </div>
                </div>
            </header>

            <main class="max-w-md mx-auto px-4 w-full" style="padding-top: 20px; padding-bottom: 140px;">
                <div id="feed-tariff-info" class="glass-card rounded-2xl p-4 mb-4"></div>
                <div id="feed-listings" class="space-y-4">
                    <div id="feed-skeleton" class="space-y-4">
                        <div class="profile-card glass-card rounded-[22px] overflow-hidden skeleton" style="height: calc((100vh - 220px) / 2.8); min-height: 245px;"></div>
                    </div>
                </div>
                <div class="text-center py-4 hidden" id="feed-load-more">
                    <button id="feed-load-more-btn" class="glass-card px-6 py-2 rounded-full text-primary text-sm font-bold hover:bg-primary/10 transition">
                        Ko'proq yuklash
                    </button>
                </div>
            </main>

            <!-- Profil batafsil: header va footer qimirlamaydi, faqat kontent scroll -->
            <div id="feed-profile-modal" class="hidden fixed inset-0 z-50 flex flex-col bg-background-dark" style="height: 100dvh; width: 100vw; max-width: 100%; left: 0; right: 0; top: 0; bottom: 0;">
                <header id="feed-profile-modal-header" class="shrink-0 z-10 bg-background-dark border-b border-white/5 flex items-center px-5 py-4 safe-area-pt">
                    <div class="max-w-md mx-auto w-full flex items-center justify-between">
                        <button type="button" onclick="window.closeFeedModal()" class="size-10 flex items-center justify-center text-white/80 active:scale-95 transition-transform">
                            <span class="material-symbols-outlined text-[28px]">chevron_left</span>
                        </button>
                        <h1 class="text-lg font-extrabold tracking-tight text-white">Profil</h1>
                        <div id="feed-profile-modal-header-right" class="size-10 flex items-center justify-center"></div>
                    </div>
                </header>
                <div id="feed-profile-modal-scroll" class="flex-1 min-h-0 overflow-y-auto overflow-x-hidden overscroll-behavior-contain" style="-webkit-overflow-scrolling: touch;">
                    <div class="max-w-md mx-auto w-full bg-background-dark" id="feed-profile-modal-inner">
                        <div id="feed-profile-content"></div>
                    </div>
                </div>
                <div id="feed-profile-modal-footer" class="hidden shrink-0 p-4 pt-2 bg-background-dark border-t border-white/5 safe-area-pb"></div>
            </div>
        </div>

        <!-- REQUESTS PAGE -->
        <div id="page-requests" class="page-container">
            <header class="sticky top-0 z-50 bg-background-dark/95 backdrop-blur-xl pt-4 pb-3 px-4">
                <div class="max-w-md mx-auto">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <button onclick="window.showPage('chats')" class="size-10 rounded-full glass-card flex items-center justify-center text-white/70 active:scale-95 transition-transform">
                                <span class="material-symbols-outlined text-[24px]">arrow_back_ios_new</span>
                            </button>
                            <h1 class="text-xl font-extrabold tracking-tight">So'rovlar</h1>
                        </div>
                        <div class="flex items-center gap-2">
                            <button id="requests-received-tab" onclick="switchRequestsTab('received')" class="relative h-10 px-3 pr-4 rounded-full glass-card flex items-center gap-2 text-primary active-neon-btn">
                                <div class="relative flex items-center justify-center">
                                    <span class="material-symbols-outlined text-[22px]">call_received</span>
                                    <span id="requests-received-badge" class="absolute -top-1.5 -right-1.5 badge-neon text-[9px] font-black text-black px-1.5 rounded-full min-w-[18px] h-[18px] flex items-center justify-center border-2 border-background-dark hidden">0</span>
                                </div>
                                <span id="requests-received-label" class="text-[10px] font-black tracking-widest uppercase">Kelgan</span>
                            </button>
                            <button id="requests-sent-tab" onclick="switchRequestsTab('sent')" class="relative h-10 px-3 pr-4 rounded-full glass-card flex items-center gap-2 text-white/40 requests-tab-icon-only">
                                <div class="relative flex items-center justify-center">
                                <span class="material-symbols-outlined text-[22px]">call_made</span>
                                    <span id="requests-sent-badge" class="absolute -top-1.5 -right-1.5 bg-white/20 text-[9px] font-black text-white px-1.5 rounded-full min-w-[18px] h-[18px] flex items-center justify-center border-2 border-background-dark hidden">0</span>
                                </div>
                                <span id="requests-sent-label" class="text-[10px] font-black tracking-widest uppercase hidden">Yuborilgan</span>
                            </button>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="flex-1 relative">
                            <div class="absolute inset-y-0 left-3 flex items-center pointer-events-none">
                                <span class="material-symbols-outlined text-white/30 text-[18px]">search</span>
                            </div>
                            <input id="requests-search" class="w-full h-11 search-glass rounded-full pl-10 pr-4 text-[13px] bg-transparent text-white placeholder:text-white/30 border-none focus:ring-1 focus:ring-primary/30 outline-none" placeholder="Ism yoki ID qidirish..." type="text"/>
                        </div>
                        <button id="requests-sort-btn" type="button" class="flex items-center gap-1.5 h-11 px-4 glass-card rounded-full text-[10px] font-black uppercase tracking-[0.1em] text-white/40 hover:text-primary hover:border-primary/40 transition-all active:scale-95" title="Saralash">
                            <span>SARALASH</span>
                            <span class="material-symbols-outlined text-[16px]">sort</span>
                        </button>
                    </div>
                </div>
            </header>

            <main class="max-w-md mx-auto px-4 w-full" style="padding-top: 20px; padding-bottom: 140px;">
                <div id="requests-tariff-info"></div>
                <div id="requests-received-container" class="space-y-4">
                    <div id="requests-received-skeleton" class="space-y-4">
                        <div class="profile-card glass-card rounded-[28px] overflow-hidden skeleton" style="height: calc((100vh - 220px) / 2.8); min-height: 245px;"></div>
                        <div class="profile-card glass-card rounded-[28px] overflow-hidden skeleton" style="height: calc((100vh - 220px) / 2.8); min-height: 245px;"></div>
                    </div>
                </div>
                <div id="requests-sent-container" class="space-y-4 hidden">
                    <div id="requests-sent-skeleton" class="space-y-4">
                        <div class="profile-card glass-card rounded-[28px] overflow-hidden skeleton" style="height: calc((100vh - 220px) / 2.8); min-height: 245px;"></div>
                        <div class="profile-card glass-card rounded-[28px] overflow-hidden skeleton" style="height: calc((100vh - 220px) / 2.8); min-height: 245px;"></div>
                    </div>
                </div>
            </main>
            <div class="fixed top-0 left-0 w-full h-full pointer-events-none -z-10 overflow-hidden opacity-25">
                <div class="absolute top-[-20%] right-[-10%] w-[80%] h-[80%] bg-primary/20 blur-[180px] rounded-full"></div>
                <div class="absolute bottom-[-20%] left-[-10%] w-[80%] h-[80%] bg-primary/10 blur-[180px] rounded-full"></div>
            </div>
        </div>

        <!-- CHATS PAGE -->
        <div id="page-chats" class="page-container">
            <header class="pt-8 pb-4 px-6 space-y-5 bg-background-dark/95 backdrop-blur-xl sticky top-0 z-50">
                <div class="max-w-md mx-auto flex items-center justify-between">
                    <h1 class="text-3xl font-extrabold tracking-tight">Xabarlar</h1>
                        <div class="flex items-center gap-3">
                        <button onclick="window.showPage('requests'); switchRequestsTab('received');" class="relative glass-card size-12 rounded-2xl flex items-center justify-center text-primary group active:scale-90 transition-all">
                            <span class="material-symbols-outlined text-[26px]">call_received</span>
                            <span id="chats-received-badge" class="absolute -top-1.5 -right-1.5 badge-neon text-[10px] font-black text-black px-1.5 rounded-full min-w-[22px] h-[22px] flex items-center justify-center border-2 border-background-dark hidden">0</span>
                            </button>
                        <button onclick="window.showPage('requests'); switchRequestsTab('sent');" class="relative glass-card size-12 rounded-2xl flex items-center justify-center text-white/50 group active:scale-90 transition-all">
                            <span class="material-symbols-outlined text-[26px]">call_made</span>
                            <span id="chats-sent-badge" class="absolute -top-1.5 -right-1.5 bg-white/20 text-[10px] font-black text-white px-1.5 rounded-full min-w-[22px] h-[22px] flex items-center justify-center border-2 border-background-dark hidden">0</span>
                        </button>
                        </div>
                    </div>
                <div class="max-w-md mx-auto relative group">
                    <div class="absolute inset-y-0 left-4 flex items-center pointer-events-none">
                        <span class="material-symbols-outlined text-white/20 text-[20px]">search</span>
                    </div>
                    <input id="chats-search" class="w-full h-12 search-glass rounded-2xl pl-12 pr-4 text-[15px] text-white bg-transparent focus:ring-1 focus:ring-primary/30 border-none placeholder:text-white/20 transition-all" placeholder="Ism yoki ID qidirish..." type="text"/>
                </div>
            </header>
            <main class="px-4" style="padding-bottom: 140px;">
                <div class="max-w-md mx-auto space-y-3 pt-4">
                    <div id="chats-profile-tabs" class="flex gap-2 overflow-x-auto pb-2 mb-2 scrollbar-hide hidden"></div>
                    <div class="flex items-center justify-between px-2 mb-4">
                        <h3 class="text-[10px] font-black uppercase tracking-[0.2em] text-white/30">Faol suhbatlar</h3>
                        <button class="flex items-center gap-1.5 text-[10px] font-bold text-primary active:opacity-50 transition-opacity">
                            <span class="material-symbols-outlined text-[16px]">history</span>
                            ARXIV
                        </button>
                    </div>
                <div id="chats-list" class="space-y-3">
                    <div id="chats-skeleton" class="space-y-3">
                            <div class="glass-row p-3.5 rounded-[28px] skeleton" style="height: 80px;"></div>
                            <div class="glass-row p-3.5 rounded-[28px] skeleton" style="height: 80px;"></div>
                            <div class="glass-row p-3.5 rounded-[28px] skeleton" style="height: 80px;"></div>
                        </div>
                    </div>
                    <div id="chats-empty" class="pt-12 pb-8 text-center hidden">
                        <p class="text-[10px] font-black text-white/15 uppercase tracking-[0.3em]">Barcha suhbatlar ko'rsatildi</p>
                    </div>
                </div>
            </main>
            <div class="fixed top-0 left-0 w-full h-full pointer-events-none -z-10 overflow-hidden opacity-30">
                <div class="absolute top-[-20%] right-[-10%] w-[80%] h-[80%] bg-primary/10 blur-[180px] rounded-full"></div>
                <div class="absolute bottom-[-20%] left-[-10%] w-[80%] h-[80%] bg-primary/5 blur-[180px] rounded-full"></div>
            </div>
        </div>

        <!-- FAVORITES PAGE (Asosiy sahifa bilan bir xil header) -->
        <div id="page-favorites" class="page-container">
            <header class="sticky top-0 z-50 bg-background-dark/95 backdrop-blur-xl pt-4 pb-4 px-5">
                <div class="max-w-md mx-auto">
                    <div class="flex items-center justify-between mb-5">
                        <div class="flex items-center gap-2">
                            <div class="size-7 bg-primary rounded-lg flex items-center justify-center neon-glow">
                                <span class="material-symbols-outlined text-black text-[18px] font-bold">diamond</span>
                            </div>
                            <h1 class="text-lg logo-text uppercase font-extrabold tracking-wider">Sevimli</h1>
                        </div>
                        <div class="flex items-center gap-2">
                            <button type="button" id="favorites-kuyov-btn" class="feed-gender-btn h-9 px-3 rounded-full text-[10px] font-black uppercase tracking-wider flex items-center gap-1.5 transition-all active:scale-95" title="Kuyovlar">
                                <span class="material-symbols-outlined text-[18px]">male</span>
                                <span>Kuyov</span>
                        </button>
                            <button type="button" id="favorites-kelin-btn" class="feed-gender-btn h-9 px-3 rounded-full text-[10px] font-black uppercase tracking-wider flex items-center gap-1.5 transition-all active:scale-95" title="Kelinlar">
                                <span class="material-symbols-outlined text-[18px]">female</span>
                                <span>Kelin</span>
                            </button>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="relative flex-1">
                            <div class="absolute inset-y-0 left-4 flex items-center pointer-events-none">
                                <span class="material-symbols-outlined text-white/40 text-[18px]">search</span>
                            </div>
                            <input id="favorites-search" class="w-full h-11 search-glass rounded-2xl pl-11 pr-4 text-[13px] text-white/60 focus:outline-none focus:border-primary/40 transition-all placeholder:text-white/20 bg-transparent" placeholder="Sevimli profilni qidirish..." type="text"/>
                        </div>
                        <button id="favorites-sort-btn" class="size-9 search-glass rounded-xl flex items-center justify-center text-white/50 hover:text-primary hover:border-primary/40 transition-all active:scale-95" title="Saralash">
                            <span class="material-symbols-outlined text-[18px]">sort</span>
                        </button>
                        <button id="favorites-filter-btn" class="size-11 search-glass rounded-full flex items-center justify-center text-white/60 hover:text-primary hover:border-primary/40 transition-all active:scale-95">
                            <span class="material-symbols-outlined text-[22px] font-light">tune</span>
                        </button>
                    </div>
                </div>
            </header>
            <main class="max-w-md mx-auto px-4 w-full" style="padding-top: 20px; padding-bottom: 140px;">
                    <div id="favorites-skeleton" class="space-y-4">
                    <div class="profile-card glass-card rounded-[22px] overflow-hidden skeleton" style="height: calc((100vh - 220px) / 2.8); min-height: 245px;"></div>
                    <div class="profile-card glass-card rounded-[22px] overflow-hidden skeleton" style="height: calc((100vh - 220px) / 2.8); min-height: 245px;"></div>
                    </div>
                    <div id="favorites-list" class="space-y-4"></div>
            </main>
            <div class="fixed top-0 left-0 w-full h-full pointer-events-none -z-10 overflow-hidden opacity-30">
                <div class="absolute top-[-20%] right-[-10%] w-[80%] h-[80%] bg-primary/10 blur-[180px] rounded-full"></div>
                <div class="absolute bottom-[-20%] left-[-10%] w-[80%] h-[80%] bg-primary/5 blur-[180px] rounded-full"></div>
            </div>
        </div>

        <!-- CHAT VIEW PAGE -->
        <div id="page-chat-view" class="page-container">
            <div class="relative flex h-screen w-full flex-col max-w-md mx-auto overflow-hidden border-x border-white/5 shadow-2xl">
                <div class="sticky top-0 z-20 flex items-center justify-between px-4 pt-12 pb-4 bg-background-dark/80 backdrop-blur-xl border-b border-white/5">
                    <div class="flex items-center gap-3">
                        <button onclick="window.showPage('chats')" class="text-white/70 hover:text-white transition-colors">
                            <span class="material-symbols-outlined text-2xl">chevron_left</span>
                        </button>
                        <button class="flex flex-col items-start text-left active:opacity-60 transition-opacity">
                            <div class="flex items-center gap-1.5">
                                <h2 id="chat-view-name" class="text-white text-[17px] font-bold tracking-tight">Foydalanuvchi</h2>
                                <span id="chat-view-user-id" class="text-white/30 text-xs font-medium">#0000</span>
                            </div>
                            <div id="chat-view-status" class="flex items-center gap-1.5">
                                <span class="size-1.5 rounded-full bg-primary glow-primary"></span>
                                <p class="text-[11px] text-white/50 font-medium">Hozir onlayn</p>
                            </div>
                        </button>
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="chat-messages-sort-btn" type="button" class="size-9 search-glass rounded-xl flex items-center justify-center text-white/50 hover:text-primary hover:border-primary/40 transition-all active:scale-95" title="Xabarlarni saralash">
                            <span class="material-symbols-outlined text-[18px]">sort</span>
                        </button>
                        <div id="chat-timer-badge" class="bg-primary/10 px-2.5 py-1 rounded-full border border-primary/20">
                            <p class="text-primary text-[11px] font-bold tracking-wider glow-text uppercase">7 kun 00:00</p>
                        </div>
                    </div>
                </div>
                <div id="chat-messages" class="flex-1 overflow-y-auto px-4 py-6 pb-24 space-y-6" style="scrollbar-width: none;">
                    <div class="flex justify-center">
                        <div class="glass-effect bg-white/5 px-4 py-1.5 rounded-full">
                            <p class="text-white/40 text-[10px] font-semibold tracking-widest uppercase">Xabarlashish uchun 7 kun berildi</p>
                        </div>
                    </div>
                    <div id="chat-timer-container" class="grid grid-cols-4 gap-2 py-2">
                        <!-- Timer will be loaded here -->
                    </div>
                    <div id="chat-messages-container" class="space-y-6">
                        <div id="chat-messages-skeleton" class="space-y-4">
                            <div class="flex items-end gap-3 max-w-[85%]">
                                <div class="size-9 rounded-full skeleton"></div>
                                <div class="flex-1 glass-effect bg-white/5 rounded-2xl rounded-bl-none p-4 skeleton" style="height: 60px;"></div>
                            </div>
                            <div class="flex items-end gap-3 justify-end ml-auto max-w-[85%]">
                                <div class="flex-1 glass-effect bg-glass-primary border-primary/30 rounded-2xl rounded-br-none p-4 skeleton" style="height: 60px;"></div>
                                <div class="size-9 rounded-full skeleton"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="fixed bottom-0 left-1/2 -translate-x-1/2 w-full max-w-md bg-background-dark/95 backdrop-blur-2xl border-t border-white/5 z-50">
                    <div class="p-4 pb-6">
                        <div class="flex items-center gap-2">
                            <button class="flex items-center justify-center size-11 rounded-xl bg-white/5 border border-white/10 text-white/50 active:bg-white/10 transition-all">
                                <span class="material-symbols-outlined text-[22px]">add</span>
                            </button>
                            <div class="flex-1 relative flex items-center">
                                <input id="chat-message-input" class="w-full bg-white/5 border border-white/10 rounded-xl pl-4 pr-10 py-2.5 text-sm text-white placeholder:text-white/20 focus:outline-none focus:ring-1 focus:ring-primary/40 focus:border-primary/40 transition-all" placeholder="Xabar yozing..." type="text"/>
                                <button class="absolute right-2 flex items-center justify-center size-8 text-white/40 hover:text-white transition-colors">
                                    <span class="material-symbols-outlined text-[20px]">mic</span>
                                </button>
                            </div>
                            <button id="chat-send-btn" onclick="sendChatMessage()" class="flex items-center justify-center size-11 rounded-xl bg-primary text-background-dark glow-primary active:scale-95 transition-all">
                                <span class="material-symbols-outlined font-bold text-[20px]">send</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PROFILE PAGE -->
        <div id="page-profile" class="page-container">
            <!-- Skeleton: profil yuklanayotganda -->
            <div id="profile-skeleton" class="px-6 pt-10 pb-4 hidden">
                <div class="max-w-md mx-auto flex flex-col items-center">
                    <div class="size-24 rounded-full bg-white/10 animate-pulse mb-3"></div>
                    <div class="h-6 w-40 bg-white/10 rounded animate-pulse mb-2"></div>
                    <div class="h-4 w-24 bg-white/10 rounded animate-pulse"></div>
                </div>
                <div class="max-w-md mx-auto px-5 mt-6 space-y-3">
                    <div class="h-14 rounded-2xl bg-white/10 animate-pulse"></div>
                    <div class="h-12 rounded-2xl bg-white/10 animate-pulse"></div>
                </div>
            </div>
            <div id="profile-content" class="contents">
            <div class="px-6 pt-10 pb-3">
                <div class="max-w-md mx-auto flex flex-col items-center">
                    <div class="relative mb-3">
                        <div class="size-24 rounded-full p-1.5 glass-card border-primary/20 overflow-hidden">
                            <div id="profile-avatar" class="w-full h-full rounded-full overflow-hidden border border-white/10 bg-gradient-to-br from-primary/20 to-green-500/20 flex items-center justify-center text-3xl font-bold text-white">
                                ?
                            </div>
                        </div>
                        <button type="button" onclick="window.showPage('profile-edit')" class="absolute bottom-0 right-0 bg-primary text-black size-9 rounded-full flex items-center justify-center border-2 border-background-dark active:scale-95 transition-transform shadow-lg">
                            <span class="material-symbols-outlined text-[20px]">edit</span>
                        </button>
                    </div>
                    <h1 id="profile-name" class="text-xl font-extrabold tracking-tight text-white">Foydalanuvchi</h1>
                    <div class="flex items-center gap-2 mt-1">
                        <span id="profile-telegram-id" class="text-[11px] font-black tracking-widest text-primary/80 uppercase">#0</span>
                        <span class="text-[10px] font-bold text-primary/70 px-2 py-0.5 rounded-full bg-primary/10 border border-primary/20 uppercase">Tasdiqlangan</span>
                    </div>
                </div>
            </div>

            <main class="max-w-md mx-auto px-5 w-full space-y-3" style="padding-bottom: 140px;">
                <!-- Statistika — ixcham -->
                <div class="glass-card rounded-2xl p-3 grid grid-cols-3 gap-1">
                    <div class="flex flex-col items-center">
                        <span id="profile-views" class="text-base font-extrabold text-white">0</span>
                        <span class="text-[9px] font-bold text-white/40 uppercase tracking-wider">Ko'rilgan</span>
                    </div>
                    <div class="flex flex-col items-center border-x border-white/5">
                        <span id="profile-likes" class="text-base font-extrabold text-white">0</span>
                        <span class="text-[9px] font-bold text-white/40 uppercase tracking-wider">Sevimlilar</span>
                    </div>
                    <div class="flex flex-col items-center">
                        <span id="profile-requests" class="text-base font-extrabold text-white">0</span>
                        <span class="text-[9px] font-bold text-white/40 uppercase tracking-wider">So'rovlar</span>
                    </div>
                </div>

                <!-- TOP va Tariflar -->
                <div class="grid grid-cols-2 gap-2">
                    <button type="button" id="profile-top-btn" onclick="window.showPage('top')" class="hidden glass-card rounded-2xl py-2.5 flex items-center justify-center gap-1.5 active:scale-[0.98] border border-amber-500/20">
                        <span class="material-symbols-outlined text-amber-400 text-[18px]">rocket_launch</span>
                        <span class="text-[11px] font-bold text-amber-400">TOP</span>
                    </button>
                    <button type="button" onclick="window.showPage('tariff')" class="glass-card rounded-2xl py-2.5 flex items-center justify-center gap-1.5 active:scale-[0.98]">
                        <span class="material-symbols-outlined text-primary text-[18px]">workspace_premium</span>
                        <span class="text-[11px] font-bold text-white/80">Tariflar</span>
                    </button>
                </div>

                <div class="space-y-1.5">
                    <div id="profile-full-profile-btn" class="hidden">
                        <button type="button" onclick="openOnboarding('full')" class="w-full glass-card rounded-2xl py-2.5 px-3 flex items-center justify-between border border-primary/20 bg-primary/5 active:scale-[0.98]">
                            <div class="flex items-center gap-3">
                                <div class="size-8 rounded-xl bg-primary/20 flex items-center justify-center text-primary">
                                    <span class="material-symbols-outlined text-[18px]">person_add</span>
                                </div>
                                <p class="text-xs font-bold text-primary">To'liq profil to'ldirish</p>
                            </div>
                            <span class="material-symbols-outlined text-primary text-[18px]">chevron_right</span>
                        </button>
                    </div>
                    <button type="button" onclick="window.showPage('listings')" class="w-full glass-card rounded-2xl py-2.5 px-3 flex items-center justify-between group active:scale-[0.98] text-left">
                        <div class="flex items-center gap-3">
                            <div class="size-8 rounded-xl bg-white/5 flex items-center justify-center text-white/60">
                                <span class="material-symbols-outlined text-[18px]">campaign</span>
                            </div>
                            <p class="text-xs font-bold">E'lonlarim</p>
                        </div>
                        <span class="material-symbols-outlined text-white/20 text-[18px] group-hover:text-primary">chevron_right</span>
                    </button>
                    <button type="button" onclick="window.showPage('settings')" class="w-full glass-card rounded-2xl py-2.5 px-3 flex items-center justify-between group active:scale-[0.98] text-left">
                        <div class="flex items-center gap-3">
                            <div class="size-8 rounded-xl bg-white/5 flex items-center justify-center text-white/60">
                                <span class="material-symbols-outlined text-[18px]">settings</span>
                            </div>
                            <p class="text-xs font-bold">Sozlamalar</p>
                        </div>
                        <span class="material-symbols-outlined text-white/20 text-[18px] group-hover:text-primary">chevron_right</span>
                    </button>
                    <!-- Qo'llanma, Bog'lanish, Ulashish — yonma-yon, kichik -->
                    <div class="grid grid-cols-3 gap-2 pt-2">
                        <button type="button" onclick="window.showPage('guide')" class="glass-card rounded-2xl py-2.5 flex flex-col items-center justify-center gap-1 active:scale-[0.98]">
                            <span class="material-symbols-outlined text-white/60 text-[20px]">menu_book</span>
                            <span class="text-[10px] font-bold text-white/70">Qo'llanma</span>
                        </button>
                        <button type="button" onclick="window.showPage('contact')" class="glass-card rounded-2xl py-2.5 flex flex-col items-center justify-center gap-1 active:scale-[0.98]">
                            <span class="material-symbols-outlined text-white/60 text-[20px]">support_agent</span>
                            <span class="text-[10px] font-bold text-white/70">Bog'lanish</span>
                        </button>
                        <button type="button" onclick="window.showPage('share')" class="glass-card rounded-2xl py-2.5 flex flex-col items-center justify-center gap-1 active:scale-[0.98]">
                            <span class="material-symbols-outlined text-white/60 text-[20px]">share</span>
                            <span class="text-[10px] font-bold text-white/70">Ulashish</span>
                        </button>
                    </div>
                </div>
            </main>
            </div>
        </div>

        <!-- Sozlamalar (Chiqish shu yerda) -->
        <div id="page-settings" class="page-container">
            <header class="sticky top-0 z-30 flex items-center justify-between px-5 py-4 backdrop-blur-xl bg-background-dark/80 border-b border-white/5">
                <div class="flex items-center gap-3">
                    <button type="button" onclick="window.showPage('profile')" class="size-9 rounded-full glass-card flex items-center justify-center text-white/80 active:scale-95 transition-transform">
                        <span class="material-symbols-outlined text-[20px]">arrow_back_ios_new</span>
                    </button>
                    <h1 class="text-lg font-extrabold tracking-tight text-white">Sozlamalar</h1>
                </div>
            </header>
            <main class="px-5 py-6">
                <button type="button" onclick="if(confirm('Chiqishni xohlaysizmi?')) window.location.href='/auth/logout';" class="w-full py-3 px-4 rounded-xl border border-red-500/20 bg-red-500/10 text-red-400 flex items-center justify-center gap-2 active:scale-[0.98] font-bold text-sm">
                    <span class="material-symbols-outlined text-[20px]">logout</span>
                    Chiqish
                </button>
            </main>
        </div>

        <!-- PROFILNI TAHRIRLASH (bo'limlar bo'yicha) -->
        <div id="page-profile-edit" class="page-container">
            <header class="sticky top-0 z-30 flex items-center justify-between px-6 py-5 backdrop-blur-xl bg-background-dark/80 border-b border-white/5">
                <div class="flex items-center gap-3">
                    <button type="button" onclick="window.showPage('profile')" class="size-10 rounded-full glass-card flex items-center justify-center text-white/80 active:scale-95 transition-transform">
                        <span class="material-symbols-outlined text-[22px]">arrow_back_ios_new</span>
                    </button>
                    <h1 class="text-xl font-extrabold tracking-tight text-white">Profilni tahrirlash</h1>
                </div>
                <button type="button" id="profile-edit-save-btn" class="bg-primary/10 hover:bg-primary/20 px-5 py-2 rounded-full transition-all active:scale-95 border border-primary/30 hidden">
                    <span class="text-primary font-bold tracking-wide neon-text-glow">Saqlash</span>
                </button>
            </header>
            <main class="flex-1 overflow-y-auto custom-scrollbar px-5 pb-32" style="padding-top: 16px;">
                <div id="profile-edit-summary" class="mt-2 mb-8 flex flex-col items-center">
                    <div class="size-24 rounded-[24px] overflow-hidden border-2 border-primary/30 bg-white/5 flex items-center justify-center text-3xl font-bold text-primary/60" id="profile-edit-avatar">?</div>
                    <h2 id="profile-edit-name" class="mt-4 text-lg font-bold text-white">—</h2>
                    <p id="profile-edit-region" class="text-sm text-white/50">—</p>
                </div>
                <div class="space-y-4">
                    <h3 class="px-1 text-[10px] font-black uppercase tracking-[0.2em] text-white/40 mb-2">Shaxsiy ma'lumotlar</h3>
                    <button type="button" data-section="diniy" onclick="openProfileEditSheet('diniy')" class="profile-edit-section-btn w-full glass-card rounded-2xl p-5 flex items-center justify-between group active:scale-[0.98] transition-all text-left border border-white/10">
                        <div class="flex items-center gap-4">
                            <div class="profile-edit-section-icon size-12 rounded-2xl bg-white/5 flex items-center justify-center text-white/60 border border-white/10">
                                <span class="material-symbols-outlined text-[26px]">mosque</span>
                            </div>
                            <div>
                                <p class="font-bold text-base text-white">Diniy</p>
                                <p id="profile-edit-diniy-summary" class="text-sm text-white/50">Belgilanmagan</p>
                            </div>
                        </div>
                        <span class="material-symbols-outlined text-white/30 group-hover:text-primary transition-colors profile-edit-chevron">chevron_right</span>
                    </button>
                    <button type="button" data-section="joylashuv" onclick="openProfileEditSheet('joylashuv')" class="profile-edit-section-btn w-full glass-card rounded-2xl p-5 flex items-center justify-between group active:scale-[0.98] transition-all text-left border border-white/10">
                        <div class="flex items-center gap-4">
                            <div class="profile-edit-section-icon size-12 rounded-2xl bg-white/5 flex items-center justify-center text-white/60 border border-white/10">
                                <span class="material-symbols-outlined text-[26px]">location_on</span>
                            </div>
                            <div>
                                <p class="font-bold text-base text-white">Joylashuv</p>
                                <p id="profile-edit-joylashuv-summary" class="text-sm text-white/50">Belgilanmagan</p>
                            </div>
                        </div>
                        <span class="material-symbols-outlined text-white/30 group-hover:text-primary transition-colors profile-edit-chevron">chevron_right</span>
                    </button>
                    <button type="button" data-section="oilaviy" onclick="openProfileEditSheet('oilaviy')" class="profile-edit-section-btn w-full glass-card rounded-2xl p-5 flex items-center justify-between group active:scale-[0.98] transition-all text-left border border-white/10">
                        <div class="flex items-center gap-4">
                            <div class="profile-edit-section-icon size-12 rounded-2xl bg-white/5 flex items-center justify-center text-white/60 border border-white/10">
                                <span class="material-symbols-outlined text-[26px]">favorite</span>
                            </div>
                            <div>
                                <p class="font-bold text-base text-white">Oilaviy holati</p>
                                <p id="profile-edit-oilaviy-summary" class="text-sm text-white/50">Belgilanmagan</p>
                            </div>
                        </div>
                        <span class="material-symbols-outlined text-white/30 group-hover:text-primary transition-colors profile-edit-chevron">chevron_right</span>
                    </button>
                    <h3 class="pt-6 px-1 text-[10px] font-black uppercase tracking-[0.2em] text-white/40 mb-2">Qo'shimcha tafsilotlar</h3>
                    <button type="button" data-section="jismoniy" onclick="openProfileEditSheet('jismoniy')" class="profile-edit-section-btn w-full glass-card rounded-2xl p-5 flex items-center justify-between group active:scale-[0.98] transition-all text-left border border-white/10">
                        <div class="flex items-center gap-4">
                            <div class="profile-edit-section-icon size-12 rounded-2xl bg-white/5 flex items-center justify-center text-white/60 border border-white/10">
                                <span class="material-symbols-outlined text-[26px]">straighten</span>
                            </div>
                            <div>
                                <p class="font-bold text-base text-white">Jismoniy</p>
                                <p id="profile-edit-jismoniy-summary" class="text-sm text-white/50">Belgilanmagan</p>
                            </div>
                        </div>
                        <span class="material-symbols-outlined text-white/30 group-hover:text-primary transition-colors profile-edit-chevron">chevron_right</span>
                    </button>
                    <button type="button" data-section="talim" onclick="openProfileEditSheet('talim')" class="profile-edit-section-btn w-full glass-card rounded-2xl p-5 flex items-center justify-between group active:scale-[0.98] transition-all text-left border border-white/10">
                        <div class="flex items-center gap-4">
                            <div class="profile-edit-section-icon size-12 rounded-2xl bg-white/5 flex items-center justify-center text-white/60 border border-white/10">
                                <span class="material-symbols-outlined text-[26px]">school</span>
                            </div>
                            <div>
                                <p class="font-bold text-base text-white">Ta'lim</p>
                                <p id="profile-edit-talim-summary" class="text-sm text-white/50">Belgilanmagan</p>
                            </div>
                        </div>
                        <span class="material-symbols-outlined text-white/30 group-hover:text-primary transition-colors profile-edit-chevron">chevron_right</span>
                    </button>
                    <button type="button" data-section="ish" onclick="openProfileEditSheet('ish')" class="profile-edit-section-btn w-full glass-card rounded-2xl p-5 flex items-center justify-between group active:scale-[0.98] transition-all text-left border border-white/10">
                        <div class="flex items-center gap-4">
                            <div class="profile-edit-section-icon size-12 rounded-2xl bg-white/5 flex items-center justify-center text-white/60 border border-white/10">
                                <span class="material-symbols-outlined text-[26px]">work</span>
                            </div>
                            <div>
                                <p class="font-bold text-base text-white">Ish &amp; Kasb</p>
                                <p id="profile-edit-ish-summary" class="text-sm text-white/50">Belgilanmagan</p>
                            </div>
                        </div>
                        <span class="material-symbols-outlined text-white/30 group-hover:text-primary transition-colors profile-edit-chevron">chevron_right</span>
                    </button>
                    <button type="button" data-section="juftga" onclick="openProfileEditSheet('juftga')" class="profile-edit-section-btn w-full glass-card rounded-2xl p-5 flex items-center justify-between group active:scale-[0.98] transition-all text-left border border-white/10">
                        <div class="flex items-center gap-4">
                            <div class="profile-edit-section-icon size-12 rounded-2xl bg-white/5 flex items-center justify-center text-white/60 border border-white/10">
                                <span class="material-symbols-outlined text-[26px]">favorite</span>
                            </div>
                            <div>
                                <p class="font-bold text-base text-white">Juftga talablari</p>
                                <p id="profile-edit-juftga-summary" class="text-sm text-white/50">Belgilanmagan</p>
                            </div>
                        </div>
                        <span class="material-symbols-outlined text-white/30 group-hover:text-primary transition-colors profile-edit-chevron">chevron_right</span>
                    </button>
                    <button type="button" data-section="bio" onclick="openProfileEditSheet('bio')" class="profile-edit-section-btn w-full glass-card rounded-2xl p-5 flex items-center justify-between group active:scale-[0.98] transition-all text-left border border-white/10">
                        <div class="flex items-center gap-4">
                            <div class="profile-edit-section-icon size-12 rounded-2xl bg-white/5 flex items-center justify-center text-white/60 border border-white/10">
                                <span class="material-symbols-outlined text-[26px]">history_edu</span>
                            </div>
                            <div>
                                <p class="font-bold text-base text-white">O'zim haqimda</p>
                                <p id="profile-edit-bio-summary" class="text-sm text-white/50 italic">Belgilanmagan</p>
                            </div>
                        </div>
                        <span class="material-symbols-outlined text-white/30 group-hover:text-primary transition-colors profile-edit-chevron">chevron_right</span>
                    </button>
                </div>
            </main>
        </div>

        <!-- E'lonlar (barcha e'lonlar — 2+ bo'lganda profildan o'tish) -->
        <div id="page-listings" class="page-container">
            <header class="sticky top-0 z-30 flex items-center justify-between px-6 py-5 backdrop-blur-xl bg-background-dark/80 border-b border-white/5">
                <div class="flex items-center gap-3">
                    <button type="button" onclick="window.showPage('profile')" class="size-10 rounded-full glass-card flex items-center justify-center text-white/80 active:scale-95 transition-transform">
                        <span class="material-symbols-outlined text-[22px]">arrow_back_ios_new</span>
                    </button>
                    <h1 class="text-xl font-extrabold tracking-tight text-white">E'lonlarim</h1>
                </div>
            </header>
            <main class="px-5 pb-32 pt-4">
                <div id="listings-page-list" class="space-y-2"></div>
                <button type="button" onclick="window.showNewListingInfoModal()" class="w-full mt-4 glass-card rounded-2xl py-3 flex items-center justify-center gap-2 border border-dashed border-primary/30 bg-primary/5 active:scale-[0.98]">
                    <span class="material-symbols-outlined text-primary text-[20px]">add_circle</span>
                    <span class="text-sm font-bold text-primary">Yangi e'lon</span>
                </button>
            </main>
        </div>

        <!-- Yangi e'lon qo'shish (aka/opa uchun — asosiy profil tahrirlash bilan bir xil dizayn) -->
        <div id="page-add-listing" class="page-container">
            <header class="sticky top-0 z-30 flex items-center justify-between px-6 py-5 backdrop-blur-xl bg-background-dark/80 border-b border-white/5">
                <div class="flex items-center gap-3">
                    <button type="button" onclick="window.showPage('profile')" class="size-10 rounded-full glass-card flex items-center justify-center text-white/80 active:scale-95 transition-transform">
                        <span class="material-symbols-outlined text-[22px]">arrow_back_ios_new</span>
                    </button>
                    <h1 class="text-xl font-extrabold tracking-tight text-white">Yangi e'lon qo'shish</h1>
                </div>
            </header>
            <main class="flex-1 overflow-y-auto custom-scrollbar px-5 pb-32" style="padding-top: 16px;">
                <p class="text-sm text-white/50 mb-6">Aka, opa, ota uchun barcha ma'lumotlarni to'ldiring — asosiy e'lon kabi.</p>
                <div id="add-listing-summary" class="mt-2 mb-6 flex flex-col items-center">
                    <div class="size-24 rounded-[24px] overflow-hidden border-2 border-primary/30 bg-white/5 flex items-center justify-center text-3xl font-bold text-primary/60" id="add-listing-avatar">?</div>
                    <h2 id="add-listing-name" class="mt-4 text-lg font-bold text-white">—</h2>
                    <p id="add-listing-region" class="text-sm text-white/50">—</p>
                </div>
                <div class="space-y-4">
                    <h3 class="px-1 text-[10px] font-black uppercase tracking-[0.2em] text-white/40 mb-2">Shaxsiy ma'lumotlar</h3>
                    <button type="button" data-section="shaxsiy" onclick="openProfileEditSheet('shaxsiy', window.newListingDraft)" class="add-listing-section-btn w-full glass-card rounded-2xl p-5 flex items-center justify-between group active:scale-[0.98] transition-all text-left border border-white/10">
                        <div class="flex items-center gap-4">
                            <div class="add-listing-section-icon size-12 rounded-2xl bg-white/5 flex items-center justify-center text-white/60 border border-white/10">
                                <span class="material-symbols-outlined text-[26px]">person</span>
                            </div>
                            <div>
                                <p class="font-bold text-base text-white">Ism, jins, yosh</p>
                                <p id="add-listing-shaxsiy-summary" class="text-sm text-white/50">Belgilanmagan</p>
                            </div>
                        </div>
                        <span class="material-symbols-outlined text-white/30 group-hover:text-primary transition-colors">chevron_right</span>
                    </button>
                    <button type="button" data-section="diniy" onclick="openProfileEditSheet('diniy', window.newListingDraft)" class="add-listing-section-btn w-full glass-card rounded-2xl p-5 flex items-center justify-between group active:scale-[0.98] transition-all text-left border border-white/10">
                        <div class="flex items-center gap-4">
                            <div class="add-listing-section-icon size-12 rounded-2xl bg-white/5 flex items-center justify-center text-white/60 border border-white/10">
                                <span class="material-symbols-outlined text-[26px]">mosque</span>
                            </div>
                            <div>
                                <p class="font-bold text-base text-white">Diniy</p>
                                <p id="add-listing-diniy-summary" class="text-sm text-white/50">Belgilanmagan</p>
                            </div>
                        </div>
                        <span class="material-symbols-outlined text-white/30 group-hover:text-primary transition-colors">chevron_right</span>
                    </button>
                    <button type="button" data-section="joylashuv" onclick="openProfileEditSheet('joylashuv', window.newListingDraft)" class="add-listing-section-btn w-full glass-card rounded-2xl p-5 flex items-center justify-between group active:scale-[0.98] transition-all text-left border border-white/10">
                        <div class="flex items-center gap-4">
                            <div class="add-listing-section-icon size-12 rounded-2xl bg-white/5 flex items-center justify-center text-white/60 border border-white/10">
                                <span class="material-symbols-outlined text-[26px]">location_on</span>
                            </div>
                            <div>
                                <p class="font-bold text-base text-white">Joylashuv</p>
                                <p id="add-listing-joylashuv-summary" class="text-sm text-white/50">Belgilanmagan</p>
                            </div>
                        </div>
                        <span class="material-symbols-outlined text-white/30 group-hover:text-primary transition-colors">chevron_right</span>
                    </button>
                    <button type="button" data-section="oilaviy" onclick="openProfileEditSheet('oilaviy', window.newListingDraft)" class="add-listing-section-btn w-full glass-card rounded-2xl p-5 flex items-center justify-between group active:scale-[0.98] transition-all text-left border border-white/10">
                        <div class="flex items-center gap-4">
                            <div class="add-listing-section-icon size-12 rounded-2xl bg-white/5 flex items-center justify-center text-white/60 border border-white/10">
                                <span class="material-symbols-outlined text-[26px]">favorite</span>
                            </div>
                            <div>
                                <p class="font-bold text-base text-white">Oilaviy holati</p>
                                <p id="add-listing-oilaviy-summary" class="text-sm text-white/50">Belgilanmagan</p>
                            </div>
                        </div>
                        <span class="material-symbols-outlined text-white/30 group-hover:text-primary transition-colors">chevron_right</span>
                    </button>
                    <h3 class="pt-6 px-1 text-[10px] font-black uppercase tracking-[0.2em] text-white/40 mb-2">Qo'shimcha tafsilotlar</h3>
                    <button type="button" data-section="jismoniy" onclick="openProfileEditSheet('jismoniy', window.newListingDraft)" class="add-listing-section-btn w-full glass-card rounded-2xl p-5 flex items-center justify-between group active:scale-[0.98] transition-all text-left border border-white/10">
                        <div class="flex items-center gap-4">
                            <div class="add-listing-section-icon size-12 rounded-2xl bg-white/5 flex items-center justify-center text-white/60 border border-white/10">
                                <span class="material-symbols-outlined text-[26px]">straighten</span>
                            </div>
                            <div>
                                <p class="font-bold text-base text-white">Jismoniy</p>
                                <p id="add-listing-jismoniy-summary" class="text-sm text-white/50">Belgilanmagan</p>
                            </div>
                        </div>
                        <span class="material-symbols-outlined text-white/30 group-hover:text-primary transition-colors">chevron_right</span>
                    </button>
                    <button type="button" data-section="talim" onclick="openProfileEditSheet('talim', window.newListingDraft)" class="add-listing-section-btn w-full glass-card rounded-2xl p-5 flex items-center justify-between group active:scale-[0.98] transition-all text-left border border-white/10">
                        <div class="flex items-center gap-4">
                            <div class="add-listing-section-icon size-12 rounded-2xl bg-white/5 flex items-center justify-center text-white/60 border border-white/10">
                                <span class="material-symbols-outlined text-[26px]">school</span>
                            </div>
                            <div>
                                <p class="font-bold text-base text-white">Ta'lim</p>
                                <p id="add-listing-talim-summary" class="text-sm text-white/50">Belgilanmagan</p>
                            </div>
                        </div>
                        <span class="material-symbols-outlined text-white/30 group-hover:text-primary transition-colors">chevron_right</span>
                    </button>
                    <button type="button" data-section="ish" onclick="openProfileEditSheet('ish', window.newListingDraft)" class="add-listing-section-btn w-full glass-card rounded-2xl p-5 flex items-center justify-between group active:scale-[0.98] transition-all text-left border border-white/10">
                        <div class="flex items-center gap-4">
                            <div class="add-listing-section-icon size-12 rounded-2xl bg-white/5 flex items-center justify-center text-white/60 border border-white/10">
                                <span class="material-symbols-outlined text-[26px]">work</span>
                            </div>
                            <div>
                                <p class="font-bold text-base text-white">Ish &amp; Kasb</p>
                                <p id="add-listing-ish-summary" class="text-sm text-white/50">Belgilanmagan</p>
                            </div>
                        </div>
                        <span class="material-symbols-outlined text-white/30 group-hover:text-primary transition-colors">chevron_right</span>
                    </button>
                    <button type="button" data-section="juftga" onclick="openProfileEditSheet('juftga', window.newListingDraft)" class="add-listing-section-btn w-full glass-card rounded-2xl p-5 flex items-center justify-between group active:scale-[0.98] transition-all text-left border border-white/10">
                        <div class="flex items-center gap-4">
                            <div class="add-listing-section-icon size-12 rounded-2xl bg-white/5 flex items-center justify-center text-white/60 border border-white/10">
                                <span class="material-symbols-outlined text-[26px]">handshake</span>
                            </div>
                            <div>
                                <p class="font-bold text-base text-white">Juftga talablari</p>
                                <p id="add-listing-juftga-summary" class="text-sm text-white/50">Belgilanmagan</p>
                            </div>
                        </div>
                        <span class="material-symbols-outlined text-white/30 group-hover:text-primary transition-colors">chevron_right</span>
                    </button>
                    <button type="button" data-section="bio" onclick="openProfileEditSheet('bio', window.newListingDraft)" class="add-listing-section-btn w-full glass-card rounded-2xl p-5 flex items-center justify-between group active:scale-[0.98] transition-all text-left border border-white/10">
                        <div class="flex items-center gap-4">
                            <div class="add-listing-section-icon size-12 rounded-2xl bg-white/5 flex items-center justify-center text-white/60 border border-white/10">
                                <span class="material-symbols-outlined text-[26px]">history_edu</span>
                            </div>
                            <div>
                                <p class="font-bold text-base text-white">O'zim haqimda</p>
                                <p id="add-listing-bio-summary" class="text-sm text-white/50 italic">Belgilanmagan</p>
                            </div>
                        </div>
                        <span class="material-symbols-outlined text-white/30 group-hover:text-primary transition-colors">chevron_right</span>
                    </button>
                </div>
                <div class="mt-10 space-y-3">
                    <button type="button" id="add-listing-draft-btn" onclick="window.saveDraftListing()" class="w-full bg-white/10 text-white font-bold py-4 rounded-2xl text-base active:scale-[0.98] transition-all border border-white/10">
                        <span class="material-symbols-outlined text-[20px] align-middle mr-2">save</span>Qoralama saqlash
                    </button>
                    <button type="button" id="add-listing-publish-btn" onclick="window.publishNewListing()" class="w-full bg-primary text-black font-black py-4 rounded-2xl text-base uppercase tracking-wider active:scale-[0.98] transition-all neon-glow">
                        <span class="material-symbols-outlined text-[20px] align-middle mr-2">publish</span>E'lon qilish
                    </button>
                </div>
                <div id="add-listing-delete-section" class="mt-6 hidden">
                    <button type="button" onclick="window.deleteCurrentListing()" class="w-full py-3 text-red-400 text-sm font-medium active:scale-[0.98] transition-all">
                        <span class="material-symbols-outlined text-[18px] align-middle mr-1">delete</span>E'lonni o'chirish
                    </button>
                </div>
            </main>
        </div>

        <!-- Profil tahrirlash bo'limi bottom sheet (scroll + X yopish) -->
        <div id="profile-edit-sheet" class="fixed inset-0 z-50 pointer-events-none">
            <div id="profile-edit-sheet-overlay" class="absolute inset-0 bg-black/60 backdrop-blur-sm opacity-0 transition-opacity pointer-events-none z-10" onclick="closeProfileEditSheet()"></div>
            <div id="profile-edit-sheet-content" class="absolute bottom-0 left-0 right-0 max-w-md mx-auto glass-card rounded-t-[32px] border-t-2 border-primary/30 shadow-[0_-10px_40px_rgba(0,0,0,0.8)] transform translate-y-full transition-transform duration-300 pointer-events-auto z-20 flex flex-col max-h-[85vh] overflow-hidden">
                <div class="shrink-0 pt-3 px-6 pb-2">
                    <div class="w-12 h-1.5 bg-white/20 rounded-full mx-auto mb-4"></div>
                    <div class="flex justify-between items-center gap-3">
                        <h4 id="profile-edit-sheet-title" class="text-xl font-bold truncate">Bo'lim</h4>
                        <button type="button" onclick="closeProfileEditSheet()" class="size-10 shrink-0 rounded-full flex items-center justify-center text-white hover:bg-white/10 active:scale-95 border border-white/10" title="Yopish">
                            <span class="material-symbols-outlined text-[24px]">close</span>
                        </button>
                    </div>
                </div>
                <div class="flex-1 min-h-0 overflow-y-auto overflow-x-hidden px-6 pb-4" style="-webkit-overflow-scrolling: touch;">
                    <div id="profile-edit-sheet-body" class="space-y-4 pb-2"></div>
                </div>
                <div class="shrink-0 px-6 pb-6 pt-2 border-t border-white/5">
                    <button type="button" id="profile-edit-sheet-save" onclick="saveProfileEditSheet()" class="w-full bg-primary text-black font-bold py-3.5 rounded-2xl active:scale-[0.98] transition-all">
                        Saqlash
                    </button>
                </div>
            </div>
        </div>

        <!-- TOP PAGE -->
        <div id="page-top" class="page-container">
            <header class="pt-6 pb-3 px-6 sticky top-0 z-50 bg-background-dark/95 backdrop-blur-xl border-b border-white/5">
                <div class="max-w-md mx-auto flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <button onclick="window.showPage('profile')" class="size-10 rounded-full glass-card flex items-center justify-center text-white/70 active:scale-95 transition-transform">
                            <span class="material-symbols-outlined text-[24px]">arrow_back_ios_new</span>
                        </button>
                        <div>
                            <h1 class="text-xl font-extrabold tracking-tight">TOP ga olib chiqish</h1>
                            <p class="text-[11px] text-white/40 mt-0.5">E'loningizni yuqoriga ko'taring</p>
                        </div>
                    </div>
                </div>
            </header>
            <main class="max-w-md mx-auto px-6 py-5 space-y-6" style="padding-bottom: 140px;">
                <section class="glass-card rounded-3xl p-5 space-y-5">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-[11px] font-black uppercase tracking-[0.2em] text-white/40 mb-1">Kunlar soni</p>
                            <div class="flex items-baseline gap-2">
                                <span id="top-days-label" class="text-2xl font-extrabold text-primary">3</span>
                                <span class="text-[12px] text-white/50">kun</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-[10px] text-white/40 uppercase tracking-[0.16em]">1 kun narxi</p>
                            <p class="text-sm font-bold text-white/80">5 000 so'm</p>
                        </div>
                    </div>
                    <div class="pt-2">
                        <input id="top-days-input" type="range" min="1" max="30" value="3" class="w-full accent-primary">
                        <div class="flex justify-between mt-1 text-[10px] text-white/30 font-medium">
                            <span>1 kun</span>
                            <span>15 kun</span>
                            <span>30 kun</span>
                        </div>
                    </div>
                </section>
                <section class="glass-card rounded-3xl p-5 space-y-4">
                    <div class="flex items-center justify-between">
                        <p class="text-[11px] font-black uppercase tracking-[0.2em] text-white/40">Hisob-kitob</p>
                        <span id="top-discount-label" class="text-[11px] font-bold text-primary/80 bg-primary/10 px-2 py-0.5 rounded-full hidden"></span>
                    </div>
                    <div class="space-y-2 text-sm text-white/70">
                        <div class="flex items-center justify-between">
                            <span>Asosiy summa</span>
                            <span id="top-base-amount">15 000 so'm</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span>Chegirma</span>
                            <span id="top-discount-amount">0 so'm</span>
                        </div>
                        <div class="border-t border-white/10 pt-3 mt-2 flex items-center justify-between">
                            <span class="text-[12px] font-bold text-white/60">Yakuniy summa</span>
                            <span id="top-final-amount" class="text-lg font-extrabold text-primary">15 000 so'm</span>
                        </div>
                    </div>
                </section>
                <section class="glass-card rounded-3xl p-5 space-y-4">
                    <p class="text-[11px] font-black uppercase tracking-[0.2em] text-white/40">To'lov ma'lumotlari</p>
                    <div class="space-y-3">
                        <div class="bg-white/5 rounded-2xl p-4 border border-white/10">
                            <p class="text-white/60 text-[10px] uppercase tracking-wider mb-2">To'lov karta raqami</p>
                            <div class="flex items-center gap-3">
                                <span class="text-white text-sm font-mono" id="top-card-number">8600 1234 5678 9012</span>
                                <button type="button" onclick="copyToClipboard('8600123456789012')" class="text-primary hover:text-primary/80">
                                    <span class="material-symbols-outlined text-[18px]">content_copy</span>
                                </button>
                            </div>
                            <p class="text-white/40 text-[11px] mt-2" id="top-card-name">NIKOH APP</p>
                        </div>
                        <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-2xl p-4">
                            <p class="text-yellow-400 text-[12px] font-semibold mb-1">⚠️ Muhim</p>
                            <p class="text-[11px] text-yellow-100/90 leading-relaxed">
                                Avval yuqoridagi karta raqamiga tanlangan summa bo'yicha to'lov qiling, so'ngra pastdagi
                                shakl orqali to'lov chekini yuklang.
                            </p>
                        </div>
                    </div>
                </section>
                <section class="glass-card rounded-3xl p-5 space-y-4">
                    <p class="text-[11px] font-black uppercase tracking-[0.2em] text-white/40">Chekni yuklash</p>
                    <div class="space-y-3">
                        <label class="block">
                            <p class="text-white/60 text-[11px] uppercase tracking-wider mb-2">To'lov cheki rasmi *</p>
                            <div class="relative">
                                <input type="file" id="top-receipt-image" accept="image/*" class="hidden">
                                <label for="top-receipt-image" class="flex flex-col items-center justify-center w-full h-28 border-2 border-dashed border-white/20 rounded-xl cursor-pointer bg-white/5 hover:bg-white/10 transition-all">
                                    <span class="material-symbols-outlined text-white/40 text-[30px] mb-1">image</span>
                                    <p class="text-[11px] text-white/60">
                                        <span class="font-semibold text-primary">Rasm yuklash</span> yoki bu yerga bosing
                                    </p>
                                </label>
                                <p id="top-receipt-filename" class="mt-2 text-[11px] text-white/40 line-clamp-1"></p>
                            </div>
                        </label>
                        <label class="block">
                            <p class="text-white/60 text-[11px] uppercase tracking-wider mb-2">Qo'shimcha xabar (ixtiyoriy)</p>
                            <textarea id="top-payment-message" class="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-white text-sm focus:outline-none focus:border-primary/50" rows="3" placeholder="To'lov haqida qisqacha ma'lumot yozishingiz mumkin..."></textarea>
                        </label>
                    </div>
                </section>
                <button onclick="createTopPaymentRequest()" class="w-full h-14 bg-primary text-black rounded-2xl flex items-center justify-center gap-3 shadow-[0_12px_45px_rgba(64,255,0,0.3)] active:scale-[0.97] transition-all duration-200">
                    <span class="material-symbols-outlined text-[22px] font-bold">payments</span>
                    <span class="text-sm font-black uppercase tracking-[0.2em]">To'lov so'rovini yaratish</span>
                </button>
            </main>
        </div>

        <!-- GUIDE PAGE -->
        <div id="page-guide" class="page-container">
            <header class="pt-6 pb-3 px-6 sticky top-0 z-50 bg-background-dark/95 backdrop-blur-xl border-b border-white/5">
                <div class="max-w-md mx-auto flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <button onclick="window.showPage('profile')" class="size-10 rounded-full glass-card flex items-center justify-center text-white/70 active:scale-95 transition-transform">
                            <span class="material-symbols-outlined text-[24px]">arrow_back_ios_new</span>
                        </button>
                        <div>
                            <h1 class="text-xl font-extrabold tracking-tight">Qo'llanma</h1>
                            <p class="text-[11px] text-white/40 mt-0.5">Ilovani ishlatish bo'yicha qisqa yo'riqnoma</p>
                        </div>
                    </div>
                </div>
            </header>
            <main class="max-w-md mx-auto px-6 py-5 space-y-5" style="padding-bottom: 140px;">
                <section class="glass-card rounded-3xl p-5 space-y-4">
                    <div class="flex items-center gap-3">
                        <span class="material-symbols-outlined text-primary text-[26px]">info</span>
                        <div>
                            <h2 class="text-lg font-bold">Platforma haqida</h2>
                            <p class="text-[12px] text-white/50 mt-1">NIKOH - halol va xavfsiz tanishuv platformasi.</p>
                        </div>
                    </div>
                    <p class="text-sm text-white/70 leading-relaxed">
                        Bu yerda siz e'tibor bilan tanlangan foydalanuvchilar orasidan o'zingizga mos juftni izlaysiz.
                        Ma'lumotlaringiz maxfiy va faqat moderatsiyadan o'tgan profillar ko'rsatiladi.
                    </p>
                </section>
                <section class="glass-card rounded-3xl p-5 space-y-4">
                    <div class="flex items-center gap-3">
                        <span class="material-symbols-outlined text-primary text-[26px]">person_add</span>
                        <div>
                            <h2 class="text-lg font-bold">Profil yaratish</h2>
                            <p class="text-[12px] text-white/50 mt-1">Profilingizni iloji boricha to'liq to'ldiring.</p>
                        </div>
                    </div>
                    <p class="text-sm text-white/70 leading-relaxed">
                        To'liq profil siz haqingizda aniqroq tasavvur beradi va mos juft topish ehtimolini oshiradi.
                        Profil ma'lumotlaringizni istalgan vaqtda "Profilni tahrirlash" bo'limidan yangilashingiz mumkin.
                    </p>
                </section>
                <section class="glass-card rounded-3xl p-5 space-y-4">
                    <div class="flex items-center gap-3">
                        <span class="material-symbols-outlined text-primary text-[26px]">workspace_premium</span>
                        <div>
                            <h2 class="text-lg font-bold">Tarif va so'rovlar</h2>
                            <p class="text-[12px] text-white/50 mt-1">So'rov yuborish uchun aktiv tarif kerak.</p>
                        </div>
                    </div>
                    <p class="text-sm text-white/70 leading-relaxed">
                        Tarif orqali ma'lum miqdorda so'rov yuborish, profilingizni TOP ro'yxatga chiqarish va boshqa
                        qulayliklardan foydalanishingiz mumkin. Tarif holatini asosiy sahifada ko'rishingiz mumkin.
                    </p>
                </section>
                <section class="glass-card rounded-3xl p-5 space-y-4">
                    <div class="flex items-center gap-3">
                        <span class="material-symbols-outlined text-primary text-[26px]">favorite</span>
                        <div>
                            <h2 class="text-lg font-bold">Sevimlilar va chat</h2>
                            <p class="text-[12px] text-white/50 mt-1">Yoqqan profillarni saqlang va keyinroq ko'rib chiqing.</p>
                        </div>
                    </div>
                    <p class="text-sm text-white/70 leading-relaxed">
                        Profilni sevimlilarga qo'shish orqali uni yo'qotib qo'ymaysiz. So'rovingiz qabul qilingandan
                        keyin 7 kunlik chat ochiladi. Bu vaqt ichida bir-biringiz bilan yaxshiroq tanishib chiqing.
                    </p>
                </section>
            </main>
        </div>

        <!-- CONTACT PAGE -->
        <div id="page-contact" class="page-container">
            <header class="pt-6 pb-3 px-6 sticky top-0 z-50 bg-background-dark/95 backdrop-blur-xl border-b border-white/5">
                <div class="max-w-md mx-auto flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <button onclick="window.showPage('profile')" class="size-10 rounded-full glass-card flex items-center justify-center text-white/70 active:scale-95 transition-transform">
                            <span class="material-symbols-outlined text-[24px]">arrow_back_ios_new</span>
                        </button>
                        <div>
                            <h1 class="text-xl font-extrabold tracking-tight">Bog'lanish</h1>
                            <p class="text-[11px] text-white/40 mt-0.5">Savol va takliflar uchun aloqaga chiqing</p>
                        </div>
                    </div>
                </div>
            </header>
            <main class="max-w-md mx-auto px-6 py-5 space-y-5" style="padding-bottom: 140px;">
                <section class="glass-card rounded-3xl p-5 space-y-4">
                    <div class="flex items-center gap-3">
                        <span class="material-symbols-outlined text-primary text-[26px]">support_agent</span>
                        <div>
                            <h2 class="text-lg font-bold">Qo'llab-quvvatlash</h2>
                            <p class="text-[12px] text-white/50 mt-1">Tezkor yordam uchun Telegram orqali yozing.</p>
                        </div>
                    </div>
                    <a href="https://t.me/nikoh_support" target="_blank" class="w-full glass-card rounded-2xl p-4 flex items-center justify-between group active:scale-[0.97] transition-transform">
                        <div class="flex items-center gap-3">
                            <div class="size-10 rounded-xl bg-primary/10 flex items-center justify-center">
                                <span class="material-symbols-outlined text-primary text-[22px]">telegram</span>
                            </div>
                            <div>
                                <p class="text-sm font-bold">Telegram</p>
                                <p class="text-[11px] text-white/50">@nikoh_support</p>
                            </div>
                        </div>
                        <span class="material-symbols-outlined text-white/20 group-hover:text-primary transition-colors">open_in_new</span>
                    </a>
                </section>
                <section class="glass-card rounded-3xl p-5 space-y-4">
                    <div class="flex items-center gap-3">
                        <span class="material-symbols-outlined text-primary text-[26px]">email</span>
                        <div>
                            <h2 class="text-lg font-bold">Email</h2>
                            <p class="text-[12px] text-white/50 mt-1">Agar batafsil murojaat yozmoqchi bo'lsangiz.</p>
                        </div>
                    </div>
                    <div class="glass-card rounded-2xl p-4 flex items-center justify-between">
                        <div>
                            <p class="text-sm font-bold">support@nikoh.uz</p>
                            <p class="text-[11px] text-white/40 mt-1">Ish vaqti: 10:00 — 18:00 (du-shanba / ju-ma)</p>
                        </div>
                        <button onclick="copyToClipboard('support@nikoh.uz')" class="text-[11px] font-bold text-primary hover:underline">
                            Nusxalash
                        </button>
                    </div>
                </section>
            </main>
        </div>

        <!-- PARTNERSHIP PAGE -->
        <div id="page-partnership" class="page-container">
            <header class="pt-6 pb-3 px-6 sticky top-0 z-50 bg-background-dark/95 backdrop-blur-xl border-b border-white/5">
                <div class="max-w-md mx-auto flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <button onclick="window.showPage('profile')" class="size-10 rounded-full glass-card flex items-center justify-center text-white/70 active:scale-95 transition-transform">
                            <span class="material-symbols-outlined text-[24px]">arrow_back_ios_new</span>
                        </button>
                        <div>
                            <h1 class="text-xl font-extrabold tracking-tight">Hamkorlik</h1>
                            <p class="text-[11px] text-white/40 mt-0.5">Biz bilan ishlash imkoniyatlari</p>
                        </div>
                    </div>
                </div>
            </header>
            <main class="max-w-md mx-auto px-6 py-5 space-y-5" style="padding-bottom: 140px;">
                <section class="glass-card rounded-3xl p-5 space-y-4">
                    <div class="flex items-center gap-3">
                        <span class="material-symbols-outlined text-primary text-[26px]">handshake</span>
                        <div>
                            <h2 class="text-lg font-bold">Hamkorlik imkoniyatlari</h2>
                            <p class="text-[12px] text-white/50 mt-1">Birgalikdagi loyihalar va reklama imkoniyatlari.</p>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <div class="glass-card rounded-2xl p-4">
                            <h3 class="text-sm font-bold mb-1 flex items-center gap-2">
                                <span class="material-symbols-outlined text-primary text-[18px]">campaign</span>
                                Reklama va promo
                            </h3>
                            <p class="text-xs text-white/60 leading-relaxed">
                                Platformada sizning mahsulot yoki loyihangizni maqsadli auditoriyaga ko'rsatish.
                            </p>
                        </div>
                        <div class="glass-card rounded-2xl p-4">
                            <h3 class="text-sm font-bold mb-1 flex items-center gap-2">
                                <span class="material-symbols-outlined text-primary text-[18px]">groups</span>
                                Qo'shma loyihalar
                            </h3>
                            <p class="text-xs text-white/60 leading-relaxed">
                                Offline/online tadbirlar, treninglar va boshqa hamkorlik formatlari.
                            </p>
                        </div>
                    </div>
                </section>
                <section class="glass-card rounded-3xl p-5 space-y-4">
                    <div class="flex items-center gap-3">
                        <span class="material-symbols-outlined text-primary text-[26px]">contact_mail</span>
                        <div>
                            <h2 class="text-lg font-bold">Bog'lanish</h2>
                            <p class="text-[12px] text-white/50 mt-1">Hamkorlik uchun aloqaga chiqing.</p>
                        </div>
                    </div>
                    <a href="https://t.me/nikoh_partnership" target="_blank" class="w-full glass-card rounded-2xl p-4 flex items-center justify-between group active:scale-[0.97] transition-transform">
                        <div class="flex items-center gap-3">
                            <div class="size-10 rounded-xl bg-primary/10 flex items-center justify-center">
                                <span class="material-symbols-outlined text-primary text-[22px]">telegram</span>
                            </div>
                            <div>
                                <p class="text-sm font-bold">Telegram</p>
                                <p class="text-[11px] text-white/50">@nikoh_partnership</p>
                            </div>
                        </div>
                        <span class="material-symbols-outlined text-white/20 group-hover:text-primary transition-colors">open_in_new</span>
                    </a>
                    <div class="glass-card rounded-2xl p-4 flex items-center justify-between">
                        <div>
                            <p class="text-sm font-bold">partnership@nikoh.uz</p>
                            <p class="text-[11px] text-white/40 mt-1">Hamkorlik bo'yicha email</p>
                        </div>
                        <button onclick="copyToClipboard('partnership@nikoh.uz')" class="text-[11px] font-bold text-primary hover:underline">
                            Nusxalash
                        </button>
                    </div>
                </section>
            </main>
        </div>

        <!-- SHARE PAGE -->
        <div id="page-share" class="page-container">
            <header class="pt-6 pb-3 px-6 sticky top-0 z-50 bg-background-dark/95 backdrop-blur-xl border-b border-white/5">
                <div class="max-w-md mx-auto flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <button onclick="window.showPage('profile')" class="size-10 rounded-full glass-card flex items-center justify-center text-white/70 active:scale-95 transition-transform">
                            <span class="material-symbols-outlined text-[24px]">arrow_back_ios_new</span>
                        </button>
                        <div>
                            <h1 class="text-xl font-extrabold tracking-tight">Do'stlar bilan ulashish</h1>
                            <p class="text-[11px] text-white/40 mt-0.5">Do'stlaringizni ham platformaga taklif qiling</p>
                        </div>
                    </div>
                </div>
            </header>
            <main class="max-w-md mx-auto px-6 py-5 space-y-5" style="padding-bottom: 140px;">
                <section class="glass-card rounded-3xl p-5 space-y-4">
                    <div class="flex items-center gap-3">
                        <span class="material-symbols-outlined text-primary text-[26px]">share</span>
                        <div>
                            <h2 class="text-lg font-bold">Taklif linki</h2>
                            <p class="text-[12px] text-white/50 mt-1">Do'stlaringiz bilan ulashish uchun maxsus link.</p>
                        </div>
                    </div>
                    <p class="text-sm text-white/70 leading-relaxed">
                        Platforma sizga foydali bo'lsa, uni yaqinlaringiz bilan ham ulashing. Qanchalik ko'p
                        foydalanuvchi bo'lsa, shunchalik mos juft topish osonlashadi.
                    </p>
                    <button onclick="shareWithFriends()" class="w-full h-14 bg-primary text-black rounded-2xl flex items-center justify-center gap-3 shadow-[0_12px_45px_rgba(64,255,0,0.3)] active:scale-[0.97] transition-all duration-200">
                        <span class="material-symbols-outlined text-[22px] font-bold">send</span>
                        <span class="text-sm font-black uppercase tracking-[0.2em]">Do'stlar bilan ulashish</span>
                    </button>
                </section>
            </main>
        </div>

        <!-- TARIFF PAGE (tez ochilishi uchun asosiy faylda) -->
        <div id="page-tariff" class="page-container">
            <header class="pt-6 pb-3 px-6 sticky top-0 z-50 bg-background-dark/95 backdrop-blur-xl border-b border-white/5">
                <div class="max-w-md mx-auto flex items-center justify-between">
                    <button onclick="window.showPage('profile')" class="size-10 rounded-full glass-card flex items-center justify-center text-white/70 active:scale-95 transition-transform">
                        <span class="material-symbols-outlined text-[24px]">arrow_back_ios_new</span>
                    </button>
                    <h1 class="text-xl font-extrabold tracking-tight">Tariflar</h1>
                    <div class="w-10"></div>
                </div>
            </header>
            <main class="max-w-md mx-auto px-6 py-5 space-y-5" style="padding-bottom: 140px;">
                <p id="tariff-page-subtitle" class="text-sm text-white/50 text-center">O'zingizga mos tarifni tanlang</p>
                <div id="tariff-cards-container" class="space-y-4">
                    <div class="space-y-4 skeleton" style="min-height: 200px;"></div>
                </div>
            </main>
        </div>

        <!-- Background Gradient -->
        <div class="fixed top-0 left-0 w-full h-full pointer-events-none -z-10 overflow-hidden opacity-25">
            <div class="absolute top-[-20%] right-[-10%] w-[80%] h-[80%] bg-primary/20 blur-[180px] rounded-full"></div>
            <div class="absolute bottom-[-20%] left-[-10%] w-[80%] h-[80%] bg-primary/10 blur-[180px] rounded-full"></div>
        </div>
        
        <!-- Notification Toast -->
        <div id="notification-toast" class="hidden fixed top-20 left-1/2 -translate-x-1/2 z-50 max-w-md w-[90%]">
            <div class="glass-card rounded-2xl p-4 flex items-center gap-3 shadow-2xl border border-primary/30">
                <span class="material-symbols-outlined text-primary text-[24px]">check_circle</span>
                <p id="notification-message" class="text-white font-semibold flex-1"></p>
                <button onclick="window.hideNotification()" class="text-white/60 hover:text-white">
                    <span class="material-symbols-outlined text-[20px]">close</span>
                </button>
            </div>
        </div>

        <!-- To'liq profil va tarif talab qiluvchi modal (so'rov yuborish / e'lon joylash uchun) -->
        <div id="require-full-profile-modal" class="hidden fixed inset-0 z-[60] flex items-end sm:items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
            <div class="glass-card rounded-2xl p-6 max-w-md w-full shadow-2xl border border-primary/20">
                <div class="text-center mb-6">
                    <div class="size-16 mx-auto mb-4 rounded-2xl bg-primary/10 flex items-center justify-center">
                        <span class="material-symbols-outlined text-primary text-3xl">info</span>
                    </div>
                    <h3 class="text-lg font-bold mb-2">To'liq profil va tarif kerak</h3>
                    <p class="text-sm text-white/60 leading-relaxed">
                        So'rov yuborish va e'lon joylash uchun avval batafsil ma'lumotlarni to'ldiring (to'liq profil), keyin tarif sotib oling.
                    </p>
                </div>
                <div class="space-y-3">
                    <button type="button" onclick="window.openFullProfileFromModal()" class="w-full bg-primary text-black font-bold py-3.5 rounded-xl text-sm uppercase tracking-wider active:scale-[0.98] transition-all">
                        To'liq profil to'ldirish
                    </button>
                    <button type="button" onclick="document.getElementById('require-full-profile-modal').classList.add('hidden'); window.showPage('tariff')" class="block w-full bg-white/10 text-white font-bold py-3.5 rounded-xl text-sm uppercase tracking-wider text-center border border-white/20 active:scale-[0.98] transition-all">
                        Tarif sotib olish
                    </button>
                    <button type="button" onclick="document.getElementById('require-full-profile-modal').classList.add('hidden')" class="w-full text-white/50 text-sm py-2">
                        Yopish
                    </button>
                </div>
            </div>
        </div>

        <!-- Yangi e'lon qo'shish haqida (avval ma'lumot, keyin Boshlash) -->
        <div id="new-listing-info-modal" class="hidden fixed inset-0 z-[60] flex items-end sm:items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
            <div class="glass-card rounded-2xl p-6 max-w-md w-full shadow-2xl border border-primary/20">
                <div class="text-center mb-6">
                    <div class="size-16 mx-auto mb-4 rounded-2xl bg-primary/10 flex items-center justify-center">
                        <span class="material-symbols-outlined text-primary text-3xl">add_circle</span>
                    </div>
                    <h3 class="text-lg font-bold mb-2">Yangi e'lon qo'shish</h3>
                    <p class="text-sm text-white/60 leading-relaxed">
                        Aka, opa yoki ota uchun alohida e'lon yaratishingiz mumkin. Har bir e'lon uchun ism, yosh, joylashuv va boshqa ma'lumotlarni to'ldirish talab qilinadi. Boshlash tugmasini bosing va formani to'ldiring.
                    </p>
                </div>
                <div class="space-y-3">
                    <button type="button" onclick="document.getElementById('new-listing-info-modal').classList.add('hidden'); window.startNewListing();" class="w-full bg-primary text-black font-bold py-3.5 rounded-xl text-sm uppercase tracking-wider active:scale-[0.98] transition-all">
                        Boshlash
                    </button>
                    <button type="button" onclick="document.getElementById('new-listing-info-modal').classList.add('hidden')" class="w-full text-white/50 text-sm py-2">
                        Yopish
                    </button>
                </div>
            </div>
        </div>

        <!-- To'lov modali (tarif sotib olish — SPA ichida) -->
        <div id="tariff-payment-modal" class="hidden fixed inset-0 z-[60] flex items-end sm:items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
            <div class="glass-card rounded-t-3xl sm:rounded-2xl p-6 max-w-md w-full max-h-[90vh] overflow-y-auto shadow-2xl border border-white/10">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-white">To'lov</h3>
                    <button type="button" onclick="window.closeTariffPaymentModal()" class="text-white/60 hover:text-white p-1">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
                <div class="space-y-4">
                    <div class="bg-white/5 rounded-xl p-4 border border-white/10">
                        <p class="text-white/60 text-xs uppercase tracking-wider mb-1">Tarif</p>
                        <p id="tariff-payment-name" class="text-white text-lg font-bold"></p>
                        <p id="tariff-payment-price" class="text-primary text-xl font-bold mt-1"></p>
                    </div>
                    <div class="bg-white/5 rounded-xl p-4 border border-white/10">
                        <p class="text-white/60 text-xs uppercase tracking-wider mb-2">Karta raqami</p>
                        <div class="flex items-center gap-2">
                            <span class="text-white font-mono text-sm" id="tariff-payment-card"></span>
                            <button type="button" onclick="window.copyTariffCardNumber()" class="text-primary">
                                <span class="material-symbols-outlined text-[20px]">content_copy</span>
                            </button>
                        </div>
                        <p class="text-white/40 text-xs mt-1" id="tariff-payment-card-name"></p>
                    </div>
                    <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-xl p-3">
                        <p class="text-yellow-400 text-xs font-semibold">To'lov chekini yuklang, admin tekshiradi</p>
                    </div>
                    <div>
                        <label class="block text-white/60 text-xs uppercase tracking-wider mb-2">To'lov cheki rasmi *</label>
                        <input type="file" id="tariff-payment-receipt" accept="image/*" class="hidden">
                        <label for="tariff-payment-receipt" class="flex flex-col items-center justify-center w-full h-28 border-2 border-dashed border-white/20 rounded-xl cursor-pointer bg-white/5 hover:bg-white/10 transition-all">
                            <span class="material-symbols-outlined text-white/40 text-[32px]">image</span>
                            <span class="text-sm text-white/60 mt-1" id="tariff-payment-receipt-label">Rasm yuklash</span>
                        </label>
                        <div id="tariff-payment-receipt-preview" class="hidden mt-2 relative">
                            <img id="tariff-payment-preview-img" src="" alt="" class="w-full h-40 object-cover rounded-xl border border-white/10">
                            <button type="button" onclick="window.clearTariffReceipt()" class="absolute top-2 right-2 bg-red-500/90 text-white rounded-full p-1.5">
                                <span class="material-symbols-outlined text-[18px]">close</span>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-white/60 text-xs uppercase tracking-wider mb-2">Qo'shimcha xabar (ixtiyoriy)</label>
                        <textarea id="tariff-payment-message" class="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-white text-sm focus:outline-none focus:border-primary/50 resize-none" rows="2" placeholder="To'lov haqida..."></textarea>
                    </div>
                    <div class="flex gap-3 pt-2">
                        <button type="button" onclick="window.closeTariffPaymentModal()" class="flex-1 h-12 bg-white/10 border border-white/10 rounded-xl text-white font-semibold text-sm">Bekor qilish</button>
                        <button type="button" id="tariff-payment-submit-btn" onclick="window.submitTariffPayment()" class="flex-1 h-12 bg-primary text-black font-bold text-sm rounded-xl active:scale-[0.98]">Yuborish</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main JavaScript - Inline for instant loading -->
    <script>
        // Telegram Web App initialization
        const tg = window.Telegram?.WebApp;
        if (tg) {
            tg.ready();
            tg.expand();
            tg.setHeaderColor('#0a0a0b');
            tg.setBackgroundColor('#0a0a0b');
            if (typeof tg.disableVerticalSwipes === 'function') {
                tg.disableVerticalSwipes();
            }
        }

        // Haptic (taptic) — yengil va tez
        function hapticTap(type = 'light') {
            try {
                if (tg && tg.HapticFeedback && typeof tg.HapticFeedback.impactOccurred === 'function') {
                    tg.HapticFeedback.impactOccurred(type);
                }
            } catch (e) {}
        }
        // Har bir bosishda darhol haptic (capture — birinchi ishlaydi)
        function initGlobalHaptic() {
            function trigger(e) {
                if (e.target && e.target.closest('button, a, [onclick], [role="button"], .nav-link, .glass-card[onclick], .feed-gender-btn')) {
                    hapticTap('light');
                }
            }
            document.addEventListener('touchend', trigger, { capture: true, passive: true });
            document.addEventListener('mousedown', trigger, { capture: true, passive: true });
        }

        // Global state
        let currentPage = 'feed';
        let userData = null;
        let hasActiveTariff = false;
        let lastTariffCheck = null; // Obuna tekshiruvi uchun
        let onboardingDone = false;

        // Chiqib ketgach qayt kirganda ko'rsatish uchun localStorage cache (7 kun)
        const NIKOH_CACHE_USER = 'nikoh_user';
        const NIKOH_CACHE_FEED = 'nikoh_feed';
        const NIKOH_CACHE_FAVORITES = 'nikoh_favorites';
        const NIKOH_CACHE_MAX_AGE_MS = 7 * 24 * 60 * 60 * 1000;

        function restoreFromLocalStorage() {
            try {
                const rawUser = localStorage.getItem(NIKOH_CACHE_USER);
                if (rawUser) {
                    const parsed = JSON.parse(rawUser);
                    if (parsed && parsed.data && (Date.now() - (parsed.t || 0)) < NIKOH_CACHE_MAX_AGE_MS) {
                        userData = parsed.data;
                        hasActiveTariff = parsed.data.tariff && parsed.data.tariff.has_active_tariff;
                        lastTariffCheck = hasActiveTariff;
                        if (typeof pageDataLoaded !== 'undefined') pageDataLoaded.profile = true;
                    }
                }
                const rawFeed = localStorage.getItem(NIKOH_CACHE_FEED);
                if (rawFeed) {
                    const parsed = JSON.parse(rawFeed);
                    if (parsed && (Date.now() - (parsed.t || 0)) < NIKOH_CACHE_MAX_AGE_MS && parsed.Ayol) {
                        if (typeof feedCacheByGender !== 'undefined') {
                            feedCacheByGender.Ayol = parsed.Ayol;
                            feedCacheByGender.Erkak = parsed.Erkak || null;
                        }
                        if (parsed.feedGender && typeof feedGender !== 'undefined') feedGender = parsed.feedGender;
                    }
                }
                const rawFav = localStorage.getItem(NIKOH_CACHE_FAVORITES);
                if (rawFav) {
                    const parsed = JSON.parse(rawFav);
                    if (parsed && parsed.favorites && Array.isArray(parsed.favorites) && (Date.now() - (parsed.t || 0)) < NIKOH_CACHE_MAX_AGE_MS) {
                        try { favoritesCache = parsed.favorites.filter(f => f && f.favorite_user); } catch (e) {}
                    }
                }
            } catch (e) { console.warn('Cache restore:', e); }
        }

        function saveUserDataToCache() {
            try {
                if (userData) localStorage.setItem(NIKOH_CACHE_USER, JSON.stringify({ t: Date.now(), data: userData }));
            } catch (e) {}
        }

        function saveFeedToCache() {
            try {
                if (typeof feedCacheByGender !== 'undefined' && (feedCacheByGender.Ayol || feedCacheByGender.Erkak))
                    localStorage.setItem(NIKOH_CACHE_FEED, JSON.stringify({ t: Date.now(), Ayol: feedCacheByGender.Ayol, Erkak: feedCacheByGender.Erkak, feedGender: typeof feedGender !== 'undefined' ? feedGender : 'Ayol' }));
            } catch (e) {}
        }
        function saveFavoritesToCache() {
            try {
                if (typeof favoritesCache !== 'undefined' && favoritesCache.length >= 0)
                    localStorage.setItem(NIKOH_CACHE_FAVORITES, JSON.stringify({ t: Date.now(), favorites: favoritesCache }));
            } catch (e) {}
        }

        // Davlatlar va viloyatlar (barcha joylarda ishlatiladi)
        const LOCATION_COUNTRIES_REGIONS = {
            "O'zbekiston": ["Toshkent shahar","Toshkent viloyati","Samarqand","Buxoro","Andijon","Farg'ona","Namangan","Qashqadaryo","Surxondaryo","Xorazm","Navoiy","Jizzax","Sirdaryo","Qoraqalpog'iston"],
            "Qozog'iston": ["Olmaota","Ostona","Shymkent","Qarag'anda","Aqtobe","Pavlodar","Semey","Oral","Atirau","Qostanay","Oqmoʻla","Shimoliy Qozog'iston","Sharqiy Qozog'iston","Mangʻistau"],
            "Qirg'iziston": ["Bishkek","O'sh","Jalal-Abad","Qorako'l","Naryn","Batlken","Talas","Chuy","Issiqko'l"],
            "Tojikiston": ["Dushanbe","Xujand","Qurghonteppa","Kulob","Istaravshan","Panjakent","Xatlon","Sughd","Badaxshon"],
            "Turkmaniston": ["Ashxobod","Turkmanobod","Mary","Balkanobod","Dasoguz","Boldumsaz","Tejen"],
            "Rossiya": ["Moskva","Sankt-Peterburg","Qozon","Novosibirsk","Yekaterinburg","Samara","Rostov","Nijniy Novgorod","Chelyabinsk","Krasnodar","Sochi","Krasnoyarsk","Perm","Voronej","Volgograd","Saratov","Krasnodar","Ufa","Tyumen","Omsk","Tolyatti","Kemerovo","Habarovsk","Vladivostok","Irkutsk","Yaroslavl","Tula","Lipetsk","Tatariston","Bashqirdiston","Dagiston","Checheniston","Krasnodar o'lkasi","Stavropol o'lkasi"],
            "Turkiya": ["Istanbul","Ankara","Izmir","Bursa","Antalya","Adana","Konya","Gaziantep","Kayseri","Mersin","Eskişehir","Diyarbakir","Samsun","Denizli","Trabzon","Malatya","Kocaeli","Manisa","Kahramanmaraş","Van","Afyon","Aydin","Tekirdag","Sakarya","Muğla","Mardin"],
            "Ozarbayjon": ["Boku","Ganja","Sumqayit","Lankaran","Mingachevir","Naxchivan","Shirvan","Shaki","Yevlax","Quba","Qusar","Masalli","Lachin","Fuzuli"],
            "Gruziya": ["Tbilisi","Batumi","Kutaisi","Rustavi","Zugdidi","Gori","Poti","Samtredia","Kobuleti","Mtsxeta"],
            "Armaniston": ["Yerevan","Gyumri","Vanadzor","Vagharshapat","Abovyan","Kapan","Armavir","Hrazdan","Artashat"],
            "Afg'oniston": ["Kobul","Qandahor","Herat","Mazori Sharif","Jalolobod","Kunduz","Pol-e Xomri","Bog'lon","Bomiyon"],
            "Pokiston": ["Islomobod","Lahor","Karachi","Peshovar","Quetta","Faysolobod","Rawalpindi","Multon","Sarg'odha","Sialkot","Gujranvala"],
            "Hindiston": ["Dehli","Mumbai","Bangalor","Chennay","Kolkata","Haydarobod","Pune","Ahmadobod","Jaipur","Surat","Lucknow","Kanpur","Nagpur","Indor","Thane","Bhopal","Visakhapatnam","Patna","Ludhiana","Agra"],
            "Bangladesh": ["Dakka","Chittagong","Rajshahi","Khulna","Sylhet","Barisal","Rangpur","Mymensingh","Comilla","Narayanganj"],
            "Nepal": ["Kathmandu","Pokhara","Lalitpur","Biratnagar","Bharatpur","Janakpur","Hetauda","Dharan"],
            "Shri Lanka": ["Kolombo","Kandi","Galle","Jaffna","Negombo","Anuradhapura","Trincomalee","Batticaloa","Ratnapura"],
            "Malayziya": ["Kuala Lumpur","George Town","Johor Bahru","Ipoh","Shah Alam","Petaling Jaya","Kuching","Kota Kinabalu","Alor Setar","Kota Bharu"],
            "Indoneziya": ["Jakarta","Surabaya","Bandung","Medan","Semarang","Makassar","Palembang","Batam","Pekanbaru","Bogor","Denpasar"],
            "Tailand": ["Bangkok","Chiang Mai","Phuket","Hat Yai","Udon Thani","Khon Kaen","Nakhon Ratchasima","Nakhon Si Thammarat","Lampang"],
            "Vyetnam": ["Ho Chi Minh","Hanoi","Da Nang","Haiphong","Can Tho","Nha Trang","Hue","Vung Tau","Da Lat","Qui Nhon"],
            "Filippin": ["Manila","Quezon City","Davao","Cebu","Caloocan","Zamboanga","Taguig","Antipolo","Cagayan de Oro","Pasig"],
            "Singapur": ["Singapur"],
            "Saudiya Arabistoni": ["Ar-Riyod","Jidda","Makkah","Madina","Dammam","Tabuk","Abha","Taif","Buroyda","Khomis Mushayt"],
            "BAA": ["Dubay","Abu Dabi","Sharja","Ajman","Ras al-Xayma","Fujayra","Umm al-Qaywayn"],
            "Quvayt": ["Quvayt shahri","Hawalli","Ahmadi","Jahra","Farwania","Mubarak al-Kabir"],
            "Bahrayn": ["Manama","Muharraq","Riffa","Hamad Town","Isa Town","Sitra"],
            "Qatar": ["Doha","Al Rayyan","Al Wakrah","Al Khor","Umm Salal","Mesaieed"],
            "Ummon": ["Maskat","Salala","Suhar","Nizva","Sur","Ibri","Barka","Rustaq"],
            "Iroq": ["Bag'dod","Basra","Mosul","Arbil","Najaf","Karbalo","Sulaymaniya","Kirkuk","Nasiriya"],
            "Eron": ["Tehron","Mashhad","Isfahan","Shiraz","Tabriz","Qum","Ahvoz","Kermonshoh","Rasht","Kerman"],
            "Iordaniya": ["Amman","Zarqa","Irbid","Ras al-Ayn","Aqaba","Madaba","Jerash","Salt"],
            "Suriya": ["Damashq","Halab","Hims","Hama","Latakiya","Raqqa","Daraa","Idlib","Tartus"],
            "Livan": ["Bayrut","Tripoli","Sidon","Tyr","Jounieh","Zahle","Baalbek","Nabatiye"],
            "Yaman": ["Sana","Aden","Taizz","Al Hudaydah","Ibb","Dhamar","Mukalla","Say'un"],
            "Misr": ["Qohira","Iskandariya","Giza","Sharm al-Shayx","Luxor","Asuan","Port Said","Suez","Mansura","Tanta","Fayyum"],
            "Liviya": ["Tripoli","Banghazi","Misrata","Bayda","Tobruk","Sabha","Zawiya","Ajdabiya"],
            "Tunis": ["Tunis","Sfax","Sousse","Kairuan","Bizerte","Gabes","Monastir","Béja","Jendouba"],
            "Jazoir": ["Jazoir shahri","Oran","Konstantin","Annaba","Blida","Batna","Setif","Sidi Bel Abbes","Biskra"],
            "Marokash": ["Rabat","Casablanca","Fes","Marakesh","Tanger","Agadir","Meknes","Oujda","Kenitra"],
            "Sudan": ["Xartum","Omdurman","Port Sudan","Kassala","Gedaref","Nyala","Al Fashir","Kosti"],
            "Germaniya": ["Berlin","Myunxen","Gamburg","Keln","Frankfurt","Shtutgart","Dusseldorf","Leypsig","Dortmund","Essen","Bremen","Drezden","Hanover","Nurnberg","Duisburg"],
            "Fransiya": ["Parij","Marsel","Lion","Tuluza","Nitsa","Nant","Strasburg","Montpellier","Bordo","Lill","Renn","Reims","Sent-Etyen","Tulon","Grenobl"],
            "Buyuk Britaniya": ["London","Birmingem","Lids","Glazgo","Sheffild","Bristol","Manchester","Edinburg","Liverpul","Lester","Koventry","Nottingem","Belfast","Kardiff"],
            "Italiya": ["Rim","Milan","Neapol","Turin","Palermo","Genuya","Bologna","Florentsiya","Venetsiya","Verona","Messina","Padua","Triest","Brescia","Taranto"],
            "Ispaniya": ["Madrid","Barselona","Valensiya","Sevilya","Saragosa","Malaga","Murcia","Palma","Las Palmas","Bilbao","Alicante","Kordova","Valladolid"],
            "Niderlandiya": ["Amsterdam","Rotterdam","Gaaga","Utrext","Eindhoven","Groningen","Tilburg","Almere","Breda","Nijmegen"],
            "Belgiya": ["Bryussel","Antverpen","Gent","Charleroi","Lyej","Brugge","Namur","Loven","Mons","Aalst"],
            "Shveysariya": ["Syurix","Jeneva","Bazel","Bern","Lozanna","Lucerne","Lugano","Winterthur","St. Gallen"],
            "Avstriya": ["Vena","Graz","Lints","Zalsburg","Innsbruck","Klagenfurt","Villach","Vels","Sankt Pölten"],
            "Polsha": ["Varshava","Krakov","Lodz","Vrotslav","Poznan","Gdansk","Shchetsin","Bydgoszcz","Lublin","Katowice"],
            "Ukraina": ["Kiyev","Xarkov","Odessa","Dnepr","Donetsk","Zaporijiya","Lvov","Krivoy Rog","Nikolayev","Mariupol"],
            "Belarus": ["Minsk","Gomel","Mogilyov","Vitebsk","Grodno","Brest","Bobruysk","Baranovichi","Pinsk","Orsha"],
            "Litva": ["Vilnyus","Kaunas","Klaipeda","Siauliai","Panevezys","Alytus","Marijampole","Mazeikiai","Utena"],
            "Latviya": ["Riga","Daugavpils","Liepaja","Jelgava","Jurmala","Ventspils","Rezekne","Valmiera","Jekabpils"],
            "Estoniya": ["Tallin","Tartu","Narva","Parnu","Kohtla-Jarve","Viljandi","Rakvere","Sillamae","Maardu"],
            "Finlandiya": ["Helsinki","Espoo","Tampere","Vantaa","Oulu","Turku","Jyväskylä","Lahti","Kuopio","Pori"],
            "Shvetsiya": ["Stokgolm","Gothenburg","Malmö","Uppsala","Västerås","Örebro","Linköping","Helsingborg","Jönköping","Norrköping"],
            "Norvegiya": ["Oslo","Bergen","Trondheim","Stavanger","Drammen","Fredrikstad","Kristiansand","Sandnes","Tromsø","Sarpsborg"],
            "Daniya": ["Kopengagen","Aarhus","Odense","Aalborg","Frederiksberg","Esbjerg","Gentofte","Gladsaxe","Randers","Kolding"],
            "AQSH": ["New York","Los Angeles","Chicago","Houston","Phoenix","Philadelphia","San Antonio","San Diego","Dallas","San Jose","Austin","Jacksonville","Fort Worth","Columbus","Charlotte","San Francisco","Indianapolis","Seattle","Denver","Boston"],
            "Kanada": ["Toronto","Montreal","Vancouver","Calgary","Edmonton","Ottawa","Winnipeg","Quebec","Hamilton","Kitchener"],
            "Meksika": ["Mexiko shahri","Guadalajara","Monterrey","Puebla","Tijuana","Leon","Juarez","Zapopan","Merida","Cancun"],
            "Braziliya": ["San-Paulu","Rio-de-Janeyro","Brasilia","Salvador","Fortaleza","Belo Horizonte","Manaus","Kuritiba","Resifi","Portu-Alegri"],
            "Argentina": ["Buenos Ayres","Kordova","Rosario","Mendoza","San Miguel de Tukuman","La Plata","Mar del Plata","Salta","Santa Fe","San Xuan"],
            "Xitoy": ["Pekin","Shanxay","Guanchjou","Shenchjen","Chengdu","Xanchjou","Uxan","Xi'an","Tianjin","Nanjing","Chunqing","Suzhou","Dongguan","Kunming","Qingdao"],
            "Yaponiya": ["Tokio","Yokohama","Osaka","Nagoya","Sapporo","Kobe","Kioto","Fukuoka","Kawasaki","Saitama"],
            "Janubiy Koreya": ["Seul","Busan","Incheon","Daegu","Daejeon","Gwangju","Suwon","Ulsan","Changwon","Seongnam"],
            "Tayvan": ["Taypey","Kaohsiung","Taichung","Tainan","Banqiao","Taoyuan","Keelung","Hsinchu","Changhua"],
            "Avstraliya": ["Sidney","Melburn","Brisben","Perth","Adelaida","Gold Coast","Newcastle","Canberra","Sunshine Coast","Wollongong"],
            "Yangi Zelandiya": ["Oklend","Vellington","Christchurch","Hamilton","Tauranga","Napier-Hastings","Dunedin","Palmerston North","Nelson","Rotorua"],
            "Janubiy Afrika": ["Yohannesburg","Keyp Taun","Durban","Pretoriya","Port Elizabet","Bloemfontein","East London","Pietermaritzburg","Kimberley"],
            "Nigeriya": ["Lagos","Abuja","Kano","Ibadan","Kaduna","Port Harcourt","Benin City","Maiduguri","Zaria","Aba"],
            "Keniya": ["Nairobi","Mombasa","Kisumu","Nakuru","Eldoret","Thika","Malindi","Kitale","Garissa","Kakamega"],
            "Boshqa": []
        };

        // Sahifa ma'lumotlari faqat 1 marta yuklanadi (sahifadan sahifaga qaytganda qayta yuklanmaydi)
        let pageDataLoaded = { feed: false, chats: false, favorites: false, profile: false, requests: false, listings: false, tariff: false };
        window.invalidatePageCache = function(pageName) {
            if (pageDataLoaded[pageName] !== undefined) pageDataLoaded[pageName] = false;
        };

        // Page navigation — ozgina qimirlash, tez (Xabarlar: faqat birinchi kirganda yuklanadi, sahifa almashganda qayta yuklanmaydi)
        window.showPage = function(pageName) {
            if (currentPage === pageName) return;
            
            const currentEl = document.querySelector('.page-container.active');
            const targetPage = document.getElementById(`page-${pageName}`);
            if (!targetPage) return;
            
            var switched = false;
            function doSwitch() {
                if (switched) return;
                switched = true;
                if (currentEl) currentEl.classList.remove('active', 'page-leave');
                targetPage.classList.add('active');
                currentPage = pageName;
                updateNav(pageName);
                setTimeout(() => loadPageData(pageName), 0);
                window.scrollTo({ top: 0, behavior: 'instant' });
            }
            
            if (currentEl && currentEl !== targetPage) {
                currentEl.classList.add('page-leave');
                targetPage.classList.add('active');
                currentPage = pageName;
                updateNav(pageName);
                setTimeout(() => loadPageData(pageName), 0);
                window.scrollTo({ top: 0, behavior: 'instant' });
                currentEl.addEventListener('transitionend', function onEnd(e) {
                    if (e.target !== currentEl || e.propertyName !== 'opacity') return;
                    if (currentEl.classList.contains('page-leave')) {
                        currentEl.classList.remove('active', 'page-leave');
                    }
                }, { once: true });
                setTimeout(function() { currentEl.classList.remove('active', 'page-leave'); }, 120);
            } else {
                if (currentEl) currentEl.classList.remove('active');
                doSwitch();
            }
        };

        function updateNav(activePage) {
            const nav = document.querySelector('nav');
            
            // Chat view sahifasida navbar'ni yashirish
            if (activePage === 'chat-view') {
                if (nav) {
                    nav.style.display = 'none';
                }
                return;
            }
            
            // Boshqa sahifalarda navbar'ni ko'rsatish
            if (nav) {
                nav.style.display = '';
            }
            
            // Barcha navigatsiya linklarini yangilash
            document.querySelectorAll('.nav-link').forEach(link => {
                const page = link.getAttribute('data-page');
                const icon = link.querySelector('.material-symbols-outlined');
                const text = link.querySelector('span:last-child');
                
                if (page === activePage) {
                    // Faol link
                    link.classList.remove('text-white/30', 'hover:text-white');
                    link.classList.add('text-primary');
                    if (icon) {
                        icon.style.fontVariationSettings = "'FILL' 1";
                    }
                    if (text) {
                        text.classList.remove('text-white/30');
                        text.classList.add('text-primary');
                    }
                } else {
                    // Nofaol link
                    link.classList.remove('text-primary');
                    link.classList.add('text-white/30', 'hover:text-white');
                    if (icon) {
                        icon.style.fontVariationSettings = "'FILL' 0";
                    }
                    if (text) {
                        text.classList.remove('text-primary');
                        text.classList.add('text-white/30');
                    }
                }
            });
        }

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }

        function initApp() {
            initGlobalHaptic();
            var modalEl = document.getElementById('feed-profile-modal');
            if (modalEl && modalEl.parentNode && modalEl.parentNode !== document.body) {
                document.body.appendChild(modalEl);
            }
            restoreFromLocalStorage();
            // Oldin kirgan bo'lsa: cache bilan darhol ko'rsatish, keyin orqada yangi ma'lumot yuklanadi
            if (currentPage === 'feed' && typeof applyFeedFromCache === 'function' && typeof feedCacheByGender !== 'undefined' && typeof feedGender !== 'undefined' && feedCacheByGender[feedGender] && feedCacheByGender[feedGender].listings && feedCacheByGender[feedGender].listings.length > 0) {
                applyFeedFromCache(feedCacheByGender[feedGender]);
                if (typeof updateFeedGenderUI === 'function') updateFeedGenderUI();
            }
            if (userData && currentPage === 'feed' && typeof updateFeedTariffInfo === 'function') updateFeedTariffInfo();

            // Welcome va oddiy ro'yxatdan o'tish
            const welcomeStartBtn = document.getElementById('welcome-start-btn');
            if (welcomeStartBtn) {
                welcomeStartBtn.addEventListener('click', () => {
                    hapticTap('medium');
                    document.getElementById('welcome-screen').classList.add('hidden');
                    document.getElementById('welcome-screen').style.display = 'none';
                    const simpleReg = document.getElementById('simple-reg-form');
                    simpleReg.classList.remove('hidden');
                    simpleReg.style.display = 'flex';
                });
            }
            const simpleRegBack = document.getElementById('simple-reg-back');
            if (simpleRegBack) {
                simpleRegBack.addEventListener('click', () => {
                    hapticTap('light');
                    document.getElementById('simple-reg-form').classList.add('hidden');
                    document.getElementById('simple-reg-form').style.display = 'none';
                    const welcome = document.getElementById('welcome-screen');
                    welcome.classList.remove('hidden');
                    welcome.style.display = 'flex';
                });
            }
            const simpleRegForm = document.getElementById('simple-reg-form');
            if (simpleRegForm) {
                simpleRegForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const btn = document.getElementById('simple-reg-submit');
                    if (btn) { btn.disabled = true; btn.textContent = 'SAQLANMOQDA...'; }
                    const formData = new FormData();
                    formData.append('phone_number', document.getElementById('simple-phone').value.trim());
                    formData.append('name', document.getElementById('simple-name').value.trim());
                    formData.append('birth_year', document.getElementById('simple-birth_year').value);
                    const genderRadio = simpleRegForm.querySelector('input[name="gender"]:checked');
                    if (genderRadio) formData.append('gender', genderRadio.value);
                    try {
                        const response = await fetch('/profile/edit', { method: 'POST', body: formData, credentials: 'same-origin' });
                        const data = await response.json();
                        if (response.ok && data.success) {
                            hapticTap('heavy');
                            onboardingDone = true;
                            await initUserData();
                            closeOnboardingOverlay();
                            window.showPage('feed');
                            loadPageData('feed');
                        } else {
                            alert(data.message || "Xatolik. Qaytadan urinib ko'ring.");
                        }
                    } catch (err) {
                        console.error(err);
                        alert("Internet aloqasini tekshiring.");
                    } finally {
                        if (btn) { btn.disabled = false; btn.textContent = "DAVOM ETISH"; }
                    }
                });
            }

            function closeOnboardingOverlay() {
                const overlay = document.getElementById('onboarding-overlay');
                const nav = document.querySelector('nav');
                const feedHeader = document.querySelector('#page-feed header');
                const feedPage = document.getElementById('page-feed');
                if (overlay) overlay.classList.add('hidden');
                if (nav) nav.classList.remove('hidden');
                if (feedHeader) feedHeader.style.display = '';
                if (feedPage) feedPage.style.display = '';
                document.querySelectorAll('.page-container').forEach(page => { page.style.display = ''; });
            }
            window.closeOnboardingOverlay = closeOnboardingOverlay;

            // Navigation event listeners
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const page = link.getAttribute('data-page');
                    if (page) window.showPage(page);
                });
            });
            
            // URL'dan chat_id'ni o'qish va chat view'ni ochish
            const urlPath = window.location.pathname;
            const chatMatch = urlPath.match(/^\/chat\/(\d+)$/);
            if (chatMatch) {
                const chatId = parseInt(chatMatch[1]);
                window.history.replaceState({}, '', '/');
                initUserData().then(() => { showChatView(chatId); });
                return;
            }
            
            // Orqada yangi ma'lumot yuklanadi (user kutmaydi, cache bilan ishlaydi)
            const initPromises = [initUserData()];
            if (currentPage === 'feed') initPromises.push(loadFeedListings(1));
            Promise.all(initPromises).then(() => {
                // Obuna holatini tekshirish (har 10 soniyada)
                setInterval(async () => {
                    try {
                        const response = await fetch('/api/user-data', {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Requested-With': 'XMLHttpRequest'
                            },
                            credentials: 'same-origin'
                        });
                        if (response.ok) {
                            const newUserData = await response.json();
                            const newHasActiveTariff = newUserData.tariff?.has_active_tariff || false;
                            
                            // Obuna qabul bo'lganini tekshirish
                            if (lastTariffCheck !== null && !hasActiveTariff && newHasActiveTariff) {
                                // Obuna yangi qabul qilindi
                                if (typeof window.showNotification === 'function') {
                                    window.showNotification('✅ Obunangiz qabul qilindi! Endi e\'lon yaratishingiz mumkin.');
                                }
                                // User data ni yangilash
                                await initUserData();
                                if (currentPage === 'profile') {
                                    updateProfileUI();
                                }
                            }
                            
                            hasActiveTariff = newHasActiveTariff;
                            lastTariffCheck = hasActiveTariff;
                        }
                    } catch (error) {
                        console.error('Error checking tariff status:', error);
                    }
                }, 30000); // 30 soniyada bir marta (kamroq yuk, tezroq ilova)
                
                // Update UI with user data
                if (currentPage === 'feed') {
                    updateFeedTariffInfo();
                    if (typeof updateFeedGenderUI === 'function') updateFeedGenderUI();
                } else if (currentPage === 'profile') {
                    updateProfileUI();
                }

                // Agar minimal ro'yxatdan o'tmagan bo'lsa: ilovani tanishtirish + oddiy ro'yxatdan o'tish
                if (userData && userData.user && !userData.user.profile_basic_complete) {
                    onboardingDone = false;
                    openOnboarding('welcome');
                } else {
                    onboardingDone = true;
                    // Feed allaqachon parallel yuklangan; boshqa sahifalar uchun loadPageData
                    if (currentPage !== 'feed') {
                        loadPageData(currentPage);
                        setTimeout(function() {
                            if (typeof loadFeedListings === 'function' && !pageDataLoaded.feed) loadFeedListings(1);
                        }, 350);
                    }
                }
            }).catch(err => { console.error('Initialization error:', err); });

            // Asosiy sahifa: Nikoh yonidagi Yangilash tugmasi
            document.getElementById('feed-refresh-btn')?.addEventListener('click', async function() {
                const btn = this;
                const icon = btn.querySelector('.material-symbols-outlined');
                if (!icon) return;
                btn.disabled = true;
                icon.classList.add('animate-spin');
                try {
                    pageDataLoaded.feed = false;
                    await initUserData();
                    await loadFeedData();
                    if (typeof updateFeedGenderUI === 'function') updateFeedGenderUI();
                } finally {
                    btn.disabled = false;
                    icon.classList.remove('animate-spin');
                }
            });
        }

        // Load page data — faqat birinchi marta yuklanadi, keyin cache'dan
        async function loadPageData(pageName) {
            switch(pageName) {
                case 'feed':
                    if (pageDataLoaded.feed) { updateFeedTariffInfo(); if (!pageDataLoaded.profile) loadProfileData().catch(function() {}); return; }
                    await loadFeedData();
                    if (!pageDataLoaded.profile) loadProfileData().catch(function() {});
                    break;
                case 'requests':
                    if (requestsCurrentTab !== 'received' && requestsCurrentTab !== 'sent') {
                        switchRequestsTab('received');
                    }
                    pageDataLoaded.requests = false;
                    await loadRequestsData();
                    break;
                case 'chats':
                    if (!pageDataLoaded.chats) await loadChatsData();
                    break;
                case 'chat-view':
                    if (currentChatId) await loadChatView(currentChatId);
                    break;
                case 'favorites':
                    if (pageDataLoaded.favorites) return;
                    await loadFavoritesData();
                    break;
                case 'profile':
                    await initUserData();
                    if (pageDataLoaded.profile) {
                        document.getElementById('profile-skeleton')?.classList.add('hidden');
                        document.getElementById('profile-content')?.classList.remove('hidden');
                        if (document.getElementById('profile-content')?.style) document.getElementById('profile-content').style.display = '';
                        updateProfileUI();
                        return;
                    }
                    document.getElementById('profile-skeleton')?.classList.remove('hidden');
                    var pc = document.getElementById('profile-content');
                    if (pc) { pc.classList.add('hidden'); pc.style.display = 'none'; }
                    await loadProfileData();
                    document.getElementById('profile-skeleton')?.classList.add('hidden');
                    if (pc) { pc.classList.remove('hidden'); pc.style.display = ''; }
                    break;
                case 'profile-edit':
                    await loadProfileEditPage();
                    break;
                case 'add-listing':
                    window.newListingDraft = window.newListingDraft || {};
                    updateAddListingSummaries();
                    break;
                case 'tariff':
                    if (pageDataLoaded.tariff) return;
                    await loadTariffPageData();
                    break;
                case 'listings':
                    if (pageDataLoaded.listings) return;
                    await loadListingsPageData();
                    break;
                case 'settings':
                    break;
            }
        }

        async function loadTariffPageData() {
            const container = document.getElementById('tariff-cards-container');
            if (!container) return;
            container.innerHTML = '<p class="text-white/50 text-center py-8">Yuklanmoqda...</p>';
            try {
                const statusRes = await fetch('/tariff/api/status', { credentials: 'same-origin' });
                const statusData = statusRes.ok ? await statusRes.json() : {};
                const hasActive = !!statusData.has_active_tariff;
                const activeTariff = statusData.tariff || null;

                var subtitleEl = document.getElementById('tariff-page-subtitle');
                if (hasActive && activeTariff) {
                    if (subtitleEl) subtitleEl.textContent = 'Sizning aktiv tarifingiz';
                    container.innerHTML = `
                        <div class="glass-card rounded-2xl p-6 border border-primary/30 bg-primary/5">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <h4 class="text-primary text-lg font-bold mb-1">Aktiv obuna</h4>
                                    <p class="text-white/60 text-sm">${activeTariff.name || 'Tarif'} tarif</p>
                                </div>
                                <span class="bg-primary/20 text-primary px-4 py-2 rounded-full text-xs font-bold uppercase">Aktiv</span>
                            </div>
                            <div class="grid grid-cols-2 gap-4 mt-4">
                                <div>
                                    <p class="text-white/40 text-xs mb-1">Qolgan so'rovlar</p>
                                    <p class="text-white text-xl font-bold">${activeTariff.requests_count ?? 0} / ${activeTariff.total_requests ?? 0}</p>
                                </div>
                                <div>
                                    <p class="text-white/40 text-xs mb-1">Qolgan kunlar</p>
                                    <p class="text-white text-xl font-bold">${activeTariff.days_remaining ?? 0} kun</p>
                                </div>
                            </div>
                            ${activeTariff.is_top ? `<div class="mt-4 pt-4 border-t border-white/10"><p class="text-yellow-400 text-sm font-semibold flex items-center gap-2"><span class="material-symbols-outlined text-[18px]">star</span>TOP rejimida</p></div>` : ''}
                        </div>
                        <p class="text-white/40 text-center text-sm mt-4">Aktiv tarifingiz mavjud. Yangi tarif kerak bo'lsa, obuna tugagach qayta kirishingiz mumkin.</p>
                    `;
                    pageDataLoaded.tariff = true;
                    return;
                }

                if (subtitleEl) subtitleEl.textContent = 'O\'zingizga mos tarifni tanlang';
                const [tariffsRes, paymentRes] = await Promise.all([
                    fetch('/tariff/api/tariffs', { credentials: 'same-origin' }),
                    fetch('/tariff/api/payment-info', { credentials: 'same-origin' })
                ]);
                const tariffsData = tariffsRes.ok ? await tariffsRes.json() : { tariffs: [] };
                const paymentInfo = paymentRes.ok ? await paymentRes.json() : {};
                const tariffs = tariffsData.tariffs || [];
                window._tariffPaymentInfo = { card_number: paymentInfo.card_number || '', card_name: paymentInfo.card_name || '' };
                container.innerHTML = '';
                if (tariffs.length === 0) {
                    container.innerHTML = '<p class="text-white/50 text-center py-8">Tariflar topilmadi</p>';
                    pageDataLoaded.tariff = true;
                    return;
                }
                tariffs.forEach(t => {
                    const card = document.createElement('div');
                    card.className = 'glass-card rounded-2xl p-5 border border-white/10';
                    const isGold = t.name === 'OLTIN';
                    if (isGold) card.classList.add('border-yellow-500/30', 'bg-yellow-500/5');
                    const price = t.price || 0;
                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-3">
                            <h3 class="text-lg font-bold ${isGold ? 'text-yellow-400' : 'text-white'}">${t.name}</h3>
                            <div class="text-right">
                                <span class="text-xl font-extrabold text-primary">${price.toLocaleString('uz-UZ')}</span>
                                <span class="text-white/50 text-sm"> UZS</span>
                            </div>
                        </div>
                        <ul class="space-y-2 mb-4 text-sm text-white/70">
                            ${(t.features || []).map(f => `<li class="flex items-center gap-2"><span class="material-symbols-outlined text-primary text-[16px]">check_circle</span>${f}</li>`).join('')}
                        </ul>
                        <button type="button" onclick="window.openTariffPayment('${(t.name || '').replace(/'/g, "\\'")}', ${price})" class="w-full h-12 rounded-xl font-bold text-sm uppercase tracking-wider transition-all active:scale-[0.98] ${isGold ? 'bg-yellow-500 text-black' : 'bg-primary text-black'}">
                            Sotib olish
                        </button>
                    `;
                    container.appendChild(card);
                });
                pageDataLoaded.tariff = true;
            } catch (e) {
                console.error(e);
                container.innerHTML = '<p class="text-red-400 text-center py-8">Xatolik yuz berdi</p>';
            }
        }

        window.openTariffPayment = function(name, price) {
            window._tariffPaymentSelected = { name: name, price: price };
            document.getElementById('tariff-payment-name').textContent = name || '';
            document.getElementById('tariff-payment-price').textContent = (price || 0).toLocaleString('uz-UZ') + ' UZS';
            const info = window._tariffPaymentInfo || {};
            document.getElementById('tariff-payment-card').textContent = info.card_number || '—';
            document.getElementById('tariff-payment-card-name').textContent = info.card_name || '';
            document.getElementById('tariff-payment-message').value = '';
            document.getElementById('tariff-payment-receipt').value = '';
            document.getElementById('tariff-payment-receipt-label').textContent = 'Rasm yuklash';
            document.getElementById('tariff-payment-receipt-preview').classList.add('hidden');
            document.getElementById('tariff-payment-submit-btn').disabled = false;
            document.getElementById('tariff-payment-submit-btn').textContent = 'Yuborish';
            document.getElementById('tariff-payment-modal').classList.remove('hidden');
        };
        window.closeTariffPaymentModal = function() {
            document.getElementById('tariff-payment-modal').classList.add('hidden');
            window._tariffPaymentSelected = null;
        };
        window.copyTariffCardNumber = function() {
            const el = document.getElementById('tariff-payment-card');
            const num = (el && el.textContent || '').replace(/\s/g, '');
            if (!num || num === '—') return;
            navigator.clipboard.writeText(num).then(function() {
                if (typeof window.showNotification === 'function') window.showNotification('Karta raqami nusxalandi');
                else alert('Karta raqami nusxalandi');
            });
        };
        window.clearTariffReceipt = function() {
            var inp = document.getElementById('tariff-payment-receipt');
            if (inp) inp.value = '';
            document.getElementById('tariff-payment-receipt-preview').classList.add('hidden');
            window._tariffPaymentReceiptFile = null;
            document.getElementById('tariff-payment-receipt-label').textContent = 'Rasm yuklash';
        };
        window.submitTariffPayment = function() {
            var sel = window._tariffPaymentSelected;
            var fileInput = document.getElementById('tariff-payment-receipt');
            var file = (fileInput && fileInput.files && fileInput.files[0]) || window._tariffPaymentReceiptFile;
            if (!sel || !sel.name || !sel.price) { alert('Tarif tanlanmagan'); return; }
            if (!file) { alert('To\'lov cheki rasmini yuklang'); return; }
            if (file.size > 5 * 1024 * 1024) { alert('Rasm 5MB dan oshmasin'); return; }
            var msg = (document.getElementById('tariff-payment-message') || {}).value || '';
            var btn = document.getElementById('tariff-payment-submit-btn');
            if (btn) { btn.disabled = true; btn.textContent = 'Yuborilmoqda...'; }
            var formData = new FormData();
            formData.append('tariff_name', sel.name);
            formData.append('amount', String(sel.price));
            formData.append('message', msg);
            formData.append('receipt_image', file);
            fetch('/tariff/api/create-payment-request', { method: 'POST', credentials: 'same-origin', body: formData })
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    if (data.success) {
                        if (typeof window.showNotification === 'function') window.showNotification('To\'lov so\'rovi yuborildi! Admin tekshiradi.');
                        window.closeTariffPaymentModal();
                        loadTariffPageData();
                        if (typeof window.refreshUserData === 'function') window.refreshUserData();
                    } else {
                        alert(data.error || 'Xatolik');
                    }
                })
                .catch(function() { alert('Xatolik yuz berdi'); })
                .finally(function() {
                    if (btn) { btn.disabled = false; btn.textContent = 'Yuborish'; }
                });
        };

        // Notification functions
        window.showNotification = function(message) {
            const toast = document.getElementById('notification-toast');
            const messageEl = document.getElementById('notification-message');
            if (toast && messageEl) {
                messageEl.textContent = message;
                toast.classList.remove('hidden');
                toast.classList.add('fadeIn');
                
                // 5 soniyadan keyin yashirish
                setTimeout(() => {
                    hideNotification();
                }, 5000);
            }
        }

        window.hideNotification = function() {
            const toast = document.getElementById('notification-toast');
            if (toast) {
                toast.classList.add('hidden');
                toast.classList.remove('fadeIn');
            }
        }

        // ONBOARDING HELPERS
        // Onboarding state
        let currentOnboardingStep = 1;
        const totalOnboardingSteps = 5;
        const stepTitles = {
            1: "Tanishib olaylik",
            2: "Qayerdansiz?",
            3: "Shaxsiy xususiyatlar",
            4: "Ta'lim va kasb",
            5: "Juftingiz haqida"
        };
        const stepFields = {
            1: ['name', 'gender', 'birth_year'],
            2: ['country', 'region', 'nationality', 'marital_status'],
            3: ['height', 'weight', 'prays', 'fasts', 'religious_level'],
            4: ['education', 'profession', 'is_working', 'salary'],
            5: ['partner_age_min', 'partner_age_max', 'partner_region', 'partner_religious_level', 'partner_marital_status', 'bio']
        };

        function openOnboarding(mode) {
            const overlay = document.getElementById('onboarding-overlay');
            const welcomeScreen = document.getElementById('welcome-screen');
            const simpleRegForm = document.getElementById('simple-reg-form');
            const onboardingForm = document.getElementById('onboarding-form');
            const nav = document.querySelector('nav');
            const feedHeader = document.querySelector('#page-feed header');
            const feedPage = document.getElementById('page-feed');
            
            if (overlay) overlay.classList.remove('hidden');
            if (nav) nav.classList.add('hidden');
            if (feedHeader) feedHeader.style.display = 'none';
            if (feedPage) feedPage.style.display = 'none';
            document.querySelectorAll('.page-container').forEach(page => { page.style.display = 'none'; });
            
            if (mode === 'welcome') {
                if (welcomeScreen) { welcomeScreen.classList.remove('hidden'); welcomeScreen.style.display = 'flex'; }
                if (simpleRegForm) { simpleRegForm.classList.add('hidden'); simpleRegForm.style.display = 'none'; }
                if (onboardingForm) { onboardingForm.classList.add('hidden'); onboardingForm.style.display = 'none'; }
            } else {
                // To'liq profil (5 qadam)
                if (welcomeScreen) { welcomeScreen.classList.add('hidden'); welcomeScreen.style.display = 'none'; }
                if (simpleRegForm) { simpleRegForm.classList.add('hidden'); simpleRegForm.style.display = 'none'; }
                if (onboardingForm) { onboardingForm.classList.remove('hidden'); onboardingForm.style.display = 'flex'; }
            currentOnboardingStep = 1;
            updateOnboardingUI();
            initOnboardingListeners();
            }
        }

        function initOnboardingListeners() {
            // Add haptic feedback to all interactive elements
            const form = document.getElementById('onboarding-form');
            if (!form) return;

            // Option cards
            form.querySelectorAll('.onboarding-option-card input, .onboarding-chip input, .onboarding-list-option input').forEach(input => {
                input.addEventListener('change', () => {
                    hapticTap('light');
                });
            });

            // Select changes
            form.querySelectorAll('select').forEach(select => {
                select.addEventListener('change', () => {
                    hapticTap('light');
                });
            });
            // Onboarding: davlatlar ro'yxatini to'ldirish va davlat o'zgarganda viloyat yangilash (global LOCATION_COUNTRIES_REGIONS)
            const obCountry = document.getElementById('onboarding-country');
            const obRegion = document.getElementById('onboarding-region');
            if (obCountry && obRegion && typeof LOCATION_COUNTRIES_REGIONS !== 'undefined') {
                obCountry.innerHTML = '<option value="">Davlatni tanlang</option>' + Object.keys(LOCATION_COUNTRIES_REGIONS).map(c => '<option value="' + c.replace(/"/g, '&quot;') + '">' + c + '</option>').join('');
                obCountry.addEventListener('change', function() {
                    const regs = LOCATION_COUNTRIES_REGIONS[this.value] || [];
                    obRegion.innerHTML = '<option value="">Viloyatni tanlang</option>' + regs.map(r => `<option value="${r}">${r}</option>`).join('');
                    obRegion.required = regs.length > 0;
                });
            }
        }

        function updateOnboardingUI() {
            // Update step number
            const stepNum = document.getElementById('onboarding-step-num');
            const stepTitle = document.getElementById('onboarding-step-title');
            if (stepNum) stepNum.textContent = currentOnboardingStep;
            if (stepTitle) stepTitle.textContent = stepTitles[currentOnboardingStep];

            // Update progress dots
            document.querySelectorAll('.onboarding-dot').forEach((dot, index) => {
                dot.classList.remove('active', 'completed');
                if (index + 1 === currentOnboardingStep) {
                    dot.classList.add('active');
                } else if (index + 1 < currentOnboardingStep) {
                    dot.classList.add('completed');
                }
            });

            // Update steps visibility
            document.querySelectorAll('.onboarding-step').forEach(step => {
                const stepNum = parseInt(step.dataset.step);
                step.classList.remove('active', 'prev');
                if (stepNum === currentOnboardingStep) {
                    step.classList.add('active');
                } else if (stepNum < currentOnboardingStep) {
                    step.classList.add('prev');
                }
            });

            // Update back button
            const backBtn = document.getElementById('onboarding-back-btn');
            if (backBtn) {
                if (currentOnboardingStep === 1) {
                    backBtn.classList.add('opacity-0', 'pointer-events-none');
                } else {
                    backBtn.classList.remove('opacity-0', 'pointer-events-none');
                }
            }

            // Update next button text
            const nextBtn = document.getElementById('onboarding-next-btn');
            if (nextBtn) {
                if (currentOnboardingStep === totalOnboardingSteps) {
                    nextBtn.textContent = 'TUGATISH';
                } else {
                    nextBtn.textContent = 'DAVOM ETISH';
                }
            }
            if (currentOnboardingStep === 2) updateOnboardingMaritalOptions();
        }
        function updateOnboardingMaritalOptions() {
            const container = document.getElementById('onboarding-marital-options');
            if (!container) return;
            const gender = document.querySelector('#onboarding-form input[name="gender"]:checked')?.value;
            const isWoman = gender === 'Ayol';
            const options = isWoman
                ? [{ v: 'Qiz bola', icon: 'person' }, { v: 'Beva', icon: 'heart_broken' }, { v: 'Ajrashgan', icon: 'group_remove' }]
                : [{ v: 'Bo\'ydoq', icon: 'person_add' }, { v: 'Oilali', icon: 'family_restroom' }, { v: 'Ajrashgan', icon: 'group_remove' }];
            container.innerHTML = options.map((o, i) => `
                <label class="onboarding-option-card">
                    <input type="radio" name="marital_status" value="${o.v}" ${i === 0 ? 'required' : ''} class="hidden">
                    <div class="card-inner">
                        <span class="material-symbols-outlined text-2xl mb-2">${o.icon}</span>
                        <span class="font-bold">${o.v}</span>
                    </div>
                </label>
            `).join('');
        }

        function validateCurrentStep() {
            const form = document.getElementById('onboarding-form');
            if (!form) return false;

            const fields = stepFields[currentOnboardingStep];
            let isValid = true;
            let firstInvalid = null;

            fields.forEach(fieldName => {
                const field = form.querySelector(`[name="${fieldName}"]`);
                if (field && field.required) {
                    if (field.type === 'radio') {
                        const checked = form.querySelector(`[name="${fieldName}"]:checked`);
                        if (!checked) {
                            isValid = false;
                            if (!firstInvalid) firstInvalid = field.closest('.onboarding-option-card, .onboarding-chip, .onboarding-list-option') || field;
                        }
                    } else if (!field.value) {
                        isValid = false;
                        if (!firstInvalid) firstInvalid = field;
                    }
                }
            });

            if (!isValid && firstInvalid) {
                // Add shake animation
                const container = firstInvalid.closest('.onboarding-option-card, .onboarding-chip, .onboarding-list-option, div');
                if (container) {
                    container.classList.add('shake');
                    setTimeout(() => container.classList.remove('shake'), 400);
                }
                hapticTap('heavy');
            }

            return isValid;
        }

        function onboardingNextStep() {
            hapticTap('medium');

            if (!validateCurrentStep()) {
                return;
            }

            if (currentOnboardingStep < totalOnboardingSteps) {
                currentOnboardingStep++;
                updateOnboardingUI();
                // Scroll to top of step
                const activeStep = document.querySelector('.onboarding-step.active');
                if (activeStep) {
                    const scrollContainer = activeStep.querySelector('.overflow-y-auto');
                    if (scrollContainer) scrollContainer.scrollTop = 0;
                }
            } else {
                submitOnboarding();
            }
        }

        function onboardingPrevStep() {
            hapticTap('light');
            if (currentOnboardingStep > 1) {
                currentOnboardingStep--;
                updateOnboardingUI();
            }
        }

        async function submitOnboarding() {
            const form = document.getElementById('onboarding-form');
            if (!form) return;

            const nextBtn = document.getElementById('onboarding-next-btn');
            if (nextBtn) {
                nextBtn.disabled = true;
                nextBtn.innerHTML = '<span class="animate-pulse">SAQLANMOQDA...</span>';
            }

            const formData = new FormData(form);
            try {
                const response = await fetch('/profile/edit', {
                    method: 'POST',
                    body: formData,
                    credentials: 'same-origin'
                });
                const data = await response.json();
                if (response.ok && data.success) {
                    hapticTap('heavy');
                    onboardingDone = true;
                    await initUserData();
                    if (typeof window.closeOnboardingOverlay === 'function') {
                        window.closeOnboardingOverlay();
                    }
                    window.showPage('feed');
                    loadPageData('feed');
                } else {
                    hapticTap('heavy');
                    alert(data.message || "Xatolik yuz berdi. Iltimos, qaytadan urinib ko'ring.");
                }
            } catch (error) {
                console.error('Onboarding error:', error);
                hapticTap('heavy');
                alert("Xatolik yuz berdi. Internet aloqasini tekshiring.");
            } finally {
                if (nextBtn) {
                    nextBtn.disabled = false;
                    nextBtn.textContent = 'TUGATISH';
                }
            }
        }

        window.refreshUserData = function() { initUserData(); };

        // Initialize user data
        async function initUserData() {
            try {
                const response = await fetch('/api/user-data', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'same-origin'
                });
                if (!response.ok) {
                    if (response.status === 401) {
                        console.warn('User not authenticated, redirecting...');
                        window.location.href = '/';
                        return;
                    }
                    throw new Error(`HTTP ${response.status}: Failed to load user data`);
                }
                const newUserData = await response.json();
                const newHasActiveTariff = newUserData.tariff?.has_active_tariff || false;
                
                // Obuna qabul bo'lganini tekshirish
                if (lastTariffCheck !== null && !hasActiveTariff && newHasActiveTariff) {
                    // Obuna yangi qabul qilindi
                    if (typeof window.showNotification === 'function') {
                        window.showNotification('✅ Obunangiz qabul qilindi! Endi e\'lon yaratishingiz mumkin.');
                    }
                }
                
                userData = newUserData;
                hasActiveTariff = newHasActiveTariff;
                lastTariffCheck = hasActiveTariff;
                saveUserDataToCache();
                console.log('User data loaded:', userData);
            } catch (error) {
                console.error('Error loading user data:', error);
                // Retry after 1 second
                setTimeout(() => {
                    if (!userData) {
                        initUserData();
                    }
                }, 1000);
            }
        }

        // FEED PAGE
        let feedCurrentPage = 1;
        let feedIsLoading = false;
        let feedHasMore = true;
        let feedCacheByGender = { Ayol: null, Erkak: null };

        function getFeedCacheKey() {
            return (feedSort || 'new') + (typeof buildFeedFilterParams === 'function' ? buildFeedFilterParams() : '');
        }

        function applyFeedFromCache(cache) {
            if (!cache || !cache.listings) return;
            const container = document.getElementById('feed-listings');
            const skeleton = document.getElementById('feed-skeleton');
            if (skeleton) { skeleton.style.display = 'none'; if (skeleton.parentNode) skeleton.remove(); }
            if (!container) return;
            container.innerHTML = '';
            if (cache.listings.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-white/60">E\'lonlar topilmadi</div>';
            } else {
                cache.listings.forEach(listing => container.appendChild(createFeedListingCard(listing)));
            }
            feedHasMore = !!cache.has_next;
            feedCurrentPage = 1;
            pageDataLoaded.feed = true;
            const lm = document.getElementById('feed-load-more');
            if (lm) lm.classList.toggle('hidden', !feedHasMore);
        }

        function invalidateFeedCache() {
            feedCacheByGender = { Ayol: null, Erkak: null };
        }

        function preloadOtherGenderFeed() {
            const other = feedGender === 'Ayol' ? 'Erkak' : 'Ayol';
            if (feedCacheByGender[other] && feedCacheByGender[other].filterKey === getFeedCacheKey()) return;
            const filterParams = buildFeedFilterParams();
            const url = '/feed/api/listings?page=1&per_page=20&top_only=false&gender=' + encodeURIComponent(other) + '&sort=' + encodeURIComponent(feedSort || 'new') + filterParams;
            fetch(url, { method: 'GET', headers: feedHeaders, credentials: 'same-origin' })
                .then(r => { if (r.ok) return r.json(); return null; })
                .then(data => {
                    if (data && data.listings) {
                        var key = getFeedCacheKey();
                        if (!feedCacheByGender[other] || feedCacheByGender[other].filterKey !== key) {
                            feedCacheByGender[other] = { listings: data.listings.slice(), has_next: !!data.has_next, filterKey: key };
                            saveFeedToCache();
                        }
                    }
                })
                .catch(() => {});
        }

        async function loadFeedData() {
            if (!userData) await initUserData();
            if (userData?.user?.gender && !window._feedGenderInitialized) {
                window._feedGenderInitialized = true;
                feedGender = userData.user.gender === 'Erkak' ? 'Ayol' : 'Erkak';
                updateFeedGenderUI();
            }
            updateFeedTariffInfo();
            const container = document.getElementById('feed-listings');
            const skeleton = document.getElementById('feed-skeleton');
            if (!container) return;
            const hasContent = container.children.length > 0 && (!skeleton || skeleton.style.display === 'none');
            // Jins/saralash o'zgarganda ham qayta yuklash (pageDataLoaded.feed = false bo'lganda)
            if (!hasContent || !pageDataLoaded.feed) await loadFeedListings(1);
            pageDataLoaded.feed = true;
        }

        function updateFeedTariffInfo() {
            const container = document.getElementById('feed-tariff-info');
            const badge = document.getElementById('feed-tariff-badge');
            
            if (!container || !badge) return;
            
            // Agar tarif active bo'lsa, "Aktiv tarif" ko'rsatilmaydi
            if (hasActiveTariff && userData?.tariff?.tariff) {
                const tariff = userData.tariff.tariff;
                // Container bo'sh qoldiriladi
                container.innerHTML = '';
                badge.innerHTML = `<p class="text-[10px] font-black text-primary uppercase tracking-wider">${tariff.requests_count} SO'ROV</p>`;
            } else {
                container.innerHTML = `
                    <div>
                        <div class="flex items-center gap-3">
                            <div class="size-10 rounded-xl bg-yellow-500/20 flex items-center justify-center">
                                <span class="material-symbols-outlined text-yellow-400 text-[22px]">info</span>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm font-bold text-yellow-400">E'lonlarni ko'rishingiz mumkin</p>
                                <p class="text-[11px] text-yellow-400/80 mt-0.5">So'rov yuborish uchun tarif kerak</p>
                            </div>
                                <button type="button" onclick="window.showPage('tariff')" class="bg-primary text-black px-4 py-2 rounded-xl text-xs font-bold uppercase tracking-wider active:scale-95 transition-all">
                                Tarif
                            </button>
                        </div>
                    </div>
                `;
                badge.innerHTML = `<button type="button" onclick="window.showPage('tariff')" class="glass-card px-3 py-1.5 rounded-full text-[10px] font-black text-yellow-400 uppercase tracking-wider">Tarif</button>`;
            }
        }

        const feedHeaders = {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        };

        async function loadFeedListings(page = 1, topOnly = false) {
            if (feedIsLoading) return;
            feedIsLoading = true;

            const container = document.getElementById('feed-listings');
            const skeleton = document.getElementById('feed-skeleton');

            // Birinchi sahifa: 1 ta va 20 ta parallel yuklash — qaysi birinchi kelsa tez ko'rsatamiz
            if (page === 1) {
                const filterParams = buildFeedFilterParams();
                // userData bo'lmasa gender yuborilmaydi — backend session orqali aniqlaydi va filter_gender qaytaradi
                const genderParam = (userData && userData.user && userData.user.gender) ? '&gender=' + encodeURIComponent(feedGender) : '';
                const urlBase = `/feed/api/listings?page=1&top_only=${topOnly}${genderParam}&sort=${encodeURIComponent(feedSort)}${filterParams}`;
                let fullReceived = false;
                function applyFull(data) {
                    if (!data || !data.listings || fullReceived) return;
                    fullReceived = true;
                    if (data.filter_gender) { feedGender = data.filter_gender; if (typeof updateFeedGenderUI === 'function') updateFeedGenderUI(); }
                    const c = document.getElementById('feed-listings');
                    if (skeleton) { skeleton.style.display = 'none'; if (skeleton.parentNode) skeleton.remove(); }
                    if (!c) return;
                    c.innerHTML = '';
                    if (data.listings.length === 0) {
                        c.innerHTML = '<div class="text-center py-8 text-white/60">E\'lonlar topilmadi</div>';
                    } else {
                        data.listings.forEach(listing => c.appendChild(createFeedListingCard(listing)));
                    }
                    feedHasMore = data.has_next;
                    feedCurrentPage = 1;
                    pageDataLoaded.feed = true;
                    feedCacheByGender[feedGender] = { listings: (data.listings || []).slice(), has_next: !!data.has_next, filterKey: getFeedCacheKey() };
                    const lm = document.getElementById('feed-load-more');
                    if (lm) lm.classList.toggle('hidden', !feedHasMore);
                    saveFeedToCache();
                }
                function applyQuick(data) {
                    if (fullReceived || !data || !data.listings || data.listings.length === 0) return;
                    if (data.filter_gender) { feedGender = data.filter_gender; if (typeof updateFeedGenderUI === 'function') updateFeedGenderUI(); }
                    if (skeleton) { skeleton.style.display = 'none'; if (skeleton.parentNode) skeleton.remove(); }
                    if (container) container.innerHTML = '';
                    data.listings.forEach(listing => container.appendChild(createFeedListingCard(listing)));
                    feedHasMore = data.has_next;
                    feedCurrentPage = 1;
                    pageDataLoaded.feed = true;
                    feedCacheByGender[feedGender] = { listings: (data.listings || []).slice(), has_next: !!data.has_next, filterKey: getFeedCacheKey() };
                    const lm = document.getElementById('feed-load-more');
                    if (lm) lm.classList.toggle('hidden', !feedHasMore);
                    saveFeedToCache();
                }
                try {
                    const quickPromise = fetch(urlBase + '&per_page=1', { method: 'GET', headers: feedHeaders, credentials: 'same-origin' })
                        .then(r => { if (r.status === 401 || r.status === 403) { window.location.href = '/'; return null; } return r.ok ? r.json() : null; });
                    const fullPromise = fetch(urlBase + '&per_page=20', { method: 'GET', headers: feedHeaders, credentials: 'same-origin' })
                        .then(r => { if (r.status === 401 || r.status === 403) { window.location.href = '/'; return null; } return r.ok ? r.json() : null; });
                    quickPromise.then(quickData => { if (quickData) applyQuick(quickData); }).catch(() => {});
                    fullPromise.then(fullData => { if (fullData) applyFull(fullData); }).catch(() => {});
                    await Promise.race([quickPromise, fullPromise]);
                    if (!fullReceived) {
                        const fullData = await fullPromise;
                        if (fullData) applyFull(fullData);
                        else {
                            const quickData = await quickPromise;
                            if (quickData && quickData.listings && quickData.listings.length === 0) {
                                if (skeleton) { skeleton.style.display = 'none'; if (skeleton.parentNode) skeleton.remove(); }
                                if (container) container.innerHTML = '<div class="text-center py-8 text-white/60">E\'lonlar topilmadi</div>';
                                feedHasMore = false;
                                pageDataLoaded.feed = true;
                            }
                        }
                    }
                } catch (err) {
                    if (skeleton) skeleton.style.display = 'none';
                    if (container) container.innerHTML = '<div class="text-center py-8 text-red-400">Xatolik yuz berdi</div>';
                }
                feedIsLoading = false;
                setTimeout(function() { if (typeof preloadOtherGenderFeed === 'function') preloadOtherGenderFeed(); }, 0);
                return;
            }

            const filterParams = buildFeedFilterParams();
            try {
                const response = await fetch(`/feed/api/listings?page=${page}&per_page=20&top_only=${topOnly}&gender=${encodeURIComponent(feedGender)}&sort=${encodeURIComponent(feedSort)}${filterParams}`, {
                    method: 'GET',
                    headers: feedHeaders,
                    credentials: 'same-origin'
                });
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        window.location.href = '/';
                        return;
                    }
                    throw new Error(`HTTP ${response.status}: Failed to load listings`);
                }
                const data = await response.json();

                if (skeleton) {
                    skeleton.style.display = 'none';
                    if (skeleton.parentNode) skeleton.remove();
                }
                if (page === 1 && container) {
                    container.innerHTML = '';
                }

                if (data.listings.length === 0 && page === 1) {
                    container.innerHTML = '<div class="text-center py-8 text-white/60">E\'lonlar topilmadi</div>';
                    feedHasMore = false;
                    return;
                }

                data.listings.forEach(listing => {
                    container.appendChild(createFeedListingCard(listing));
                });

                feedHasMore = data.has_next;
                const loadMore = document.getElementById('feed-load-more');
                if (loadMore) loadMore.classList.toggle('hidden', !feedHasMore);
                feedCurrentPage = page;
                pageDataLoaded.feed = true;

            } catch (error) {
                console.error('Error loading listings:', error);
                if (skeleton) skeleton.remove();
                if (container) container.innerHTML = '<div class="text-center py-8 text-red-400">Xatolik yuz berdi</div>';
            } finally {
                feedIsLoading = false;
            }
        }

        function createFeedListingCard(listing) {
            const div = document.createElement('article');
            div.className = 'profile-card glass-card rounded-[22px] overflow-hidden relative flex flex-col group';
            div.style.height = 'calc((100vh - 220px) / 2.8)';
            div.style.minHeight = '245px';
            div.onclick = () => showFeedProfileFromListing(listing);

            // Har xil gradient ranglar yaratish
            const gradients = [
                'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
                'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                'linear-gradient(135deg, #30cfd0 0%, #330867 100%)',
                'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
                'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)',
                'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)',
                'linear-gradient(135deg, #ff6e7f 0%, #bfe9ff 100%)'
            ];
            const gradientIndex = (listing.user_id || 0) % gradients.length;
            const selectedGradient = gradients[gradientIndex];
            
            div.innerHTML = `
                <div class="relative flex-1" style="background: ${selectedGradient}">
                    <div class="absolute inset-0 profile-gradient"></div>
                    <div class="absolute top-3 left-3 right-3 flex justify-between items-start z-10">
                        <div class="flex flex-wrap gap-1.5 items-center">
                            <span class="bg-primary px-2.5 py-1 rounded text-[9px] font-black tracking-widest text-black neon-glow uppercase">#${listing.user_id || '0000'}</span>
                            ${listing.is_top ? '<div class="tag-premium px-2.5 py-1.5 rounded-xl flex items-center gap-1.5 text-[8px] font-extrabold text-white uppercase tracking-wider shadow-lg"><span class="material-symbols-outlined text-[12px] text-primary">star</span> TOP</div>' : ''}
                            <div class="tag-premium px-2.5 py-1.5 rounded-xl flex items-center gap-1.5 text-[8px] font-extrabold text-white uppercase tracking-wider shadow-lg">
                                <span class="material-symbols-outlined text-[12px] text-primary">public</span>
                                ${listing.nationality || 'O\'zbek'}
                            </div>
                            <div class="tag-premium px-2.5 py-1.5 rounded-xl flex items-center gap-1.5 text-[8px] font-extrabold text-white uppercase tracking-wider shadow-lg">
                                <span class="material-symbols-outlined text-[12px] text-primary">location_on</span>
                                ${listing.region || 'Toshkent'}
                            </div>
                        </div>
                        <button onclick="event.stopPropagation(); toggleFavorite(${listing.user_id}, this)" class="size-8 rounded-full glass-card flex items-center justify-center transition-colors ${listing.is_favorite ? 'text-red-400 bg-red-500/20 border-red-400/30' : 'text-white/80 border-white/20 hover:text-red-400 hover:bg-red-500/20'}" data-user-id="${listing.user_id}" data-is-favorite="${listing.is_favorite || false}">
                            <span class="material-symbols-outlined text-[18px]" style="${listing.is_favorite ? 'font-variation-settings: \'FILL\' 1' : ''}">favorite</span>
                        </button>
                    </div>
                    <div class="absolute bottom-2 left-4 right-4 z-10">
                        <div class="flex items-baseline gap-2 mb-1">
                            <h2 class="text-xl font-extrabold tracking-tight">${listing.name || 'Foydalanuvchi'}</h2>
                            <span class="text-[12px] font-bold text-white/60">${listing.age || '?'} yosh</span>
                        </div>
                        <div class="grid grid-cols-2 gap-x-3 gap-y-0.5 text-[10px] font-bold text-white">
                            <span class="flex items-center gap-1.5 truncate">
                                <span class="material-symbols-outlined text-[13px] text-primary">straighten</span>
                                ${listing.height || '-'} sm • ${listing.weight || '-'} kg
                            </span>
                            <span class="flex items-center gap-1.5 truncate">
                                <span class="material-symbols-outlined text-[13px] text-primary">family_restroom</span>
                                ${listing.marital_status || 'Bo\'ydoq'}
                            </span>
                            <span class="flex items-center gap-1.5 truncate">
                                <span class="material-symbols-outlined text-[13px] text-primary">verified_user</span>
                                ${listing.religious_level || 'O\'rtacha'}
                            </span>
                            <span class="flex items-center gap-1.5 truncate">
                                <span class="material-symbols-outlined text-[13px] text-primary">school</span>
                                ${listing.education || 'Oliy'}
                            </span>
                        </div>
                    </div>
                </div>
                <div class="glass-strip px-4 py-2 flex justify-between items-center text-[8px] uppercase tracking-[0.12em] font-black">
                    <div class="flex items-center gap-3 text-white/50">
                        <span class="flex items-center gap-1"><span class="material-symbols-outlined text-[14px]">visibility</span> ${listing.views || 0}</span>
                        <span class="flex items-center gap-1"><span class="material-symbols-outlined text-[14px]">favorite</span> ${listing.likes || 0}</span>
                    </div>
                </div>
            `;

            return div;
        }
        
        async function toggleFavorite(userId, buttonElement) {
            const isFavorite = buttonElement.getAttribute('data-is-favorite') === 'true';
            
            try {
                let response;
                if (isFavorite) {
                    // Sevimlidan olib tashlash
                    // Avval favorite_id ni topish kerak
                    const favoritesResponse = await fetch('/favorites/api/list');
                    const favoritesData = await favoritesResponse.json();
                    const favorite = favoritesData.favorites.find(f => f.favorite_user_id === userId);
                    
                    if (!favorite) {
                        alert('Sevimli topilmadi');
                        return;
                    }
                    
                    response = await fetch(`/favorites/api/${favorite.id}/remove`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        credentials: 'same-origin'
                    });
                } else {
                    // Sevimliga qo'shish
                    response = await fetch('/favorites/api/add', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({user_id: userId}),
                        credentials: 'same-origin'
                    });
                }
                
                const data = await response.json();
                
                if (response.ok) {
                    // UI ni yangilash
                    if (isFavorite) {
                        // Qizil rangni olib tashlash
                        buttonElement.classList.remove('text-red-400', 'bg-red-500/20', 'border-red-400/30');
                        buttonElement.classList.add('text-white/80', 'border-white/20', 'hover:text-red-400', 'hover:bg-red-500/20');
                        buttonElement.setAttribute('data-is-favorite', 'false');
                        const icon = buttonElement.querySelector('.material-symbols-outlined');
                        if (icon) icon.style.fontVariationSettings = '';
                    } else {
                        // Qizil rangni qo'shish
                        buttonElement.classList.remove('text-white/80', 'border-white/20', 'hover:text-red-400', 'hover:bg-red-500/20');
                        buttonElement.classList.add('text-red-400', 'bg-red-500/20', 'border-red-400/30');
                        buttonElement.setAttribute('data-is-favorite', 'true');
                        const icon = buttonElement.querySelector('.material-symbols-outlined');
                        if (icon) icon.style.fontVariationSettings = "'FILL' 1";
                    }
                    
                    if (typeof window.showNotification === 'function') {
                        window.showNotification('✅ ' + data.message);
                    }
                    if (typeof window.invalidatePageCache === 'function') {
                        window.invalidatePageCache('favorites');
                    }
                } else {
                    alert('Xatolik: ' + (data.error || 'Noma\'lum xatolik'));
                }
            } catch (error) {
                console.error('Error toggling favorite:', error);
                alert('Xatolik: ' + error.message);
            }
        }
        
        window.toggleFavorite = toggleFavorite;

        function updateFeedModalHeaderFavorite(userId, isFavorite) {
            const el = document.getElementById('feed-profile-modal-header-right');
            if (!el) return;
            const fav = !!isFavorite;
            el.innerHTML = '<button type="button" onclick="event.stopPropagation(); window.toggleFavorite(' + userId + ', this)" class="size-10 rounded-full flex items-center justify-center transition-colors ' + (fav ? 'text-red-400 bg-red-500/20' : 'text-white/80 hover:text-red-400 hover:bg-red-500/10') + '" data-is-favorite="' + fav + '"><span class="material-symbols-outlined text-[22px]" style="' + (fav ? 'font-variation-settings: \'FILL\' 1' : '') + '">favorite</span></button>';
        }

        function renderFeedModalContent(profile, userId, actionHtml) {
            const bioEsc = (profile.bio || '').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
            const gradients = ['linear-gradient(135deg, #667eea 0%, #764ba2 100%)','linear-gradient(135deg, #f093fb 0%, #f5576c 100%)','linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)','linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)','linear-gradient(135deg, #fa709a 0%, #fee140 100%)','linear-gradient(135deg, #30cfd0 0%, #330867 100%)','linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)','linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)','linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)','linear-gradient(135deg, #ff6e7f 0%, #bfe9ff 100%)'];
            const gradientIndex = (profile.user_id || userId || 0) % gradients.length;
            const gradient = gradients[gradientIndex];
            return `
                <main class="max-w-md mx-auto px-0" style="padding-bottom: 24px;">
                    <section class="relative h-[45vh] w-full overflow-hidden">
                        <div class="absolute inset-0" style="background: ${gradient}"></div>
                        <div class="absolute inset-0 profile-gradient"></div>
                        <div class="absolute bottom-6 left-6 right-6">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="bg-primary/20 text-primary border border-primary/30 px-2 py-0.5 rounded text-[10px] font-black tracking-widest uppercase">#${profile.user_id || userId || '0000'}</span>
                                <span class="flex items-center gap-1 bg-primary/20 text-primary border border-primary/30 px-2 py-0.5 rounded text-[10px] font-bold">
                                    <span class="material-symbols-outlined text-[12px]" style="font-variation-settings: 'FILL' 1">verified</span>
                                    TASDIQLANGAN
                                </span>
                            </div>
                            <h1 class="text-3xl font-extrabold tracking-tight mb-1">${profile.name || 'Foydalanuvchi'}, <span class="text-white/70 font-medium text-2xl">${profile.age || '?'}</span></h1>
                            <div class="flex items-center gap-1.5 text-white/60 font-medium">
                                <span class="material-symbols-outlined text-[18px] text-primary">location_on</span>
                                ${profile.region || 'Toshkent'}${profile.nationality ? ', ' + profile.nationality : ''}
                            </div>
                        </div>
                    </section>
                    <div class="px-5 space-y-4 -mt-2 relative z-10">
                        <div class="glass-card rounded-2xl p-4">
                            <div class="flex items-center gap-2 mb-4 border-b border-white/5 pb-2">
                                <span class="material-symbols-outlined text-primary text-[20px]">straighten</span>
                                <h3 class="text-[12px] font-black uppercase tracking-widest text-white/80">Jismoniy ma'lumotlar</h3>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><p class="text-[10px] text-white/40 font-bold uppercase tracking-wider mb-1">Bo'yi</p><p class="text-[14px] text-white font-semibold">${profile.height || '-'} sm</p></div>
                                <div><p class="text-[10px] text-white/40 font-bold uppercase tracking-wider mb-1">Vazni</p><p class="text-[14px] text-white font-semibold">${profile.weight || '-'} kg</p></div>
                                ${profile.smoking ? `<div><p class="text-[10px] text-white/40 font-bold uppercase tracking-wider mb-1">Sigaret</p><p class="text-[14px] text-white font-semibold">${profile.smoking}</p></div>` : ''}
                                ${profile.sport_days != null && profile.sport_days >= 1 ? `<div><p class="text-[10px] text-white/40 font-bold uppercase tracking-wider mb-1">Sport</p><p class="text-[14px] text-white font-semibold">${profile.sport_days === 7 ? 'Har kuni' : 'Haftada ' + profile.sport_days + ' kun'}</p></div>` : ''}
                            </div>
                        </div>
                        <div class="glass-card rounded-2xl p-4">
                            <div class="flex items-center gap-2 mb-4 border-b border-white/5 pb-2">
                                <span class="material-symbols-outlined text-primary text-[20px]">person_celebrate</span>
                                <h3 class="text-[12px] font-black uppercase tracking-widest text-white/80">Shaxsiy holati</h3>
                            </div>
                            <div class="grid grid-cols-2 gap-y-4 gap-x-4">
                                <div><p class="text-[10px] text-white/40 font-bold uppercase tracking-wider mb-1">Davlat</p><p class="text-[14px] text-white font-semibold">${profile.country || '-'}</p></div>
                                <div><p class="text-[10px] text-white/40 font-bold uppercase tracking-wider mb-1">Viloyat</p><p class="text-[14px] text-white font-semibold">${profile.region || '-'}</p></div>
                                <div><p class="text-[10px] text-white/40 font-bold uppercase tracking-wider mb-1">Millati</p><p class="text-[14px] text-white font-semibold">${profile.nationality || 'O\'zbek'}</p></div>
                                <div><p class="text-[10px] text-white/40 font-bold uppercase tracking-wider mb-1">Oilaviy holati</p><p class="text-[14px] text-white font-semibold">${profile.marital_status || 'Bo\'ydoq'}</p></div>
                            </div>
                        </div>
                        <div class="glass-card rounded-2xl p-4">
                            <div class="flex items-center gap-2 mb-4 border-b border-white/5 pb-2">
                                <span class="material-symbols-outlined text-primary text-[20px]">school</span>
                                <h3 class="text-[12px] font-black uppercase tracking-widest text-white/80">Ilm &amp; Kasb</h3>
                            </div>
                            <div class="grid grid-cols-2 gap-y-4 gap-x-4">
                                <div><p class="text-[10px] text-white/40 font-bold uppercase tracking-wider mb-1">Ta'lim</p><p class="text-[14px] text-white font-semibold">${profile.education || '-'}</p></div>
                                <div><p class="text-[10px] text-white/40 font-bold uppercase tracking-wider mb-1">Kasbi</p><p class="text-[14px] text-white font-semibold">${profile.profession || '-'}</p></div>
                                <div><p class="text-[10px] text-white/40 font-bold uppercase tracking-wider mb-1">Maosh</p><p class="text-[14px] text-white font-semibold">${profile.salary || '-'}</p></div>
                                <div><p class="text-[10px] text-white/40 font-bold uppercase tracking-wider mb-1">Ishlaydi</p><p class="text-[14px] text-white font-semibold">${profile.is_working === true || profile.is_working === 'true' ? 'Ha' : (profile.is_working === false || profile.is_working === 'false' ? 'Yo\'q' : '-')}</p></div>
                            </div>
                        </div>
                        <div class="glass-card rounded-2xl p-4">
                            <div class="flex items-center gap-2 mb-4 border-b border-white/5 pb-2">
                                <span class="material-symbols-outlined text-primary text-[20px]">auto_awesome</span>
                                <h3 class="text-[12px] font-black uppercase tracking-widest text-white/80">Diniy ma'lumotlar</h3>
                            </div>
                            <div class="grid grid-cols-2 gap-y-4 gap-x-4">
                                <div><p class="text-[10px] text-white/40 font-bold uppercase tracking-wider mb-1">Aqida</p><p class="text-[14px] text-white font-semibold">${profile.aqida || '-'}</p></div>
                                <div><p class="text-[10px] text-white/40 font-bold uppercase tracking-wider mb-1">Namoz</p><p class="text-[14px] text-white font-semibold">${profile.prays || '-'}</p></div>
                                <div><p class="text-[10px] text-white/40 font-bold uppercase tracking-wider mb-1">Ro'za</p><p class="text-[14px] text-white font-semibold">${profile.fasts || '-'}</p></div>
                                <div><p class="text-[10px] text-white/40 font-bold uppercase tracking-wider mb-1">Qur'on o'qish</p><p class="text-[14px] text-white font-semibold">${profile.quran_reading || '-'}</p></div>
                                <div><p class="text-[10px] text-white/40 font-bold uppercase tracking-wider mb-1">Mazhab</p><p class="text-[14px] text-white font-semibold">${profile.mazhab || '-'}</p></div>
                                <div><p class="text-[10px] text-white/40 font-bold uppercase tracking-wider mb-1">Diniy daraja</p><p class="text-[14px] text-white font-semibold">${profile.religious_level || '-'}</p></div>
                            </div>
                        </div>
                        ${(profile.partner_age_min != null || profile.partner_age_max != null || (profile.partner_locations && profile.partner_locations.length) || profile.partner_country || profile.partner_region || profile.partner_religious_level || profile.partner_marital_status) ? `
                        <div class="glass-card rounded-2xl p-4">
                            <div class="flex items-center gap-2 mb-4 border-b border-white/5 pb-2">
                                <span class="material-symbols-outlined text-primary text-[20px]">handshake</span>
                                <h3 class="text-[12px] font-black uppercase tracking-widest text-white/80">Juftga talablari</h3>
                            </div>
                            <div class="grid grid-cols-2 gap-y-4 gap-x-4">
                                ${profile.partner_age_min != null || profile.partner_age_max != null ? `<div><p class="text-[10px] text-white/40 font-bold uppercase tracking-wider mb-1">Yosh oralig'i</p><p class="text-[14px] text-white font-semibold">${profile.partner_age_min ?? '-'}-${profile.partner_age_max ?? '-'} yosh</p></div>` : ''}
                                ${(profile.partner_locations && profile.partner_locations.length) ? `<div class="col-span-2"><p class="text-[10px] text-white/40 font-bold uppercase tracking-wider mb-1">Joylashuv</p><p class="text-[14px] text-white font-semibold">${profile.partner_locations.some(function(x){ return x.all_countries; }) ? 'Barcha davlatlar' : profile.partner_locations.map(function(x){ return x.all ? (x.c || x.country) + ': butun mamlakat' : (x.c || x.country) + ': ' + (x.r || []).join(', '); }).join('; ')}</p></div>` : (profile.partner_country || profile.partner_region) ? `<div><p class="text-[10px] text-white/40 font-bold uppercase tracking-wider mb-1">Joylashuv</p><p class="text-[14px] text-white font-semibold">${profile.partner_country || ''}${profile.partner_region ? ': ' + profile.partner_region : ''}</p></div>` : ''}
                                ${profile.partner_religious_level ? `<div><p class="text-[10px] text-white/40 font-bold uppercase tracking-wider mb-1">Diniy daraja</p><p class="text-[14px] text-white font-semibold">${profile.partner_religious_level}</p></div>` : ''}
                                ${profile.partner_marital_status ? `<div><p class="text-[10px] text-white/40 font-bold uppercase tracking-wider mb-1">Oilaviy holati</p><p class="text-[14px] text-white font-semibold">${profile.partner_marital_status}</p></div>` : ''}
                            </div>
                        </div>
                        ` : ''}
                        ${bioEsc ? `<div class="glass-card rounded-2xl p-5"><h3 class="text-[13px] font-black uppercase tracking-widest text-primary mb-3">O'zim haqimda</h3><p class="text-[14px] leading-relaxed text-white/80 font-medium">${bioEsc}</p></div>` : ''}
                        <div id="feed-profile-similar-listings" class="glass-card rounded-xl p-3">
                            <div class="flex items-center gap-2 mb-2 border-b border-white/5 pb-2">
                                <span class="material-symbols-outlined text-primary text-[16px]">recommend</span>
                                <h3 class="text-[11px] font-black uppercase tracking-widest text-white/80">Tafsiya qilinadigan e'lonlar</h3>
                            </div>
                            <div id="feed-profile-similar-listings-body" class="flex gap-2 overflow-x-auto ios-scroll-hide pb-1 -mx-1" style="-webkit-overflow-scrolling: touch;">
                                <p class="text-white/40 text-[11px] py-4 flex items-center gap-2 shrink-0"><span class="animate-spin rounded-full h-3 w-3 border border-primary border-t-transparent"></span>Tafsiya qilinadigan e'lonlar yuklanmoqda</p>
                            </div>
                        </div>
                        </div>
                </main>
            `;
        }

        function renderSimilarListingsCards(listings) {
            if (!listings || !listings.length) return '';
            const gradients = ['linear-gradient(135deg, #667eea 0%, #764ba2 100%)','linear-gradient(135deg, #f093fb 0%, #f5576c 100%)','linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)','linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)','linear-gradient(135deg, #fa709a 0%, #fee140 100%)','linear-gradient(135deg, #30cfd0 0%, #330867 100%)'];
            return listings.map(function(l) {
                const gIdx = (l.id || 0) % gradients.length;
                return `<div onclick="window.closeFeedModal(); showFeedProfile(${l.user_id}, ${l.id || 0})" class="flex-shrink-0 w-[calc(50%-4px)] min-w-[140px] max-w-[168px] glass-card rounded-xl overflow-hidden cursor-pointer active:scale-95 transition-transform border border-white/10">
                    <div class="h-16 w-full" style="background: ${gradients[gIdx]}"></div>
                    <div class="p-2">
                        <p class="text-[11px] font-bold text-white truncate">${(l.name || 'Noma\'lum')}, ${l.age || '?'}</p>
                        <p class="text-[9px] text-white/50 truncate">${l.region || ''}</p>
                        <p class="text-[8px] text-white/40 mt-0.5 truncate">${l.profession || ''} ${l.marital_status ? '· ' + l.marital_status : ''}</p>
                    </div>
                </div>`;
            }).join('');
        }

        function loadSimilarListings(profile, excludeUserId, callback) {
            const gender = profile.gender || (feedGender === 'Erkak' ? 'Ayol' : 'Erkak');
            const region = profile.region ? encodeURIComponent(profile.region) : '';
            var urlWithRegion = '/feed/api/listings?page=1&per_page=8&gender=' + encodeURIComponent(gender) + '&exclude_user_id=' + excludeUserId + (region ? '&regions=' + region : '');
            var urlNoRegion = '/feed/api/listings?page=1&per_page=8&gender=' + encodeURIComponent(gender) + '&exclude_user_id=' + excludeUserId;
            fetch(urlWithRegion, { method: 'GET', headers: { 'X-Requested-With': 'XMLHttpRequest' }, credentials: 'same-origin' })
                .then(r => r.ok ? r.json() : null)
                .then(function(data) {
                    var list = (data && data.listings) || [];
                    if (list.length > 0) {
                        if (typeof callback === 'function') callback(list);
                        return;
                    }
                    return fetch(urlNoRegion, { method: 'GET', headers: { 'X-Requested-With': 'XMLHttpRequest' }, credentials: 'same-origin' })
                        .then(function(r) { return r.ok ? r.json() : null; })
                        .then(function(data2) {
                            var list2 = (data2 && data2.listings) || [];
                            if (typeof callback === 'function') callback(list2);
                        })
                        .catch(function() { if (typeof callback === 'function') callback([]); });
                })
                .catch(function() {
                    fetch(urlNoRegion, { method: 'GET', headers: { 'X-Requested-With': 'XMLHttpRequest' }, credentials: 'same-origin' })
                        .then(function(r) { return r.ok ? r.json() : null; })
                        .then(function(data2) {
                            var list2 = (data2 && data2.listings) || [];
                            if (typeof callback === 'function') callback(list2);
                        })
                        .catch(function() { if (typeof callback === 'function') callback([]); });
                });
        }

        var feedModalSavedScrollY = 0;

        function showFeedProfileFromListing(listing) {
            const modal = document.getElementById('feed-profile-modal');
            const content = document.getElementById('feed-profile-content');
            const footer = document.getElementById('feed-profile-modal-footer');
            const scrollEl = document.getElementById('feed-profile-modal-scroll');
            const nav = document.querySelector('nav');
            if (!modal || !content) return;
            hapticTap('light');
            feedModalSavedScrollY = window.scrollY ?? document.documentElement.scrollTop ?? document.body.scrollTop ?? 0;
            window.scrollTo(0, 0);
            const userId = listing.user_id;
            content.innerHTML = renderFeedModalContent(listing, userId, '');
            if (scrollEl) scrollEl.scrollTop = 0;
            if (footer) { footer.classList.remove('hidden'); footer.innerHTML = '<div class="max-w-md mx-auto"><div class="h-14 rounded-2xl bg-white/10 animate-pulse"></div></div>'; }
            if (nav) nav.style.display = 'none';
            updateFeedModalHeaderFavorite(userId, listing.is_favorite);
            document.body.classList.add('feed-modal-open');
            modal.classList.remove('hidden');
            modal.style.opacity = '0';
            modal.style.transform = 'scale(0.98)';
            requestAnimationFrame(function() { modal.style.transition = 'opacity 0.2s ease-out, transform 0.2s ease-out'; modal.style.opacity = '1'; modal.style.transform = 'scale(1)'; });
            var similarGender = (typeof feedGender !== 'undefined' ? feedGender : 'Ayol');
            loadSimilarListings({ gender: similarGender, region: listing.region }, userId, function(similar) {
                const bodyEl = document.getElementById('feed-profile-similar-listings-body');
                if (!bodyEl) return;
                if (similar.length === 0) {
                    bodyEl.innerHTML = '<p class="text-white/40 text-[11px] py-2">Tafsiya qilinadigan e\'lonlar topilmadi</p>';
                    return;
                }
                bodyEl.innerHTML = renderSimilarListingsCards(similar);
            });
            const profileId = listing.id || '';
            const url = profileId ? '/feed/api/listing/' + userId + '?profile_id=' + profileId : '/feed/api/listing/' + userId;
            fetch(url, { method: 'GET', headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' }, credentials: 'same-origin' })
                .then(r => r.ok ? r.json() : null)
                .then(profile => {
                    if (!profile) return;
                    let actionHtml;
                    if (profile.request_sent && profile.request_status === 'accepted' && profile.chat_id) {
                        actionHtml = '<button onclick="window.closeFeedModal(); window.showChatView(' + profile.chat_id + ')" class="w-full h-14 bg-gradient-to-r from-primary to-green-500 rounded-2xl flex items-center justify-center gap-2 text-black font-extrabold text-[15px] tracking-widest uppercase neon-glow active:scale-95">CHATGA O\'TISH 💬</button>';
                    } else if (profile.request_sent && profile.request_status === 'pending' && profile.is_sender) {
                        actionHtml = '<div class="glass-card p-4 rounded-2xl text-center text-white/60">So\'rov yuborilgan, javob kutilmoqda</div>';
                    } else if (profile.request_sent && profile.request_status === 'pending' && !profile.is_sender) {
                        actionHtml = '<div class="glass-card p-4 rounded-2xl text-center text-white/60">Sizga so\'rov yuborilgan. So\'rovlar bo\'limida ko\'ring</div>';
                    } else if (profile.request_sent && profile.request_status === 'rejected') {
                        actionHtml = '<div class="glass-card p-4 rounded-2xl text-center text-white/60">So\'rov rad etilgan</div>';
                    } else {
                        const pid = profile.id || '';
                        actionHtml = '<button onclick="window.sendFeedRequest(' + userId + ', ' + pid + ')" class="w-full h-14 bg-gradient-to-r from-primary to-green-500 rounded-2xl flex items-center justify-center gap-2 text-black font-extrabold text-[15px] tracking-widest uppercase neon-glow active:scale-95">SO\'ROV YUBORISH 💌</button>';
                    }
                    if (footer) footer.innerHTML = '<div class="max-w-md mx-auto">' + actionHtml + '</div>';
                    content.innerHTML = renderFeedModalContent(profile, userId, '');
                    updateFeedModalHeaderFavorite(userId, profile.is_favorite === true || (typeof favoritesCache !== 'undefined' && favoritesCache.some(function(f){ return (f.favorite_user_id || (f.favorite_user && f.favorite_user.id)) == userId; })));
                })
                .catch(() => {
                    if (footer) footer.innerHTML = '<div class="max-w-md mx-auto"><button onclick="window.sendFeedRequest(' + userId + ')" class="w-full h-14 bg-primary text-black rounded-2xl font-bold">SO\'ROV YUBORISH</button></div>';
                });
        }

        async function showFeedProfile(userId, profileId) {
            const modal = document.getElementById('feed-profile-modal');
            const content = document.getElementById('feed-profile-content');
            const footer = document.getElementById('feed-profile-modal-footer');
            const scrollEl = document.getElementById('feed-profile-modal-scroll');
            const nav = document.querySelector('nav');
            if (!modal || !content) return;
            feedModalSavedScrollY = window.scrollY ?? document.documentElement.scrollTop ?? document.body.scrollTop ?? 0;
            window.scrollTo(0, 0);
            content.innerHTML = '<div class="text-center py-12"><div class="animate-spin rounded-full h-10 w-10 border-2 border-primary border-t-transparent mx-auto"></div></div>';
            if (footer) { footer.classList.remove('hidden'); footer.innerHTML = '<div class="max-w-md mx-auto"><div class="h-14 rounded-2xl bg-white/10 animate-pulse"></div></div>'; }
            if (nav) nav.style.display = 'none';
            if (scrollEl) scrollEl.scrollTop = 0;
            var fromCache = typeof favoritesCache !== 'undefined' && favoritesCache.some(function(f){ return (f.favorite_user_id || (f.favorite_user && f.favorite_user.id)) == userId; });
            updateFeedModalHeaderFavorite(userId, fromCache);
            document.body.classList.add('feed-modal-open');
            modal.classList.remove('hidden');
            modal.style.opacity = '0';
            modal.style.transform = 'scale(0.98)';
            requestAnimationFrame(function() { modal.style.transition = 'opacity 0.2s ease-out, transform 0.2s ease-out'; modal.style.opacity = '1'; modal.style.transform = 'scale(1)'; });
            try {
                const url = profileId ? '/feed/api/listing/' + userId + '?profile_id=' + profileId : '/feed/api/listing/' + userId;
                const response = await fetch(url, { method: 'GET', headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' }, credentials: 'same-origin' });
                if (!response.ok) throw new Error();
                const profile = await response.json();
                const pid = profile.id || profileId || '';
                let actionHtml = profile.request_sent && profile.request_status === 'accepted' && profile.chat_id ?
                    '<button onclick="window.closeFeedModal(); window.showChatView(' + profile.chat_id + ')" class="w-full h-14 bg-gradient-to-r from-primary to-green-500 rounded-2xl flex items-center justify-center gap-2 text-black font-extrabold text-[15px] tracking-widest uppercase neon-glow active:scale-95">CHATGA O\'TISH 💬</button>' :
                    profile.request_sent && profile.request_status === 'pending' && profile.is_sender ? '<div class="glass-card p-4 rounded-2xl text-center text-white/60">So\'rov yuborilgan</div>' :
                    profile.request_sent && profile.request_status === 'pending' && !profile.is_sender ? '<div class="glass-card p-4 rounded-2xl text-center text-white/60">Sizga so\'rov yuborilgan</div>' :
                    profile.request_sent && profile.request_status === 'rejected' ? '<div class="glass-card p-4 rounded-2xl text-center text-white/60">So\'rov rad etilgan</div>' :
                    '<button onclick="window.sendFeedRequest(' + userId + ', ' + pid + ')" class="w-full h-14 bg-gradient-to-r from-primary to-green-500 rounded-2xl flex items-center justify-center gap-2 text-black font-extrabold text-[15px] tracking-widest uppercase neon-glow active:scale-95">SO\'ROV YUBORISH 💌</button>';
                if (footer) footer.innerHTML = '<div class="max-w-md mx-auto">' + actionHtml + '</div>';
                content.innerHTML = renderFeedModalContent(profile, userId, '');
                loadSimilarListings(profile, userId, function(similar) {
                    const bodyEl = document.getElementById('feed-profile-similar-listings-body');
                    const wrapEl = document.getElementById('feed-profile-similar-listings');
                    if (!bodyEl || !wrapEl) return;
                    if (similar.length === 0) {
                        bodyEl.innerHTML = '<p class="text-white/40 text-[11px] py-2">Tafsiya qilinadigan e\'lonlar topilmadi</p>';
                        return;
                    }
                    bodyEl.innerHTML = renderSimilarListingsCards(similar);
                });
            } catch (e) {
                content.innerHTML = '<div class="text-center py-8 text-red-400">Xatolik</div>';
                if (footer) footer.classList.add('hidden');
            }
        }

        window.closeFeedModal = function() {
            hapticTap('light');
            document.body.classList.remove('feed-modal-open');
            if (typeof feedModalSavedScrollY === 'number') window.scrollTo(0, feedModalSavedScrollY);
            const modal = document.getElementById('feed-profile-modal');
            const nav = document.querySelector('nav');
            if (nav) nav.style.display = '';
            if (modal) {
                modal.classList.add('hidden');
                const scrollEl = document.getElementById('feed-profile-modal-scroll');
                if (scrollEl) scrollEl.scrollTop = 0;
            }
        };

        window.sendFeedRequest = async function(receiverId, profileId) {
            await initUserData();
            const profileComplete = userData && userData.user && userData.user.profile_complete;
            if (!profileComplete || !hasActiveTariff) {
                document.getElementById('require-full-profile-modal').classList.remove('hidden');
                return;
            }
            
            if (!confirm('Ushbu foydalanuvchiga so\'rov yuborasizmi?')) return;

            try {
                const body = { receiver_id: receiverId };
                if (profileId) body.receiver_profile_id = profileId;
                const response = await fetch('/requests/api/send', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(body)
                });

                const data = await response.json();

                if (response.ok) {
                    alert('So\'rov muvaffaqiyatli yuborildi!');
                    window.closeFeedModal();
                    window.showPage('requests');
                } else {
                    alert(data.error || 'Xatolik yuz berdi');
                }
            } catch (error) {
                alert('Xatolik yuz berdi');
            }
        };

        // Feed event listeners - use event delegation
        document.addEventListener('change', (e) => {
            if (e.target.id === 'feed-top-only') {
                feedCurrentPage = 1;
                loadFeedListings(1, e.target.checked);
            }
        });

        document.addEventListener('click', (e) => {
            if (e.target.id === 'feed-load-more-btn' || e.target.closest('#feed-load-more-btn')) {
                feedCurrentPage++;
                const topOnly = document.getElementById('feed-top-only')?.checked || false;
                loadFeedListings(feedCurrentPage, topOnly);
            }
        });

        // REQUESTS PAGE
        let requestsCurrentTab = 'received';
        let requestsSort = 'new';
        let sortSheetContext = 'feed';

        async function loadRequestsData() {
            if (!userData) await initUserData();
            updateRequestsTariffInfo();
            if (requestsCurrentTab === 'received') {
            await loadReceivedRequests();
            } else if (requestsCurrentTab === 'sent') {
                await loadSentRequests();
            } else {
                switchRequestsTab('received');
            }
            pageDataLoaded.requests = true;
        }
        
        async function loadRequestsDataOld() {
            // Wait for user data if not loaded yet
            if (!userData) {
                await initUserData();
            }
            updateRequestsTariffInfo();
            // Load both received and sent requests
            await loadReceivedRequests();
            await loadSentRequests();
        }

        function updateRequestsTariffInfo() {
            const container = document.getElementById('requests-tariff-info');
            if (!container) return;
            
            if (!hasActiveTariff) {
                container.innerHTML = `
                    <div class="glass-card rounded-2xl p-5 mb-4 border border-yellow-500/30 bg-yellow-500/10">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="size-12 rounded-xl bg-yellow-500/20 flex items-center justify-center">
                                <span class="material-symbols-outlined text-yellow-400 text-[28px]">workspace_premium</span>
                            </div>
                            <div>
                                <h3 class="text-base font-bold text-yellow-400">Tarif kerak</h3>
                                <p class="text-[11px] text-yellow-400/80">So'rov yuborish uchun tarif sotib oling</p>
                            </div>
                        </div>
                        <button type="button" onclick="window.showPage('tariff')" class="w-full bg-primary text-black py-3 rounded-xl text-center font-bold text-sm uppercase tracking-wider neon-glow active:scale-95 transition-all">
                            Tarif sotib olish
                        </button>
                    </div>
                `;
            } else {
                container.innerHTML = '';
            }
        }

        function sortRequestsBy(list, sortKey) {
            if (!list || !Array.isArray(list)) return list;
            const arr = [...list];
            const getSender = r => r.sender || r.receiver || {};
            const getDate = r => (r.created_at && new Date(r.created_at).getTime()) || 0;
            const getName = r => (getSender(r).name || '').toLowerCase();
            const getAge = r => parseInt(getSender(r).age, 10) || 0;
            const getHeight = r => parseInt(getSender(r).height, 10) || 0;
            if (sortKey === 'new') arr.sort((a, b) => getDate(b) - getDate(a));
            else if (sortKey === 'name_asc') arr.sort((a, b) => getName(a).localeCompare(getName(b)));
            else if (sortKey === 'name_desc') arr.sort((a, b) => getName(b).localeCompare(getName(a)));
            else if (sortKey === 'age_asc') arr.sort((a, b) => getAge(b) - getAge(a));
            else if (sortKey === 'age_desc') arr.sort((a, b) => getAge(a) - getAge(b));
            else if (sortKey === 'height_asc') arr.sort((a, b) => getHeight(a) - getHeight(b));
            else if (sortKey === 'height_desc') arr.sort((a, b) => getHeight(b) - getHeight(a));
            return arr;
        }

        function switchRequestsTab(tab) {
            requestsCurrentTab = tab;
            updateRequestsTariffInfo();
            
            const receivedTab = document.getElementById('requests-received-tab');
            const sentTab = document.getElementById('requests-sent-tab');
            const receivedLabel = document.getElementById('requests-received-label');
            const sentLabel = document.getElementById('requests-sent-label');
            
            // Barcha tablarni inactive qilish: faqat ikonka, kulrang
            [receivedTab, sentTab].forEach(el => {
                if (el) {
                    el.classList.remove('text-primary', 'active-neon-btn');
                    el.classList.add('text-white/40', 'requests-tab-icon-only');
                }
            });
            [receivedLabel, sentLabel].forEach(el => { if (el) el.classList.add('hidden'); });
            
            document.getElementById('requests-received-container')?.classList.add('hidden');
            document.getElementById('requests-sent-container')?.classList.add('hidden');
            
            if (tab === 'received') {
                if (receivedTab) {
                    receivedTab.classList.remove('text-white/40', 'requests-tab-icon-only');
                    receivedTab.classList.add('text-primary', 'active-neon-btn');
                }
                if (receivedLabel) receivedLabel.classList.remove('hidden');
                document.getElementById('requests-received-container')?.classList.remove('hidden');
                loadReceivedRequests();
            } else if (tab === 'sent') {
                if (sentTab) {
                    sentTab.classList.remove('text-white/40', 'requests-tab-icon-only');
                    sentTab.classList.add('text-primary', 'active-neon-btn');
                }
                if (sentLabel) sentLabel.classList.remove('hidden');
                document.getElementById('requests-sent-container')?.classList.remove('hidden');
                loadSentRequests();
            }
        }
        
        window.switchRequestsTab = switchRequestsTab;

        async function loadReceivedRequests() {
            const container = document.getElementById('requests-received-container');
            const skeleton = document.getElementById('requests-received-skeleton');
            
            if (!container) return;
            
            try {
                if (skeleton) setTimeout(() => skeleton.style.display = 'none', 100);
                
                const response = await fetch('/requests/api/received', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'same-origin'
                });
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        window.location.href = '/';
                        return;
                    }
                    throw new Error(`HTTP ${response.status}: Failed to load requests`);
                }
                const data = await response.json();

                if (skeleton) skeleton.remove();
                container.innerHTML = '';

                if (data.requests.length === 0) {
                    container.innerHTML = '<div class="text-center py-8 text-white/60">Qabul qilingan so\'rovlar yo\'q</div>';
                    return;
                }
                
                const badge = document.getElementById('requests-received-badge');
                if (badge && data.count > 0) {
                    badge.textContent = data.count;
                    badge.classList.remove('hidden');
                }

                const sorted = sortRequestsBy(data.requests, requestsSort);
                sorted.forEach(request => {
                    container.appendChild(createReceivedRequestCard(request));
                });

            } catch (error) {
                console.error('Error loading received requests:', error);
                if (skeleton) skeleton.remove();
                container.innerHTML = '<div class="text-center py-8 text-red-400">Xatolik yuz berdi</div>';
            }
        }

        async function loadSentRequests() {
            const container = document.getElementById('requests-sent-container');
            const skeleton = document.getElementById('requests-sent-skeleton');
            
            if (!container) return;
            
            try {
                if (skeleton) setTimeout(() => skeleton.style.display = 'none', 100);
                
                const response = await fetch('/requests/api/sent', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'same-origin'
                });
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        window.location.href = '/';
                        return;
                    }
                    throw new Error(`HTTP ${response.status}: Failed to load requests`);
                }
                const data = await response.json();

                if (skeleton) skeleton.remove();
                container.innerHTML = '';

                if (data.requests.length === 0) {
                    container.innerHTML = '<div class="text-center py-8 text-white/60">Yuborilgan so\'rovlar yo\'q</div>';
                    return;
                }
                
                const badge = document.getElementById('requests-sent-badge');
                if (badge && data.count > 0) {
                    badge.textContent = data.count;
                    badge.classList.remove('hidden');
                }

                const sorted = sortRequestsBy(data.requests, requestsSort);
                sorted.forEach(request => {
                    container.appendChild(createSentRequestCard(request));
                });

            } catch (error) {
                console.error('Error loading sent requests:', error);
                if (skeleton) skeleton.remove();
                container.innerHTML = '<div class="text-center py-8 text-red-400">Xatolik yuz berdi</div>';
            }
        }

        async function loadAcceptedRequests() {
            const container = document.getElementById('requests-chats-container');
            const skeleton = document.getElementById('requests-chats-skeleton');
            
            if (!container) return;
            
            try {
                if (skeleton) setTimeout(() => skeleton.style.display = 'none', 100);
                
                const response = await fetch('/requests/api/accepted', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'same-origin'
                });
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        window.location.href = '/';
                        return;
                    }
                    throw new Error(`HTTP ${response.status}: Failed to load accepted requests`);
                }
                const data = await response.json();

                if (skeleton) skeleton.remove();
                container.innerHTML = '';

                if (data.requests.length === 0) {
                    container.innerHTML = '<div class="text-center py-8 text-white/60">Qabul qilingan so\'rovlar yo\'q</div>';
                    return;
                }
                
                const badge = document.getElementById('requests-chats-badge');
                if (badge && data.count > 0) {
                    badge.textContent = data.count;
                    badge.classList.remove('hidden');
                }

                data.requests.forEach(request => {
                    // Determine if current user is sender or receiver
                    const isSender = userData && userData.user && request.sender && request.sender.id === userData.user.id;
                    if (isSender) {
                        container.appendChild(createSentRequestCard(request));
                    } else {
                        container.appendChild(createReceivedRequestCard(request));
                    }
                });

            } catch (error) {
                console.error('Error loading accepted requests:', error);
                if (skeleton) skeleton.remove();
                container.innerHTML = '<div class="text-center py-8 text-red-400">Xatolik yuz berdi</div>';
            }
        }
        
        window.loadAcceptedRequests = loadAcceptedRequests;

        function createReceivedRequestCard(request) {
            const div = document.createElement('article');
            div.className = 'profile-card glass-card rounded-[28px] overflow-hidden relative flex flex-col group';
            div.style.height = 'calc((100vh - 220px) / 2.8)';
            div.style.minHeight = '245px';

            const statusBadge = request.status === 'pending' 
                ? '<div class="status-pending px-3 py-1 rounded-full flex items-center gap-1.5"><span class="material-symbols-outlined text-[14px]">pending_actions</span> KUTILMOQDA</div>'
                : request.status === 'accepted'
                ? '<div class="bg-green-500/20 border-green-500/40 text-green-400 px-3 py-1 rounded-full flex items-center gap-1.5 text-[9px] font-black uppercase"><span class="material-symbols-outlined text-[14px]">check_circle</span> QABUL QILINDI</div>'
                : '<div class="status-rejected px-3 py-1 rounded-full flex items-center gap-1.5"><span class="material-symbols-outlined text-[14px]">cancel</span> RAD ETILDI</div>';

            const sender = request.sender || {};
            const senderName = sender.name || 'Foydalanuvchi';
            const senderId = sender.id || sender.user_id || '0000';
            const senderAge = sender.age || '';
            const senderLocation = sender.location || sender.region || '';
            const senderNationality = sender.nationality || '';
            // Generate gradient background based on user_id
            const gradientColors = [
                ['rgba(255, 107, 107, 0.3)', 'rgba(78, 205, 196, 0.3)'],
                ['rgba(69, 183, 209, 0.3)', 'rgba(150, 206, 180, 0.3)'],
                ['rgba(255, 234, 167, 0.3)', 'rgba(221, 160, 221, 0.3)'],
                ['rgba(116, 185, 255, 0.3)', 'rgba(162, 155, 254, 0.3)'],
                ['rgba(253, 121, 168, 0.3)', 'rgba(253, 203, 110, 0.3)']
            ];
            const colorIndex = (parseInt(senderId) || 0) % gradientColors.length;
            const bgGradient = `linear-gradient(135deg, ${gradientColors[colorIndex][0]}, ${gradientColors[colorIndex][1]})`;
            const bgImage = sender.photo_url || '';
            
            div.innerHTML = `
                <div class="relative flex-1 bg-cover bg-center" style="${bgImage ? `background-image: url('${bgImage}')` : `background: ${bgGradient}`}">
                    <div class="absolute inset-0 profile-gradient"></div>
                    <div class="absolute top-4 left-4 right-4 flex justify-between items-start z-10">
                        <div class="flex flex-wrap items-center gap-1.5">
                            <span class="bg-primary px-2.5 py-1 rounded text-[10px] font-black tracking-widest text-black neon-glow uppercase">#${senderId}</span>
                            ${senderNationality ? `<div class="tag-premium-dark px-2.5 py-1.5 rounded-full flex items-center gap-1.5 text-[9px] font-extrabold text-white uppercase tracking-wider">
                                <span class="material-symbols-outlined text-[13px] text-primary">public</span>
                                ${senderNationality}
                            </div>` : ''}
                            ${senderLocation ? `<div class="tag-premium-dark px-2.5 py-1.5 rounded-full flex items-center gap-1.5 text-[9px] font-extrabold text-white uppercase tracking-wider">
                                <span class="material-symbols-outlined text-[13px] text-primary">location_on</span>
                                ${senderLocation}
                            </div>` : ''}
                        </div>
                        <div class="flex flex-col gap-3">
                            <button onclick="window.acceptRequest(${request.id})" class="size-11 rounded-full action-glass flex items-center justify-center text-primary shadow-xl border-primary/40 active:scale-90 transition-transform">
                                <span class="material-symbols-outlined text-[24px]">check_circle</span>
                            </button>
                            <button onclick="window.rejectRequest(${request.id})" class="size-11 rounded-full action-glass flex items-center justify-center text-red-500 shadow-xl border-red-500/40 active:scale-90 transition-transform">
                                <span class="material-symbols-outlined text-[24px]">cancel</span>
                            </button>
                        </div>
                    </div>
                    <div class="absolute bottom-3 left-5 right-5 z-10">
                        <div class="flex items-baseline gap-2 mb-1.5">
                            <h2 class="text-2xl font-extrabold tracking-tight">${senderName}</h2>
                            ${senderAge ? `<span class="text-[14px] font-bold text-white/60">${senderAge} yosh</span>` : ''}
                        </div>
                        <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-[11px] font-bold text-white/90">
                            ${sender.height ? `<span class="flex items-center gap-2 truncate"><span class="material-symbols-outlined text-[14px] text-primary">straighten</span> ${sender.height} sm${sender.weight ? ' • ' + sender.weight + ' kg' : ''}</span>` : ''}
                            ${sender.marital_status ? `<span class="flex items-center gap-2 truncate"><span class="material-symbols-outlined text-[14px] text-primary">family_restroom</span> ${sender.marital_status}</span>` : ''}
                            ${sender.salary ? `<span class="flex items-center gap-2 truncate"><span class="material-symbols-outlined text-[14px] text-primary">payments</span> ${sender.salary}</span>` : ''}
                            ${sender.religious_level ? `<span class="flex items-center gap-2 truncate"><span class="material-symbols-outlined text-[14px] text-primary">verified_user</span> ${sender.religious_level}</span>` : ''}
                        </div>
                    </div>
                </div>
                <div class="glass-strip px-5 py-3 flex justify-between items-center text-[9px] uppercase tracking-[0.15em] font-black">
                    <div class="flex items-center gap-4 text-white/50">
                        <span class="flex items-center gap-1"><span class="material-symbols-outlined text-[15px]">visibility</span> ${sender.views_count || 0}</span>
                        <span class="flex items-center gap-1 text-primary/80"><span class="material-symbols-outlined text-[15px] fill-current" style="font-variation-settings: 'FILL' 1">favorite</span> ${sender.favorites_count || 0}</span>
                        <span class="flex items-center gap-1"><span class="material-symbols-outlined text-[15px]">schedule</span> ${formatTimeAgo(new Date(request.created_at))}</span>
                    </div>
                    <div class="text-primary flex items-center gap-1.5">
                        <span class="material-symbols-outlined text-[16px]">send_time_extension</span> ${sender.requests_count || 15} SO'ROV
                </div>
                    </div>
            `;

            return div;
        }

        function createSentRequestCard(request) {
            const div = document.createElement('article');
            div.className = 'profile-card glass-card rounded-[28px] overflow-hidden relative flex flex-col group';
            div.style.height = 'calc((100vh - 220px) / 2.8)';
            div.style.minHeight = '245px';

            const statusBadge = request.status === 'pending' 
                ? '<div class="status-pending px-3 py-1 rounded-full flex items-center gap-1.5"><span class="material-symbols-outlined text-[14px]">pending_actions</span> KUTILMOQDA</div>'
                : request.status === 'accepted'
                ? '<div class="bg-green-500/20 border-green-500/40 text-green-400 px-3 py-1 rounded-full flex items-center gap-1.5 text-[9px] font-black uppercase"><span class="material-symbols-outlined text-[14px]">check_circle</span> QABUL QILINDI</div>'
                : '<div class="status-rejected px-3 py-1 rounded-full flex items-center gap-1.5"><span class="material-symbols-outlined text-[14px]">cancel</span> RAD ETILDI</div>';

            const receiver = request.receiver || {};
            const receiverName = receiver.name || 'Foydalanuvchi';
            const receiverId = receiver.id || receiver.user_id || '0000';
            const receiverAge = receiver.age || '';
            const receiverLocation = receiver.location || receiver.region || '';
            const receiverNationality = receiver.nationality || '';
            // Generate gradient background based on user_id
            const gradientColors = [
                ['rgba(255, 107, 107, 0.3)', 'rgba(78, 205, 196, 0.3)'],
                ['rgba(69, 183, 209, 0.3)', 'rgba(150, 206, 180, 0.3)'],
                ['rgba(255, 234, 167, 0.3)', 'rgba(221, 160, 221, 0.3)'],
                ['rgba(116, 185, 255, 0.3)', 'rgba(162, 155, 254, 0.3)'],
                ['rgba(253, 121, 168, 0.3)', 'rgba(253, 203, 110, 0.3)']
            ];
            const colorIndex = (parseInt(receiverId) || 0) % gradientColors.length;
            const bgGradient = `linear-gradient(135deg, ${gradientColors[colorIndex][0]}, ${gradientColors[colorIndex][1]})`;
            const bgImage = receiver.photo_url || '';
            
            div.innerHTML = `
                <div class="relative flex-1 bg-cover bg-center" style="${bgImage ? `background-image: url('${bgImage}')` : `background: ${bgGradient}`}">
                    <div class="absolute inset-0 profile-gradient"></div>
                    <div class="absolute top-4 left-4 right-4 flex justify-between items-start z-10">
                        <div class="flex flex-wrap items-center gap-1.5">
                            <span class="bg-primary px-2.5 py-1 rounded text-[10px] font-black tracking-widest text-black neon-glow uppercase">#${receiverId}</span>
                            ${receiverNationality ? `<div class="tag-premium-darker px-2.5 py-1.5 rounded-full flex items-center gap-1.5 text-[9px] font-extrabold text-white uppercase tracking-wider">
                                <span class="material-symbols-outlined text-[14px] text-primary">public</span>
                                ${receiverNationality}
                            </div>` : ''}
                            ${receiverLocation ? `<div class="tag-premium-darker px-2.5 py-1.5 rounded-full flex items-center gap-1.5 text-[9px] font-extrabold text-white uppercase tracking-wider">
                                <span class="material-symbols-outlined text-[14px] text-primary">location_on</span>
                                ${receiverLocation}
                            </div>` : ''}
                        </div>
                        <div>
                            <button onclick="window.cancelRequest(${request.id})" class="size-11 rounded-full action-glass flex items-center justify-center text-white/70 shadow-xl active:scale-90 transition-transform">
                                <span class="material-symbols-outlined text-[24px]">close</span>
                            </button>
                        </div>
                    </div>
                    <div class="absolute bottom-3 left-5 right-5 z-10">
                        <div class="flex items-baseline gap-2 mb-1.5">
                            <h2 class="text-2xl font-extrabold tracking-tight">${receiverName}</h2>
                            ${receiverAge ? `<span class="text-[14px] font-bold text-white/60">${receiverAge} yosh</span>` : ''}
                        </div>
                        <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-[11px] font-bold text-white/90">
                            ${receiver.height ? `<span class="flex items-center gap-2 truncate"><span class="material-symbols-outlined text-[14px] text-primary">straighten</span> ${receiver.height} sm${receiver.weight ? ' • ' + receiver.weight + ' kg' : ''}</span>` : ''}
                            ${receiver.marital_status ? `<span class="flex items-center gap-2 truncate"><span class="material-symbols-outlined text-[14px] text-primary">family_restroom</span> ${receiver.marital_status}</span>` : ''}
                            ${receiver.salary ? `<span class="flex items-center gap-2 truncate"><span class="material-symbols-outlined text-[14px] text-primary">payments</span> ${receiver.salary}</span>` : ''}
                            ${receiver.religious_level ? `<span class="flex items-center gap-2 truncate"><span class="material-symbols-outlined text-[14px] text-primary">verified_user</span> ${receiver.religious_level}</span>` : ''}
                        </div>
                    </div>
                </div>
                <div class="glass-strip px-5 py-3 flex justify-between items-center text-[9px] uppercase tracking-[0.15em] font-black">
                    <div class="flex items-center gap-3.5 text-white/50">
                        <span class="flex items-center gap-1"><span class="material-symbols-outlined text-[15px]">visibility</span> ${receiver.views_count || '1.2K'}</span>
                        <span class="flex items-center gap-1"><span class="material-symbols-outlined text-[15px]">favorite</span> ${receiver.favorites_count || 24}</span>
                        <span class="flex items-center gap-1"><span class="material-symbols-outlined text-[15px]">schedule</span> ${formatTimeAgo(new Date(request.created_at))}</span>
                    </div>
                    ${statusBadge}
                </div>
                ${request.chat && request.chat.id ? `
                    <div class="glass-strip px-5 py-3">
                        <button onclick="event.stopPropagation(); showChatView(${request.chat.id})" class="w-full text-center bg-primary/20 border-primary/40 text-primary py-2.5 rounded-xl font-black text-[10px] uppercase tracking-wider hover:bg-primary/30 transition active:scale-95">
                            Chatga o'tish
                        </button>
                    </div>
                ` : ''}
            `;

            return div;
        }

        window.acceptRequest = async function(requestId) {
            if (!confirm('Ushbu so\'rovni qabul qilasizmi?')) return;
            try {
                const response = await fetch(`/requests/api/${requestId}/accept`, { 
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'same-origin'
                });
                const data = await response.json();
                if (response.ok) {
                    alert('So\'rov qabul qilindi!');
                    loadReceivedRequests();
                } else {
                    alert(data.error || 'Xatolik yuz berdi');
                }
            } catch (error) {
                alert('Xatolik yuz berdi');
            }
        };

        window.rejectRequest = async function(requestId) {
            if (!confirm('Ushbu so\'rovni rad qilasizmi?')) return;
            try {
                const response = await fetch(`/requests/api/${requestId}/reject`, { 
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'same-origin'
                });
                const data = await response.json();
                if (response.ok) {
                    alert('So\'rov rad etildi');
                    loadReceivedRequests();
                } else {
                    alert(data.error || 'Xatolik yuz berdi');
                }
            } catch (error) {
                alert('Xatolik yuz berdi');
            }
        };

        window.cancelRequest = async function(requestId) {
            if (!confirm('Ushbu so\'rovni bekor qilasizmi?')) return;
            try {
                const response = await fetch(`/requests/api/${requestId}/cancel`, { 
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'same-origin'
                });
                const data = await response.json();
                if (response.ok) {
                    alert('So\'rov bekor qilindi');
                    loadSentRequests();
                } else {
                    alert(data.error || 'Xatolik yuz berdi');
                }
            } catch (error) {
                alert('Xatolik yuz berdi');
            }
        };

        // Requests event listeners - use event delegation
        document.addEventListener('click', (e) => {
            if (e.target.id === 'requests-received-tab' || e.target.closest('#requests-received-tab')) {
                switchRequestsTab('received');
            } else if (e.target.id === 'requests-sent-tab' || e.target.closest('#requests-sent-tab')) {
                switchRequestsTab('sent');
            }
        });

        // CHATS PAGE
        let chatsSelectedProfileId = null;
        async function loadChatsData(profileId) {
            if (profileId !== undefined) chatsSelectedProfileId = profileId;
            const container = document.getElementById('chats-list');
            const skeleton = document.getElementById('chats-skeleton');
            const tabsEl = document.getElementById('chats-profile-tabs');
            
            if (!container) {
                console.error('chats-list container not found');
                return;
            }
            
            try {
                if (skeleton) skeleton.style.display = 'block';
                const url = profileId != null ? `/chat/api/list?profile_id=${profileId}` : '/chat/api/list';
                const response = await fetch(url, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
                    credentials: 'same-origin'
                });
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) { window.location.href = '/'; return; }
                    throw new Error(`HTTP ${response.status}: Failed to load chats`);
                }
                const data = await response.json();

                if (skeleton) skeleton.style.display = 'none';
                Array.from(container.children).forEach(child => {
                    if (child.id !== 'chats-skeleton') child.remove();
                });

                const myProfiles = data.my_profiles || [];
                if (tabsEl && myProfiles.length > 1) {
                    tabsEl.classList.remove('hidden');
                    tabsEl.innerHTML = '';
                    myProfiles.forEach(p => {
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = 'chats-profile-tab shrink-0 px-4 py-2 rounded-full text-[12px] font-bold transition-all ' + (chatsSelectedProfileId === p.id ? 'bg-primary text-black' : 'glass-card text-white/70');
                        btn.textContent = p.name || 'E\'lon';
                        btn.onclick = () => { chatsSelectedProfileId = p.id; loadChatsData(p.id); };
                        tabsEl.appendChild(btn);
                    });
                    const allBtn = document.createElement('button');
                    allBtn.type = 'button';
                    allBtn.className = 'chats-profile-tab shrink-0 px-4 py-2 rounded-full text-[12px] font-bold transition-all ' + (chatsSelectedProfileId === null ? 'bg-primary text-black' : 'glass-card text-white/70');
                    allBtn.textContent = 'Barchasi';
                    allBtn.onclick = () => { chatsSelectedProfileId = null; loadChatsData(null); };
                    tabsEl.insertBefore(allBtn, tabsEl.firstChild);
                } else if (tabsEl) tabsEl.classList.add('hidden');

                if (data.chats.length === 0) {
                    const emptyDiv = document.getElementById('chats-empty');
                    if (emptyDiv) emptyDiv.classList.remove('hidden');
                    pageDataLoaded.chats = true;
                    return;
                }
                const emptyDiv = document.getElementById('chats-empty');
                if (emptyDiv) emptyDiv.classList.add('hidden');
                data.chats.forEach(chat => container.appendChild(createChatCard(chat)));
                pageDataLoaded.chats = true;
            } catch (error) {
                console.error('Error loading chats:', error);
                if (skeleton) skeleton.style.display = 'none';
                Array.from(container.children).forEach(child => {
                    if (child.id !== 'chats-skeleton') child.remove();
                });
                const errorDiv = document.createElement('div');
                errorDiv.className = 'text-center py-8 text-red-400';
                errorDiv.textContent = 'Xatolik yuz berdi';
                container.appendChild(errorDiv);
            }
        }
        
        window.loadChatsData = loadChatsData;

        function createChatCard(chat) {
            const div = document.createElement('div');
            div.className = 'glass-row p-3.5 rounded-[28px] flex items-center gap-4 active:bg-white/5 transition-all cursor-pointer';
            div.onclick = () => showChatView(chat.id);

            const lastMsg = chat.last_message;
            const otherUser = chat.other_user || {};
            const photoUrl = otherUser.photo_url || '';
            const name = otherUser.name || 'Foydalanuvchi';
            const age = otherUser.age || '';
            const location = otherUser.location || otherUser.region || '';
            const userId = otherUser.id || otherUser.user_id || '0000';
            
            // Generate gradient background based on user_id
            const gradientColors = [
                ['rgba(255, 107, 107, 0.3)', 'rgba(78, 205, 196, 0.3)'],
                ['rgba(69, 183, 209, 0.3)', 'rgba(150, 206, 180, 0.3)'],
                ['rgba(255, 234, 167, 0.3)', 'rgba(221, 160, 221, 0.3)'],
                ['rgba(116, 185, 255, 0.3)', 'rgba(162, 155, 254, 0.3)'],
                ['rgba(253, 121, 168, 0.3)', 'rgba(253, 203, 110, 0.3)']
            ];
            const colorIndex = (parseInt(userId) || 0) % gradientColors.length;
            const bgGradient = `linear-gradient(135deg, ${gradientColors[colorIndex][0]}, ${gradientColors[colorIndex][1]})`;
            
            const daysRemaining = chat.days_remaining || 0;
            const isActive = chat.is_active && !chat.is_expired;
            const statusColor = isActive ? 'bg-primary' : 'bg-zinc-800';
            
            const lastMsgText = lastMsg ? (lastMsg.is_mine ? 'Siz: ' + lastMsg.content : lastMsg.content) : 'Chat boshlandi';
            const lastMsgClass = lastMsg && !lastMsg.is_mine && chat.unread_count > 0 ? 'text-primary font-bold' : lastMsg && !lastMsg.is_mine ? 'text-white/60' : 'text-white/40 font-medium';
            const isItalic = lastMsg && !lastMsg.is_mine && chat.unread_count === 0 ? 'italic' : '';

            div.innerHTML = `
                <div class="relative">
                    <div class="size-14 rounded-2xl bg-cover bg-center border border-white/10 ring-1 ring-white/5" style="${photoUrl ? `background-image: url('${photoUrl}')` : `background: ${bgGradient}`}"></div>
                    <div class="absolute -bottom-1 -right-1 size-4 ${statusColor} border-2 border-background-dark rounded-full"></div>
                    </div>
                    <div class="flex-1 min-w-0">
                    <div class="flex items-center justify-between mb-0.5">
                        <h4 class="font-extrabold text-[16px] truncate">${name}</h4>
                        <span class="timer-badge px-2.5 py-1 rounded-full text-[9px] font-black tracking-tight flex items-center gap-1 shadow-sm ${daysRemaining <= 1 ? 'opacity-70' : ''}">
                            <span class="material-symbols-outlined text-[12px]">hourglass_top</span>
                            ${daysRemaining} KUN QOLDI
                        </span>
                        </div>
                    <div class="flex items-center gap-2 mb-1">
                        <span class="text-[10px] font-black text-primary/80 tracking-widest uppercase">#${userId}</span>
                        <span class="text-white/10 text-[10px]">•</span>
                        <span class="text-[11px] font-semibold text-white/40">${location}${age ? ', ' + age + ' yosh' : ''}</span>
                    </div>
                    <p class="text-[13px] ${lastMsgClass} truncate font-medium ${isItalic}">${lastMsgText}</p>
                </div>
            `;

            return div;
        }
        
        // CHAT VIEW PAGE
        let currentChatId = null;
        let currentChatData = null;
        let chatTimerInterval = null;
        let chatRefreshInterval = null;
        
        async function showChatView(chatId) {
            console.log('showChatView called with chatId:', chatId);
            currentChatId = chatId;
            // Wait for user data if not loaded
            if (!userData) {
                await initUserData();
            }
            window.showPage('chat-view');
            await loadChatView(chatId);
        }
        
        window.showChatView = showChatView;
        
        async function loadChatView(chatId) {
            const container = document.getElementById('chat-messages-container');
            const skeleton = document.getElementById('chat-messages-skeleton');
            
            try {
                if (skeleton) setTimeout(() => skeleton.style.display = 'none', 100);
                
                const sortOrder = (typeof chatMessageSort !== 'undefined' && chatMessageSort === 'asc') ? 'asc' : 'desc';
                const response = await fetch(`/chat/api/${chatId}/messages?sort=${sortOrder}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'same-origin'
                });
                
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        window.location.href = '/';
                        return;
                    }
                    throw new Error(`HTTP ${response.status}: Failed to load chat`);
                }
                
                const data = await response.json();
                
                if (skeleton) skeleton.remove();
                
                currentChatData = data.chat;
                const order = (typeof chatMessageSort !== 'undefined' && chatMessageSort === 'asc') ? 'asc' : 'desc';
                const msgs = order === 'desc' ? data.messages.slice().reverse() : data.messages;
                displayChatMessages(msgs);
                updateChatHeader(data.chat);
                updateChatTimer();
                
                // Timer yangilash
                if (chatTimerInterval) clearInterval(chatTimerInterval);
                if (currentChatData.is_active && !currentChatData.is_expired) {
                    chatTimerInterval = setInterval(updateChatTimer, 1000);
                }
                
                // Xabarlarni avtomatik yangilash
                if (chatRefreshInterval) clearInterval(chatRefreshInterval);
                if (currentChatData.is_active && !currentChatData.is_expired) {
                    chatRefreshInterval = setInterval(() => {
                        loadChatView(chatId);
                    }, 3000);
                }
                
            } catch (error) {
                console.error('Error loading chat:', error);
                if (skeleton) skeleton.remove();
                if (container) container.innerHTML = '<div class="text-center py-8 text-red-400">Xatolik yuz berdi</div>';
            }
        }
        
        function displayChatMessages(messages) {
            const container = document.getElementById('chat-messages-container');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (messages.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-white/60">Xabarlar yo\'q</div>';
                return;
            }
            
            messages.forEach(msg => {
                container.appendChild(createChatMessageElement(msg));
            });
            
            container.scrollTop = container.scrollHeight;
        }
        
        function createChatMessageElement(msg) {
            const div = document.createElement('div');
            const isMine = userData && userData.user && msg.sender_id === userData.user.id;
            
            div.className = `flex items-end gap-3 ${isMine ? 'justify-end ml-auto max-w-[85%]' : 'max-w-[85%]'}`;
            
            // Avatar for other user
            if (!isMine && currentChatData && currentChatData.other_user) {
                const avatarDiv = document.createElement('div');
                const photoUrl = currentChatData.other_user.photo_url || '';
                avatarDiv.className = 'bg-center bg-no-repeat aspect-square bg-cover rounded-full w-9 h-9 border border-white/10 shrink-0';
                if (photoUrl) {
                    avatarDiv.style.backgroundImage = `url('${photoUrl}')`;
                } else {
                    avatarDiv.style.background = 'linear-gradient(135deg, rgba(64, 255, 0, 0.2), rgba(16, 185, 129, 0.2))';
                }
                div.appendChild(avatarDiv);
            }
            
            const messageContent = document.createElement('div');
            messageContent.className = `flex flex-col gap-1.5 ${isMine ? 'items-end' : ''}`;
            
            const bubble = document.createElement('div');
            bubble.className = isMine 
                ? 'glass-effect bg-glass-primary border-primary/30 px-4 py-3 rounded-2xl rounded-br-none'
                : 'glass-effect bg-white/5 px-4 py-3 rounded-2xl rounded-bl-none';
            
            bubble.innerHTML = `<p class="text-sm font-normal leading-relaxed ${isMine ? 'text-white' : 'text-white/90'}">${escapeHtml(msg.content)}</p>`;
            
            const time = document.createElement('p');
            time.className = `text-white/20 text-[9px] uppercase ${isMine ? 'text-right mr-1' : 'text-left ml-1'}`;
            time.textContent = formatMessageTime(new Date(msg.created_at));
            
            messageContent.appendChild(bubble);
            messageContent.appendChild(time);
            
            div.appendChild(messageContent);
            
            // Avatar for current user
            if (isMine && userData && userData.user && userData.user.profile) {
                const avatarDiv = document.createElement('div');
                const photoUrl = userData.user.profile.photo_url || '';
                avatarDiv.className = 'bg-center bg-no-repeat aspect-square bg-cover rounded-full w-9 h-9 border border-primary/20 shrink-0';
                if (photoUrl) {
                    avatarDiv.style.backgroundImage = `url('${photoUrl}')`;
                } else {
                    avatarDiv.style.background = 'linear-gradient(135deg, rgba(64, 255, 0, 0.3), rgba(16, 185, 129, 0.3))';
                }
                div.appendChild(avatarDiv);
            }
            
            return div;
        }
        
        function updateChatHeader(chat) {
            const nameEl = document.getElementById('chat-view-name');
            const userIdEl = document.getElementById('chat-view-user-id');
            const avatarEl = document.getElementById('chat-view-avatar');
            
            if (nameEl && chat.other_user) {
                nameEl.textContent = chat.other_user.name || 'Foydalanuvchi';
            }
            
            if (userIdEl && chat.other_user && chat.other_user.id) {
                userIdEl.textContent = '#' + chat.other_user.id;
            }
            
            if (avatarEl && chat.other_user) {
                if (chat.other_user.photo_url) {
                    avatarEl.style.backgroundImage = `url('${chat.other_user.photo_url}')`;
                    avatarEl.style.backgroundSize = 'cover';
                    avatarEl.style.backgroundPosition = 'center';
                    avatarEl.textContent = '';
                } else if (chat.other_user.name) {
                    avatarEl.textContent = chat.other_user.name.charAt(0).toUpperCase();
                    avatarEl.style.backgroundImage = '';
                }
            }
        }
        
        function updateChatTimer() {
            if (!currentChatData || !currentChatData.expires_at) return;
            
            const expiresAt = new Date(currentChatData.expires_at);
            const now = new Date();
            const diff = expiresAt - now;
            
            const container = document.getElementById('chat-timer-container');
            if (!container) return;
            
            if (diff <= 0) {
                if (chatTimerInterval) clearInterval(chatTimerInterval);
                container.innerHTML = '<div class="col-span-4 text-center text-red-400 text-sm">Muddati tugadi</div>';
                const input = document.getElementById('chat-message-input');
                const btn = document.getElementById('chat-send-btn');
                if (input) input.disabled = true;
                if (btn) btn.disabled = true;
                return;
            }
            
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);
            
            container.innerHTML = `
                <div class="flex flex-col items-center gap-1.5">
                    <div class="flex h-12 w-full items-center justify-center rounded-2xl bg-white/5 border border-white/10 glass-effect">
                        <p class="text-white text-lg font-bold">${String(days).padStart(2, '0')}</p>
                    </div>
                    <p class="text-white/30 text-[9px] uppercase font-bold tracking-wider">Kun</p>
                </div>
                <div class="flex flex-col items-center gap-1.5">
                    <div class="flex h-12 w-full items-center justify-center rounded-2xl bg-white/5 border border-white/10 glass-effect">
                        <p class="text-white text-lg font-bold">${String(hours).padStart(2, '0')}</p>
                    </div>
                    <p class="text-white/30 text-[9px] uppercase font-bold tracking-wider">Soat</p>
                </div>
                <div class="flex flex-col items-center gap-1.5">
                    <div class="flex h-12 w-full items-center justify-center rounded-2xl bg-white/5 border border-white/10 glass-effect">
                        <p class="text-white text-lg font-bold">${String(minutes).padStart(2, '0')}</p>
                    </div>
                    <p class="text-white/30 text-[9px] uppercase font-bold tracking-wider">Minut</p>
                </div>
                <div class="flex flex-col items-center gap-1.5">
                    <div class="flex h-12 w-full items-center justify-center rounded-2xl bg-primary/20 border border-primary/40 glass-effect">
                        <p class="text-primary text-lg font-bold glow-text">${String(seconds).padStart(2, '0')}</p>
                    </div>
                    <p class="text-primary/60 text-[9px] uppercase font-bold tracking-wider">Sekund</p>
                </div>
            `;
            
            // Update timer badge
            const timerBadge = document.getElementById('chat-timer-badge');
            if (timerBadge) {
                timerBadge.innerHTML = `<p class="text-primary text-[11px] font-bold tracking-wider glow-text uppercase">${days} kun ${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}</p>`;
            }
        }
        
        async function sendChatMessage() {
            if (!currentChatId) return;
            
            const input = document.getElementById('chat-message-input');
            const content = input?.value.trim();
            
            if (!content) return;
            if (!currentChatData || !currentChatData.is_active || currentChatData.is_expired) {
                alert('Chat muddati tugagan');
                return;
            }
            
            try {
                const response = await fetch(`/chat/api/${currentChatId}/send`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({content: content}),
                    credentials: 'same-origin'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    if (input) input.value = '';
                    // Xabarlarni qayta yuklash
                    await loadChatView(currentChatId);
                } else {
                    alert(data.error || 'Xatolik yuz berdi');
                }
            } catch (error) {
                console.error('Error sending message:', error);
                alert('Xatolik yuz berdi');
            }
        }
        
        window.sendChatMessage = sendChatMessage;
        
        function formatMessageTime(date) {
            return date.toLocaleTimeString('uz-UZ', { hour: '2-digit', minute: '2-digit' });
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Enter bosilganda xabar yuborish
        document.addEventListener('keypress', (e) => {
            if (e.target.id === 'chat-message-input' && e.key === 'Enter') {
                sendChatMessage();
            }
        });

        // PROFILE PAGE
        // FAVORITES PAGE
        let favoritesCache = [];
        function renderFavoritesListWithFilter() {
            const container = document.getElementById('favorites-list');
            if (!container) return;
            const q = (document.getElementById('favorites-search')?.value || '').trim().toLowerCase();
            const filtered = favoritesCache.filter(f => {
                const listing = f.favorite_user;
                if (!listing) return false;
                if (listing.gender && listing.gender !== feedGender) return false;
                if (q && !(listing.name || '').toLowerCase().includes(q) && !String(listing.user_id || '').includes(q)) return false;
                return true;
            });
            container.innerHTML = '';
            if (filtered.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-white/60">Sevimlilar yo\'q</div>';
                return;
            }
            filtered.forEach(favorite => container.appendChild(createFavoriteCard(favorite)));
        }
        async function loadFavoritesData() {
            const container = document.getElementById('favorites-list');
            const skeleton = document.getElementById('favorites-skeleton');
            if (!container) return;
            if (favoritesCache.length > 0) {
                if (skeleton) { skeleton.style.display = 'none'; skeleton.remove(); }
                renderFavoritesListWithFilter();
            }
            try {
                const response = await fetch('/favorites/api/list', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
                    credentials: 'same-origin'
                });
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) { window.location.href = '/'; return; }
                    throw new Error(`HTTP ${response.status}: Failed to load favorites`);
                }
                const data = await response.json();
                if (skeleton) { skeleton.style.display = 'none'; skeleton.remove(); }
                favoritesCache = (data.favorites || []).filter(f => f.favorite_user);
                pageDataLoaded.favorites = true;
                renderFavoritesListWithFilter();
                saveFavoritesToCache();
            } catch (error) {
                console.error('Error loading favorites:', error);
                if (skeleton) skeleton.remove();
                if (favoritesCache.length === 0) container.innerHTML = '<div class="text-center py-8 text-red-400">Xatolik yuz berdi</div>';
            }
        }
        
        function createFavoriteCard(favorite) {
            const listing = favorite.favorite_user;
            const div = document.createElement('article');
            div.className = 'profile-card glass-card rounded-[22px] overflow-hidden relative flex flex-col group';
            div.style.height = 'calc((100vh - 220px) / 2.8)';
            div.style.minHeight = '245px';
            div.onclick = () => (typeof showFeedProfileFromListing === 'function' ? showFeedProfileFromListing(listing) : (window.location.href = `/feed/profile/${listing.user_id || favorite.favorite_user_id}`));

            // Har xil gradient ranglar yaratish
            const gradients = [
                'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
                'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                'linear-gradient(135deg, #30cfd0 0%, #330867 100%)',
                'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
                'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)',
                'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)',
                'linear-gradient(135deg, #ff6e7f 0%, #bfe9ff 100%)'
            ];
            const gradientIndex = (listing.user_id || favorite.favorite_user_id || 0) % gradients.length;
            const selectedGradient = gradients[gradientIndex];
            
            div.innerHTML = `
                <div class="relative flex-1" style="background: ${selectedGradient}">
                    <div class="absolute inset-0 profile-gradient"></div>
                    <div class="absolute top-3 left-3 right-3 flex justify-between items-start z-10">
                        <div class="flex flex-wrap gap-1.5 items-center">
                            <span class="bg-primary px-2.5 py-1 rounded text-[9px] font-black tracking-widest text-black neon-glow uppercase">#${listing.user_id || favorite.favorite_user_id || '0000'}</span>
                            ${listing.is_top ? '<div class="tag-premium px-2.5 py-1.5 rounded-xl flex items-center gap-1.5 text-[8px] font-extrabold text-white uppercase tracking-wider shadow-lg"><span class="material-symbols-outlined text-[12px] text-primary">star</span> TOP</div>' : ''}
                            <div class="tag-premium px-2.5 py-1.5 rounded-xl flex items-center gap-1.5 text-[8px] font-extrabold text-white uppercase tracking-wider shadow-lg">
                                <span class="material-symbols-outlined text-[12px] text-primary">public</span>
                                ${listing.nationality || 'O\'zbek'}
                            </div>
                            <div class="tag-premium px-2.5 py-1.5 rounded-xl flex items-center gap-1.5 text-[8px] font-extrabold text-white uppercase tracking-wider shadow-lg">
                                <span class="material-symbols-outlined text-[12px] text-primary">location_on</span>
                                ${listing.region || 'Toshkent'}
                            </div>
                        </div>
                        <button onclick="event.stopPropagation(); removeFavorite(${favorite.id})" class="size-8 rounded-full glass-card flex items-center justify-center text-red-400 border-white/20 hover:bg-red-500/20 transition-colors">
                            <span class="material-symbols-outlined text-[18px]">favorite</span>
                        </button>
                    </div>
                    <div class="absolute bottom-2 left-4 right-4 z-10">
                        <div class="flex items-baseline gap-2 mb-1">
                            <h2 class="text-xl font-extrabold tracking-tight">${listing.name || 'Foydalanuvchi'}</h2>
                            <span class="text-[12px] font-bold text-white/60">${listing.age || '?'} yosh</span>
                        </div>
                        <div class="grid grid-cols-2 gap-x-3 gap-y-0.5 text-[10px] font-bold text-white">
                            <span class="flex items-center gap-1.5 truncate">
                                <span class="material-symbols-outlined text-[13px] text-primary">straighten</span>
                                ${listing.height || '-'} sm • ${listing.weight || '-'} kg
                            </span>
                            <span class="flex items-center gap-1.5 truncate">
                                <span class="material-symbols-outlined text-[13px] text-primary">family_restroom</span>
                                ${listing.marital_status || 'Bo\'ydoq'}
                            </span>
                            <span class="flex items-center gap-1.5 truncate">
                                <span class="material-symbols-outlined text-[13px] text-primary">verified_user</span>
                                ${listing.religious_level || 'O\'rtacha'}
                            </span>
                            <span class="flex items-center gap-1.5 truncate">
                                <span class="material-symbols-outlined text-[13px] text-primary">school</span>
                                ${listing.education || 'Oliy'}
                            </span>
                        </div>
                    </div>
                </div>
                <div class="glass-strip px-4 py-2 flex justify-between items-center text-[8px] uppercase tracking-[0.12em] font-black">
                    <div class="flex items-center gap-3 text-white/50">
                        <span class="flex items-center gap-1"><span class="material-symbols-outlined text-[14px]">visibility</span> ${listing.views || 0}</span>
                        <span class="flex items-center gap-1"><span class="material-symbols-outlined text-[14px]">favorite</span> ${listing.likes || 0}</span>
                    </div>
                </div>
            `;

            return div;
        }
        
        async function removeFavorite(favoriteId) {
            if (!confirm('Sevimlidan olib tashlamoqchimisiz?')) return;
            
            try {
                const response = await fetch(`/favorites/api/${favoriteId}/remove`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'same-origin'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    if (typeof window.showNotification === 'function') {
                        window.showNotification('✅ ' + data.message);
                    }
                    await loadFavoritesData();
                } else {
                    alert('Xatolik: ' + (data.error || 'Noma\'lum xatolik'));
                }
            } catch (error) {
                console.error('Error removing favorite:', error);
                alert('Xatolik: ' + error.message);
            }
        }
        
        window.removeFavorite = removeFavorite;

        async function loadProfileData() {
            if (!userData) await initUserData();
            updateProfileUI();
            await Promise.all([loadListingsPageData(), loadTariffPageData()]);
            pageDataLoaded.profile = true;
        }

        let currentProfileEditSection = null;

        async function loadProfileEditPage() {
            if (!userData) await initUserData();
            updateProfileEditSummaries();
        }

        function isProfileSectionFilled(section, p) {
            switch (section) {
                case 'diniy': return !!(p.prays && p.fasts && p.religious_level);
                case 'joylashuv': return !!(p.country && p.region && p.nationality);
                case 'oilaviy': return !!(p.marital_status && (p.marital_status || '').trim());
                case 'jismoniy': return p.height != null && p.height !== '' && p.weight != null && p.weight !== '';
                case 'talim': return !!(p.education && (p.education || '').trim());
                case 'ish': return !!(p.profession && (p.profession || '').trim() && (p.is_working === true || p.is_working === 'true' || p.is_working === false || p.is_working === 'false'));
                case 'juftga': return !!(p.partner_age_min != null && p.partner_age_max != null && (function(){ const locs = p.partner_locations; if (Array.isArray(locs) && locs.length > 0) return true; return !!(p.partner_country && p.partner_region); })() && p.partner_religious_level && p.partner_marital_status);
                case 'bio': return !!((p.bio || '').trim());
                default: return false;
            }
        }

        function updateProfileEditSummaries() {
            const p = userData?.profile || {};
            const el = (id, text) => { const e = document.getElementById(id); if (e) e.textContent = text || '—'; };
            const avatar = document.getElementById('profile-edit-avatar');
            if (avatar) avatar.textContent = (p.name || '?').charAt(0).toUpperCase();
            el('profile-edit-name', p.name ? `${p.name}${p.age ? ', ' + p.age : ''}` : '—');
            el('profile-edit-region', p.region ? `${p.region}${p.nationality ? ', ' + p.nationality : ''}` : '—');
            el('profile-edit-diniy-summary', [p.aqida, p.prays, p.quran_reading, p.mazhab, p.religious_level].filter(Boolean).join(', ') || 'Belgilanmagan');
            el('profile-edit-joylashuv-summary', [p.country, p.region, p.nationality].filter(Boolean).join(', ') || 'Belgilanmagan');
            el('profile-edit-oilaviy-summary', p.marital_status || 'Belgilanmagan');
            el('profile-edit-jismoniy-summary', [p.height && (p.height + ' sm'), p.weight && (p.weight + ' kg'), p.smoking, (p.sport_days != null && p.sport_days >= 1) ? (p.sport_days === 7 ? 'Sport: har kuni' : 'Sport: ' + p.sport_days + ' kun') : null].filter(Boolean).join(', ') || 'Belgilanmagan');
            el('profile-edit-talim-summary', p.education || 'Belgilanmagan');
            el('profile-edit-ish-summary', (p.profession ? (p.profession + (p.is_working ? ', Ishlaman' : '') + (p.salary ? ' · ' + p.salary : '')) : null) || 'Belgilanmagan');
            const juftgaParts = [];
            if (p.partner_age_min != null || p.partner_age_max != null) juftgaParts.push((p.partner_age_min ?? '?') + '-' + (p.partner_age_max ?? '?') + ' yosh');
            const locs = p.partner_locations;
            if (Array.isArray(locs) && locs.length) {
                juftgaParts.push(locs.map(function(x){ return x.all ? (x.c || x.country) + ': butun' : (x.c || x.country) + ': ' + (x.r || []).length + ' joy'; }).join('; '));
            } else if (p.partner_country || p.partner_region) juftgaParts.push((p.partner_country || '') + (p.partner_region ? ': ' + p.partner_region : ''));
            if (p.partner_religious_level) juftgaParts.push(p.partner_religious_level);
            if (p.partner_marital_status) juftgaParts.push(p.partner_marital_status);
            el('profile-edit-juftga-summary', juftgaParts.length ? juftgaParts.join(', ') : 'Belgilanmagan');
            const bioEl = document.getElementById('profile-edit-bio-summary');
            if (bioEl) { bioEl.textContent = (p.bio || '').trim() ? (p.bio.slice(0, 40) + (p.bio.length > 40 ? '…' : '')) : 'Belgilanmagan'; bioEl.classList.toggle('italic', !p.bio); }
            document.querySelectorAll('.profile-edit-section-btn').forEach(function(btn) {
                var section = btn.getAttribute('data-section');
                var filled = section && isProfileSectionFilled(section, p);
                if (filled) {
                    btn.classList.add('border-primary', 'bg-primary/5');
                    btn.classList.remove('border-white/10');
                    var icon = btn.querySelector('.profile-edit-section-icon');
                    if (icon) { icon.classList.add('bg-primary/10', 'text-primary', 'border-primary/30'); icon.classList.remove('bg-white/5', 'text-white/60', 'border-white/10'); }
                    var sum = btn.querySelector('p[id^="profile-edit-"][id$="-summary"]');
                    if (sum) { sum.classList.add('text-primary/80'); sum.classList.remove('text-white/50'); }
                    var chevron = btn.querySelector('.profile-edit-chevron');
                    if (chevron) { chevron.classList.add('text-primary'); chevron.classList.remove('text-white/30'); }
                } else {
                    btn.classList.remove('border-primary', 'bg-primary/5');
                    btn.classList.add('border-white/10');
                    var icon = btn.querySelector('.profile-edit-section-icon');
                    if (icon) { icon.classList.remove('bg-primary/10', 'text-primary', 'border-primary/30'); icon.classList.add('bg-white/5', 'text-white/60', 'border-white/10'); }
                    var sum = btn.querySelector('p[id^="profile-edit-"][id$="-summary"]');
                    if (sum) { sum.classList.remove('text-primary/80'); sum.classList.add('text-white/50'); }
                    var chevron = btn.querySelector('.profile-edit-chevron');
                    if (chevron) { chevron.classList.remove('text-primary'); chevron.classList.add('text-white/30'); }
                }
            });
        }

        let _sheetDataSource = null;
        let addListingShaxsiyStep = 0;
        const SHAXSIY_STEP_NAMES = ['Jins', 'Ism', 'Tug\'ilgan yil', 'Davlat', 'Viloyat / Shahar', 'Millat'];
        function openProfileEditSheet(section, dataSource, initialShaxsiyStep) {
            currentProfileEditSection = section;
            _sheetDataSource = dataSource || null;
            if (section === 'shaxsiy' && _sheetDataSource) {
                addListingShaxsiyStep = (typeof initialShaxsiyStep === 'number') ? initialShaxsiyStep : 0;
            }
            hapticTap('light');
            const sheet = document.getElementById('profile-edit-sheet');
            const overlay = document.getElementById('profile-edit-sheet-overlay');
            const content = document.getElementById('profile-edit-sheet-content');
            const title = document.getElementById('profile-edit-sheet-title');
            const body = document.getElementById('profile-edit-sheet-body');
            const p = _sheetDataSource || userData?.profile || {};
            if (!sheet || !body) return;
            sheet.classList.remove('pointer-events-none');
            overlay.classList.remove('pointer-events-none');
            overlay.classList.add('opacity-100');
            content.classList.remove('translate-y-full');
            const titles = { shaxsiy: 'Ism, jins, yosh', diniy: 'Diniy ma\'lumotlar', joylashuv: 'Joylashuv', oilaviy: 'Oilaviy holati', jismoniy: 'Jismoniy', talim: 'Ta\'lim', ish: 'Ish & Kasb', juftga: 'Juftga talablari', bio: 'O\'zim haqimda' };
            title.textContent = titles[section] || 'Tahrirlash';
            const countryList = Object.keys(LOCATION_COUNTRIES_REGIONS);
            const regionOpts = LOCATION_COUNTRIES_REGIONS["O'zbekiston"] || [];
            const yearOpts = Array.from({length: 48}, (_, i) => 2006 - i);
            if (section === 'shaxsiy') {
                const defaultGender = (p.gender && (p.gender === 'Erkak' || p.gender === 'Ayol')) ? p.gender : 'Ayol';
                const isWoman = (defaultGender === 'Ayol');
                const maritalOpts = isWoman ? ['Qiz bola', 'Beva', 'Ajrashgan'] : ['Bo\'ydoq', 'Oilali', 'Ajrashgan'];
                const isAddListingSteps = !!_sheetDataSource;
                if (isAddListingSteps) {
                    title.textContent = 'Ism, jins, yosh';
                    body.innerHTML = `
                        <label class="block text-[11px] font-bold text-white/60 mb-2">Jins</label>
                        <div class="flex gap-3 mb-4">
                            <label class="flex-1 flex items-center justify-center p-5 rounded-2xl border-2 cursor-pointer transition-all ${p.gender === 'Erkak' ? 'border-primary bg-primary/10' : 'border-white/10 bg-white/5'}"><span class="text-lg font-bold">Erkak</span><input type="radio" name="gender" value="Erkak" ${p.gender === 'Erkak' ? 'checked' : ''} class="hidden"></label>
                            <label class="flex-1 flex items-center justify-center p-5 rounded-2xl border-2 cursor-pointer transition-all ${p.gender === 'Ayol' ? 'border-primary bg-primary/10' : 'border-white/10 bg-white/5'}"><span class="text-lg font-bold">Ayol</span><input type="radio" name="gender" value="Ayol" ${p.gender === 'Ayol' ? 'checked' : ''} class="hidden"></label>
                        </div>
                        <label class="block text-[11px] font-bold text-white/60 mb-2">Ism</label>
                        <input type="text" name="name" value="${(p.name || '').replace(/"/g, '&quot;')}" placeholder="Ismni kiriting" class="w-full glass-card rounded-2xl px-4 py-3 text-white border border-white/10 bg-white/5 mb-4">
                        <label class="block text-[11px] font-bold text-white/60 mb-2">Tug'ilgan yil</label>
                        <select name="birth_year" class="w-full glass-card rounded-2xl px-4 py-3 text-white border border-white/10 bg-white/5 mb-4">${yearOpts.map(y => `<option value="${y}" ${(p.birth_year == y) ? 'selected' : ''}>${y} yil</option>`).join('')}</select>
                    `;
                    body.querySelectorAll('input[type=radio][name=gender]').forEach(radio => {
                        radio.addEventListener('change', function() {
                            body.querySelectorAll('label').forEach(l => l.classList.remove('border-primary', 'bg-primary/10'));
                            this.closest('label')?.classList.add('border-primary', 'bg-primary/10');
                        });
                    });
                    document.getElementById('profile-edit-sheet-save')?.classList.remove('hidden');
                } else {
                    body.innerHTML = `
                    <label class="block text-[11px] font-bold text-white/60 mb-2">Ism</label>
                    <input type="text" name="name" value="${(p.name || '').replace(/"/g, '&quot;')}" placeholder="Ism" class="w-full glass-card rounded-2xl px-4 py-3 text-white border border-white/10 bg-white/5 mb-4">
                    <label class="block text-[11px] font-bold text-white/60 mb-2">Jins</label>
                    <div class="flex gap-3 mb-4">
                        <label class="flex-1 flex items-center justify-between p-4 rounded-2xl border cursor-pointer transition-all ${defaultGender === 'Erkak' ? 'border-primary bg-primary/10' : 'border-white/10 bg-white/5'}"><span>Erkak</span><input type="radio" name="gender" value="Erkak" ${defaultGender === 'Erkak' ? 'checked' : ''} class="hidden"></label>
                        <label class="flex-1 flex items-center justify-between p-4 rounded-2xl border cursor-pointer transition-all ${defaultGender === 'Ayol' ? 'border-primary bg-primary/10' : 'border-white/10 bg-white/5'}"><span>Ayol</span><input type="radio" name="gender" value="Ayol" ${defaultGender === 'Ayol' ? 'checked' : ''} class="hidden"></label>
                    </div>
                    <label class="block text-[11px] font-bold text-white/60 mb-2">Tug'ilgan yil</label>
                    <select name="birth_year" class="w-full glass-card rounded-2xl px-4 py-3 text-white border border-white/10 bg-white/5 mb-4">${yearOpts.map(y => `<option value="${y}" ${(p.birth_year === y) ? 'selected' : ''}>${y}</option>`).join('')}</select>
                    <label class="block text-[11px] font-bold text-white/60 mb-2">Davlat</label>
                    <select name="country" id="profile-edit-country" class="w-full glass-card rounded-2xl px-4 py-3 text-white border border-white/10 bg-white/5 mb-4">${countryList.map(c => `<option value="${c}" ${(p.country === c) ? 'selected' : ''}>${c}</option>`).join('')}</select>
                    <label class="block text-[11px] font-bold text-white/60 mb-2">Viloyat / Shahar</label>
                    <select name="region" id="profile-edit-region-select" class="w-full glass-card rounded-2xl px-4 py-3 text-white border border-white/10 bg-white/5 mb-4">${(LOCATION_COUNTRIES_REGIONS[p.country || "O'zbekiston"] || []).map(r => `<option value="${r}" ${(p.region === r) ? 'selected' : ''}>${r}</option>`).join('')}</select>
                    <label class="block text-[11px] font-bold text-white/60 mb-2">Millat</label>
                    <select name="nationality" class="w-full glass-card rounded-2xl px-4 py-3 text-white border border-white/10 bg-white/5 mb-4">${['O\'zbek','Rus','Tojik','Qozoq','Qoraqalpoq','Boshqa'].map(n => `<option value="${n}" ${(p.nationality === n) ? 'selected' : ''}>${n}</option>`).join('')}</select>
                    <label class="block text-[11px] font-bold text-white/60 mb-2">Oilaviy holati</label>
                    <div class="space-y-2">
                        ${maritalOpts.map(v => `<label class="flex items-center justify-between p-4 rounded-2xl border cursor-pointer transition-all ${(p.marital_status === v) ? 'border-primary bg-primary/10' : 'border-white/10 bg-white/5'}"><span>${v}</span><input type="radio" name="marital_status" value="${v}" ${(p.marital_status === v) ? 'checked' : ''} class="hidden"></label>`).join('')}
                    </div>
                `;
                    const countryEl = document.getElementById('profile-edit-country');
                    const regionEl = document.getElementById('profile-edit-region-select');
                    if (countryEl && regionEl) countryEl.addEventListener('change', function() {
                        const regs = LOCATION_COUNTRIES_REGIONS[this.value] || [];
                        const curVal = regionEl.value;
                        regionEl.innerHTML = regs.map(r => `<option value="${r}">${r}</option>`).join('');
                        if (regs.indexOf(curVal) !== -1) regionEl.value = curVal;
                    });
                }
            } else if (section === 'diniy') {
                body.innerHTML = `
                    <p class="text-[11px] font-black text-white/40 uppercase tracking-[0.2em] mb-3 ml-1">Aqidasi (filterdagidek)</p>
                    <div class="flex flex-wrap gap-2 mb-4">
                        ${['Ahli Sunna','Ash\'ariya','Moturidiya','Boshqa'].map(v => `<button type="button" class="chip ${(p.aqida === v) ? 'chip-selected' : 'chip-unselected'}" data-name="aqida" data-value="${v.replace(/'/g,'\\\'')}">${v}</button>`).join('')}
                    </div>
                    <input type="hidden" name="aqida" value="${(p.aqida || '').replace(/"/g,'&quot;')}">
                    <p class="text-[11px] font-black text-white/40 uppercase tracking-[0.2em] mb-3 ml-1">Namoz</p>
                    <div class="space-y-2 mb-4">
                        ${['5 vaqt to\'liq','Faqat juma','O\'qimaydi','Boshlash niyatida'].map(v => `<button type="button" class="radio-item w-full flex items-center justify-between p-4 rounded-2xl bg-white/[0.03] border transition-all ${(p.prays === v) ? 'radio-item-selected border-primary/40' : 'border-white/[0.05]'}" data-name="prays" data-value="${v.replace(/'/g,'\\\'')}"><span class="text-sm font-semibold ${(p.prays === v) ? 'text-white' : 'text-white/60'}">${v}</span><div class="size-5 rounded-full border-2 flex items-center justify-center ${(p.prays === v) ? 'border-primary' : 'border-white/20'}">${(p.prays === v) ? '<div class="size-2.5 bg-primary rounded-full"></div>' : ''}</div></button>`).join('')}
                    </div>
                    <input type="hidden" name="prays" value="${(p.prays || '').replace(/"/g,'&quot;')}">
                    <p class="text-[11px] font-black text-white/40 uppercase tracking-[0.2em] mb-3 ml-1">Qur'on o'qish</p>
                    <div class="flex flex-wrap gap-2 mb-4">
                        ${['Bilmaydi','O\'qishni biladi','Ravon o\'qiydi','Hofizi Qur\'on'].map(v => `<button type="button" class="chip ${(p.quran_reading === v) ? 'chip-selected' : 'chip-unselected'}" data-name="quran_reading" data-value="${v.replace(/'/g,'\\\'')}">${v}</button>`).join('')}
                    </div>
                    <input type="hidden" name="quran_reading" value="${(p.quran_reading || '').replace(/"/g,'&quot;')}">
                    <p class="text-[11px] font-black text-white/40 uppercase tracking-[0.2em] mb-3 ml-1">Mazhabi</p>
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        ${['Hanafi','Shafi\'i','Maliki','Hanbali'].map(v => `<button type="button" class="radio-item p-4 rounded-2xl bg-white/[0.03] border transition-all text-center ${(p.mazhab === v) ? 'border-primary/40' : 'border-white/[0.05]'}" data-name="mazhab" data-value="${v}"><span class="text-sm font-bold ${(p.mazhab === v) ? 'text-white' : 'text-white/60'}">${v}</span></button>`).join('')}
                    </div>
                    <input type="hidden" name="mazhab" value="${(p.mazhab || '').replace(/"/g,'&quot;')}">
                    <p class="text-[11px] font-black text-white/40 uppercase tracking-[0.2em] mb-3 ml-1">Ro'za</p>
                    <div class="flex gap-2 mb-4">
                        ${['Ha','Yo\'q'].map(v => `<button type="button" class="chip flex-1 ${(p.fasts === v) ? 'chip-selected' : 'chip-unselected'}" data-name="fasts" data-value="${v}">${v}</button>`).join('')}
                    </div>
                    <input type="hidden" name="fasts" value="${(p.fasts || '').replace(/"/g,'&quot;')}">
                    <p class="text-[11px] font-black text-white/40 uppercase tracking-[0.2em] mb-3 ml-1">Diniy daraja</p>
                    <div class="flex flex-wrap gap-2">
                        ${['Jiddiy','O\'rtacha','Yengil'].map(v => `<button type="button" class="chip ${(p.religious_level === v) ? 'chip-selected' : 'chip-unselected'}" data-name="religious_level" data-value="${v}">${v}</button>`).join('')}
                    </div>
                    <input type="hidden" name="religious_level" value="${(p.religious_level || '').replace(/"/g,'&quot;')}">
                `;
                body.querySelectorAll('.chip[data-name]').forEach(function(btn) {
                    btn.addEventListener('click', function() {
                        var name = this.getAttribute('data-name');
                        var val = this.getAttribute('data-value');
                        var group = body.querySelectorAll('.chip[data-name="' + name + '"]');
                        group.forEach(function(b) { b.classList.remove('chip-selected'); b.classList.add('chip-unselected'); });
                        this.classList.remove('chip-unselected'); this.classList.add('chip-selected');
                        var inp = body.querySelector('input[name="' + name + '"]');
                        if (inp) inp.value = val;
                    });
                });
                body.querySelectorAll('.radio-item[data-name]').forEach(function(btn) {
                    btn.addEventListener('click', function() {
                        var name = this.getAttribute('data-name');
                        var val = this.getAttribute('data-value');
                        body.querySelectorAll('.radio-item[data-name="' + name + '"]').forEach(function(b) {
                            b.classList.remove('radio-item-selected', 'border-primary/40');
                            b.classList.add('border-white/[0.05]');
                            var sp = b.querySelector('span');
                            if (sp) { sp.classList.add('text-white/60'); sp.classList.remove('text-white'); }
                            var circle = b.querySelector('.size-5');
                            if (circle) { circle.classList.remove('border-primary'); circle.classList.add('border-white/20'); circle.innerHTML = ''; }
                        });
                        this.classList.add('radio-item-selected', 'border-primary/40');
                        this.classList.remove('border-white/[0.05]');
                        var sp = this.querySelector('span');
                        if (sp) { sp.classList.remove('text-white/60'); sp.classList.add('text-white'); }
                        var circle = this.querySelector('.size-5');
                        if (circle) { circle.classList.add('border-primary'); circle.classList.remove('border-white/20'); var d = document.createElement('div'); d.className = 'size-2.5 bg-primary rounded-full'; circle.appendChild(d); }
                        var inp = body.querySelector('input[name="' + name + '"]');
                        if (inp) inp.value = val;
                    });
                });
            } else if (section === 'joylashuv') {
                const joyCountry = p.country || "O'zbekiston";
                const joyRegions = LOCATION_COUNTRIES_REGIONS[joyCountry] || [];
                body.innerHTML = `
                    <label class="block text-[11px] font-bold text-white/60 mb-2">Davlat</label>
                    <select name="country" id="profile-edit-joy-country" class="w-full glass-card rounded-2xl px-4 py-3 text-white border border-white/10 bg-white/5 mb-4">${countryList.map(c => `<option value="${c}" ${(joyCountry === c) ? 'selected' : ''}>${c}</option>`).join('')}</select>
                    <label class="block text-[11px] font-bold text-white/60 mb-2">Viloyat / Shahar</label>
                    <select name="region" id="profile-edit-joy-region" class="w-full glass-card rounded-2xl px-4 py-3 text-white border border-white/10 bg-white/5 mb-4">${joyRegions.map(r => `<option value="${r}" ${(p.region === r) ? 'selected' : ''}>${r}</option>`).join('')}</select>
                    <label class="block text-[11px] font-bold text-white/60 mb-2">Millat</label>
                    <select name="nationality" class="w-full glass-card rounded-2xl px-4 py-3 text-white border border-white/10 bg-white/5">${['O\'zbek','Rus','Tojik','Qozoq','Qoraqalpoq','Boshqa'].map(n => `<option value="${n}" ${(p.nationality === n) ? 'selected' : ''}>${n}</option>`).join('')}</select>
                `;
                const joyCountryEl = document.getElementById('profile-edit-joy-country');
                const joyRegionEl = document.getElementById('profile-edit-joy-region');
                if (joyCountryEl && joyRegionEl) joyCountryEl.addEventListener('change', function() {
                    const regs = LOCATION_COUNTRIES_REGIONS[this.value] || [];
                    joyRegionEl.innerHTML = regs.map(r => `<option value="${r}">${r}</option>`).join('');
                });
            } else if (section === 'oilaviy') {
                const isWoman = (p.gender === 'Ayol');
                const options = isWoman ? ['Qiz bola', 'Beva', 'Ajrashgan'] : ['Bo\'ydoq', 'Oilali', 'Ajrashgan'];
                body.innerHTML = `
                    <div class="space-y-2">
                        ${options.map(v => `<label class="flex items-center justify-between p-4 rounded-2xl border cursor-pointer transition-all ${(p.marital_status === v) ? 'border-primary bg-primary/10' : 'border-white/10 bg-white/5'}"><span>${v}</span><input type="radio" name="marital_status" value="${v}" ${(p.marital_status === v) ? 'checked' : ''} class="hidden"></label>`).join('')}
                    </div>
                `;
            } else if (section === 'jismoniy') {
                const hVal = p.height != null && p.height >= 140 && p.height <= 210 ? parseInt(p.height, 10) : 170;
                const wVal = p.weight != null && p.weight >= 40 && p.weight <= 130 ? parseInt(p.weight, 10) : 70;
                body.innerHTML = `
                    <p class="text-[11px] font-bold text-white/60 mb-3">Filterdagidek aylantirib tanlang</p>
                    <div class="flex items-start justify-center gap-3 w-full">
                        <div class="ios-dial-wrapper flex-1">
                            <span class="ios-dial-title">BO'Y</span>
                            <div class="ios-dial" id="profile-edit-dial-height" data-min="140" data-max="210">
                                <div class="ios-dial-fade-top"></div>
                                <div class="ios-dial-ticks"><div class="ios-dial-tick"></div><div class="ios-dial-tick"></div><div class="ios-dial-tick glow"></div><div class="ios-dial-tick glow"></div><div class="ios-dial-tick"></div><div class="ios-dial-tick"></div></div>
                                <div class="ios-dial-track"><div class="ios-dial-items"></div></div>
                                <div class="ios-dial-fade-bottom"></div>
                            </div>
                            <span class="ios-dial-label">sm</span>
                        </div>
                        <div class="ios-dial-wrapper flex-1">
                            <span class="ios-dial-title">VAZN</span>
                            <div class="ios-dial" id="profile-edit-dial-weight" data-min="40" data-max="130">
                                <div class="ios-dial-fade-top"></div>
                                <div class="ios-dial-ticks"><div class="ios-dial-tick"></div><div class="ios-dial-tick"></div><div class="ios-dial-tick glow"></div><div class="ios-dial-tick glow"></div><div class="ios-dial-tick"></div><div class="ios-dial-tick"></div></div>
                                <div class="ios-dial-track"><div class="ios-dial-items"></div></div>
                                <div class="ios-dial-fade-bottom"></div>
                            </div>
                            <span class="ios-dial-label">kg</span>
                        </div>
                    </div>
                    <input type="hidden" name="height" id="profile-edit-height-input" value="${hVal}">
                    <input type="hidden" name="weight" id="profile-edit-weight-input" value="${wVal}">
                    <p class="text-[11px] font-black text-white/40 uppercase tracking-[0.2em] mb-2 mt-6 ml-1">Sigaret chekadimi? (filterdagidek)</p>
                    <div class="grid grid-cols-3 gap-3 mb-4">
                        ${['Ha','Yo\'q','Tashlagan'].map(v => `<button type="button" class="profile-edit-smoking-btn py-3 rounded-2xl text-sm font-bold uppercase tracking-wide transition-all ${(p.smoking === v) ? 'bg-primary text-black' : 'bg-white/[0.05] border border-white/[0.08] text-white/60'}" data-value="${v}">${v}</button>`).join('')}
                    </div>
                    <input type="hidden" name="smoking" id="profile-edit-smoking-input" value="${(p.smoking || '').replace(/"/g,'&quot;')}">
                    <p class="text-[11px] font-black text-white/40 uppercase tracking-[0.2em] mb-2 mt-4 ml-1">Sport bilan shug'ullanish</p>
                    <div class="p-4 rounded-2xl bg-white/[0.03] border border-white/[0.06] space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-[10px] font-bold text-white/40 uppercase tracking-widest">Haftada necha kun?</span>
                            <span id="profile-edit-sport-label" class="text-xs font-bold text-primary">${(p.sport_days != null && p.sport_days >= 1 && p.sport_days <= 7) ? ['','Haftada 1 kun','Haftada 2 kun','Haftada 3 kun','Haftada 4 kun','Haftada 5 kun','Haftada 6 kun','Har kuni'][p.sport_days] : 'Tanlang'}</span>
                        </div>
                        <div class="flex gap-1.5 h-2" id="profile-edit-sport-bars">
                            ${[1,2,3,4,5,6,7].map(d => `<button type="button" class="profile-edit-sport-bar flex-1 rounded-full transition-all ${(p.sport_days != null && d <= p.sport_days) ? 'bg-primary' : 'bg-white/10'}" data-day="${d}"></button>`).join('')}
                        </div>
                    </div>
                    <input type="hidden" name="sport_days" id="profile-edit-sport-days-input" value="${p.sport_days != null ? p.sport_days : ''}">
                `;
                body.querySelectorAll('.profile-edit-smoking-btn').forEach(function(btn) {
                    btn.addEventListener('click', function() {
                        var v = this.getAttribute('data-value');
                        body.querySelectorAll('.profile-edit-smoking-btn').forEach(function(b){ b.classList.remove('bg-primary','text-black'); b.classList.add('bg-white/[0.05]','border','border-white/[0.08]','text-white/60'); });
                        this.classList.remove('bg-white/[0.05]','border','border-white/[0.08]','text-white/60'); this.classList.add('bg-primary','text-black');
                        var inp = document.getElementById('profile-edit-smoking-input'); if (inp) inp.value = v;
                    });
                });
                body.querySelectorAll('.profile-edit-sport-bar').forEach(function(bar) {
                    bar.addEventListener('click', function() {
                        var day = parseInt(this.getAttribute('data-day'), 10);
                        body.querySelectorAll('.profile-edit-sport-bar').forEach(function(b) {
                            var d = parseInt(b.getAttribute('data-day'), 10);
                            b.classList.toggle('bg-primary', d <= day);
                            b.classList.toggle('bg-white/10', d > day);
                        });
                        var labels = ['','Haftada 1 kun','Haftada 2 kun','Haftada 3 kun','Haftada 4 kun','Haftada 5 kun','Haftada 6 kun','Har kuni'];
                        var labelEl = document.getElementById('profile-edit-sport-label');
                        if (labelEl) labelEl.textContent = labels[day] || '';
                        var inp = document.getElementById('profile-edit-sport-days-input');
                        if (inp) inp.value = day;
                    });
                });
                setTimeout(function() {
                    if (typeof initIosDial === 'function') {
                        initIosDial('profile-edit-dial-height', 140, 210, hVal);
                        initIosDial('profile-edit-dial-weight', 40, 130, wVal);
                    }
                }, 50);
            } else if (section === 'talim') {
                const eduOpts = [['Oliy','Oliy ma\'lumotli'],['O\'rta maxsus','O\'rta-maxsus'],['O\'rta','O\'rta']];
                body.innerHTML = `
                    <p class="text-[11px] font-black text-white/40 uppercase tracking-[0.2em] mb-3 ml-1">Ta'lim darajasi (filterdagidek)</p>
                    <div class="space-y-2">
                        ${eduOpts.map(function(arr) {
                            var v = arr[0], label = arr[1];
                            var sel = (p.education === v || p.education === label);
                            return '<button type="button" class="profile-edit-education-opt w-full flex items-center justify-between p-4 rounded-2xl bg-white/[0.03] border transition-all ' + (sel ? 'border-primary/40' : 'border-white/[0.05]') + '" data-value="' + v.replace(/'/g,'\\\'') + '"><span class="text-sm font-semibold ' + (sel ? 'text-white' : 'text-white/60') + '">' + label + '</span><div class="size-5 rounded-full flex items-center justify-center ' + (sel ? 'bg-primary' : 'border-2 border-white/10') + '">' + (sel ? '<span class="material-symbols-outlined text-black text-[14px] font-bold">check</span>' : '') + '</div></button>';
                        }).join('')}
                    </div>
                    <input type="hidden" name="education" value="${(p.education || '').replace(/"/g,'&quot;')}">
                `;
                body.querySelectorAll('.profile-edit-education-opt').forEach(function(btn) {
                    btn.addEventListener('click', function() {
                        var val = this.getAttribute('data-value');
                        body.querySelectorAll('.profile-edit-education-opt').forEach(function(b) {
                            b.classList.remove('border-primary/40');
                            b.classList.add('border-white/[0.05]');
                            var sp = b.querySelector('span'); if (sp) sp.classList.add('text-white/60'), sp.classList.remove('text-white');
                            var box = b.querySelector('.size-5'); if (box) { box.classList.remove('bg-primary'); box.classList.add('border-2', 'border-white/10'); box.innerHTML = ''; }
                        });
                        this.classList.add('border-primary/40');
                        this.classList.remove('border-white/[0.05]');
                        var sp = this.querySelector('span'); if (sp) sp.classList.remove('text-white/60'), sp.classList.add('text-white');
                        var box = this.querySelector('.size-5'); if (box) { box.classList.add('bg-primary'); box.classList.remove('border-2', 'border-white/10'); box.innerHTML = '<span class="material-symbols-outlined text-black text-[14px] font-bold">check</span>'; }
                        var inp = body.querySelector('input[name="education"]');
                        if (inp) inp.value = val;
                    });
                });
            } else if (section === 'ish') {
                const professions = ['Tadbirkor','Shifokor','IT muhandis','O\'qituvchi','Dizayner','Huquqshunos','Muhandis','Sotuvchi','Boshqa'];
                const currentProf = (p.profession || '').trim();
                const profMatch = professions.find(function(x) { return x === currentProf || (x === 'Boshqa' && !professions.slice(0,-1).includes(currentProf) && currentProf); });
                const salaryStr = (p.salary || '').replace(/\$/g,'').replace(/\s/g,'');
                const salaryNum = parseInt(salaryStr, 10) || 0;
                const salVal = Math.min(5000, Math.max(0, salaryNum));
                body.innerHTML = `
                    <p class="text-[11px] font-bold text-white/60 mb-2">Kasb (filterdagidek)</p>
                    <div class="flex flex-wrap gap-2 mb-4" id="profile-edit-professions">
                        ${professions.map(pr => `<button type="button" class="profile-edit-profession px-4 py-2.5 rounded-full text-sm font-bold transition-all ${(currentProf === pr || (pr === 'Boshqa' && currentProf && !professions.slice(0,-1).includes(currentProf)) ? 'bg-primary text-black' : 'bg-white/[0.05] border border-white/[0.1] text-white/70')}" data-value="${pr.replace(/"/g,'&quot;')}">${pr}</button>`).join('')}
                    </div>
                    <input type="hidden" name="profession" id="profile-edit-profession-input" value="${(currentProf || '').replace(/"/g,'&quot;')}">
                    <div id="profile-edit-boshqa-profession-wrap" class="mb-4 ${currentProf && currentProf !== 'Boshqa' && !professions.slice(0,-1).includes(currentProf) ? '' : 'hidden'}">
                        <label class="block text-[11px] font-bold text-white/60 mb-2">Boshqa kasb</label>
                        <input type="text" id="profile-edit-boshqa-profession-text" placeholder="Yozing..." class="w-full glass-card rounded-2xl px-4 py-3 text-white border border-white/10 bg-white/5" value="${currentProf && !professions.slice(0,-1).includes(currentProf) ? (currentProf.replace(/"/g,'&quot;')) : ''}">
                    </div>
                    <p class="text-[11px] font-bold text-white/60 mb-2 mt-4">Oylik daromad (slider orqali)</p>
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-[10px] text-white/40">0</span>
                        <span id="profile-edit-salary-label" class="text-sm font-black text-primary bg-primary/10 border border-primary/30 px-3 py-1.5 rounded-xl">${salVal ? '$'+salVal : 'Ko\'rsatmaslik'}</span>
                        <span class="text-[10px] text-white/40">$5000+</span>
                    </div>
                    <div class="relative pt-2 pb-4" id="profile-edit-salary-slider-container">
                        <div class="relative h-2 bg-white/10 rounded-full">
                            <div id="profile-edit-salary-range" class="absolute h-2 bg-primary rounded-full left-0" style="width: ${(salVal/5000*100)}%"></div>
                            <div id="profile-edit-salary-thumb" class="salary-slider-thumb absolute" style="left: ${(salVal/5000*100)}%" data-type="single"></div>
                        </div>
                    </div>
                    <input type="hidden" name="salary" id="profile-edit-salary-input" value="${salVal ? (salVal + '$') : ''}">
                    <p class="text-[11px] font-bold text-white/60 mb-2 mt-4">Ishlaysizmi?</p>
                    <div class="flex gap-3">
                        <label class="flex-1 flex items-center justify-between p-4 rounded-2xl border cursor-pointer transition-all ${p.is_working === true ? 'border-primary bg-primary/10' : 'border-white/10 bg-white/5'}"><span>Ha</span><input type="radio" name="is_working" value="true" ${p.is_working === true ? 'checked' : ''} class="hidden"></label>
                        <label class="flex-1 flex items-center justify-between p-4 rounded-2xl border cursor-pointer transition-all ${p.is_working === false ? 'border-primary bg-primary/10' : 'border-white/10 bg-white/5'}"><span>Yo'q</span><input type="radio" name="is_working" value="false" ${p.is_working === false ? 'checked' : ''} class="hidden"></label>
                    </div>
                `;
                document.querySelectorAll('#profile-edit-professions .profile-edit-profession').forEach(function(btn) {
                    btn.addEventListener('click', function() {
                        var v = this.getAttribute('data-value');
                        document.querySelectorAll('#profile-edit-professions .profile-edit-profession').forEach(function(b){ b.classList.remove('bg-primary','text-black'); b.classList.add('bg-white/[0.05]','border','border-white/[0.1]','text-white/70'); });
                        this.classList.remove('bg-white/[0.05]','border','border-white/[0.1]','text-white/70'); this.classList.add('bg-primary','text-black');
                        document.getElementById('profile-edit-profession-input').value = v;
                        var wrap = document.getElementById('profile-edit-boshqa-profession-wrap');
                        if (wrap) wrap.classList.toggle('hidden', v !== 'Boshqa');
                    });
                });
                var boshqaText = document.getElementById('profile-edit-boshqa-profession-text');
                if (boshqaText) boshqaText.addEventListener('input', function() { document.getElementById('profile-edit-profession-input').value = this.value || 'Boshqa'; });
                (function initProfileSalarySlider() {
                    var container = document.getElementById('profile-edit-salary-slider-container');
                    var track = container && container.querySelector('.bg-white\\/10');
                    var thumb = document.getElementById('profile-edit-salary-thumb');
                    var range = document.getElementById('profile-edit-salary-range');
                    var input = document.getElementById('profile-edit-salary-input');
                    var label = document.getElementById('profile-edit-salary-label');
                    if (!track || !thumb || !input) return;
                    var val = Math.min(5000, Math.max(0, parseInt(input.value, 10) || 0));
                    function percentToVal(pct) { return Math.round((pct / 100) * 5000 / 100) * 100; }
                    function update() {
                        var pct = (val / 5000) * 100;
                        thumb.style.left = pct + '%';
                        if (range) range.style.width = pct + '%';
                        input.value = val ? (val + '$') : '';
                        if (label) label.textContent = val ? '$' + val : 'Ko\'rsatmaslik';
                    }
                    function onMove(e) {
                        var rect = track.getBoundingClientRect();
                        var clientX = e.touches ? e.touches[0].clientX : e.clientX;
                        var pct = Math.max(0, Math.min(100, ((clientX - rect.left) / rect.width) * 100));
                        val = percentToVal(pct);
                        update();
                        if (typeof hapticFeedback === 'function') hapticFeedback('light');
                    }
                    function onEnd() { isDrag = false; }
                    var isDrag = false;
                    thumb.addEventListener('mousedown', function(e) { e.preventDefault(); isDrag = true; });
                    thumb.addEventListener('touchstart', function(e) { isDrag = true; }, { passive: false });
                    document.addEventListener('mousemove', function(e) { if (isDrag) onMove(e); });
                    document.addEventListener('touchmove', function(e) { if (isDrag) onMove(e); }, { passive: false });
                    document.addEventListener('mouseup', onEnd);
                    document.addEventListener('touchend', onEnd);
                    update();
                })();
            } else if (section === 'juftga') {
                const ageOpts = Array.from({length: 50}, (_, i) => 18 + i);
                const partnerLocs = Array.isArray(p.partner_locations) ? p.partner_locations : (p.partner_country && p.partner_region ? [{ c: p.partner_country, r: [p.partner_region] }] : []);
                const allCountriesChecked = partnerLocs.some(function(x) { return x.all_countries === true; });
                window._juftgaPartnerLocations = allCountriesChecked ? [] : partnerLocs;
                const countryFlags = { "O'zbekiston":"🇺🇿","Qozog'iston":"🇰🇿","Qirg'iziston":"🇰🇬","Tojikiston":"🇹🇯","Turkmaniston":"🇹🇲","Rossiya":"🇷🇺","Turkiya":"🇹🇷","Ozarbayjon":"🇦🇿","Gruziya":"🇬🇪","Armaniston":"🇦🇲","Afg'oniston":"🇦🇫","Pokiston":"🇵🇰","Hindiston":"🇮🇳","Bangladesh":"🇧🇩","Malayziya":"🇲🇾","Indoneziya":"🇮🇩","Tailand":"🇹🇭","Vyetnam":"🇻🇳","Filippin":"🇵🇭","Singapur":"🇸🇬","Saudiya Arabistoni":"🇸🇦","BAA":"🇦🇪","Quvayt":"🇰🇼","Qatar":"🇶🇦","Iroq":"🇮🇶","Eron":"🇮🇷","Misr":"🇪🇬","Germaniya":"🇩🇪","Fransiya":"🇫🇷","Buyuk Britaniya":"🇬🇧","Italiya":"🇮🇹","Ispaniya":"🇪🇸","Polsha":"🇵🇱","Ukraina":"🇺🇦","AQSH":"🇺🇸","Kanada":"🇨🇦","Xitoy":"🇨🇳","Yaponiya":"🇯🇵","Janubiy Koreya":"🇰🇷","Avstraliya":"🇦🇺" };
                const locationListHtml = countryList.map(function(c) {
                    const flag = countryFlags[c] || '🌐';
                    const isFirst = c === "O'zbekiston";
                    return '<div class="juftga-location-country-block bg-white/[0.03] border border-white/[0.05] rounded-2xl overflow-hidden" data-country-name="' + c.replace(/"/g, '&quot;') + '">' +
                        '<button type="button" class="juftga-location-header w-full flex items-center justify-between p-4 ' + (isFirst ? 'border-b border-white/[0.04]' : '') + ' text-left active:bg-white/[0.05] transition-colors">' +
                        '<div class="flex items-center gap-3"><span class="text-xl">' + flag + '</span><span class="font-bold text-white/80 text-sm">' + c + '</span></div>' +
                        '<span class="material-symbols-outlined text-white/20 juftga-location-chevron text-[20px]">chevron_right</span></button>' +
                        '<div class="juftga-location-cities hidden px-4 py-3 space-y-3 bg-white/[0.01]"></div></div>';
                }).join('');
                body.innerHTML = `
                    <label class="block text-[11px] font-bold text-white/60 mb-2">Yosh oralig'i (min)</label>
                    <select name="partner_age_min" class="w-full glass-card rounded-2xl px-4 py-3 text-white border border-white/10 bg-white/5 mb-4">${ageOpts.map(a => `<option value="${a}" ${(p.partner_age_min == a) ? 'selected' : ''}>${a} yosh</option>`).join('')}</select>
                    <label class="block text-[11px] font-bold text-white/60 mb-2">Yosh oralig'i (max)</label>
                    <select name="partner_age_max" class="w-full glass-card rounded-2xl px-4 py-3 text-white border border-white/10 bg-white/5 mb-4">${ageOpts.map(a => `<option value="${a}" ${(p.partner_age_max == a) ? 'selected' : ''}>${a} yosh</option>`).join('')}</select>
                    <label class="block text-[11px] font-bold text-white/60 mb-2 mt-4">Joylashuv (bir nechta tanlash mumkin)</label>
                    <label id="juftga-all-countries-wrap" class="flex items-center justify-between p-4 rounded-2xl border cursor-pointer transition-all mb-3 ${allCountriesChecked ? 'border-primary bg-primary/10' : 'border-white/10 bg-white/5'}">
                        <span class="font-medium text-white/90">Barcha davlatlar (joylashuv farqi yo'q)</span>
                        <input type="checkbox" id="juftga-all-countries-cb" class="custom-checkbox" ${allCountriesChecked ? ' checked' : ''}>
                    </label>
                    <div id="juftga-location-list-wrap" class="${allCountriesChecked ? 'hidden' : ''}">
                    <input id="juftga-location-search" type="text" placeholder="Mamlakatni qidirish..." class="w-full glass-card rounded-2xl px-4 py-3 text-white border border-white/10 bg-white/5 mb-3 text-sm">
                    <div id="juftga-location-list" class="space-y-2 max-h-[220px] overflow-y-auto ios-scroll-hide">${locationListHtml}</div>
                    </div>
                    <label class="block text-[11px] font-bold text-white/60 mb-2 mt-4">Diniy daraja</label>
                    <div class="space-y-2 mb-4">
                        ${['Jiddiy','O\'rtacha','Yengil'].map(v => `<label class="flex items-center justify-between p-4 rounded-2xl border cursor-pointer transition-all ${(p.partner_religious_level === v) ? 'border-primary bg-primary/10' : 'border-white/10 bg-white/5'}"><span>${v}</span><input type="radio" name="partner_religious_level" value="${v}" ${(p.partner_religious_level === v) ? 'checked' : ''} class="hidden"></label>`).join('')}
                    </div>
                    <label class="block text-[11px] font-bold text-white/60 mb-2">Oilaviy holati</label>
                    <div class="space-y-2">
                        ${['Bo\'ydoq','Oilali','Ajrashgan'].map(v => `<label class="flex items-center justify-between p-4 rounded-2xl border cursor-pointer transition-all ${(p.partner_marital_status === v) ? 'border-primary bg-primary/10' : 'border-white/10 bg-white/5'}"><span>${v}</span><input type="radio" name="partner_marital_status" value="${v}" ${(p.partner_marital_status === v) ? 'checked' : ''} class="hidden"></label>`).join('')}
                    </div>
                `;
                const allCountriesCb = document.getElementById('juftga-all-countries-cb');
                const allCountriesWrap = document.getElementById('juftga-all-countries-wrap');
                const locationListWrap = document.getElementById('juftga-location-list-wrap');
                if (allCountriesCb && locationListWrap) {
                    allCountriesCb.addEventListener('change', function() {
                        if (this.checked) {
                            locationListWrap.classList.add('hidden');
                            if (allCountriesWrap) { allCountriesWrap.classList.add('border-primary', 'bg-primary/10'); allCountriesWrap.classList.remove('border-white/10', 'bg-white/5'); }
                        } else {
                            locationListWrap.classList.remove('hidden');
                            if (allCountriesWrap) { allCountriesWrap.classList.remove('border-primary', 'bg-primary/10'); allCountriesWrap.classList.add('border-white/10', 'bg-white/5'); }
                        }
                    });
                    if (allCountriesWrap) allCountriesWrap.addEventListener('click', function() {
                        setTimeout(function() {
                            if (allCountriesCb.checked) {
                                locationListWrap.classList.add('hidden');
                                allCountriesWrap.classList.add('border-primary', 'bg-primary/10'); allCountriesWrap.classList.remove('border-white/10', 'bg-white/5');
                            } else {
                                locationListWrap.classList.remove('hidden');
                                allCountriesWrap.classList.remove('border-primary', 'bg-primary/10'); allCountriesWrap.classList.add('border-white/10', 'bg-white/5');
                            }
                        }, 0);
                    });
                }
                const juftgaSearch = document.getElementById('juftga-location-search');
                if (juftgaSearch) juftgaSearch.addEventListener('input', function() {
                    const q = (this.value || '').trim().toLowerCase();
                    document.querySelectorAll('#juftga-location-list .juftga-location-country-block').forEach(block => {
                        const name = (block.getAttribute('data-country-name') || '').toLowerCase();
                        block.style.display = (q === '' || name.includes(q)) ? '' : 'none';
                    });
                });
                document.querySelectorAll('#juftga-location-list .juftga-location-header').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const block = this.closest('.juftga-location-country-block');
                        const citiesEl = block && block.querySelector('.juftga-location-cities');
                        const chevron = this.querySelector('.juftga-location-chevron');
                        if (!citiesEl) return;
                        const isHidden = citiesEl.classList.contains('hidden');
                        if (isHidden) {
                            citiesEl.classList.remove('hidden');
                            if (chevron) { chevron.classList.remove('text-white/20'); chevron.classList.add('text-primary'); chevron.style.transform = 'rotate(90deg)'; }
                            if (citiesEl.children.length === 0) {
                                const countryName = block.getAttribute('data-country-name');
                                const cities = LOCATION_COUNTRIES_REGIONS[countryName] || [];
                                const locEntry = (window._juftgaPartnerLocations || []).find(function(x) { return (x.c || x.country) === countryName; });
                                const wholeChecked = locEntry && (locEntry.all === true || locEntry.whole === true);
                                const selectedRegions = (locEntry && locEntry.r) ? (locEntry.r || []) : [];
                                const wholeWrap = document.createElement('label');
                                wholeWrap.className = 'flex items-center justify-between group cursor-pointer';
                                wholeWrap.innerHTML = '<span class="text-sm font-medium text-white/80">Butun mamlakat</span><input type="checkbox" class="juftga-whole-country-cb custom-checkbox" data-country="' + countryName.replace(/"/g, '&quot;') + '"' + (wholeChecked ? ' checked' : '') + '>';
                                citiesEl.appendChild(wholeWrap);
                                cities.forEach(function(city) {
                                    const label = document.createElement('label');
                                    label.className = 'flex items-center justify-between group cursor-pointer';
                                    const checked = wholeChecked || selectedRegions.indexOf(city) !== -1;
                                    label.innerHTML = '<span class="text-sm font-medium text-white/80 group-active:text-white">' + city + '</span><input type="checkbox" class="juftga-location-city-cb custom-checkbox" value="' + city.replace(/"/g, '&quot;') + '" data-country="' + countryName.replace(/"/g, '&quot;') + '"' + (checked ? ' checked' : '') + '>';
                                    citiesEl.appendChild(label);
                                });
                                var wholeCb = wholeWrap.querySelector('.juftga-whole-country-cb');
                                if (wholeCb) wholeCb.addEventListener('change', function() {
                                    block.querySelectorAll('.juftga-location-city-cb').forEach(function(cb) { cb.checked = wholeCb.checked; });
                                });
                            }
                        } else {
                            citiesEl.classList.add('hidden');
                            if (chevron) { chevron.classList.add('text-white/20'); chevron.classList.remove('text-primary'); chevron.style.transform = ''; }
                        }
                    });
                });
            } else if (section === 'bio') {
                body.innerHTML = `
                    <label class="block text-[11px] font-bold text-white/60 mb-2">O'zingiz haqingizda (qisqacha)</label>
                    <textarea name="bio" rows="5" placeholder="O'zingiz haqingizda yozing..." class="w-full glass-card rounded-2xl px-4 py-3 text-white border border-white/10 bg-white/5 resize-none">${(p.bio || '').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</textarea>
                `;
            }
            body.querySelectorAll('input[type=radio]').forEach(radio => {
                radio.addEventListener('change', function() {
                    body.querySelectorAll('label').forEach(l => l.classList.remove('border-primary', 'bg-primary/10'));
                    body.querySelectorAll('input[type=radio]:checked').forEach(r => r.closest('label')?.classList.add('border-primary', 'bg-primary/10'));
                });
            });
        }

        function closeProfileEditSheet() {
            const sheet = document.getElementById('profile-edit-sheet');
            const overlay = document.getElementById('profile-edit-sheet-overlay');
            const content = document.getElementById('profile-edit-sheet-content');
            const saveBtn = document.getElementById('profile-edit-sheet-save');
            if (sheet) sheet.classList.add('pointer-events-none');
            if (overlay) { overlay.classList.remove('opacity-100'); overlay.classList.add('pointer-events-none'); }
            if (content) content.classList.add('translate-y-full');
            if (saveBtn) saveBtn.classList.remove('hidden');
            currentProfileEditSection = null;
            _sheetDataSource = null;
        }

        function collectShaxsiyStepToDraft() {
            const body = document.getElementById('profile-edit-sheet-body');
            if (!body) return;
            window.newListingDraft = window.newListingDraft || {};
            body.querySelectorAll('input, select, textarea').forEach(el => {
                if (el.name && (el.type !== 'radio' || el.checked)) window.newListingDraft[el.name] = el.value;
            });
        }

        window.addListingShaxsiyNext = function() {
            collectShaxsiyStepToDraft();
            addListingShaxsiyStep++;
            openProfileEditSheet('shaxsiy', window.newListingDraft, addListingShaxsiyStep);
        };

        window.addListingShaxsiyBack = function() {
            addListingShaxsiyStep--;
            openProfileEditSheet('shaxsiy', window.newListingDraft, addListingShaxsiyStep);
        };

        window.addListingShaxsiySave = function() {
            collectShaxsiyStepToDraft();
            updateAddListingSummaries();
            closeProfileEditSheet();
        };

        function buildPartnerLocationsFromSheet() {
            const allCb = document.getElementById('juftga-all-countries-cb');
            if (allCb && allCb.checked) return [{ all_countries: true }];
            const list = document.getElementById('juftga-location-list');
            if (!list) return [];
            const out = [];
            list.querySelectorAll('.juftga-location-country-block').forEach(block => {
                const country = block.getAttribute('data-country-name');
                if (!country) return;
                const wholeCb = block.querySelector('.juftga-whole-country-cb');
                if (wholeCb && wholeCb.checked) {
                    out.push({ c: country, all: true });
                    return;
                }
                const checked = block.querySelectorAll('.juftga-location-city-cb:checked');
                const regions = Array.from(checked).map(cb => cb.value).filter(Boolean);
                if (regions.length) out.push({ c: country, r: regions });
            });
            return out;
        }

        async function saveProfileEditSheet() {
            if (!currentProfileEditSection) return;
            const body = document.getElementById('profile-edit-sheet-body');
            if (!body) return;
            if (currentProfileEditSection === 'jismoniy') {
                var hi = document.getElementById('profile-edit-height-input');
                var wi = document.getElementById('profile-edit-weight-input');
                if (hi && typeof getIosDialValue === 'function') { var v = getIosDialValue('profile-edit-dial-height'); if (v != null) hi.value = v; }
                if (wi && typeof getIosDialValue === 'function') { var v = getIosDialValue('profile-edit-dial-weight'); if (v != null) wi.value = v; }
            }
            if (currentProfileEditSection === 'ish') {
                var profInput = document.getElementById('profile-edit-profession-input');
                var boshqaText = document.getElementById('profile-edit-boshqa-profession-text');
                if (profInput && boshqaText && profInput.value === 'Boshqa') profInput.value = (boshqaText.value || '').trim() || 'Boshqa';
            }
            const formData = new FormData();
            body.querySelectorAll('input, select, textarea').forEach(el => {
                if (el.name && (el.type !== 'radio' || el.checked)) formData.append(el.name, el.value);
            });
            if (currentProfileEditSection === 'juftga') {
                const ploc = buildPartnerLocationsFromSheet();
                formData.set('partner_locations', JSON.stringify(ploc));
            }
            if (_sheetDataSource) {
                formData.forEach((val, key) => { _sheetDataSource[key] = val; });
                if (currentProfileEditSection === 'juftga') _sheetDataSource.partner_locations = JSON.stringify(buildPartnerLocationsFromSheet());
                _sheetDataSource = null;
                updateAddListingSummaries();
                closeProfileEditSheet();
                return;
            }
            const btn = document.getElementById('profile-edit-sheet-save');
            if (btn) { btn.disabled = true; btn.textContent = 'Saqlanmoqda...'; }
            try {
                const response = await fetch('/profile/edit', { method: 'POST', body: formData, credentials: 'same-origin' });
                const data = await response.json();
                if (response.ok && data.success) {
                    if (typeof window.showNotification === 'function') window.showNotification('✅ Saqlandi');
                await initUserData();
                    updateProfileEditSummaries();
                    if (pageDataLoaded.profile) updateProfileUI();
                    closeProfileEditSheet();
                } else {
                    alert(data.message || 'Xatolik');
                }
            } catch (e) {
                alert('Xatolik yuz berdi');
            } finally {
                if (btn) { btn.disabled = false; btn.textContent = 'Saqlash'; }
            }
        }

        function isAddListingSectionFilled(section, d) {
            switch (section) {
                case 'shaxsiy': return !!(d.name && (d.name || '').trim() && d.gender && d.birth_year);
                case 'diniy': return !!(d.prays && d.fasts && d.religious_level);
                case 'joylashuv': return !!(d.country && d.region && d.nationality);
                case 'oilaviy': return !!(d.marital_status && (d.marital_status || '').trim());
                case 'jismoniy': return d.height != null && d.height !== '' && d.weight != null && d.weight !== '';
                case 'talim': return !!(d.education && (d.education || '').trim());
                case 'ish': return !!(d.profession && (d.profession || '').trim() && (d.is_working === true || d.is_working === 'true' || d.is_working === false || d.is_working === 'false'));
                case 'juftga': return !!(d.partner_age_min != null && d.partner_age_max != null && (function(){ try { const locs = typeof d.partner_locations === 'string' ? JSON.parse(d.partner_locations) : d.partner_locations; if (Array.isArray(locs) && locs.length > 0) return true; } catch(e){} return !!(d.partner_country && d.partner_region); })() && d.partner_religious_level && d.partner_marital_status);
                case 'bio': return !!((d.bio || '').trim());
                default: return false;
            }
        }

        function validateAddListingFull(d) {
            var msg = [];
            if (!(d.name || '').trim() || !d.gender || !d.birth_year) msg.push('Ism, jins, yosh');
            if (!d.country || !d.region || !d.nationality) msg.push('Joylashuv');
            if (!d.prays || !d.fasts || !d.religious_level) msg.push('Diniy');
            if (!(d.marital_status || '').trim()) msg.push('Oilaviy holati');
            if (d.height == null || d.height === '' || d.weight == null || d.weight === '') msg.push('Jismoniy (bo\'y, vazn)');
            if (!(d.education || '').trim()) msg.push('Ta\'lim');
            if (!(d.profession || '').trim()) msg.push('Ish & Kasb');
            if (d.is_working !== true && d.is_working !== 'true' && d.is_working !== false && d.is_working !== 'false') msg.push('Ish & Kasb (ishlaymanmi)');
            var juftgaLocOk = false;
            try { var jl = typeof d.partner_locations === 'string' ? JSON.parse(d.partner_locations) : d.partner_locations; juftgaLocOk = Array.isArray(jl) && jl.length > 0; } catch(e) {}
            if (!juftgaLocOk && !(d.partner_country || '').trim()) juftgaLocOk = false; else if (!juftgaLocOk) juftgaLocOk = !!(d.partner_country && d.partner_region);
            if (d.partner_age_min == null || d.partner_age_max == null || !juftgaLocOk || !(d.partner_religious_level || '').trim() || !(d.partner_marital_status || '').trim()) msg.push('Juftga talablari');
            if (!(d.bio || '').trim()) msg.push('O\'zim haqimda');
            if (msg.length === 0) return { ok: true };
            return { ok: false, message: 'Quyidagi bo\'limlarni to\'ldiring: ' + msg.join(', ') };
        }

        function updateAddListingSummaries() {
            const d = window.newListingDraft || {};
            const el = (id, text) => { const e = document.getElementById(id); if (e) e.textContent = text || 'Belgilanmagan'; };
            el('add-listing-avatar', d.name ? d.name[0] : null);
            el('add-listing-name', d.name || '—');
            el('add-listing-region', d.region || '—');
            el('add-listing-shaxsiy-summary', d.name ? `${d.name}, ${d.gender || ''}, ${d.birth_year ? d.birth_year + ' yosh' : ''}`.replace(/,\s*,/g, ',').replace(/^,\s*|,\s*$/g, '') : null);
            el('add-listing-diniy-summary', d.prays ? `${d.prays}, ${d.mazhab || ''}`.replace(/,\s*$/g, '') : null);
            el('add-listing-joylashuv-summary', [d.country, d.region, d.nationality].filter(Boolean).join(', ') || 'Belgilanmagan');
            el('add-listing-oilaviy-summary', d.marital_status || null);
            el('add-listing-jismoniy-summary', [d.height && (d.height + ' sm'), d.weight && (d.weight + ' kg'), d.smoking, (d.sport_days != null && d.sport_days >= 1) ? ('Sport: ' + d.sport_days + ' kun') : null].filter(Boolean).join(', ') || null);
            el('add-listing-talim-summary', d.education || null);
            el('add-listing-ish-summary', (d.profession ? (d.profession + (d.is_working === 'true' ? ', Ishlaman' : '') + (d.salary ? ' · ' + d.salary : '')) : null) || 'Belgilanmagan');
            var juftgaLocSummary = null;
            try {
                var jl = typeof d.partner_locations === 'string' ? JSON.parse(d.partner_locations) : d.partner_locations;
                if (Array.isArray(jl) && jl.length) juftgaLocSummary = jl.map(function(x){ return x.all ? (x.c || x.country) + ': butun' : (x.c || x.country) + ': ' + (x.r || []).length + ' joy'; }).join('; ');
            } catch(e) {}
            if (!juftgaLocSummary && (d.partner_country || d.partner_region)) juftgaLocSummary = (d.partner_country || '') + (d.partner_region ? ': ' + d.partner_region : '');
            el('add-listing-juftga-summary', [d.partner_age_min != null || d.partner_age_max != null ? (d.partner_age_min ?? '?') + '-' + (d.partner_age_max ?? '?') + ' yosh' : null, juftgaLocSummary].filter(Boolean).join(', ') || null);
            const bioEl = document.getElementById('add-listing-bio-summary');
            if (bioEl) { bioEl.textContent = (d.bio || '').trim() ? (d.bio.slice(0, 40) + (d.bio.length > 40 ? '…' : '')) : 'Belgilanmagan'; bioEl.classList.toggle('italic', !d.bio); }
            document.querySelectorAll('.add-listing-section-btn').forEach(function(btn) {
                var section = btn.getAttribute('data-section');
                var filled = section && isAddListingSectionFilled(section, d);
                if (filled) {
                    btn.classList.add('border-primary', 'bg-primary/5');
                    btn.classList.remove('border-white/10');
                    var icon = btn.querySelector('.add-listing-section-icon');
                    if (icon) { icon.classList.add('bg-primary/10', 'text-primary', 'border-primary/30'); icon.classList.remove('bg-white/5', 'text-white/60', 'border-white/10'); }
                    var sum = btn.querySelector('p[id^="add-listing-"][id$="-summary"]');
                    if (sum) { sum.classList.add('text-primary/80'); sum.classList.remove('text-white/50'); }
                    var chevron = btn.querySelector('.material-symbols-outlined:last-of-type');
                    if (chevron) { chevron.classList.add('text-primary'); chevron.classList.remove('text-white/30'); }
                } else {
                    btn.classList.remove('border-primary', 'bg-primary/5');
                    btn.classList.add('border-white/10');
                    var icon = btn.querySelector('.add-listing-section-icon');
                    if (icon) { icon.classList.remove('bg-primary/10', 'text-primary', 'border-primary/30'); icon.classList.add('bg-white/5', 'text-white/60', 'border-white/10'); }
                    var sum = btn.querySelector('p[id^="add-listing-"][id$="-summary"]');
                    if (sum) { sum.classList.remove('text-primary/80'); sum.classList.add('text-white/50'); }
                    var chevron = btn.querySelector('.material-symbols-outlined:last-of-type');
                    if (chevron) { chevron.classList.remove('text-primary'); chevron.classList.add('text-white/30'); }
                }
            });
        }


        document.getElementById('profile-edit-sheet-overlay')?.addEventListener('click', closeProfileEditSheet);

        function updateProfileUI() {
            if (!userData) return;
            
            const avatar = document.getElementById('profile-avatar');
            const name = document.getElementById('profile-name');
            const telegramId = document.getElementById('profile-telegram-id');
            const views = document.getElementById('profile-views');
            const likes = document.getElementById('profile-likes');
            const requests = document.getElementById('profile-requests');
            const topBtn = document.getElementById('profile-top-btn');
            
            const profile = userData.profile || {};
            const user = userData.user || {};
            const tariffInfo = userData.tariff?.tariff || null;
            
            if (avatar) avatar.textContent = profile.name?.[0] || '?';
            if (name) name.textContent = profile.name || 'Foydalanuvchi';
            if (telegramId) telegramId.textContent = `#${user.telegram_id || '0'}`;
            if (views) views.textContent = profile.views || 0;
            if (likes) likes.textContent = profile.likes || 0;
            if (requests) requests.textContent = user.sent_requests_count || 0;
            
            if (topBtn) {
                const icon = topBtn.querySelector('.material-symbols-outlined');
                const textSpan = topBtn.querySelector('span:last-child');
                const hasTopActive = !!(tariffInfo && tariffInfo.is_top);
                if (hasActiveTariff) {
                    topBtn.classList.remove('hidden');
                    if (icon) icon.textContent = hasTopActive ? 'campaign' : 'rocket_launch';
                    if (textSpan) textSpan.textContent = hasTopActive ? `Reklama (${tariffInfo.days_remaining || 0} kun)` : 'TOP';
                } else {
                    topBtn.classList.add('hidden');
                }
            }

            // To'liq profil to'ldirish tugmasi (so'rov yuborish va e'lon joylash uchun)
            const fullProfileBtn = document.getElementById('profile-full-profile-btn');
            if (fullProfileBtn) {
                if (user && !user.profile_complete) {
                    fullProfileBtn.classList.remove('hidden');
                    fullProfileBtn.style.display = '';
                } else {
                    fullProfileBtn.classList.add('hidden');
                    fullProfileBtn.style.display = 'none';
                }
            }
        }

        window.startNewListing = function() {
            window.newListingDraft = {};
            window.currentEditingListingId = null;
            document.getElementById('add-listing-delete-section')?.classList.add('hidden');
            updateAddListingSummaries();
            window.showPage('add-listing');
        };

        window.showNewListingInfoModal = function() {
            if (!userData) return;
            var user = userData.user || {};
            var profileComplete = user.profile_complete;
            if (!profileComplete || !hasActiveTariff) {
                document.getElementById('require-full-profile-modal').classList.remove('hidden');
                return;
            }
            document.getElementById('new-listing-info-modal').classList.remove('hidden');
        };

        async function loadProfileListings() {
            const listEl = document.getElementById('profile-listings-list');
            const rowEl = document.getElementById('profile-listings-row');
            const toPageLink = document.getElementById('profile-listings-to-page-link');
            const addWrap = document.getElementById('profile-add-listing-wrap');
            const addBtn = document.getElementById('profile-add-listing-btn');
            if (!listEl || !rowEl) return;
            rowEl.innerHTML = '';
            listEl.innerHTML = '';
            listEl.classList.add('hidden');
            toPageLink.classList.add('hidden');
            if (addBtn && addWrap && !addWrap.contains(addBtn)) addWrap.appendChild(addBtn);
            try {
                const r = await fetch('/profile/api/listings', { method: 'GET', headers: { 'X-Requested-With': 'XMLHttpRequest' }, credentials: 'same-origin' });
                if (!r.ok) {
                    rowEl.innerHTML = '<p class="text-white/50 text-sm">E\'lonlar yuklanmadi.</p>';
                    return;
                }
                const data = await r.json();
                const profiles = data.profiles || data.listings || [];
                if (profiles.length === 0) {
                    return;
                }
                if (profiles.length === 1) {
                    var p = profiles[0];
                    var name = p.name || 'E\'lon';
                    var isPrimary = p.is_primary;
                    var isPublished = p.is_published !== false;
                    var card = document.createElement('div');
                    card.className = 'glass-card rounded-2xl p-3 flex-1 min-w-0 flex items-center justify-between gap-2';
                    card.innerHTML = '<div class="min-w-0 flex-1 flex items-center gap-2"><p class="text-sm font-bold text-white truncate">' + name + '</p></div>' +
                        (!isPrimary ? '<label class="relative inline-flex items-center cursor-pointer shrink-0"><input type="checkbox" class="sr-only peer" ' + (isPublished ? 'checked' : '') + ' onchange="window.toggleListingPublish(' + p.id + ', this.checked)"><div class="toggle-pill bg-white/10"><div class="toggle-circle"></div></div></label>' : '') +
                        '<button type="button" onclick="window.editListing(' + p.id + ')" class="size-8 rounded-lg flex items-center justify-center text-white/40 hover:text-white hover:bg-white/10 shrink-0"><span class="material-symbols-outlined text-[18px]">edit</span></button>';
                    rowEl.appendChild(card);
                    if (addBtn && addWrap && addWrap.contains(addBtn)) { addWrap.removeChild(addBtn); rowEl.appendChild(addBtn); }
                    return;
                }
                toPageLink.classList.remove('hidden');
                toPageLink.textContent = 'Barchasi (' + profiles.length + ') →';
            } catch (e) {
                console.warn('Profile listings load error', e);
                rowEl.innerHTML = '<p class="text-white/50 text-sm">E\'lonlar yuklanmadi.</p>';
            }
        }

        async function loadListingsPageData() {
            const listEl = document.getElementById('listings-page-list');
            if (!listEl) return;
            listEl.innerHTML = '<p class="text-white/50 text-center py-4 text-sm">Yuklanmoqda...</p>';
            try {
                const r = await fetch('/profile/api/listings', { method: 'GET', headers: { 'X-Requested-With': 'XMLHttpRequest' }, credentials: 'same-origin' });
                if (!r.ok) {
                    listEl.innerHTML = '<p class="text-white/50 text-center py-4 text-sm">E\'lonlar yuklanmadi.</p>';
                    return;
                }
                const data = await r.json();
                const profiles = data.profiles || data.listings || [];
                listEl.innerHTML = '';
                profiles.forEach(p => {
                    const name = p.name || 'E\'lon';
                    const isPrimary = p.is_primary;
                    const isPublished = p.is_published !== false;
                    const div = document.createElement('div');
                    div.className = 'glass-card rounded-2xl p-4';
                    div.innerHTML = '<div class="flex items-center justify-between"><div class="flex items-center gap-3 flex-1 min-w-0" onclick="window.editListing(' + p.id + ')"><div class="size-10 rounded-xl ' + (isPublished ? 'bg-primary/10 text-primary' : 'bg-white/5 text-white/40') + ' flex items-center justify-center shrink-0"><span class="material-symbols-outlined text-[22px]">' + (isPublished ? 'visibility' : 'visibility_off') + '</span></div><div class="min-w-0"><p class="text-sm font-bold text-white truncate">' + name + '</p><p class="text-[10px] text-white/40">' + (isPrimary ? 'Asosiy profil' : (isPublished ? 'E\'lon qilingan' : 'Qoralama')) + '</p></div></div><div class="flex items-center gap-2 shrink-0">' + '<label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" class="sr-only peer" ' + (isPublished ? 'checked' : '') + ' onchange="window.toggleListingPublish(' + p.id + ', this.checked)"><div class="toggle-pill bg-white/10"><div class="toggle-circle"></div></div></label>' + '<button type="button" onclick="window.editListing(' + p.id + ')" class="size-8 rounded-lg flex items-center justify-center text-white/40 hover:text-white hover:bg-white/10"><span class="material-symbols-outlined text-[20px]">edit</span></button></div></div>';
                    listEl.appendChild(div);
                });
                pageDataLoaded.listings = true;
            } catch (e) {
                console.warn('Listings page load error', e);
                listEl.innerHTML = '<p class="text-white/50 text-center py-4 text-sm">E\'lonlar yuklanmadi.</p>';
            }
        }

        window.toggleListingPublish = async function(listingId, publish) {
            try {
                const r = await fetch(`/profile/api/listings/${listingId}/publish`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
                    credentials: 'same-origin',
                    body: JSON.stringify({ publish: publish })
                });
                const data = await r.json();
                if (r.ok && data.success) {
                    loadProfileListings();
                    if (currentPage === 'listings' && typeof loadListingsPageData === 'function') loadListingsPageData();
                } else {
                    alert(data.message || data.error || 'Xatolik');
                    loadProfileListings();
                    if (currentPage === 'listings' && typeof loadListingsPageData === 'function') loadListingsPageData();
                }
            } catch (e) {
                alert('Xatolik yuz berdi');
                loadProfileListings();
                if (currentPage === 'listings' && typeof loadListingsPageData === 'function') loadListingsPageData();
            }
        };

        window.editListing = function(listingId) {
            window.currentEditingListingId = listingId;
            fetch(`/profile/api/listings/${listingId}`, { headers: { 'X-Requested-With': 'XMLHttpRequest' }, credentials: 'same-origin' })
                .then(r => r.json())
                .then(data => {
                    if (data.success && data.listing) {
                        window.newListingDraft = { ...data.listing };
                        document.getElementById('add-listing-delete-section')?.classList.remove('hidden');
                        updateAddListingSummaries();
                        window.showPage('add-listing');
                    }
                })
                .catch(e => alert('Xatolik yuz berdi'));
        };

        window.saveDraftListing = async function() {
            const d = window.newListingDraft || {};
            var v = validateAddListingFull(d);
            if (!v.ok) {
                alert(v.message);
                return;
            }
            const btn = document.getElementById('add-listing-draft-btn');
            if (btn) { btn.disabled = true; btn.innerHTML = '<span class="material-symbols-outlined text-[20px] align-middle mr-2 animate-spin">sync</span>Saqlanmoqda...'; }
            try {
                const listingId = window.currentEditingListingId;
                const url = listingId ? `/profile/api/listings/${listingId}` : '/profile/api/listings';
                const method = listingId ? 'PUT' : 'POST';
                const controller = new AbortController();
                const timeoutId = setTimeout(function() { controller.abort(); }, 20000);
                const r = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
                    credentials: 'same-origin',
                    body: JSON.stringify(buildListingPayload(d, false)),
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                var data = {};
                var contentType = r.headers.get('Content-Type') || '';
                if (contentType.indexOf('application/json') !== -1) {
                    try { data = await r.json(); } catch (je) { data = { error: 'Javob o\'qishda xatolik' }; }
                } else {
                    data = { error: 'Server noto\'g\'ri javob qaytardi.' };
                }
                if (r.ok && data.success) {
                    if (typeof window.showNotification === 'function') window.showNotification('✅ Qoralama saqlandi');
                    window.currentEditingListingId = data.listing_id || data.id || listingId;
                    document.getElementById('add-listing-delete-section')?.classList.remove('hidden');
                } else {
                    alert(data.message || data.error || 'Qoralama saqlanmadi.');
                }
            } catch (e) {
                if (e && e.name === 'AbortError') {
                    alert('Server javob bermadi. Qaytadan urinib ko\'ring.');
                } else {
                    alert('Xatolik yuz berdi');
                }
            } finally {
                if (btn) { btn.disabled = false; btn.innerHTML = '<span class="material-symbols-outlined text-[20px] align-middle mr-2">save</span>Qoralama saqlash'; }
            }
        };

        function buildListingPayload(d, isPublished) {
            var keys = ['name','gender','birth_year','country','region','nationality','marital_status','height','weight','smoking','sport_days','aqida','prays','fasts','quran_reading','mazhab','religious_level','education','profession','is_working','salary','partner_age_min','partner_age_max','partner_country','partner_region','partner_locations','partner_religious_level','partner_marital_status','bio'];
            var payload = { is_published: !!isPublished };
            keys.forEach(function(k) { if (d[k] !== undefined && d[k] !== null && d[k] !== '') payload[k] = d[k]; });
            if (d.is_working === true || d.is_working === false) payload.is_working = d.is_working;
            return payload;
        }

        window.publishNewListing = async function() {
            const d = window.newListingDraft || {};
            var v = validateAddListingFull(d);
            if (!v.ok) {
                alert(v.message);
                return;
            }
            const btn = document.getElementById('add-listing-publish-btn');
            if (btn) { btn.disabled = true; btn.innerHTML = '<span class="material-symbols-outlined text-[20px] align-middle mr-2 animate-spin">sync</span>E\'lon qilinmoqda...'; }
            try {
                const listingId = window.currentEditingListingId;
                const url = listingId ? `/profile/api/listings/${listingId}` : '/profile/api/listings';
                const method = listingId ? 'PUT' : 'POST';
                const controller = new AbortController();
                const timeoutId = setTimeout(function() { controller.abort(); }, 20000);
                const r = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
                    credentials: 'same-origin',
                    body: JSON.stringify(buildListingPayload(d, true)),
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                var data = {};
                var contentType = r.headers.get('Content-Type') || '';
                if (contentType.indexOf('application/json') !== -1) {
                    try { data = await r.json(); } catch (je) { data = { error: 'Javob o\'qishda xatolik' }; }
                } else {
                    data = { error: 'Server noto\'g\'ri javob qaytardi. Qaytadan urinib ko\'ring.' };
                }
                if (r.ok && data.success) {
                    if (typeof window.showNotification === 'function') window.showNotification('✅ E\'lon qilindi!');
                    window.newListingDraft = {};
                    window.currentEditingListingId = null;
                    window.showPage('profile');
                    loadProfileListings();
                } else {
                    alert(data.message || data.error || 'E\'lon saqlanmadi. Qaytadan urinib ko\'ring.');
                }
            } catch (e) {
                if (e && e.name === 'AbortError') {
                    alert('Server javob bermadi. Internetingizni tekshiring va qaytadan urinib ko\'ring.');
                } else {
                    alert('Xatolik: ' + (e && e.message ? e.message : 'E\'lon yuborilmadi. Qaytadan urinib ko\'ring.'));
                }
            } finally {
                if (btn) { btn.disabled = false; btn.innerHTML = '<span class="material-symbols-outlined text-[20px] align-middle mr-2">publish</span>E\'lon qilish'; }
            }
        };

        window.deleteCurrentListing = async function() {
            const listingId = window.currentEditingListingId;
            if (!listingId) {
                window.newListingDraft = {};
                updateAddListingSummaries();
                window.showPage('profile');
                return;
            }
            if (!confirm('Haqiqatan ham bu e\'lonni o\'chirmoqchimisiz?')) return;
            try {
                const r = await fetch(`/profile/api/listings/${listingId}`, {
                    method: 'DELETE',
                    headers: { 'X-Requested-With': 'XMLHttpRequest' },
                    credentials: 'same-origin'
                });
                const data = await r.json();
                if (r.ok && data.success) {
                    if (typeof window.showNotification === 'function') window.showNotification('E\'lon o\'chirildi');
                    window.newListingDraft = {};
                    window.currentEditingListingId = null;
                    window.showPage('profile');
                    loadProfileListings();
                } else {
                    alert(data.message || data.error || 'Xatolik');
                }
            } catch (e) {
                alert('Xatolik yuz berdi');
            }
        };

        
        // To'liq profil modalini yopish va profil sahifasiga o'tish (to'liq profil to'ldirish uchun)
        window.openFullProfileFromModal = function() {
            document.getElementById('require-full-profile-modal').classList.add('hidden');
            window.showPage('profile');
            if (userData && userData.user && !userData.user.profile_complete) {
                openOnboarding('full');
            }
        };
        
        // E'lon yaratish funksiyasi
        window.createAd = async function() {
            await initUserData();
            const profileComplete = userData && userData.user && userData.user.profile_complete;
            if (!profileComplete || !hasActiveTariff) {
                document.getElementById('require-full-profile-modal').classList.remove('hidden');
                return;
            }
            
            try {
                const response = await fetch('/profile/toggle-active', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin'
                });
                
                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.error || 'Xatolik yuz berdi');
                }
                
                const data = await response.json();
                
                if (data.success) {
                    if (typeof window.showNotification === 'function') {
                        window.showNotification('✅ ' + data.message);
                    } else {
                        alert('✅ ' + data.message);
                    }
                    // User data ni yangilash
                    await initUserData();
                    updateProfileUI();
                } else {
                    alert('Xatolik: ' + (data.error || 'Noma\'lum xatolik'));
                }
            } catch (error) {
                console.error('Error creating ad:', error);
                alert('Xatolik: ' + error.message);
            }
        }

        // Profile toggle event listener - use event delegation
        document.addEventListener('change', async (e) => {
            if (e.target.id === 'profile-toggle') {
                const toggle = e.target;
                await initUserData();
                const profileComplete = userData && userData.user && userData.user.profile_complete;
                if (toggle.checked && (!profileComplete || !hasActiveTariff)) {
                    document.getElementById('require-full-profile-modal').classList.remove('hidden');
                    toggle.checked = false;
                    return;
                }
                try {
                    const response = await fetch('/profile/toggle-active', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'}
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        await initUserData();
                        updateProfileUI();
                    } else {
                        alert(data.error || 'Xatolik yuz berdi');
                        toggle.checked = !toggle.checked;
                    }
                } catch (error) {
                    alert('Xatolik yuz berdi');
                    toggle.checked = !toggle.checked;
                }
            }
        });

        // Utility functions
        function formatTimeAgo(date) {
            if (!date || isNaN(date.getTime())) return 'hozir';
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 1) return 'hozir';
            if (minutes < 60) return `${minutes}min`;
            if (hours < 24) return `${hours}soat`;
            if (days < 7) return `${days}kun`;
            return date.toLocaleDateString('uz-UZ', { day: 'numeric', month: 'short' });
        }

        // Filter sahifalari funksiyalari
        let currentFilterSheet = null;
        const filterSheets = {};

        function openFilterSheet(sheetId) {
            document.querySelectorAll('.bottom-sheet').forEach(sheet => {
                sheet.classList.remove('active');
            });
            const overlay = document.getElementById('filter-overlay');
            if (overlay) overlay.style.display = 'block';
            const sheet = document.getElementById(sheetId);
            if (sheet) {
                sheet.classList.add('active');
                currentFilterSheet = sheetId;
            }
            if (sheetId === 'filter-sort-sheet') updateSortSheetUI(sortSheetContext === 'requests' ? requestsSort : feedSort);
            if (sheetId === 'filter-physical-sheet') {
                initScrollDials();
                document.querySelectorAll('#filter-physical-sheet .filter-smoking-btn').forEach(b => {
                    const v = b.getAttribute('data-value');
                    const active = (feedFilterSmoking || 'Yo\'q') === v;
                    b.classList.toggle('bg-primary', active); b.classList.toggle('text-black', active);
                    b.classList.toggle('bg-white/[0.05]', !active); b.classList.toggle('border', !active); b.classList.toggle('border-white/[0.08]', !active); b.classList.toggle('text-white/60', !active);
                });
                const sportDay = feedFilterSportDays != null ? feedFilterSportDays : 3;
                document.querySelectorAll('#filter-physical-sheet .filter-sport-bar').forEach(b => {
                    const d = parseInt(b.dataset.day);
                    b.classList.toggle('bg-primary', d <= sportDay);
                    b.classList.toggle('bg-white/10', d > sportDay);
                });
                const sportLabels = ['', 'Haftada 1 kun', 'Haftada 2 kun', 'Haftada 3 kun', 'Haftada 4 kun', 'Haftada 5 kun', 'Haftada 6 kun', 'Har kuni'];
                var sportLabelEl = document.getElementById('filter-sport-label');
                if (sportLabelEl) sportLabelEl.textContent = sportLabels[sportDay] || '';
            }
            if (sheetId === 'filter-work-sheet') {
                initSalarySlider();
            }
            if (sheetId === 'filter-family-sheet') {
                const cards = document.querySelectorAll('#filter-family-status-cards .filter-family-opt');
                cards.forEach(btn => {
                    const forG = btn.getAttribute('data-for-gender');
                    const show = forG === feedGender || forG === 'both';
                    btn.style.display = show ? '' : 'none';
                    const isSelected = (feedFilterMarital === btn.getAttribute('data-value'));
                    btn.classList.toggle('selected', isSelected);
                    btn.classList.toggle('border-primary/50', isSelected);
                    btn.classList.toggle('bg-primary/5', isSelected);
                    btn.classList.toggle('neon-glow', isSelected);
                    const icon = btn.querySelector('.material-symbols-outlined');
                    if (icon) icon.classList.toggle('text-primary', isSelected), icon.classList.toggle('text-white/40', !isSelected);
                    const span = btn.querySelector('.text-xs');
                    if (span) span.classList.toggle('text-primary', isSelected), span.classList.toggle('text-white/80', !isSelected);
                    let check = btn.querySelector('.absolute');
                    if (isSelected && !check) {
                        check = document.createElement('div');
                        check.className = 'absolute top-2 right-2';
                        check.innerHTML = '<span class="material-symbols-outlined text-[14px] text-primary">check_circle</span>';
                        btn.appendChild(check);
                    } else if (check) check.style.display = isSelected ? '' : 'none';
                });
                document.querySelectorAll('#filter-family-sheet .filter-family-children').forEach(b => {
                    const v = b.getAttribute('data-value');
                    const active = (feedFilterChildren || 'Bor') === v;
                    b.classList.toggle('bg-primary', active); b.classList.toggle('text-black', active);
                    b.classList.toggle('bg-white/[0.05]', !active); b.classList.toggle('text-white/60', !active);
                });
                document.querySelectorAll('#filter-family-sheet .filter-family-polygamy').forEach(b => {
                    const v = b.getAttribute('data-value');
                    const active = (feedFilterPolygamy || '1') === v;
                    b.classList.toggle('border-l-primary', active); b.classList.toggle('border-l-transparent', !active);
                    const span = b.querySelector('span:first-child');
                    if (span) { span.classList.toggle('text-primary', active); span.classList.toggle('text-white/60', !active); }
                    const icon = b.querySelector('.material-symbols-outlined');
                    if (icon) { icon.classList.toggle('text-primary', active); icon.classList.toggle('text-white/10', !active); icon.textContent = active ? 'check_circle' : 'circle'; }
                });
            }
            if (sheetId === 'filter-education-sheet') {
                document.querySelectorAll('#filter-education-sheet .filter-education-opt').forEach(b => {
                    const v = b.getAttribute('data-value');
                    const active = feedFilterEducation === v;
                    b.classList.toggle('filter-education-selected', active); b.classList.toggle('border-primary/40', active);
                    b.classList.toggle('border-white/[0.05]', !active);
                    const textSpan = b.querySelector('.text-sm');
                    if (textSpan) { textSpan.classList.toggle('text-white', active); textSpan.classList.toggle('text-white/60', !active); }
                    const icon = b.querySelector('.size-5');
                    if (icon) {
                        if (active) { icon.className = 'size-5 rounded-full bg-primary flex items-center justify-center'; icon.innerHTML = '<span class="material-symbols-outlined text-black text-[14px] font-bold">check</span>'; }
                        else { icon.className = 'size-5 rounded-full border-2 border-white/10'; icon.innerHTML = ''; }
                    }
                });
            }
            if (sheetId === 'filter-work-sheet') {
                initSalarySlider();
                document.querySelectorAll('#filter-work-sheet .filter-work-profession').forEach(b => {
                    const v = b.getAttribute('data-value');
                    const active = feedFilterProfession === v;
                    b.classList.toggle('bg-primary', active); b.classList.toggle('text-black', active); b.classList.toggle('shadow-[0_4px_15px_rgba(64,255,0,0.2)]', active);
                    b.classList.toggle('bg-white/[0.05]', !active); b.classList.toggle('border', !active); b.classList.toggle('border-white/[0.1]', !active); b.classList.toggle('text-white/70', !active);
                });
            }
        }

        function closeFilterSheet() {
            const sheet = currentFilterSheet;
            if (sheet === 'filter-location-sheet') {
                const checked = document.querySelectorAll('#filter-location-sheet .location-city-cb:checked');
                feedFilterRegions = Array.from(checked).map(cb => cb.value).filter(Boolean);
            } else if (sheet === 'filter-family-sheet') {
                const sel = document.querySelector('#filter-family-sheet .filter-family-opt.selected, #filter-family-sheet .status-card.selected');
                feedFilterMarital = sel ? (sel.getAttribute('data-value') || null) : feedFilterMarital;
                const childrenSel = document.querySelector('#filter-family-sheet .filter-family-children.bg-primary');
                feedFilterChildren = childrenSel ? (childrenSel.getAttribute('data-value') || null) : feedFilterChildren;
                const polygamySel = document.querySelector('#filter-family-sheet .filter-family-polygamy.border-l-primary');
                feedFilterPolygamy = polygamySel ? (polygamySel.getAttribute('data-value') || null) : feedFilterPolygamy;
            } else if (sheet === 'filter-religious-sheet') {
                const selAqida = document.querySelector('#filter-religious-sheet [data-filter="aqida"].chip-selected');
                const selPrays = document.querySelector('#filter-religious-sheet [data-filter="prays"].chip-selected, #filter-religious-sheet [data-filter="prays"].radio-item-selected');
                const selQuran = document.querySelector('#filter-religious-sheet [data-filter="quran_reading"].chip-selected');
                const mEl = document.querySelector('#filter-religious-sheet [data-filter="mazhab"].radio-item-selected');
                feedFilterAqida = selAqida ? (selAqida.getAttribute('data-value') || null) : feedFilterAqida;
                feedFilterPrays = selPrays ? (selPrays.getAttribute('data-value') || null) : feedFilterPrays;
                feedFilterQuran = selQuran ? (selQuran.getAttribute('data-value') || null) : feedFilterQuran;
                feedFilterMazhab = mEl ? (mEl.getAttribute('data-value') || null) : feedFilterMazhab;
            } else if (sheet === 'filter-physical-sheet') {
                const ageMin = getIosDialValue('ios-dial-age-min');
                const ageMax = getIosDialValue('ios-dial-age-max');
                const heightMin = getIosDialValue('ios-dial-height-min');
                const heightMax = getIosDialValue('ios-dial-height-max');
                const weightMin = getIosDialValue('ios-dial-weight-min');
                const weightMax = getIosDialValue('ios-dial-weight-max');
                if (ageMin != null) feedFilterAgeMin = ageMin;
                if (ageMax != null) feedFilterAgeMax = ageMax;
                if (heightMin != null) feedFilterHeightMin = heightMin;
                if (heightMax != null) feedFilterHeightMax = heightMax;
                if (weightMin != null) feedFilterWeightMin = weightMin;
                if (weightMax != null) feedFilterWeightMax = weightMax;
                const smokingBtn = document.querySelector('#filter-physical-sheet .filter-smoking-btn.bg-primary');
                if (smokingBtn) feedFilterSmoking = smokingBtn.getAttribute('data-value') || null;
                const sportBars = document.querySelectorAll('#filter-physical-sheet .filter-sport-bar.bg-primary');
                feedFilterSportDays = sportBars ? sportBars.length : null;
                const parts = [];
                if (feedFilterAgeMin != null || feedFilterAgeMax != null) parts.push((feedFilterAgeMin ?? '?') + '-' + (feedFilterAgeMax ?? '?') + ' yosh');
                if (feedFilterHeightMin != null || feedFilterHeightMax != null) parts.push((feedFilterHeightMin ?? '?') + '-' + (feedFilterHeightMax ?? '?') + ' sm');
                if (feedFilterWeightMin != null || feedFilterWeightMax != null) parts.push((feedFilterWeightMin ?? '?') + '-' + (feedFilterWeightMax ?? '?') + ' kg');
                const sumEl = document.getElementById('filter-physical-summary');
                if (sumEl) sumEl.textContent = parts.length ? parts.join(', ') : 'Yosh, bo\'y, vazn';
            } else if (sheet === 'filter-education-sheet') {
                const sel = document.querySelector('#filter-education-sheet .filter-education-opt.filter-education-selected, #filter-education-sheet .filter-education-opt.border-primary\\/40');
                feedFilterEducation = sel ? (sel.getAttribute('data-value') || null) : feedFilterEducation;
            } else if (sheet === 'filter-work-sheet') {
                const sel = document.querySelector('#filter-work-sheet .filter-work-profession.bg-primary');
                const salaryMinEl = document.getElementById('filter-work-salary-min');
                const salaryMaxEl = document.getElementById('filter-work-salary-max');
                feedFilterProfession = sel ? (sel.getAttribute('data-value') || null) : feedFilterProfession;
                feedFilterSalaryMin = salaryMinEl && salaryMinEl.value ? parseInt(salaryMinEl.value, 10) : feedFilterSalaryMin;
                feedFilterSalaryMax = salaryMaxEl && salaryMaxEl.value ? parseInt(salaryMaxEl.value, 10) : feedFilterSalaryMax;
                feedFilterHasSalary = (feedFilterSalaryMin > 0 || feedFilterSalaryMax > 0) ? 'true' : null;
            }
            if (sheet && sheet.startsWith('filter-') && sheet.endsWith('-sheet')) {
                if (typeof invalidateFeedCache === 'function') invalidateFeedCache();
                pageDataLoaded.feed = false;
                loadFeedData();
                updateFilterButtonState();
            }
            document.querySelectorAll('.bottom-sheet').forEach(s => {
                s.classList.remove('active');
            });
            const overlay = document.getElementById('filter-overlay');
            if (overlay) overlay.style.display = 'none';
            currentFilterSheet = null;
        }

        /* iOS-style Dial - Mukammal fizika */
        const IOS_DIAL_ITEM_H = 40;
        const IOS_DIAL_CENTER_OFFSET = 144; // dial height / 2
        const iosDialStates = {};

        function hapticFeedback(style = 'light') {
            if (navigator.vibrate) {
                navigator.vibrate(style === 'light' ? 8 : style === 'medium' ? 15 : 25);
            }
            // iOS Taptic Engine
            if (window.webkit?.messageHandlers?.haptic) {
                window.webkit.messageHandlers.haptic.postMessage(style);
            }
        }

        function getIosDialValue(dialId) {
            const state = iosDialStates[dialId];
            if (!state) return null;
            const index = Math.round(-state.position / IOS_DIAL_ITEM_H);
            return Math.max(state.min, Math.min(state.max, state.min + index));
        }

        function setIosDialValue(dialId, value) {
            const state = iosDialStates[dialId];
            if (!state) return;
            const v = Math.max(state.min, Math.min(state.max, value));
            const index = v - state.min;
            state.position = -index * IOS_DIAL_ITEM_H;
            state.lastValue = v;
            renderIosDial(dialId);
        }

        function renderIosDial(dialId) {
            const state = iosDialStates[dialId];
            if (!state) return;
            const itemsEl = state.itemsEl;
            itemsEl.style.transform = `translateY(${IOS_DIAL_CENTER_OFFSET + state.position}px)`;
            const currentVal = getIosDialValue(dialId);
            // Haptic when value changes
            if (state.lastValue !== currentVal) {
                hapticFeedback('light');
                state.lastValue = currentVal;
            }
            // Update item styles based on distance from center
            itemsEl.querySelectorAll('.ios-dial-item').forEach((item, i) => {
                const itemVal = state.min + i;
                const offset = itemVal - currentVal;
                item.setAttribute('data-offset', Math.max(-3, Math.min(3, offset)));
            });
        }

        function initIosDial(dialId, min, max, defaultValue) {
            const dial = document.getElementById(dialId);
            if (!dial) return;
            const track = dial.querySelector('.ios-dial-track');
            const itemsEl = dial.querySelector('.ios-dial-items');
            if (!track || !itemsEl) return;

            // Build items
            itemsEl.innerHTML = '';
            for (let v = min; v <= max; v++) {
                const div = document.createElement('div');
                div.className = 'ios-dial-item';
                div.textContent = v;
                itemsEl.appendChild(div);
            }

            // State
            const state = {
                min, max,
                position: 0,
                velocity: 0,
                lastY: 0,
                lastTime: 0,
                isDragging: false,
                lastValue: defaultValue,
                itemsEl,
                animFrame: null
            };
            iosDialStates[dialId] = state;

            // Set initial value
            setIosDialValue(dialId, defaultValue);

            // Touch handlers
            const onStart = (e) => {
                state.isDragging = true;
                state.velocity = 0;
                const touch = e.touches ? e.touches[0] : e;
                state.lastY = touch.clientY;
                state.lastTime = Date.now();
                if (state.animFrame) cancelAnimationFrame(state.animFrame);
                itemsEl.style.transition = 'none';
            };

            const onMove = (e) => {
                if (!state.isDragging) return;
                e.preventDefault();
                const touch = e.touches ? e.touches[0] : e;
                const now = Date.now();
                const deltaY = touch.clientY - state.lastY;
                const deltaTime = now - state.lastTime || 1;
                
                state.velocity = deltaY / deltaTime * 16;
                state.position += deltaY;
                
                // Clamp with rubber band effect
                const maxPos = 0;
                const minPos = -(max - min) * IOS_DIAL_ITEM_H;
                if (state.position > maxPos) {
                    state.position = maxPos + (state.position - maxPos) * 0.3;
                } else if (state.position < minPos) {
                    state.position = minPos + (state.position - minPos) * 0.3;
                }
                
                state.lastY = touch.clientY;
                state.lastTime = now;
                renderIosDial(dialId);
            };

            const onEnd = () => {
                if (!state.isDragging) return;
                state.isDragging = false;
                
                // Deceleration animation
                const decelerate = () => {
                    if (state.isDragging) return;
                    
                    state.velocity *= 0.92; // friction
                    state.position += state.velocity;
                    
                    // Clamp
                    const maxPos = 0;
                    const minPos = -(max - min) * IOS_DIAL_ITEM_H;
                    if (state.position > maxPos) {
                        state.position = maxPos;
                        state.velocity = 0;
                    } else if (state.position < minPos) {
                        state.position = minPos;
                        state.velocity = 0;
                    }
                    
                    renderIosDial(dialId);
                    
                    if (Math.abs(state.velocity) > 0.5) {
                        state.animFrame = requestAnimationFrame(decelerate);
                    } else {
                        // Snap to nearest
                        const targetIndex = Math.round(-state.position / IOS_DIAL_ITEM_H);
                        const targetPos = -targetIndex * IOS_DIAL_ITEM_H;
                        itemsEl.style.transition = 'transform 0.15s ease-out';
                        state.position = targetPos;
                        renderIosDial(dialId);
                    }
                };
                
                if (Math.abs(state.velocity) > 1) {
                    state.animFrame = requestAnimationFrame(decelerate);
                } else {
                    // Just snap
                    const targetIndex = Math.round(-state.position / IOS_DIAL_ITEM_H);
                    const targetPos = -targetIndex * IOS_DIAL_ITEM_H;
                    itemsEl.style.transition = 'transform 0.15s ease-out';
                    state.position = targetPos;
                    renderIosDial(dialId);
                }
            };

            // Mouse wheel
            const onWheel = (e) => {
                e.preventDefault();
                state.position -= e.deltaY * 0.5;
                const maxPos = 0;
                const minPos = -(max - min) * IOS_DIAL_ITEM_H;
                state.position = Math.max(minPos, Math.min(maxPos, state.position));
                itemsEl.style.transition = 'transform 0.08s ease-out';
                // Snap
                const targetIndex = Math.round(-state.position / IOS_DIAL_ITEM_H);
                state.position = -targetIndex * IOS_DIAL_ITEM_H;
                renderIosDial(dialId);
            };

            track.addEventListener('touchstart', onStart, { passive: false });
            track.addEventListener('touchmove', onMove, { passive: false });
            track.addEventListener('touchend', onEnd);
            track.addEventListener('touchcancel', onEnd);
            track.addEventListener('mousedown', onStart);
            document.addEventListener('mousemove', (e) => { if (state.isDragging) onMove(e); });
            document.addEventListener('mouseup', onEnd);
            track.addEventListener('wheel', onWheel, { passive: false });
        }

        function initScrollDials() {
            const ageMin = feedFilterAgeMin != null ? feedFilterAgeMin : 22;
            const ageMax = feedFilterAgeMax != null ? feedFilterAgeMax : 28;
            const heightMin = feedFilterHeightMin != null ? feedFilterHeightMin : 165;
            const heightMax = feedFilterHeightMax != null ? feedFilterHeightMax : 190;
            const weightMin = feedFilterWeightMin != null ? feedFilterWeightMin : 60;
            const weightMax = feedFilterWeightMax != null ? feedFilterWeightMax : 90;
            initIosDial('ios-dial-age-min', 18, 70, Math.min(ageMin, ageMax));
            initIosDial('ios-dial-age-max', 18, 70, Math.max(ageMin, ageMax));
            initIosDial('ios-dial-height-min', 140, 210, Math.min(heightMin, heightMax));
            initIosDial('ios-dial-height-max', 140, 210, Math.max(heightMin, heightMax));
            initIosDial('ios-dial-weight-min', 40, 130, Math.min(weightMin, weightMax));
            initIosDial('ios-dial-weight-max', 40, 130, Math.max(weightMin, weightMax));
            
            // Smoking filter click handler
            document.querySelectorAll('.filter-smoking-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-smoking-btn').forEach(b => {
                        b.classList.remove('bg-primary', 'text-black');
                        b.classList.add('bg-white/[0.05]', 'border', 'border-white/[0.08]', 'text-white/60');
                    });
                    btn.classList.remove('bg-white/[0.05]', 'border', 'border-white/[0.08]', 'text-white/60');
                    btn.classList.add('bg-primary', 'text-black');
                    hapticFeedback('light');
                });
            });
            
            // Sport bars click handler
            document.querySelectorAll('.filter-sport-bar').forEach(bar => {
                bar.addEventListener('click', () => {
                    const day = parseInt(bar.dataset.day);
                    document.querySelectorAll('.filter-sport-bar').forEach(b => {
                        const d = parseInt(b.dataset.day);
                        if (d <= day) {
                            b.classList.remove('bg-white/10');
                            b.classList.add('bg-primary');
                        } else {
                            b.classList.remove('bg-primary');
                            b.classList.add('bg-white/10');
                        }
                    });
                    const labels = ['', 'Haftada 1 kun', 'Haftada 2 kun', 'Haftada 3 kun', 'Haftada 4 kun', 'Haftada 5 kun', 'Haftada 6 kun', 'Har kuni'];
                    document.getElementById('filter-sport-label').textContent = labels[day] || '';
                    hapticFeedback('light');
                });
            });
            
            // Init salary slider
            initSalarySlider();
        }

        // Dual Range Salary Slider
        function initSalarySlider() {
            const container = document.getElementById('salary-slider-container');
            if (!container) return;
            
            const track = container.querySelector('.bg-white\\/10');
            const range = document.getElementById('salary-slider-range');
            const minThumb = document.getElementById('salary-slider-min');
            const maxThumb = document.getElementById('salary-slider-max');
            const minInput = document.getElementById('filter-work-salary-min');
            const maxInput = document.getElementById('filter-work-salary-max');
            const label = document.getElementById('filter-work-salary-label');
            
            if (!track || !range || !minThumb || !maxThumb) return;
            
            const SALARY_MIN = 0;
            const SALARY_MAX = 5000;
            let minVal = (feedFilterSalaryMin != null && feedFilterSalaryMin > 0) ? feedFilterSalaryMin : 500;
            let maxVal = (feedFilterSalaryMax != null && feedFilterSalaryMax > 0) ? feedFilterSalaryMax : 5000;
            if (minVal >= maxVal) { minVal = 500; maxVal = 5000; }
            
            function valToPercent(val) {
                return Math.max(0, Math.min(100, (val / SALARY_MAX) * 100));
            }
            
            function percentToVal(pct) {
                return Math.round((pct / 100) * SALARY_MAX / 100) * 100;
            }
            
            function updateSlider() {
                const minPct = valToPercent(minVal);
                const maxPct = valToPercent(maxVal);
                minThumb.style.left = minPct + '%';
                maxThumb.style.left = maxPct + '%';
                range.style.left = minPct + '%';
                range.style.right = (100 - maxPct) + '%';
                minInput.value = minVal;
                maxInput.value = maxVal;
                const maxLabel = maxVal >= 5000 ? '$5000+' : '$' + maxVal;
                label.textContent = '$' + minVal + ' — ' + maxLabel;
            }
            
            function handleDrag(thumb, isMin) {
                let isDragging = false;
                
                const onStart = (e) => {
                    isDragging = true;
                    e.preventDefault();
                };
                
                const onMove = (e) => {
                    if (!isDragging) return;
                    const rect = track.getBoundingClientRect();
                    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                    let pct = ((clientX - rect.left) / rect.width) * 100;
                    pct = Math.max(0, Math.min(100, pct));
                    let val = percentToVal(pct);
                    
                    if (isMin) {
                        val = Math.min(val, maxVal - 100);
                        if (val !== minVal) {
                            minVal = val;
                            hapticFeedback('light');
                        }
                    } else {
                        val = Math.max(val, minVal + 100);
                        if (val !== maxVal) {
                            maxVal = val;
                            hapticFeedback('light');
                        }
                    }
                    updateSlider();
                };
                
                const onEnd = () => {
                    isDragging = false;
                };
                
                thumb.addEventListener('mousedown', onStart);
                thumb.addEventListener('touchstart', onStart, { passive: false });
                document.addEventListener('mousemove', onMove);
                document.addEventListener('touchmove', onMove, { passive: false });
                document.addEventListener('mouseup', onEnd);
                document.addEventListener('touchend', onEnd);
            }
            
            handleDrag(minThumb, true);
            handleDrag(maxThumb, false);
            updateSlider();
        }
        
        document.addEventListener('click', (e) => {
            if (e.target.closest('#filter-work-sheet .filter-work-category')) {
                const btn = e.target.closest('.filter-work-category');
                const isActive = btn.classList.contains('border-primary/50');
                document.querySelectorAll('#filter-work-sheet .filter-work-category').forEach(b => {
                    b.classList.remove('border-primary/50', 'bg-primary/5');
                    b.classList.add('border-white/[0.06]', 'bg-white/[0.03]');
                });
                if (!isActive) {
                    btn.classList.remove('border-white/[0.06]', 'bg-white/[0.03]');
                    btn.classList.add('border-primary/50', 'bg-primary/5');
                }
                hapticFeedback('light');
            }
        });

        // Legacy alias for getAppleDialValue
        function getAppleDialValue(dialEl) {
            if (!dialEl) return null;
            return getIosDialValue(dialEl.id);
        }

        function updateWorkSalaryLabel() {
            const minEl = document.getElementById('filter-work-salary-min');
            const maxEl = document.getElementById('filter-work-salary-max');
            const labelEl = document.getElementById('filter-work-salary-label');
            if (!labelEl) return;
            const min = minEl && minEl.value ? parseInt(minEl.value, 10) : null;
            const max = maxEl && maxEl.value ? parseInt(maxEl.value, 10) : null;
            if (min != null && max != null) labelEl.textContent = '$' + min + ' — $' + max;
            else if (min != null) labelEl.textContent = '$' + min + '+';
            else if (max != null) labelEl.textContent = '— $' + max;
            else labelEl.textContent = '—';
        }

        function updateSortSheetUI(currentSort) {
            const sortVal = currentSort != null ? currentSort : feedSort;
            document.querySelectorAll('#filter-sort-sheet .sort-option-btn').forEach(btn => {
                const val = btn.getAttribute('data-sort');
                const active = val === sortVal;
                btn.classList.toggle('sort-option-active', active);
                btn.classList.toggle('border-primary/30', active);
                btn.classList.toggle('border-white/5', !active);
                btn.classList.toggle('border-white/10', !active);
                btn.classList.toggle('text-primary', active);
                btn.classList.toggle('text-white/60', !active);
                const icon = btn.querySelector('.sort-option-icon');
                const label = btn.querySelector('.sort-option-label');
                const badge = btn.querySelector('.sort-option-badge');
                if (icon) { icon.classList.toggle('text-primary', active); icon.classList.toggle('text-white/40', !active); }
                if (label) { label.classList.toggle('text-white', active); label.classList.toggle('text-white/60', !active); }
                if (badge) { badge.classList.toggle('border-primary/30', active); badge.classList.toggle('opacity-100', active); badge.classList.toggle('opacity-60', !active); }
            });
        }

        // Filter state
        const filterState = {
            religious: {
                aqida: 'Ahli Sunna',
                namoz: '5 vaqt to\'liq',
                quran: 'O\'qishni biladi',
                mazhab: 'Hanafi'
            },
            location: {
                country: 'O\'zbekiston',
                cities: ['Toshkent']
            },
            family: {
                status: 'Ajrashgan',
                children: 'Bor',
                polygamy: '1-ro\'zg\'or'
            },
            physical: {
                age: { min: 22, max: 28 },
                height: { min: 165, max: 190 },
                weight: { min: 60, max: 90 },
                smoking: 'Yo\'q',
                sport: 3
            },
            education: {
                level: 'Oliy ma\'lumotli',
                languages: ['O\'zbek', 'Ingliz', 'Arab'],
                religious_education: []
            },
            work: {
                profession: 'Tadbirkor',
                income: { min: 500, max: 5000 }
            }
        };

        // Filter funksiyalari
        function initFilterHandlers() {
            // Chip selection (chip-selected, chip-unselected) — profil/yangi e'lon sheetida ishlamasin (o'z handleri bor)
            document.addEventListener('click', (e) => {
                if (e.target.closest('#profile-edit-sheet')) return;
                if (e.target.closest('.chip')) {
                    const chip = e.target.closest('.chip');
                    const container = chip.closest('section') || chip.closest('div');
                    
                    // Agar chip-selected class'i bo'lsa, toggle qilish
                    if (chip.classList.contains('chip-selected')) {
                        chip.classList.remove('chip-selected');
                        chip.classList.add('chip-unselected');
                    } else if (chip.classList.contains('chip-unselected')) {
                        // Boshqa chip'larni unselect qilish (agar kerak bo'lsa)
                        const siblings = container.querySelectorAll('.chip');
                        siblings.forEach(s => {
                            s.classList.remove('chip-selected');
                            s.classList.add('chip-unselected');
                        });
                        chip.classList.remove('chip-unselected');
                        chip.classList.add('chip-selected');
                    }
                }
            });

            // Radio item selection — profil/yangi e'lon sheetida ishlamasin
            document.addEventListener('click', (e) => {
                if (e.target.closest('#profile-edit-sheet')) return;
                if (e.target.closest('.radio-item')) {
                    const radioItem = e.target.closest('.radio-item');
                    const container = radioItem.closest('section') || radioItem.closest('div');
                    
                    // Boshqa radio item'larni unselect qilish
                    const siblings = container.querySelectorAll('.radio-item');
                    siblings.forEach(s => {
                        s.classList.remove('radio-item-selected');
                        const radio = s.querySelector('.size-5');
                        if (radio) {
                            radio.classList.remove('bg-primary', 'border-primary');
                            radio.classList.add('border-2', 'border-white/20');
                            radio.innerHTML = '';
                        }
                    });
                    
                    // Tanlangan item'ni select qilish
                    radioItem.classList.add('radio-item-selected');
                    const radio = radioItem.querySelector('.size-5');
                    if (radio) {
                        radio.classList.remove('border-2', 'border-white/20');
                        radio.classList.add('bg-primary', 'border-primary', 'flex', 'items-center', 'justify-center');
                        radio.innerHTML = '<div class="size-2.5 bg-black rounded-full"></div>';
                    }
                }
            });

            // Oilaviy: Farzandi (Bor/Yo'q)
            document.addEventListener('click', (e) => {
                if (e.target.closest('#filter-family-sheet .filter-family-children')) {
                    const btn = e.target.closest('.filter-family-children');
                    document.querySelectorAll('#filter-family-sheet .filter-family-children').forEach(b => {
                        b.classList.remove('bg-primary', 'text-black');
                        b.classList.add('bg-white/[0.05]', 'text-white/60');
                    });
                    btn.classList.remove('bg-white/[0.05]', 'text-white/60');
                    btn.classList.add('bg-primary', 'text-black');
                }
            });
            // Oilaviy: Nechinchilikka (1/2/3-ro'zg'or)
            document.addEventListener('click', (e) => {
                if (e.target.closest('#filter-family-sheet .filter-family-polygamy')) {
                    const btn = e.target.closest('.filter-family-polygamy');
                    document.querySelectorAll('#filter-family-sheet .filter-family-polygamy').forEach(b => {
                        b.classList.remove('border-l-primary');
                        b.classList.add('border-l-transparent');
                        b.querySelector('span:first-child')?.classList.remove('text-primary'), b.querySelector('span:first-child')?.classList.add('text-white/60');
                        const ic = b.querySelector('.material-symbols-outlined');
                        if (ic) { ic.classList.remove('text-primary'); ic.classList.add('text-white/10'); ic.textContent = 'circle'; }
                    });
                    btn.classList.remove('border-l-transparent');
                    btn.classList.add('border-l-primary');
                    btn.querySelector('span:first-child')?.classList.remove('text-white/60'), btn.querySelector('span:first-child')?.classList.add('text-primary');
                    const icon = btn.querySelector('.material-symbols-outlined');
                    if (icon) { icon.classList.remove('text-white/10'); icon.classList.add('text-primary'); icon.textContent = 'check_circle'; }
                }
            });
            // Status card selection
            document.addEventListener('click', (e) => {
                if (e.target.closest('.status-card')) {
                    const card = e.target.closest('.status-card');
                    const container = card.closest('div');
                    if (card.classList.contains('filter-family-opt') && filterState.family) {
                        filterState.family.status = card.getAttribute('data-value') || filterState.family.status;
                    }
                    const siblings = container.querySelectorAll('.status-card');
                    siblings.forEach(s => {
                        s.classList.remove('selected', 'border-primary/50', 'bg-primary/5', 'neon-glow');
                        const icon = s.querySelector('.material-symbols-outlined');
                        if (icon) {
                            icon.classList.remove('text-primary');
                            icon.classList.add('text-white/40');
                        }
                        const text = s.querySelector('span:last-child');
                        if (text) {
                            text.classList.remove('text-primary');
                            text.classList.add('text-white');
                        }
                        const checkIcon = s.querySelector('.absolute');
                        if (checkIcon) checkIcon.remove();
                    });
                    card.classList.add('selected', 'border-primary/50', 'bg-primary/5', 'neon-glow');
                    const icon = card.querySelector('.material-symbols-outlined');
                    if (icon) {
                        icon.classList.remove('text-white/40');
                        icon.classList.add('text-primary');
                    }
                    const text = card.querySelector('span:last-child');
                    if (text) {
                        text.classList.remove('text-white');
                        text.classList.add('text-primary');
                    }
                    if (card.classList.contains('filter-family-opt') && !card.querySelector('.absolute')) {
                        const check = document.createElement('div');
                        check.className = 'absolute top-2 right-2';
                        check.innerHTML = '<span class="material-symbols-outlined text-[14px] text-primary">check_circle</span>';
                        card.appendChild(check);
                    }
                    // Check icon qo'shish
                    if (!card.querySelector('.absolute')) {
                        const checkDiv = document.createElement('div');
                        checkDiv.className = 'absolute top-2 right-2';
                        checkDiv.innerHTML = '<span class="material-symbols-outlined text-[14px] text-primary">check_circle</span>';
                        card.appendChild(checkDiv);
                    }
                }
            });

            // Ta'lim filter: bitta tanlash
            document.addEventListener('click', (e) => {
                if (e.target.closest('#filter-education-sheet .filter-education-opt')) {
                    const btn = e.target.closest('.filter-education-opt');
                    const sheet = document.getElementById('filter-education-sheet');
                    if (!sheet || !sheet.classList.contains('active')) return;
                    sheet.querySelectorAll('.filter-education-opt').forEach(b => {
                        b.classList.remove('filter-education-selected', 'border-primary/40');
                        b.classList.add('border-white/[0.05]');
                        b.querySelector('span')?.classList.remove('text-white');
                        b.querySelector('span')?.classList.add('text-white/60');
                        const icon = b.querySelector('.size-5');
                        if (icon) { icon.className = 'size-5 rounded-full border-2 border-white/10'; icon.innerHTML = ''; }
                    });
                    btn.classList.add('filter-education-selected', 'border-primary/40');
                    btn.classList.remove('border-white/[0.05]');
                    btn.querySelector('span')?.classList.remove('text-white/60');
                    btn.querySelector('span')?.classList.add('text-white');
                    const icon = btn.querySelector('.size-5');
                    if (icon) { icon.className = 'size-5 rounded-full bg-primary flex items-center justify-center'; icon.innerHTML = '<span class="material-symbols-outlined text-black text-[14px] font-bold">check</span>'; }
                }
            });

            // Ish & Daromad: kasb tanlash (active = yashil)
            document.addEventListener('click', (e) => {
                if (e.target.closest('#filter-work-sheet .filter-work-profession')) {
                    const btn = e.target.closest('.filter-work-profession');
                    const sheet = document.getElementById('filter-work-sheet');
                    if (!sheet || !sheet.classList.contains('active')) return;
                    document.querySelectorAll('#filter-work-sheet .filter-work-profession').forEach(b => {
                        b.classList.remove('bg-primary', 'text-black', 'shadow-[0_4px_15px_rgba(64,255,0,0.2)]');
                        b.classList.add('bg-white/[0.05]', 'border', 'border-white/[0.1]', 'text-white/70');
                    });
                    btn.classList.remove('bg-white/[0.05]', 'border', 'border-white/[0.1]', 'text-white/70');
                    btn.classList.add('bg-primary', 'text-black', 'shadow-[0_4px_15px_rgba(64,255,0,0.2)]');
                }
            });

            document.addEventListener('input', (e) => {
                const el = e.target;
                if (el.id === 'filter-work-salary-min' || el.id === 'filter-work-salary-max') updateWorkSalaryLabel();
            });

            // Custom checkbox toggle
            document.addEventListener('change', (e) => {
                if (e.target.classList.contains('custom-checkbox')) {
                    // Checkbox allaqachon checked/unchecked bo'ladi, faqat visual update kerak
                }
            });

            // Tag active/inactive (Ilm & Til tillari va boshqa)
            document.addEventListener('click', (e) => {
                const tag = e.target.closest('.tag-active, .tag-inactive');
                if (!tag) return;
                if (tag.classList.contains('tag-active')) {
                    tag.classList.remove('tag-active');
                    tag.classList.add('tag-inactive');
                } else {
                    tag.classList.remove('tag-inactive');
                    tag.classList.add('tag-active');
                }
            });
            // Diniy ilm (Ilm & Til) bitta tanlash
            document.addEventListener('click', (e) => {
                if (e.target.closest('#filter-education-sheet .filter-education-religious')) {
                    const btn = e.target.closest('.filter-education-religious');
                    document.querySelectorAll('#filter-education-sheet .filter-education-religious').forEach(b => {
                        b.classList.remove('border-primary/40', 'bg-primary/5');
                        b.classList.add('border-white/[0.05]', 'bg-white/[0.03]');
                        b.querySelector('span:last-child')?.classList.remove('text-white');
                        b.querySelector('span:last-child')?.classList.add('text-white/60');
                    });
                    btn.classList.remove('border-white/[0.05]', 'bg-white/[0.03]');
                    btn.classList.add('border-primary/40', 'bg-primary/5');
                    btn.querySelector('span:last-child')?.classList.remove('text-white/60');
                    btn.querySelector('span:last-child')?.classList.add('text-white');
                }
            });
        }

        let feedGender = 'Ayol'; // Kuyov rejimi = Kelin (ayollar) ko'rsatiladi; Kelin rejimi = Kuyov (erkaklar)
        let feedSort = 'new';   // new | name_asc | name_desc | age_asc | age_desc | height_asc | height_desc
        let chatMessageSort = 'desc';   // desc = yangi birinchi, asc = eski birinchi
        let feedFilterRegions = [];
        let feedFilterMarital = null;
        let feedFilterChildren = null;
        let feedFilterPolygamy = null;
        let feedFilterAqida = null;
        let feedFilterPrays = null;
        let feedFilterReligiousLevel = null;
        let feedFilterQuran = null;
        let feedFilterMazhab = null;
        let feedFilterEducation = null;
        let feedFilterProfession = null;
        let feedFilterAgeMin = null;
        let feedFilterAgeMax = null;
        let feedFilterHeightMin = null;
        let feedFilterHeightMax = null;
        let feedFilterHasSalary = null;
        let feedFilterWeightMin = null;
        let feedFilterWeightMax = null;
        let feedFilterSalaryMin = null;
        let feedFilterSalaryMax = null;
        let feedFilterSmoking = null;
        let feedFilterSportDays = null;

        function clearAllFilters() {
            feedFilterRegions = [];
            feedFilterMarital = null;
            feedFilterChildren = null;
            feedFilterPolygamy = null;
            feedFilterAqida = null;
            feedFilterPrays = null;
            feedFilterReligiousLevel = null;
            feedFilterQuran = null;
            feedFilterMazhab = null;
            feedFilterEducation = null;
            feedFilterProfession = null;
            feedFilterAgeMin = null;
            feedFilterAgeMax = null;
            feedFilterHeightMin = null;
            feedFilterHeightMax = null;
            feedFilterHasSalary = null;
            feedFilterWeightMin = null;
            feedFilterWeightMax = null;
            feedFilterSalaryMin = null;
            feedFilterSalaryMax = null;
            feedFilterSmoking = null;
            feedFilterSportDays = null;
            pageDataLoaded.feed = false;
            const sumEl = document.getElementById('filter-physical-summary');
            if (sumEl) sumEl.textContent = 'Yosh, bo\'y, vazn';
            updateFilterButtonState();
        }

        function buildFeedFilterParams() {
            let s = '';
            if (feedFilterRegions.length) s += '&regions=' + encodeURIComponent(feedFilterRegions.join(','));
            if (feedFilterMarital) s += '&marital_status=' + encodeURIComponent(feedFilterMarital);
            if (feedFilterAqida) s += '&aqida=' + encodeURIComponent(feedFilterAqida);
            if (feedFilterPrays) s += '&prays=' + encodeURIComponent(feedFilterPrays);
            if (feedFilterReligiousLevel) s += '&religious_level=' + encodeURIComponent(feedFilterReligiousLevel);
            if (feedFilterQuran) s += '&quran_reading=' + encodeURIComponent(feedFilterQuran);
            if (feedFilterMazhab) s += '&mazhab=' + encodeURIComponent(feedFilterMazhab);
            if (feedFilterEducation) s += '&education=' + encodeURIComponent(feedFilterEducation);
            if (feedFilterProfession) s += '&profession=' + encodeURIComponent(feedFilterProfession);
            if (feedFilterAgeMin != null && feedFilterAgeMin > 0) s += '&age_min=' + feedFilterAgeMin;
            if (feedFilterAgeMax != null && feedFilterAgeMax > 0) s += '&age_max=' + feedFilterAgeMax;
            if (feedFilterHeightMin != null && feedFilterHeightMin > 0) s += '&height_min=' + feedFilterHeightMin;
            if (feedFilterHeightMax != null && feedFilterHeightMax > 0) s += '&height_max=' + feedFilterHeightMax;
            if (feedFilterWeightMin != null && feedFilterWeightMin > 0) s += '&weight_min=' + feedFilterWeightMin;
            if (feedFilterWeightMax != null && feedFilterWeightMax > 0) s += '&weight_max=' + feedFilterWeightMax;
            if (feedFilterSmoking) s += '&smoking=' + encodeURIComponent(feedFilterSmoking);
            if (feedFilterSportDays != null && feedFilterSportDays > 0) s += '&sport_days_min=' + feedFilterSportDays;
            if (feedFilterHasSalary === 'true') s += '&has_salary=true';
            if (feedFilterSalaryMin != null && feedFilterSalaryMin > 0) s += '&salary_min=' + feedFilterSalaryMin;
            if (feedFilterSalaryMax != null && feedFilterSalaryMax > 0) s += '&salary_max=' + feedFilterSalaryMax;
            return s;
        }

        function hasActiveFilters() {
            return (feedFilterRegions && feedFilterRegions.length > 0) || feedFilterMarital || feedFilterChildren || feedFilterPolygamy ||
                feedFilterAqida || feedFilterPrays || feedFilterReligiousLevel || feedFilterQuran || feedFilterMazhab ||
                feedFilterEducation || feedFilterProfession || (feedFilterAgeMin != null && feedFilterAgeMin > 0) || (feedFilterAgeMax != null && feedFilterAgeMax > 0) ||
                (feedFilterHeightMin != null && feedFilterHeightMin > 0) || (feedFilterHeightMax != null && feedFilterHeightMax > 0) ||
                (feedFilterWeightMin != null && feedFilterWeightMin > 0) || (feedFilterWeightMax != null && feedFilterWeightMax > 0) ||
                feedFilterSmoking || (feedFilterSportDays != null && feedFilterSportDays > 0) ||
                feedFilterHasSalary === 'true' || (feedFilterSalaryMin != null && feedFilterSalaryMin > 0) || (feedFilterSalaryMax != null && feedFilterSalaryMax > 0);
        }

        function updateFilterButtonState() {
            const btn = document.getElementById('favorites-filter-btn');
            if (!btn) return;
            if (hasActiveFilters()) {
                btn.classList.add('!bg-primary/25', '!border-primary', '!text-primary');
            } else {
                btn.classList.remove('!bg-primary/25', '!border-primary', '!text-primary');
            }
        }

        function updateFeedGenderUI() {
            const kuyov = document.getElementById('feed-kuyov-btn');
            const kelin = document.getElementById('feed-kelin-btn');
            // Kelin tugmasi faol = Ayol (kelinlar) ko'rsatiladi; Kuyov tugmasi faol = Erkak (kuyovlar) ko'rsatiladi
            if (kelin) kelin.className = 'feed-gender-btn h-9 px-3 rounded-full text-[10px] font-black uppercase tracking-wider flex items-center gap-1.5 transition-all active:scale-95 ' + (feedGender === 'Ayol' ? 'feed-gender-kelin' : 'feed-gender-inactive');
            if (kuyov) kuyov.className = 'feed-gender-btn h-9 px-3 rounded-full text-[10px] font-black uppercase tracking-wider flex items-center gap-1.5 transition-all active:scale-95 ' + (feedGender === 'Erkak' ? 'feed-gender-kuyov' : 'feed-gender-inactive');
        }
        function updateFavoritesGenderUI() {
            const kuyov = document.getElementById('favorites-kuyov-btn');
            const kelin = document.getElementById('favorites-kelin-btn');
            if (kelin) kelin.className = 'feed-gender-btn h-9 px-3 rounded-full text-[10px] font-black uppercase tracking-wider flex items-center gap-1.5 transition-all active:scale-95 ' + (feedGender === 'Ayol' ? 'feed-gender-kelin' : 'feed-gender-inactive');
            if (kuyov) kuyov.className = 'feed-gender-btn h-9 px-3 rounded-full text-[10px] font-black uppercase tracking-wider flex items-center gap-1.5 transition-all active:scale-95 ' + (feedGender === 'Erkak' ? 'feed-gender-kuyov' : 'feed-gender-inactive');
        }
        function setFeedGender(gender) {
            if (feedGender === gender) return;
            var cache = feedCacheByGender[gender];
            var key = getFeedCacheKey();
            if (cache && cache.filterKey === key && cache.listings) {
                feedGender = gender;
                updateFeedGenderUI();
                updateFavoritesGenderUI();
                applyFeedFromCache(cache);
                if (pageDataLoaded.favorites) renderFavoritesListWithFilter();
                return;
            }
            feedGender = gender;
            updateFeedGenderUI();
            updateFavoritesGenderUI();
            pageDataLoaded.feed = false;
            loadFeedData();
            if (pageDataLoaded.favorites) renderFavoritesListWithFilter();
        }

        // Filter button event listener
        document.addEventListener('DOMContentLoaded', () => {
            const filterBtn = document.getElementById('feed-filter');
            if (filterBtn) {
                filterBtn.addEventListener('click', () => {
                    openFilterSheet('filter-main-sheet');
                });
            }
            const sortBtn = document.getElementById('feed-sort-btn');
            if (sortBtn) {
                sortBtn.addEventListener('click', () => {
                    openFilterSheet('filter-sort-sheet');
                });
            }
            const kuyovBtn = document.getElementById('feed-kuyov-btn');
            const kelinBtn = document.getElementById('feed-kelin-btn');
            if (kelinBtn) kelinBtn.addEventListener('click', (e) => { e.preventDefault(); setFeedGender('Ayol'); });   // Kelin = Ayol (kelinlar) ko'rsatiladi
            if (kuyovBtn) kuyovBtn.addEventListener('click', (e) => { e.preventDefault(); setFeedGender('Erkak'); });   // Kuyov = Erkak (kuyovlar) ko'rsatiladi
            // Asosiy sahifada tugmalar ishlashi uchun event delegation (ustki elementlar blok qilsa ham)
            document.getElementById('page-feed')?.addEventListener('click', function(e) {
                const t = e.target.closest('#feed-kuyov-btn, #feed-kelin-btn');
                if (!t) return;
                e.preventDefault();
                if (t.id === 'feed-kelin-btn') setFeedGender('Ayol');
                else if (t.id === 'feed-kuyov-btn') setFeedGender('Erkak');
            });
            updateFeedGenderUI();
            const favKuyov = document.getElementById('favorites-kuyov-btn');
            const favKelin = document.getElementById('favorites-kelin-btn');
            if (favKelin) favKelin.addEventListener('click', () => setFeedGender('Ayol'));
            if (favKuyov) favKuyov.addEventListener('click', () => setFeedGender('Erkak'));
            const favSort = document.getElementById('favorites-sort-btn');
            const favFilter = document.getElementById('favorites-filter-btn');
            if (favSort) favSort.addEventListener('click', () => { sortSheetContext = 'feed'; openFilterSheet('filter-sort-sheet'); });
            if (favFilter) favFilter.addEventListener('click', () => openFilterSheet('filter-main-sheet'));
            const requestsSortBtn = document.getElementById('requests-sort-btn');
            if (requestsSortBtn) requestsSortBtn.addEventListener('click', () => { sortSheetContext = 'requests'; openFilterSheet('filter-sort-sheet'); });

            // To'lov cheki rasm preview (tarif modal)
            const receiptInp = document.getElementById('tariff-payment-receipt');
            if (receiptInp) {
                receiptInp.addEventListener('change', function() {
                    var file = this.files && this.files[0];
                    if (!file) return;
                    if (file.size > 5 * 1024 * 1024) { alert('Rasm 5MB dan oshmasin'); this.value = ''; return; }
                    if (!file.type.startsWith('image/')) { alert('Faqat rasm yuklang'); this.value = ''; return; }
                    window._tariffPaymentReceiptFile = file;
                    document.getElementById('tariff-payment-receipt-label').textContent = file.name;
                    var preview = document.getElementById('tariff-payment-receipt-preview');
                    var img = document.getElementById('tariff-payment-preview-img');
                    if (preview && img) {
                        img.src = URL.createObjectURL(file);
                        preview.classList.remove('hidden');
                    }
                });
            }

            // Chat xabarlari saralash tugmasi
            const chatSortBtn = document.getElementById('chat-messages-sort-btn');
            if (chatSortBtn) {
                chatSortBtn.addEventListener('click', () => {
                    chatMessageSort = chatMessageSort === 'desc' ? 'asc' : 'desc';
                    chatSortBtn.title = chatMessageSort === 'desc' ? 'Yangi birinchi (hozirgi)' : 'Eski birinchi (hozirgi)';
                    if (currentChatId) loadChatView(currentChatId);
                });
            }

            // Saralash variantlari: tanlanganda feedSort/requestsSort yangilanadi, sheet yopiladi
            document.querySelectorAll('#filter-sort-sheet .sort-option-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const val = btn.getAttribute('data-sort');
                    if (!val) return;
                    if (sortSheetContext === 'requests') {
                        requestsSort = val;
                        updateSortSheetUI(requestsSort);
                        closeFilterSheet();
                        pageDataLoaded.requests = false;
                        loadRequestsData();
                    } else {
                        feedSort = val;
                        updateSortSheetUI(feedSort);
                        closeFilterSheet();
                        pageDataLoaded.feed = false;
                        loadFeedData();
                    }
                });
            });
            const favSearch = document.getElementById('favorites-search');
            if (favSearch) favSearch.addEventListener('input', () => { if (pageDataLoaded.favorites) renderFavoritesListWithFilter(); });
            updateFavoritesGenderUI();

            // Close buttons
            document.querySelectorAll('.filter-close-btn').forEach(btn => {
                btn.addEventListener('click', closeFilterSheet);
            });

            // Overlay click
            const overlay = document.getElementById('filter-overlay');
            if (overlay) {
                overlay.addEventListener('click', closeFilterSheet);
            }

            // Joylashuv: ro'yxatni LOCATION_COUNTRIES_REGIONS dan yig'ish, keyin qidiruv va shaharlar
            const filterLocationListEl = document.getElementById('filter-location-list');
            if (filterLocationListEl && typeof LOCATION_COUNTRIES_REGIONS !== 'undefined') {
                const countryFlags = { "O'zbekiston":"🇺🇿","Qozog'iston":"🇰🇿","Qirg'iziston":"🇰🇬","Tojikiston":"🇹🇯","Turkmaniston":"🇹🇲","Rossiya":"🇷🇺","Turkiya":"🇹🇷","Ozarbayjon":"🇦🇿","Gruziya":"🇬🇪","Armaniston":"🇦🇲","Afg'oniston":"🇦🇫","Pokiston":"🇵🇰","Hindiston":"🇮🇳","Bangladesh":"🇧🇩","Malayziya":"🇲🇾","Indoneziya":"🇮🇩","Tailand":"🇹🇭","Vyetnam":"🇻🇳","Filippin":"🇵🇭","Singapur":"🇸🇬","Saudiya Arabistoni":"🇸🇦","BAA":"🇦🇪","Quvayt":"🇰🇼","Qatar":"🇶🇦","Iroq":"🇮🇶","Eron":"🇮🇷","Misr":"🇪🇬","Germaniya":"🇩🇪","Fransiya":"🇫🇷","Buyuk Britaniya":"🇬🇧","Italiya":"🇮🇹","Ispaniya":"🇪🇸","Polsha":"🇵🇱","Ukraina":"🇺🇦","AQSH":"🇺🇸","Kanada":"🇨🇦","Xitoy":"🇨🇳","Yaponiya":"🇯🇵","Janubiy Koreya":"🇰🇷","Avstraliya":"🇦🇺" };
                filterLocationListEl.innerHTML = Object.keys(LOCATION_COUNTRIES_REGIONS).map(function(c) {
                    const flag = countryFlags[c] || '🌐';
                    const isFirst = c === "O'zbekiston";
                    return '<div class="location-country-block bg-white/[0.03] border border-white/[0.05] rounded-3xl overflow-hidden" data-country-name="' + c.replace(/"/g, '&quot;') + '">' +
                        '<button type="button" class="location-country-header w-full flex items-center justify-between p-5 ' + (isFirst ? 'border-b border-white/[0.04]' : '') + ' text-left active:bg-white/[0.05] transition-colors">' +
                        '<div class="flex items-center gap-3"><span class="text-2xl">' + flag + '</span><span class="font-bold text-white/80">' + c + '</span></div>' +
                        '<span class="material-symbols-outlined text-white/20 location-chevron">chevron_right</span></button>' +
                        '<div class="location-cities hidden px-5 py-4 space-y-4 bg-white/[0.01]"></div></div>';
                }).join('');
            }
            const locationSearch = document.getElementById('filter-location-search');
            if (locationSearch) {
                locationSearch.addEventListener('input', function() {
                    const q = (this.value || '').trim().toLowerCase();
                    document.querySelectorAll('#filter-location-list .location-country-block').forEach(block => {
                        const name = (block.getAttribute('data-country-name') || '').toLowerCase();
                        block.style.display = (q === '' || name.includes(q)) ? '' : 'none';
                    });
                });
            }
            document.querySelectorAll('.location-country-header').forEach(btn => {
                btn.addEventListener('click', function() {
                    const block = this.closest('.location-country-block');
                    const citiesEl = block && block.querySelector('.location-cities');
                    const chevron = this.querySelector('.location-chevron');
                    if (!citiesEl) return;
                    const isHidden = citiesEl.classList.contains('hidden');
                    if (isHidden) {
                        citiesEl.classList.remove('hidden');
                        if (chevron) { chevron.classList.remove('text-white/20'); chevron.classList.add('text-primary'); chevron.style.transform = 'rotate(90deg)'; }
                        if (citiesEl.children.length === 0) {
                            const countryName = block.getAttribute('data-country-name');
                            const cities = LOCATION_COUNTRIES_REGIONS[countryName] || [];
                            cities.forEach(city => {
                                const label = document.createElement('label');
                                label.className = 'flex items-center justify-between group cursor-pointer';
                                label.innerHTML = `<span class="text-sm font-medium text-white/80 group-active:text-white">${city}</span><input name="location_city" value="${city.replace(/"/g, '&quot;')}" class="location-city-cb custom-checkbox" type="checkbox"/>`;
                                citiesEl.appendChild(label);
                            });
                        }
                    } else {
                        citiesEl.classList.add('hidden');
                        if (chevron) { chevron.classList.add('text-white/20'); chevron.classList.remove('text-primary'); chevron.style.transform = ''; }
                    }
                });
            });

            // Filter handlers'ni ishga tushirish
            initFilterHandlers();
        });

        // Share funksiyasi
        function shareWithFriends() {
            const shareText = 'NIKOH - Halol tanishuv platformasi. Bu yerda halol va xavfsiz tanishuv imkoniyati mavjud!';
            const shareUrl = window.location.origin;
            
            // Telegram Web App share funksiyasi
            if (tg && tg.shareUrl) {
                tg.shareUrl(shareUrl, shareText);
            } else if (navigator.share) {
                // Web Share API
                navigator.share({
                    title: 'NIKOH - Halol tanishuv',
                    text: shareText,
                    url: shareUrl
                }).catch(err => {
                    console.log('Share error:', err);
                    // Fallback: clipboard'ga nusxalash
                    copyToClipboard(shareUrl);
                });
            } else {
                // Fallback: clipboard'ga nusxalash
                copyToClipboard(shareUrl);
            }
        }

        function copyToClipboard(text) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    if (typeof window.showNotification === 'function') {
                        window.showNotification('✅ Link nusxalandi!');
                    } else {
                        alert('✅ Link nusxalandi!');
                    }
                }).catch(err => {
                    console.error('Copy error:', err);
                    alert('Xatolik: Link nusxalashda muammo yuz berdi');
                });
            } else {
                // Fallback method
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    if (typeof window.showNotification === 'function') {
                        window.showNotification('✅ Link nusxalandi!');
                    } else {
                        alert('✅ Link nusxalandi!');
                    }
                } catch (err) {
                    alert('Xatolik: Link nusxalashda muammo yuz berdi');
                }
                document.body.removeChild(textarea);
            }
        }

        // TOP hisob-kitob funksiyasi
        function calculateTopAmounts(days) {
            const pricePerDay = 5000;
            const base = days * pricePerDay;
            let discountPercent = 0;

            if (days >= 20) {
                discountPercent = 15;
            } else if (days >= 10) {
                discountPercent = 10;
            } else if (days >= 5) {
                discountPercent = 5;
            }

            const discount = Math.round(base * discountPercent / 100);
            const finalAmount = base - discount;

            return { base, discount, finalAmount, discountPercent };
        }

        function formatSum(amount) {
            return amount.toLocaleString('uz-UZ') + " so'm";
        }

        function initTopPage() {
            const daysInput = document.getElementById('top-days-input');
            const daysLabel = document.getElementById('top-days-label');
            const baseEl = document.getElementById('top-base-amount');
            const discountEl = document.getElementById('top-discount-amount');
            const finalEl = document.getElementById('top-final-amount');
            const discountLabel = document.getElementById('top-discount-label');

            const fileInput = document.getElementById('top-receipt-image');
            const fileNameEl = document.getElementById('top-receipt-filename');

            if (!daysInput || !daysLabel || !baseEl || !discountEl || !finalEl) return;

            function updateUI() {
                const days = parseInt(daysInput.value, 10) || 1;
                const { base, discount, finalAmount, discountPercent } = calculateTopAmounts(days);

                daysLabel.textContent = days.toString();
                baseEl.textContent = formatSum(base);
                discountEl.textContent = discount > 0 ? "-" + formatSum(discount) : "0 so'm";
                finalEl.textContent = formatSum(finalAmount);

                if (discountPercent > 0 && discountLabel) {
                    discountLabel.textContent = `${discountPercent}% chegirma`;
                    discountLabel.classList.remove('hidden');
                } else if (discountLabel) {
                    discountLabel.classList.add('hidden');
                }
            }

            daysInput.addEventListener('input', updateUI);
            if (fileInput && fileNameEl) {
                fileInput.addEventListener('change', () => {
                    const file = fileInput.files[0];
                    fileNameEl.textContent = file ? file.name : '';
                });
            }
            updateUI();
        }

        async function createTopPaymentRequest() {
            const daysInput = document.getElementById('top-days-input');
            const fileInput = document.getElementById('top-receipt-image');
            const messageEl = document.getElementById('top-payment-message');

            if (!daysInput || !fileInput) return;

            const file = fileInput.files[0];
            if (!file) {
                alert('Iltimos, to\'lov cheki rasmini yuklang!');
                return;
            }

            // Fayl hajmi va turi tekshirish (ixtiyoriy, xavfsizlik uchun)
            if (file.size > 5 * 1024 * 1024) {
                alert('Rasm hajmi 5MB dan katta bo\'lishi mumkin emas!');
                return;
            }
            if (!file.type.startsWith('image/')) {
                alert('Faqat rasm fayllari qabul qilinadi!');
                return;
            }

            const days = parseInt(daysInput.value, 10) || 1;
            const { finalAmount } = calculateTopAmounts(days);
            const message = messageEl ? messageEl.value : '';

            try {
                const formData = new FormData();
                formData.append('tariff_name', `TOP_${days}`);
                formData.append('amount', finalAmount);
                formData.append('message', message || `TOPga olib chiqish: ${days} kun`);
                formData.append('receipt_image', file);

                const response = await fetch('/tariff/api/create-payment-request', {
                    method: 'POST',
                    credentials: 'same-origin',
                    body: formData
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    if (typeof window.showNotification === 'function') {
                        window.showNotification('✅ TOP uchun to‘lov so‘rovi yaratildi! Admin chekni tekshiradi.');
                    } else {
                        alert('✅ TOP uchun to‘lov so‘rovi yaratildi! Admin chekni tekshiradi.');
                    }
                    // Forma tozalash
                    fileInput.value = '';
                    if (messageEl) messageEl.value = '';
                    const fileNameEl = document.getElementById('top-receipt-filename');
                    if (fileNameEl) fileNameEl.textContent = '';
                } else {
                    alert('Xatolik: ' + (data.error || 'To‘lov so‘rovi yaratilishda xatolik yuz berdi'));
                }
            } catch (error) {
                console.error('Error creating TOP payment request:', error);
                alert('Xatolik: ' + error.message);
            }
        }

        // Global funksiyalar
        window.shareWithFriends = shareWithFriends;
        window.copyToClipboard = copyToClipboard;
        window.createTopPaymentRequest = createTopPaymentRequest;

        // DOM yuklanganda TOP sahifasini init qilish
        document.addEventListener('DOMContentLoaded', () => {
            initTopPage();
        });
    </script>

    <!-- Filter Overlay -->
    <div id="filter-overlay" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-40 hidden"></div>

    <!-- Filter Main Sheet -->
    <div id="filter-main-sheet" class="bottom-sheet">
        <div class="max-w-md mx-auto h-[92vh] flex flex-col">
            <div class="handle"></div>
            <header class="pt-6 pb-2 px-6 shrink-0 z-20 bg-[#111112]/80 backdrop-blur-md">
                <div class="max-w-md mx-auto">
                    <div class="flex items-center justify-between mb-6">
                        <button class="filter-close-btn size-10 rounded-full glass-panel flex items-center justify-center active:scale-95 transition-transform">
                            <span class="material-symbols-outlined text-[22px]">close</span>
                        </button>
                        <div class="flex flex-col items-center">
                            <h1 class="text-lg font-bold text-white tracking-tight">Izlash</h1>
                        </div>
                        <button type="button" onclick="clearAllFilters(); closeFilterSheet();" class="text-[11px] font-black uppercase tracking-widest text-primary/80 hover:text-primary transition-colors">Tozalash</button>
                    </div>
                    <div class="relative group">
                        <div class="absolute inset-y-0 left-4 flex items-center pointer-events-none">
                            <span class="material-symbols-outlined text-primary text-[20px]">search</span>
                        </div>
                        <input class="w-full h-14 glass-input rounded-2xl pl-12 pr-4 text-sm font-medium text-white placeholder-white/20" placeholder="Ism yoki ID qidirish..." type="text"/>
                    </div>
                </div>
            </header>
            <main class="flex-1 overflow-y-auto ios-scroll-hide px-6 pb-40">
                <div class="max-w-md mx-auto mt-6">
                    <div class="bg-card-bg rounded-[2.5rem] border border-white/[0.05] overflow-hidden">
                        <button onclick="openFilterSheet('filter-religious-sheet')" class="ios-row w-full group">
                            <div class="flex items-center gap-4">
                                <div class="size-10 rounded-xl bg-primary/10 flex items-center justify-center">
                                    <span class="material-symbols-outlined text-primary text-[22px]">verified_user</span>
                                </div>
                                <div class="text-left">
                                    <p class="text-[10px] font-bold text-white/40 uppercase tracking-widest">Diniy ma'lumotlar</p>
                                    <p class="text-sm font-semibold text-white">5 vaqt namoz, Hanafiy</p>
                                </div>
                            </div>
                            <span class="material-symbols-outlined text-white/20 group-active:translate-x-1 transition-transform">chevron_right</span>
                        </button>
                        <button onclick="openFilterSheet('filter-location-sheet')" class="ios-row w-full group">
                            <div class="flex items-center gap-4">
                                <div class="size-10 rounded-xl bg-white/[0.05] flex items-center justify-center">
                                    <span class="material-symbols-outlined text-white/40 text-[22px]">location_on</span>
                                </div>
                                <div class="text-left">
                                    <p class="text-[10px] font-bold text-white/40 uppercase tracking-widest">Joylashuv</p>
                                    <p class="text-sm font-semibold text-white/60">O'zbekiston, Toshkent</p>
                                </div>
                            </div>
                            <span class="material-symbols-outlined text-white/20 group-active:translate-x-1 transition-transform">chevron_right</span>
                        </button>
                        <button onclick="openFilterSheet('filter-family-sheet')" class="ios-row w-full group">
                            <div class="flex items-center gap-4">
                                <div class="size-10 rounded-xl bg-white/[0.05] flex items-center justify-center">
                                    <span class="material-symbols-outlined text-white/40 text-[22px]">person</span>
                                </div>
                                <div class="text-left">
                                    <p class="text-[10px] font-bold text-white/40 uppercase tracking-widest">Oilaviy holati</p>
                                    <p class="text-sm font-semibold text-white/60">Barchasi</p>
                                </div>
                            </div>
                            <span class="material-symbols-outlined text-white/20 group-active:translate-x-1 transition-transform">chevron_right</span>
                        </button>
                        <button onclick="openFilterSheet('filter-physical-sheet')" class="ios-row w-full group">
                            <div class="flex items-center gap-4">
                                <div class="size-10 rounded-xl bg-white/[0.05] flex items-center justify-center">
                                    <span class="material-symbols-outlined text-white/40 text-[22px]">straighten</span>
                                </div>
                                <div class="text-left">
                                    <p class="text-[10px] font-bold text-white/40 uppercase tracking-widest">Jismoniy parametrlar</p>
                                    <p id="filter-physical-summary" class="text-sm font-semibold text-white/60">Yosh, bo'y, vazn</p>
                                </div>
                            </div>
                            <span class="material-symbols-outlined text-white/20 group-active:translate-x-1 transition-transform">chevron_right</span>
                        </button>
                        <button onclick="openFilterSheet('filter-education-sheet')" class="ios-row w-full group">
                            <div class="flex items-center gap-4">
                                <div class="size-10 rounded-xl bg-white/[0.05] flex items-center justify-center">
                                    <span class="material-symbols-outlined text-white/40 text-[22px]">school</span>
                                </div>
                                <div class="text-left">
                                    <p class="text-[10px] font-bold text-white/40 uppercase tracking-widest">Ilm &amp; Til</p>
                                    <p class="text-sm font-semibold text-white/60">Oliy, Ingliz tili...</p>
                                </div>
                            </div>
                            <span class="material-symbols-outlined text-white/20 group-active:translate-x-1 transition-transform">chevron_right</span>
                        </button>
                        <button onclick="openFilterSheet('filter-work-sheet')" class="ios-row w-full group border-none">
                            <div class="flex items-center gap-4">
                                <div class="size-10 rounded-xl bg-white/[0.05] flex items-center justify-center">
                                    <span class="material-symbols-outlined text-white/40 text-[22px]">payments</span>
                                </div>
                                <div class="text-left">
                                    <p class="text-[10px] font-bold text-white/40 uppercase tracking-widest">Ish &amp; Daromad</p>
                                    <p class="text-sm font-semibold text-white/60">Tadbirkor, 1000$+</p>
                                </div>
                            </div>
                            <span class="material-symbols-outlined text-white/20 group-active:translate-x-1 transition-transform">chevron_right</span>
                        </button>
                    </div>
                </div>
            </main>
            <div class="fixed bottom-0 left-0 w-full p-6 bg-gradient-to-t from-background-dark via-background-dark/95 to-transparent pt-12 z-30">
                <div class="max-w-md mx-auto">
                    <button type="button" onclick="closeFilterSheet()" class="w-full h-16 bg-primary text-black rounded-2xl flex items-center justify-center gap-3 shadow-[0_12px_45px_rgba(64,255,0,0.3)] group active:scale-[0.97] transition-all duration-200">
                        <span class="text-sm font-black uppercase tracking-[0.2em]">Natijani ko'rish</span>
                        <span class="material-symbols-outlined text-[22px] font-bold group-hover:translate-x-1 transition-transform">arrow_forward</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Diniy ma'lumotlar Filter Sheet -->
    <div id="filter-religious-sheet" class="bottom-sheet">
        <div class="max-w-md mx-auto h-[92vh] flex flex-col">
            <div class="handle"></div>
            <div class="px-6 pb-2 flex items-center justify-between shrink-0">
                <h2 class="text-xl font-extrabold tracking-tight">Diniy ma'lumotlar</h2>
                <button onclick="closeFilterSheet()" class="size-9 rounded-full bg-white/5 flex items-center justify-center">
                    <span class="material-symbols-outlined text-white/60 text-xl">close</span>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto ios-scroll-hide px-6 py-4 space-y-8">
                <section>
                    <h3 class="text-[11px] font-black text-white/40 uppercase tracking-[0.2em] mb-4 ml-1">Aqidasi</h3>
                    <div class="flex flex-wrap gap-2">
                        <button type="button" class="chip chip-selected" data-filter="aqida" data-value="Ahli Sunna">Ahli Sunna</button>
                        <button type="button" class="chip chip-unselected" data-filter="aqida" data-value="Ash'ariya">Ash'ariya</button>
                        <button type="button" class="chip chip-unselected" data-filter="aqida" data-value="Moturidiya">Moturidiya</button>
                        <button type="button" class="chip chip-unselected" data-filter="aqida" data-value="Boshqa">Boshqa</button>
                    </div>
                </section>
                <section>
                    <h3 class="text-[11px] font-black text-white/40 uppercase tracking-[0.2em] mb-4 ml-1">Namoz</h3>
                    <div class="space-y-2">
                        <button type="button" class="radio-item radio-item-selected w-full" data-filter="prays" data-value="5 vaqt to'liq">
                            <span class="text-sm font-semibold">5 vaqt to'liq</span>
                            <div class="size-5 rounded-full border-2 border-primary flex items-center justify-center">
                                <div class="size-2.5 bg-primary rounded-full"></div>
                            </div>
                        </button>
                        <button type="button" class="radio-item w-full" data-filter="prays" data-value="Faqat juma">
                            <span class="text-sm font-semibold text-white/60">Faqat juma</span>
                            <div class="size-5 rounded-full border-2 border-white/20"></div>
                        </button>
                        <button type="button" class="radio-item w-full" data-filter="prays" data-value="O'qimaydi">
                            <span class="text-sm font-semibold text-white/60">O'qimaydi</span>
                            <div class="size-5 rounded-full border-2 border-white/20"></div>
                        </button>
                        <button type="button" class="radio-item w-full" data-filter="prays" data-value="Boshlash niyatida">
                            <span class="text-sm font-semibold text-white/60">Boshlash niyatida</span>
                            <div class="size-5 rounded-full border-2 border-white/20"></div>
                        </button>
                    </div>
                </section>
                <section>
                    <h3 class="text-[11px] font-black text-white/40 uppercase tracking-[0.2em] mb-4 ml-1">Qur'on o'qish</h3>
                    <div class="flex flex-wrap gap-2">
                        <button type="button" class="chip chip-unselected" data-filter="quran_reading" data-value="Bilmaydi">Bilmaydi</button>
                        <button type="button" class="chip chip-selected" data-filter="quran_reading" data-value="O'qishni biladi">O'qishni biladi</button>
                        <button type="button" class="chip chip-unselected" data-filter="quran_reading" data-value="Ravon o'qiydi">Ravon o'qiydi</button>
                        <button type="button" class="chip chip-unselected" data-filter="quran_reading" data-value="Hofizi Qur'on">Hofizi Qur'on</button>
                    </div>
                </section>
                <section class="pb-32">
                    <h3 class="text-[11px] font-black text-white/40 uppercase tracking-[0.2em] mb-4 ml-1">Mazhabi</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <button type="button" class="radio-item radio-item-selected justify-center" data-filter="mazhab" data-value="Hanafi">
                            <span class="text-sm font-bold">Hanafi</span>
                        </button>
                        <button type="button" class="radio-item justify-center" data-filter="mazhab" data-value="Shafi'i">
                            <span class="text-sm font-bold text-white/60">Shafi'i</span>
                        </button>
                        <button type="button" class="radio-item justify-center" data-filter="mazhab" data-value="Maliki">
                            <span class="text-sm font-bold text-white/60">Maliki</span>
                        </button>
                        <button type="button" class="radio-item justify-center" data-filter="mazhab" data-value="Hanbali">
                            <span class="text-sm font-bold text-white/60">Hanbali</span>
                        </button>
                    </div>
                </section>
            </div>
            <div class="absolute bottom-0 left-0 w-full p-6 bg-gradient-to-t from-[#111112] via-[#111112] to-transparent pt-12">
                <div class="max-w-md mx-auto">
                    <button onclick="closeFilterSheet()" class="w-full h-16 bg-primary text-black rounded-2xl flex items-center justify-center gap-2 shadow-[0_12px_45px_rgba(64,255,0,0.3)] active:scale-[0.97] transition-all duration-200">
                        <span class="text-sm font-black uppercase tracking-[0.25em]">Tayyor</span>
                        <span class="material-symbols-outlined text-[20px] font-bold">check</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Joylashuv Filter Sheet -->
    <div id="filter-location-sheet" class="bottom-sheet">
        <div class="max-w-md mx-auto h-[85vh] flex flex-col">
            <div class="handle"></div>
            <div class="px-6 pb-6 shrink-0">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold">Joylashuv</h2>
                    <button onclick="closeFilterSheet()" class="text-primary text-[11px] font-black uppercase tracking-widest">Tayyor</button>
                </div>
                <div class="relative group">
                    <div class="absolute inset-y-0 left-4 flex items-center pointer-events-none">
                        <span class="material-symbols-outlined text-white/40 text-[20px]">search</span>
                    </div>
                    <input id="filter-location-search" class="w-full h-12 glass-input rounded-xl pl-12 pr-4 text-sm font-medium text-white placeholder-white/20" placeholder="Mamlakatni qidirish, bosib shaharlarni tanlang..." type="text"/>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto ios-scroll-hide px-6 pb-12">
                <div id="filter-location-list" class="space-y-3">
                    <div class="location-country-block bg-white/[0.03] border border-white/[0.05] rounded-[2rem] overflow-hidden" data-country-name="O'zbekiston">
                        <button type="button" class="location-country-header w-full flex items-center justify-between p-5 border-b border-white/[0.04] text-left active:bg-white/[0.05] transition-colors">
                            <div class="flex items-center gap-3">
                                <span class="text-2xl">🇺🇿</span>
                                <span class="font-bold">O'zbekiston</span>
                            </div>
                            <span class="material-symbols-outlined text-primary transform rotate-90 location-chevron">chevron_right</span>
                        </button>
                        <div class="location-cities px-5 py-4 space-y-4 bg-white/[0.01]">
                            <label class="flex items-center justify-between group cursor-pointer"><span class="text-sm font-medium text-white/80 group-active:text-white">Toshkent shahar</span><input name="location_city" value="Toshkent shahar" class="location-city-cb custom-checkbox" type="checkbox"/></label>
                            <label class="flex items-center justify-between group cursor-pointer"><span class="text-sm font-medium text-white/80 group-active:text-white">Toshkent viloyati</span><input name="location_city" value="Toshkent viloyati" class="location-city-cb custom-checkbox" type="checkbox"/></label>
                            <label class="flex items-center justify-between group cursor-pointer"><span class="text-sm font-medium text-white/80 group-active:text-white">Samarqand</span><input name="location_city" value="Samarqand" class="location-city-cb custom-checkbox" type="checkbox"/></label>
                            <label class="flex items-center justify-between group cursor-pointer"><span class="text-sm font-medium text-white/80 group-active:text-white">Buxoro</span><input name="location_city" value="Buxoro" class="location-city-cb custom-checkbox" type="checkbox"/></label>
                            <label class="flex items-center justify-between group cursor-pointer"><span class="text-sm font-medium text-white/80 group-active:text-white">Andijon</span><input name="location_city" value="Andijon" class="location-city-cb custom-checkbox" type="checkbox"/></label>
                            <label class="flex items-center justify-between group cursor-pointer"><span class="text-sm font-medium text-white/80 group-active:text-white">Farg'ona</span><input name="location_city" value="Farg'ona" class="location-city-cb custom-checkbox" type="checkbox"/></label>
                            <label class="flex items-center justify-between group cursor-pointer"><span class="text-sm font-medium text-white/80 group-active:text-white">Namangan</span><input name="location_city" value="Namangan" class="location-city-cb custom-checkbox" type="checkbox"/></label>
                            <label class="flex items-center justify-between group cursor-pointer"><span class="text-sm font-medium text-white/80 group-active:text-white">Qashqadaryo</span><input name="location_city" value="Qashqadaryo" class="location-city-cb custom-checkbox" type="checkbox"/></label>
                            <label class="flex items-center justify-between group cursor-pointer"><span class="text-sm font-medium text-white/80 group-active:text-white">Surxondaryo</span><input name="location_city" value="Surxondaryo" class="location-city-cb custom-checkbox" type="checkbox"/></label>
                            <label class="flex items-center justify-between group cursor-pointer"><span class="text-sm font-medium text-white/80 group-active:text-white">Xorazm</span><input name="location_city" value="Xorazm" class="location-city-cb custom-checkbox" type="checkbox"/></label>
                            <label class="flex items-center justify-between group cursor-pointer"><span class="text-sm font-medium text-white/80 group-active:text-white">Navoiy</span><input name="location_city" value="Navoiy" class="location-city-cb custom-checkbox" type="checkbox"/></label>
                            <label class="flex items-center justify-between group cursor-pointer"><span class="text-sm font-medium text-white/80 group-active:text-white">Jizzax</span><input name="location_city" value="Jizzax" class="location-city-cb custom-checkbox" type="checkbox"/></label>
                            <label class="flex items-center justify-between group cursor-pointer"><span class="text-sm font-medium text-white/80 group-active:text-white">Sirdaryo</span><input name="location_city" value="Sirdaryo" class="location-city-cb custom-checkbox" type="checkbox"/></label>
                            <label class="flex items-center justify-between group cursor-pointer"><span class="text-sm font-medium text-white/80 group-active:text-white">Qoraqalpog'iston</span><input name="location_city" value="Qoraqalpog'iston" class="location-city-cb custom-checkbox" type="checkbox"/></label>
                        </div>
                            </div>
                    <div class="location-country-block bg-white/[0.03] border border-white/[0.05] rounded-3xl overflow-hidden" data-country-name="Qirg'iziston">
                        <button type="button" class="location-country-header w-full flex items-center justify-between p-5 active:bg-white/[0.06] transition-colors text-left">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">🇰🇬</span>
                            <span class="font-bold text-white/80">Qirg'iziston</span>
                        </div>
                            <span class="material-symbols-outlined text-white/20 location-chevron">chevron_right</span>
                    </button>
                        <div class="location-cities hidden px-5 py-4 space-y-4 bg-white/[0.01]"></div>
                    </div>
                    <div class="location-country-block bg-white/[0.03] border border-white/[0.05] rounded-3xl overflow-hidden" data-country-name="Rossiya">
                        <button type="button" class="location-country-header w-full flex items-center justify-between p-5 active:bg-white/[0.06] transition-colors text-left">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">🇷🇺</span>
                            <span class="font-bold text-white/80">Rossiya</span>
                        </div>
                            <span class="material-symbols-outlined text-white/20 location-chevron">chevron_right</span>
                    </button>
                        <div class="location-cities hidden px-5 py-4 space-y-4 bg-white/[0.01]"></div>
                    </div>
                    <div class="location-country-block bg-white/[0.03] border border-white/[0.05] rounded-3xl overflow-hidden" data-country-name="Qozog'iston">
                        <button type="button" class="location-country-header w-full flex items-center justify-between p-5 active:bg-white/[0.06] transition-colors text-left">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">🇰🇿</span>
                            <span class="font-bold text-white/80">Qozog'iston</span>
                        </div>
                            <span class="material-symbols-outlined text-white/20 location-chevron">chevron_right</span>
                    </button>
                        <div class="location-cities hidden px-5 py-4 space-y-4 bg-white/[0.01]"></div>
                    </div>
                    <div class="location-country-block bg-white/[0.03] border border-white/[0.05] rounded-3xl overflow-hidden" data-country-name="Tojikiston">
                        <button type="button" class="location-country-header w-full flex items-center justify-between p-5 active:bg-white/[0.06] transition-colors text-left">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">🇹🇯</span>
                            <span class="font-bold text-white/80">Tojikiston</span>
                        </div>
                            <span class="material-symbols-outlined text-white/20 location-chevron">chevron_right</span>
                    </button>
                        <div class="location-cities hidden px-5 py-4 space-y-4 bg-white/[0.01]"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Oilaviy holati Filter Sheet (variantlar jinsga qarab: Kelin=ayol, Kuyov=erkak) -->
    <div id="filter-family-sheet" class="bottom-sheet">
        <div class="max-w-md mx-auto h-[85vh] flex flex-col">
            <div class="handle"></div>
            <div class="px-6 pb-6 flex items-center justify-between">
                <h2 class="text-xl font-bold">Oilaviy holati</h2>
                <button onclick="closeFilterSheet()" class="text-primary text-sm font-bold bg-primary/10 px-5 py-2.5 rounded-full active:scale-95 transition-transform">Tayyor</button>
            </div>
            <div class="flex-1 overflow-y-auto px-6 pb-10 space-y-8 ios-scroll-hide">
                <div class="space-y-4">
                    <p class="text-[10px] font-bold text-white/40 uppercase tracking-widest ml-1">Holat</p>
                    <div id="filter-family-status-cards" class="grid grid-cols-3 gap-3">
                        <button type="button" class="status-card filter-family-opt" data-value="Bo'ydoq" data-for-gender="Erkak">
                            <span class="material-symbols-outlined mb-2 text-white/40">person_add</span>
                            <span class="text-xs font-bold">Bo'ydoq</span>
                        </button>
                        <button type="button" class="status-card filter-family-opt" data-value="Oilali" data-for-gender="Erkak">
                            <span class="material-symbols-outlined mb-2 text-white/40">family_restroom</span>
                            <span class="text-xs font-bold">Oilali</span>
                        </button>
                        <button type="button" class="status-card filter-family-opt" data-value="Ajrashgan" data-for-gender="both">
                            <span class="material-symbols-outlined mb-2 text-white/40">group_remove</span>
                            <span class="text-xs font-bold">Ajrashgan</span>
                        </button>
                        <button type="button" class="status-card filter-family-opt" data-value="Qiz bola" data-for-gender="Ayol">
                            <span class="material-symbols-outlined mb-2 text-white/40">person</span>
                            <span class="text-xs font-bold">Qiz bola</span>
                        </button>
                        <button type="button" class="status-card filter-family-opt" data-value="Beva" data-for-gender="Ayol">
                            <span class="material-symbols-outlined mb-2 text-white/40">heart_broken</span>
                            <span class="text-xs font-bold">Beva</span>
                        </button>
                    </div>
                </div>
                <div class="space-y-4">
                    <p class="text-[10px] font-bold text-white/40 uppercase tracking-widest ml-1">Farzandi</p>
                    <div class="flex gap-3" id="filter-family-children">
                        <button type="button" class="filter-family-children flex-1 py-3 rounded-2xl text-sm font-bold transition-all bg-primary text-black" data-value="Bor">Bor</button>
                        <button type="button" class="filter-family-children flex-1 py-3 rounded-2xl text-sm font-bold transition-all bg-white/[0.05] text-white/60" data-value="Yo'q">Yo'q</button>
                    </div>
                </div>
                <div class="space-y-4">
                    <p class="text-[10px] font-bold text-white/40 uppercase tracking-widest ml-1">Nechinchilikka (Ruhsat)</p>
                    <div class="bg-white/[0.03] rounded-3xl border border-white/[0.05] overflow-hidden" id="filter-family-polygamy">
                        <button type="button" class="filter-family-polygamy w-full px-6 py-5 flex items-center justify-between border-b border-white/[0.03] active:bg-white/[0.05] transition-colors border-l-4 border-l-primary" data-value="1">
                            <span class="text-sm font-semibold text-primary">1-ro'zg'or</span>
                            <span class="material-symbols-outlined text-primary text-[20px]">check_circle</span>
                        </button>
                        <button type="button" class="filter-family-polygamy w-full px-6 py-5 flex items-center justify-between border-b border-white/[0.03] active:bg-white/[0.05] transition-colors border-l-4 border-l-transparent" data-value="2">
                            <span class="text-sm font-semibold text-white/60">2-ro'zg'or</span>
                            <span class="material-symbols-outlined text-white/10 text-[20px]">circle</span>
                        </button>
                        <button type="button" class="filter-family-polygamy w-full px-6 py-5 flex items-center justify-between active:bg-white/[0.05] transition-colors border-l-4 border-l-transparent" data-value="3">
                            <span class="text-sm font-semibold text-white/60">3-ro'zg'or va h.k.</span>
                            <span class="material-symbols-outlined text-white/10 text-[20px]">circle</span>
                        </button>
                    </div>
                </div>
                <div class="p-4 rounded-2xl bg-white/[0.02] border border-white/[0.04]">
                    <div class="flex gap-3 items-start">
                        <span class="material-symbols-outlined text-white/30 text-[20px]">info</span>
                        <p class="text-[11px] text-white/40 leading-relaxed">
                            Oilaviy holat ma'lumotlari sizga mos keladigan nomzodlarni aniqlashda muhim ahamiyatga ega. Iltimos, ma'lumotlarni to'g'ri ko'rsating.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Jismoniy parametrlar Filter Sheet -->
    <div id="filter-physical-sheet" class="bottom-sheet h-[90vh]">
        <div class="max-w-md mx-auto flex flex-col h-full">
            <div class="handle"></div>
            <div class="px-6 pb-4 flex items-center justify-between">
                <div>
                    <h2 class="text-xl font-bold">Jismoniy parametrlar</h2>
                    <p class="text-[10px] text-white/40 uppercase tracking-widest mt-0.5">O'zingizga mos o'lchamlarni belgilang</p>
                </div>
                <button onclick="closeFilterSheet()" class="text-black bg-primary text-[11px] font-black uppercase tracking-widest px-6 py-3 rounded-xl active:scale-95 transition-transform shadow-[0_8px_20px_rgba(64,255,0,0.2)]">Tayyor</button>
            </div>
            <div class="flex-1 overflow-y-auto px-4 pb-10 ios-scroll-hide">
                <p class="text-[10px] text-white/40 uppercase tracking-widest mb-3">Bundan — bungacha (min va max)</p>
                <!-- YOSH Min / Max -->
                <div class="flex items-start justify-center gap-2 w-full mb-4">
                    <div class="ios-dial-wrapper flex-1">
                        <span class="ios-dial-title">YOSH MIN</span>
                        <div class="ios-dial" id="ios-dial-age-min" data-min="18" data-max="70">
                            <div class="ios-dial-fade-top"></div>
                            <div class="ios-dial-ticks"><div class="ios-dial-tick"></div><div class="ios-dial-tick"></div><div class="ios-dial-tick glow"></div><div class="ios-dial-tick glow"></div><div class="ios-dial-tick"></div><div class="ios-dial-tick"></div></div>
                            <div class="ios-dial-track"><div class="ios-dial-items"></div></div>
                            <div class="ios-dial-fade-bottom"></div>
                        </div>
                        <span class="ios-dial-label">yosh</span>
                    </div>
                    <div class="ios-dial-wrapper flex-1">
                        <span class="ios-dial-title">YOSH MAX</span>
                        <div class="ios-dial" id="ios-dial-age-max" data-min="18" data-max="70">
                            <div class="ios-dial-fade-top"></div>
                            <div class="ios-dial-ticks"><div class="ios-dial-tick"></div><div class="ios-dial-tick"></div><div class="ios-dial-tick glow"></div><div class="ios-dial-tick glow"></div><div class="ios-dial-tick"></div><div class="ios-dial-tick"></div></div>
                            <div class="ios-dial-track"><div class="ios-dial-items"></div></div>
                            <div class="ios-dial-fade-bottom"></div>
                        </div>
                        <span class="ios-dial-label">yosh</span>
                    </div>
                </div>
                <!-- BO'Y Min / Max -->
                <div class="flex items-start justify-center gap-2 w-full mb-4">
                    <div class="ios-dial-wrapper flex-1">
                        <span class="ios-dial-title">BO'Y MIN</span>
                        <div class="ios-dial" id="ios-dial-height-min" data-min="140" data-max="210">
                            <div class="ios-dial-fade-top"></div>
                            <div class="ios-dial-ticks"><div class="ios-dial-tick"></div><div class="ios-dial-tick"></div><div class="ios-dial-tick glow"></div><div class="ios-dial-tick glow"></div><div class="ios-dial-tick"></div><div class="ios-dial-tick"></div></div>
                            <div class="ios-dial-track"><div class="ios-dial-items"></div></div>
                            <div class="ios-dial-fade-bottom"></div>
                        </div>
                        <span class="ios-dial-label">sm</span>
                    </div>
                    <div class="ios-dial-wrapper flex-1">
                        <span class="ios-dial-title">BO'Y MAX</span>
                        <div class="ios-dial" id="ios-dial-height-max" data-min="140" data-max="210">
                            <div class="ios-dial-fade-top"></div>
                            <div class="ios-dial-ticks"><div class="ios-dial-tick"></div><div class="ios-dial-tick"></div><div class="ios-dial-tick glow"></div><div class="ios-dial-tick glow"></div><div class="ios-dial-tick"></div><div class="ios-dial-tick"></div></div>
                            <div class="ios-dial-track"><div class="ios-dial-items"></div></div>
                            <div class="ios-dial-fade-bottom"></div>
                        </div>
                        <span class="ios-dial-label">sm</span>
                    </div>
                </div>
                <!-- VAZN Min / Max -->
                <div class="flex items-start justify-center gap-2 w-full mb-4">
                    <div class="ios-dial-wrapper flex-1">
                        <span class="ios-dial-title">VAZN MIN</span>
                        <div class="ios-dial" id="ios-dial-weight-min" data-min="40" data-max="130">
                            <div class="ios-dial-fade-top"></div>
                            <div class="ios-dial-ticks"><div class="ios-dial-tick"></div><div class="ios-dial-tick"></div><div class="ios-dial-tick glow"></div><div class="ios-dial-tick glow"></div><div class="ios-dial-tick"></div><div class="ios-dial-tick"></div></div>
                            <div class="ios-dial-track"><div class="ios-dial-items"></div></div>
                            <div class="ios-dial-fade-bottom"></div>
                        </div>
                        <span class="ios-dial-label">kg</span>
                    </div>
                    <div class="ios-dial-wrapper flex-1">
                        <span class="ios-dial-title">VAZN MAX</span>
                        <div class="ios-dial" id="ios-dial-weight-max" data-min="40" data-max="130">
                            <div class="ios-dial-fade-top"></div>
                            <div class="ios-dial-ticks"><div class="ios-dial-tick"></div><div class="ios-dial-tick"></div><div class="ios-dial-tick glow"></div><div class="ios-dial-tick glow"></div><div class="ios-dial-tick"></div><div class="ios-dial-tick"></div></div>
                            <div class="ios-dial-track"><div class="ios-dial-items"></div></div>
                            <div class="ios-dial-fade-bottom"></div>
                        </div>
                        <span class="ios-dial-label">kg</span>
                    </div>
                </div>

                <!-- Sigaret chekadimi -->
                <div class="mt-8 space-y-4">
                    <div class="flex items-center gap-3">
                        <div class="size-10 rounded-xl bg-white/[0.05] flex items-center justify-center">
                            <span class="material-symbols-outlined text-white/40 text-xl">smoking_rooms</span>
                        </div>
                        <h3 class="text-base font-bold text-white/80">Sigaret chekadimi?</h3>
                    </div>
                    <div class="grid grid-cols-3 gap-3" id="filter-smoking-options">
                        <button type="button" class="filter-smoking-btn py-4 rounded-2xl text-sm font-bold uppercase tracking-wide bg-white/[0.05] border border-white/[0.08] text-white/60 transition-all" data-value="Ha">Ha</button>
                        <button type="button" class="filter-smoking-btn py-4 rounded-2xl text-sm font-bold uppercase tracking-wide bg-primary text-black transition-all" data-value="Yo'q">Yo'q</button>
                        <button type="button" class="filter-smoking-btn py-4 rounded-2xl text-sm font-bold uppercase tracking-wide bg-white/[0.05] border border-white/[0.08] text-white/60 transition-all" data-value="Tashlagan">Tashlagan</button>
                    </div>
                </div>

                <!-- Sport bilan shug'ullanish -->
                <div class="mt-6 p-5 rounded-3xl bg-white/[0.03] border border-white/[0.06] space-y-4">
                    <div class="flex justify-between items-center">
                        <span class="text-[10px] font-bold text-white/40 uppercase tracking-widest">Sport bilan shug'ullanish</span>
                        <span id="filter-sport-label" class="text-xs font-bold text-primary">Haftada 3 kun</span>
                    </div>
                    <div class="flex gap-1.5 h-2" id="filter-sport-bars">
                        <button type="button" class="filter-sport-bar flex-1 bg-primary rounded-full transition-all" data-day="1"></button>
                        <button type="button" class="filter-sport-bar flex-1 bg-primary rounded-full transition-all" data-day="2"></button>
                        <button type="button" class="filter-sport-bar flex-1 bg-primary rounded-full transition-all" data-day="3"></button>
                        <button type="button" class="filter-sport-bar flex-1 bg-white/10 rounded-full transition-all" data-day="4"></button>
                        <button type="button" class="filter-sport-bar flex-1 bg-white/10 rounded-full transition-all" data-day="5"></button>
                        <button type="button" class="filter-sport-bar flex-1 bg-white/10 rounded-full transition-all" data-day="6"></button>
                        <button type="button" class="filter-sport-bar flex-1 bg-white/10 rounded-full transition-all" data-day="7"></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ilm & Til Filter Sheet -->
    <div id="filter-education-sheet" class="bottom-sheet">
        <div class="max-w-md mx-auto h-[85vh] flex flex-col">
            <div class="handle"></div>
            <div class="px-6 pb-4 flex items-center justify-between">
                <h2 class="text-xl font-bold tracking-tight">Ilm &amp; Til</h2>
                <button onclick="closeFilterSheet()" class="text-primary text-xs font-black uppercase tracking-widest bg-primary/10 px-4 py-2 rounded-full border border-primary/20">Tayyor</button>
            </div>
            <div class="flex-1 overflow-y-auto px-6 pb-10 space-y-8 ios-scroll-hide">
                <div class="relative">
                    <div class="absolute inset-y-0 left-4 flex items-center pointer-events-none">
                        <span class="material-symbols-outlined text-white/40 text-[18px]">search</span>
                    </div>
                    <input class="w-full h-12 glass-input rounded-xl pl-11 pr-4 text-sm font-medium text-white placeholder-white/20" placeholder="Til yoki muassasa qidirish..." type="text"/>
                </div>
                <section>
                    <p class="text-[10px] font-bold text-white/30 uppercase tracking-[0.2em] mb-4">Ta'lim darajasi</p>
                    <div class="space-y-2">
                        <button type="button" class="filter-education-opt filter-education-selected w-full flex items-center justify-between p-4 rounded-2xl bg-white/[0.03] border border-primary/40 group active:scale-[0.98] transition-all" data-value="Oliy">
                            <span class="text-sm font-semibold text-white">Oliy ma'lumotli</span>
                            <div class="size-5 rounded-full bg-primary flex items-center justify-center">
                                <span class="material-symbols-outlined text-black text-[14px] font-bold">check</span>
                            </div>
                        </button>
                        <button type="button" class="filter-education-opt w-full flex items-center justify-between p-4 rounded-2xl bg-white/[0.03] border border-white/[0.05] group active:scale-[0.98] transition-all" data-value="O'rta maxsus">
                            <span class="text-sm font-semibold text-white/60">O'rta-maxsus</span>
                            <div class="size-5 rounded-full border-2 border-white/10"></div>
                        </button>
                        <button type="button" class="filter-education-opt w-full flex items-center justify-between p-4 rounded-2xl bg-white/[0.03] border border-white/[0.05] group active:scale-[0.98] transition-all" data-value="O'rta">
                            <span class="text-sm font-semibold text-white/60">O'rta</span>
                            <div class="size-5 rounded-full border-2 border-white/10"></div>
                        </button>
                    </div>
                </section>
                <section>
                    <div class="flex items-center justify-between mb-4">
                        <p class="text-[10px] font-bold text-white/30 uppercase tracking-[0.2em]">Biladigan tillari</p>
                        <span class="text-[10px] font-bold text-primary px-2 py-0.5 bg-primary/10 rounded-md">3 TANLANDI</span>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <button class="px-5 py-2.5 rounded-full border text-xs tag-active transition-all">O'zbek</button>
                        <button class="px-5 py-2.5 rounded-full border text-xs tag-active transition-all">Ingliz</button>
                        <button class="px-5 py-2.5 rounded-full border text-xs tag-inactive transition-all">Rus</button>
                        <button class="px-5 py-2.5 rounded-full border text-xs tag-active transition-all">Arab</button>
                        <button class="px-5 py-2.5 rounded-full border text-xs tag-inactive transition-all">Turk</button>
                        <button class="px-5 py-2.5 rounded-full border text-xs tag-inactive transition-all">Fransuz</button>
                        <button class="px-5 py-2.5 rounded-full border text-xs tag-inactive transition-all">Nemis</button>
                        <button class="px-5 py-2.5 rounded-full border text-xs tag-inactive transition-all">Koreys</button>
                    </div>
                </section>
                <section>
                    <p class="text-[10px] font-bold text-white/30 uppercase tracking-[0.2em] mb-4">Diniy ilm darajasi</p>
                    <div class="grid grid-cols-2 gap-3">
                        <button type="button" class="filter-education-religious flex items-center gap-3 p-3 rounded-xl bg-white/[0.03] border border-primary/40 bg-primary/5 transition-all" data-value="Qur'on o'qish">
                            <div class="size-8 rounded-lg bg-white/5 flex items-center justify-center">
                                <span class="material-symbols-outlined text-[18px] text-white/40">menu_book</span>
                            </div>
                            <span class="text-xs font-medium text-white">Qur'on o'qish</span>
                        </button>
                        <button type="button" class="filter-education-religious flex items-center gap-3 p-3 rounded-xl bg-white/[0.03] border border-white/[0.05] transition-all" data-value="Tajvid">
                            <div class="size-8 rounded-lg bg-white/5 flex items-center justify-center">
                                <span class="material-symbols-outlined text-[18px] text-white/40">auto_stories</span>
                            </div>
                            <span class="text-xs font-medium text-white/60">Tajvid</span>
                        </button>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <!-- Ish & Daromad Filter Sheet -->
    <div id="filter-work-sheet" class="bottom-sheet">
        <div class="max-w-md mx-auto h-[85vh] flex flex-col">
            <div class="handle"></div>
            <div class="px-6 pb-4 flex items-center justify-between">
                <h2 class="text-xl font-bold">Ish & Daromad</h2>
                <button onclick="closeFilterSheet()" class="text-black bg-primary text-[11px] font-black uppercase tracking-widest px-5 py-2.5 rounded-xl active:scale-95 transition-transform shadow-[0_8px_20px_rgba(64,255,0,0.2)]">Tayyor</button>
            </div>
            <div class="flex-1 overflow-y-auto px-6 space-y-6 ios-scroll-hide pb-32">
                <!-- Kasb tugmalari -->
                <div class="flex flex-wrap gap-2" id="filter-work-professions">
                    <button type="button" class="filter-work-profession px-5 py-3 rounded-full bg-primary text-black text-sm font-bold shadow-[0_4px_15px_rgba(64,255,0,0.2)] transition-all" data-value="Tadbirkor">Tadbirkor</button>
                    <button type="button" class="filter-work-profession px-5 py-3 rounded-full bg-white/[0.05] border border-white/[0.1] text-white/70 text-sm font-bold transition-all" data-value="Shifokor">Shifokor</button>
                    <button type="button" class="filter-work-profession px-5 py-3 rounded-full bg-white/[0.05] border border-white/[0.1] text-white/70 text-sm font-bold transition-all" data-value="IT muhandis">IT muhandis</button>
                    <button type="button" class="filter-work-profession px-5 py-3 rounded-full bg-white/[0.05] border border-white/[0.1] text-white/70 text-sm font-bold transition-all" data-value="O'qituvchi">O'qituvchi</button>
                    <button type="button" class="filter-work-profession px-5 py-3 rounded-full bg-white/[0.05] border border-white/[0.1] text-white/70 text-sm font-bold transition-all" data-value="Dizayner">Dizayner</button>
                    <button type="button" class="filter-work-profession px-5 py-3 rounded-full bg-white/[0.05] border border-white/[0.1] text-white/70 text-sm font-bold transition-all" data-value="Huquqshunos">Huquqshunos</button>
                </div>

                <!-- Oylik daromad - Dual Range Slider -->
                <div class="mt-6 space-y-4">
                    <div class="flex justify-between items-center">
                        <div>
                            <span class="text-xs font-bold text-white/40 uppercase tracking-widest block">Oylik daromad</span>
                            <p class="text-[10px] text-white/30 mt-0.5">O'rtacha oylik miqdori ($)</p>
                        </div>
                        <span id="filter-work-salary-label" class="text-sm font-black text-primary bg-primary/10 border border-primary/30 px-4 py-2 rounded-xl">$500 — $5000+</span>
                    </div>
                    
                    <!-- Dual Range Slider -->
                    <div class="relative pt-2 pb-4" id="salary-slider-container">
                        <div class="relative h-2 bg-white/10 rounded-full">
                            <div id="salary-slider-range" class="absolute h-2 bg-primary rounded-full" style="left: 10%; right: 20%;"></div>
                            <div id="salary-slider-min" class="salary-slider-thumb" style="left: 10%;" data-type="min"></div>
                            <div id="salary-slider-max" class="salary-slider-thumb" style="left: 80%;" data-type="max"></div>
                        </div>
                        <div class="flex justify-between mt-4 px-1">
                            <span class="text-[10px] font-bold text-white/30">0</span>
                            <span class="text-[10px] font-bold text-white/30">1000</span>
                            <span class="text-[10px] font-bold text-white/30">2500</span>
                            <span class="text-[10px] font-bold text-white/30">5000+</span>
                        </div>
                    </div>
                    <input type="hidden" id="filter-work-salary-min" value="500">
                    <input type="hidden" id="filter-work-salary-max" value="5000">
                </div>

                <!-- Mashhur toifalar -->
                <div class="mt-4 space-y-3">
                    <span class="text-xs font-bold text-white/40 uppercase tracking-widest">Mashhur toifalar</span>
                    <div class="grid grid-cols-2 gap-3" id="filter-work-categories">
                        <button type="button" class="filter-work-category p-4 rounded-2xl bg-white/[0.03] border border-white/[0.06] flex items-center gap-3 transition-all" data-value="Masofaviy">
                            <div class="size-10 rounded-xl bg-blue-500/15 flex items-center justify-center">
                                <span class="material-symbols-outlined text-blue-400 text-xl">laptop_mac</span>
                            </div>
                            <span class="text-sm font-bold text-white/80">Masofaviy ish</span>
                        </button>
                        <button type="button" class="filter-work-category p-4 rounded-2xl bg-white/[0.03] border border-white/[0.06] flex items-center gap-3 transition-all" data-value="Biznes">
                            <div class="size-10 rounded-xl bg-orange-500/15 flex items-center justify-center">
                                <span class="material-symbols-outlined text-orange-400 text-xl">storefront</span>
                            </div>
                            <span class="text-sm font-bold text-white/80">Xususiy biznes</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Saralash Sheet -->
    <div id="filter-sort-sheet" class="bottom-sheet">
        <div class="max-w-md mx-auto rounded-t-[40px] px-6 pb-14">
            <div class="ios-handle"></div>
            <div class="flex items-center justify-between mb-8">
                <h3 class="text-2xl font-extrabold tracking-tight">Saralash</h3>
                <div class="flex items-center gap-3">
                <button onclick="closeFilterSheet()" class="text-[11px] font-black text-white/40 uppercase tracking-widest hover:text-primary transition-colors">Tozalash</button>
                    <button class="filter-close-btn size-10 rounded-full glass-panel flex items-center justify-center active:scale-95 transition-transform" title="Yopish">
                        <span class="material-symbols-outlined text-[22px]">close</span>
                    </button>
            </div>
            </div>
            <div class="space-y-3" id="filter-sort-options">
                <button type="button" data-sort="new" class="sort-option-btn w-full flex items-center justify-between p-4 rounded-2xl border glass-card transition-all group">
                    <div class="flex items-center gap-4">
                        <span class="material-symbols-outlined text-[24px] sort-option-icon">new_releases</span>
                        <span class="text-[15px] font-bold sort-option-label">Yangi e'lonlar</span>
                    </div>
                    <div class="flex items-center gap-1 bg-black/40 rounded-full px-2 py-1 border border-primary/30 sort-option-badge">
                        <span class="material-symbols-outlined text-[20px]">expand_less</span>
                        <span class="text-[10px] font-black uppercase">NEW</span>
                    </div>
                </button>
                <div class="rounded-2xl border border-white/10 glass-card overflow-hidden">
                    <div class="px-4 py-3 flex items-center gap-3 border-b border-white/5">
                        <span class="material-symbols-outlined text-white/50 text-[22px]">sort_by_alpha</span>
                        <span class="text-[13px] font-bold text-white/70">Ism bo'yicha</span>
                    </div>
                    <div class="p-2 flex gap-2">
                        <button type="button" data-sort="name_asc" class="sort-option-btn flex-1 py-3 px-3 rounded-xl border border-white/10 text-center text-[12px] font-bold transition-all">A → Z</button>
                        <button type="button" data-sort="name_desc" class="sort-option-btn flex-1 py-3 px-3 rounded-xl border border-white/10 text-center text-[12px] font-bold transition-all">Z → A</button>
                    </div>
                </div>
                <div class="rounded-2xl border border-white/10 glass-card overflow-hidden">
                    <div class="px-4 py-3 flex items-center gap-3 border-b border-white/5">
                        <span class="material-symbols-outlined text-white/50 text-[22px]">calendar_month</span>
                        <span class="text-[13px] font-bold text-white/70">Yosh bo'yicha</span>
                    </div>
                    <div class="p-2 flex gap-2">
                        <button type="button" data-sort="age_desc" class="sort-option-btn flex-1 py-3 px-3 rounded-xl border border-white/10 text-center text-[12px] font-bold transition-all">Yosh kichik birinchi</button>
                        <button type="button" data-sort="age_asc" class="sort-option-btn flex-1 py-3 px-3 rounded-xl border border-white/10 text-center text-[12px] font-bold transition-all">Yosh katta birinchi</button>
                    </div>
                </div>
                <div class="rounded-2xl border border-white/10 glass-card overflow-hidden">
                    <div class="px-4 py-3 flex items-center gap-3 border-b border-white/5">
                        <span class="material-symbols-outlined text-white/50 text-[22px]">height</span>
                        <span class="text-[13px] font-bold text-white/70">Bo'y bo'yicha</span>
                    </div>
                    <div class="p-2 flex gap-2">
                        <button type="button" data-sort="height_asc" class="sort-option-btn flex-1 py-3 px-3 rounded-xl border border-white/10 text-center text-[12px] font-bold transition-all">Qisqadan uzuniga</button>
                        <button type="button" data-sort="height_desc" class="sort-option-btn flex-1 py-3 px-3 rounded-xl border border-white/10 text-center text-[12px] font-bold transition-all">Uzundan qisqaga</button>
                    </div>
                </div>
            </div>
            <div class="mt-8 flex justify-center">
                <div class="w-20 h-1 bg-white/5 rounded-full"></div>
            </div>
        </div>
    </div>

    <!-- Qo'llanma Modal -->
    <div id="guide-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="max-w-md w-full glass-card rounded-[28px] max-h-[90vh] overflow-y-auto" style="scrollbar-width: thin;">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-extrabold tracking-tight">Qo'llanma</h2>
                    <button onclick="closeGuideModal()" class="size-10 rounded-full glass-card flex items-center justify-center text-white/60 hover:text-white transition-colors">
                        <span class="material-symbols-outlined text-[24px]">close</span>
                    </button>
                </div>
                <div class="space-y-6">
                    <div>
                        <h3 class="text-lg font-bold mb-3 flex items-center gap-2">
                            <span class="material-symbols-outlined text-primary text-[24px]">info</span>
                            Platforma haqida
                        </h3>
                        <p class="text-sm text-white/70 leading-relaxed">
                            NIKOH - bu halol va xavfsiz tanishuv platformasi. Bu yerda siz o'zingizga mos juftingizni topishingiz mumkin.
                        </p>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold mb-3 flex items-center gap-2">
                            <span class="material-symbols-outlined text-primary text-[24px]">person_add</span>
                            Profil yaratish
                        </h3>
                        <p class="text-sm text-white/70 leading-relaxed">
                            Profilingizni to'liq to'ldiring. Qanchalik to'liq ma'lumot bo'lsa, shunchalik ko'p ehtimol sizga mos juft topishingiz mumkin.
                        </p>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold mb-3 flex items-center gap-2">
                            <span class="material-symbols-outlined text-primary text-[24px]">workspace_premium</span>
                            Tariflar
                        </h3>
                        <p class="text-sm text-white/70 leading-relaxed">
                            So'rov yuborish va e'lon yaratish uchun tarif sotib olishingiz kerak. Har bir tarif ma'lum miqdordagi so'rov yuborish imkoniyatini beradi.
                        </p>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold mb-3 flex items-center gap-2">
                            <span class="material-symbols-outlined text-primary text-[24px]">favorite</span>
                            Sevimlilar
                        </h3>
                        <p class="text-sm text-white/70 leading-relaxed">
                            Yoqqan profillarni sevimlilarga qo'shing va keyinroq ularni ko'rib chiqing.
                        </p>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold mb-3 flex items-center gap-2">
                            <span class="material-symbols-outlined text-primary text-[24px]">chat_bubble</span>
                            Chat
                        </h3>
                        <p class="text-sm text-white/70 leading-relaxed">
                            So'rovingiz qabul qilingandan keyin 7 kunlik chat ochiladi. Bu vaqt ichida bir-biringiz bilan tanishib chiqing.
                        </p>
                    </div>
                </div>
                <button onclick="closeGuideModal()" class="w-full mt-6 bg-primary text-black py-3 rounded-xl font-bold uppercase tracking-wider active:scale-95 transition-transform">
                    Tushundim
                </button>
            </div>
        </div>
    </div>

    <!-- Bog'lanish Modal -->
    <div id="contact-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="max-w-md w-full glass-card rounded-[28px] max-h-[90vh] overflow-y-auto" style="scrollbar-width: thin;">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-extrabold tracking-tight">Bog'lanish</h2>
                    <button onclick="closeContactModal()" class="size-10 rounded-full glass-card flex items-center justify-center text-white/60 hover:text-white transition-colors">
                        <span class="material-symbols-outlined text-[24px]">close</span>
                    </button>
                </div>
                <div class="space-y-6">
                    <div>
                        <h3 class="text-lg font-bold mb-3 flex items-center gap-2">
                            <span class="material-symbols-outlined text-primary text-[24px]">support_agent</span>
                            Qo'llab-quvvatlash
                        </h3>
                        <p class="text-sm text-white/70 leading-relaxed mb-4">
                            Savollar yoki muammolaringiz bo'lsa, biz bilan bog'laning. Biz sizga yordam berishga tayyormiz.
                        </p>
                        <div class="space-y-3">
                            <a href="https://t.me/nikoh_support" target="_blank" class="w-full glass-card rounded-xl p-4 flex items-center justify-between group active:scale-95 transition-transform">
                                <div class="flex items-center gap-3">
                                    <div class="size-10 rounded-xl bg-primary/10 flex items-center justify-center">
                                        <span class="material-symbols-outlined text-primary text-[22px]">telegram</span>
                                    </div>
                                    <div>
                                        <p class="text-sm font-bold">Telegram</p>
                                        <p class="text-[10px] text-white/50">@nikoh_support</p>
                                    </div>
                                </div>
                                <span class="material-symbols-outlined text-white/20 group-hover:text-primary transition-colors">open_in_new</span>
                            </a>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold mb-3 flex items-center gap-2">
                            <span class="material-symbols-outlined text-primary text-[24px]">email</span>
                            Email
                        </h3>
                        <div class="glass-card rounded-xl p-4">
                            <p class="text-sm font-bold mb-2">support@nikoh.uz</p>
                            <button onclick="copyToClipboard('support@nikoh.uz')" class="text-xs text-primary hover:underline">
                                Email manzilini nusxalash
                            </button>
                        </div>
                    </div>
                </div>
                <button onclick="closeContactModal()" class="w-full mt-6 bg-primary text-black py-3 rounded-xl font-bold uppercase tracking-wider active:scale-95 transition-transform">
                    Yopish
                </button>
            </div>
        </div>
    </div>

    <!-- Hamkorlik Modal -->
    <div id="partnership-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="max-w-md w-full glass-card rounded-[28px] max-h-[90vh] overflow-y-auto" style="scrollbar-width: thin;">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-extrabold tracking-tight">Hamkorlik</h2>
                    <button onclick="closePartnershipModal()" class="size-10 rounded-full glass-card flex items-center justify-center text-white/60 hover:text-white transition-colors">
                        <span class="material-symbols-outlined text-[24px]">close</span>
                    </button>
                </div>
                <div class="space-y-6">
                    <div>
                        <h3 class="text-lg font-bold mb-3 flex items-center gap-2">
                            <span class="material-symbols-outlined text-primary text-[24px]">handshake</span>
                            Hamkorlik imkoniyatlari
                        </h3>
                        <p class="text-sm text-white/70 leading-relaxed mb-4">
                            Biz bilan hamkorlik qilishni istasangiz, quyidagi imkoniyatlar mavjud:
                        </p>
                        <div class="space-y-3">
                            <div class="glass-card rounded-xl p-4">
                                <h4 class="text-sm font-bold mb-2 flex items-center gap-2">
                                    <span class="material-symbols-outlined text-primary text-[18px]">campaign</span>
                                    Reklama
                                </h4>
                                <p class="text-xs text-white/60 leading-relaxed">
                                    Bizning platformada reklama joylashtirish imkoniyati. Katta auditoriyaga yetib borish.
                                </p>
                            </div>
                            <div class="glass-card rounded-xl p-4">
                                <h4 class="text-sm font-bold mb-2 flex items-center gap-2">
                                    <span class="material-symbols-outlined text-primary text-[18px]">groups</span>
                                    Hamkorlik loyihalari
                                </h4>
                                <p class="text-xs text-white/60 leading-relaxed">
                                    Turli loyihalar va tadbirlarda hamkorlik qilish imkoniyati.
                                </p>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold mb-3 flex items-center gap-2">
                            <span class="material-symbols-outlined text-primary text-[24px]">contact_mail</span>
                            Bog'lanish
                        </h3>
                        <div class="space-y-3">
                            <a href="https://t.me/nikoh_partnership" target="_blank" class="w-full glass-card rounded-xl p-4 flex items-center justify-between group active:scale-95 transition-transform">
                                <div class="flex items-center gap-3">
                                    <div class="size-10 rounded-xl bg-primary/10 flex items-center justify-center">
                                        <span class="material-symbols-outlined text-primary text-[22px]">telegram</span>
                                    </div>
                                    <div>
                                        <p class="text-sm font-bold">Telegram</p>
                                        <p class="text-[10px] text-white/50">@nikoh_partnership</p>
                                    </div>
                                </div>
                                <span class="material-symbols-outlined text-white/20 group-hover:text-primary transition-colors">open_in_new</span>
                            </a>
                            <div class="glass-card rounded-xl p-4">
                                <p class="text-sm font-bold mb-2">partnership@nikoh.uz</p>
                                <button onclick="copyToClipboard('partnership@nikoh.uz')" class="text-xs text-primary hover:underline">
                                    Email manzilini nusxalash
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <button onclick="closePartnershipModal()" class="w-full mt-6 bg-primary text-black py-3 rounded-xl font-bold uppercase tracking-wider active:scale-95 transition-transform">
                    Yopish
                </button>
            </div>
        </div>
    </div>

</body>
</html>

</html>
